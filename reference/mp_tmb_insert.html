<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="description" content="Insert or update elements of a TMB model spec, produced using
mp_tmb_library or mp_tmb_model_spec. The
only difference between mp_tmb_insert and mp_tmb_update is that
the former shifts the positions of existing expressions to make room
for the new expressions, whereas the latter overwrites existing expressions
using the new expressions. The treatment of new default values and
integers is the same. The examples below clarify this difference."><title>Modify a TMB Model Spec — mp_tmb_insert • macpan2</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Modify a TMB Model Spec — mp_tmb_insert"><meta property="og:description" content="Insert or update elements of a TMB model spec, produced using
mp_tmb_library or mp_tmb_model_spec. The
only difference between mp_tmb_insert and mp_tmb_update is that
the former shifts the positions of existing expressions to make room
for the new expressions, whereas the latter overwrites existing expressions
using the new expressions. The treatment of new default values and
integers is the same. The examples below clarify this difference."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/quickstart.html">Quickstart</a>
    <a class="dropdown-item" href="../articles/example_models.html">Example Models</a>
    <a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a>
    <a class="dropdown-item" href="../articles/real_data.html">Fitting to Data in the International Infectious Disease Data Archive (IIDDA)</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul><form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off"></form>

      <ul class="navbar-nav"><li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div>

    
  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Modify a TMB Model Spec</h1>
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/HEAD/R/tmb_model_editors.R" class="external-link"><code>R/tmb_model_editors.R</code></a></small>
      <div class="d-none name"><code>mp_tmb_insert.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Insert or update elements of a TMB model spec, produced using
<code><a href="mp_tmb_library.html">mp_tmb_library</a></code> or <code><a href="mp_tmb_model_spec.html">mp_tmb_model_spec</a></code>. The
only difference between <code>mp_tmb_insert</code> and <code>mp_tmb_update</code> is that
the former shifts the positions of existing expressions to make room
for the new expressions, whereas the latter overwrites existing expressions
using the new expressions. The treatment of new <code>default</code> values and
<code>integers</code> is the same. The examples below clarify this difference.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">mp_tmb_insert</span><span class="op">(</span></span>
<span>  <span class="va">model</span>,</span>
<span>  phase <span class="op">=</span> <span class="st">"during"</span>,</span>
<span>  at <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  expressions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  integers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  must_save <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  must_not_save <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  sim_exprs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mp_tmb_update</span><span class="op">(</span></span>
<span>  <span class="va">model</span>,</span>
<span>  phase <span class="op">=</span> <span class="st">"during"</span>,</span>
<span>  at <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  expressions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  integers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  must_save <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  must_not_save <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  sim_exprs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>
    <dl><dt>model</dt>
<dd><p>TMB model spec object produced using
<code><a href="mp_tmb_library.html">mp_tmb_library</a></code> or <code><a href="mp_tmb_model_spec.html">mp_tmb_model_spec</a></code>.</p></dd>


<dt>phase</dt>
<dd><p>At what phase should <code>expressions</code> be inserted or updated.</p></dd>


<dt>at</dt>
<dd><p>Expression number, which can be identified by printing out
<code>model</code>, at which the <code>expressions</code> should be inserted or updated. If
inserted then the existing expressions with number <code>at</code> and higher are
shifted after the new <code>expressions</code> are added. If updated, then the
existing expressions with number from <code>at</code> to <code>at + length(expressions) - 1</code>
are replaced with the new <code>expressions</code>.</p></dd>


<dt>expressions</dt>
<dd><p>Expressions to insert into the model spec or to
replace existing expressions.</p></dd>


<dt>default</dt>
<dd><p>Named list of objects, each of which can be coerced into
a <code><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></code> <code><a href="engine_functions.html">matrix</a></code>. The names refer to
variables that appear in <code>before</code>, <code>during</code>, and <code>after</code>.</p></dd>


<dt>integers</dt>
<dd><p>Named list of vectors that can be coerced to integer
vectors. These integer vectors can be used by name in model formulas to
provide indexing of matrices and as grouping factors in
<code><a href="engine_functions.html">group_sums</a></code>.</p></dd>


<dt>must_save</dt>
<dd><p>Character vector of the names of matrices that must have
their values stored at every iteration of the simulation loop. For example,
a matrix that the user does not want to be returned but that impacts dynamics
with a time lag must be saved and therefore in this list.</p></dd>


<dt>must_not_save</dt>
<dd><p>Character vector of the names of matrices that must
not have their values stored at every iteration of the simulation loop. For
example, the user may ask to return a very large matrix that would create
performance issues if stored at each iteration. The creator of the model
can mark such matrices making it impossible for the user of the model to
save their full simulation history.</p></dd>


<dt>sim_exprs</dt>
<dd><p>Character vector of the names of <code>before</code>,
<code>during</code>, and <code>after</code> expressions that must only be evaluated
when simulations are being produced and not when the objective function is
being evaluated. For example, expressions that generate stochasticity should
be listed in <code>sim_exprs</code> because TMB objective functions must be
continuous.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    

<p>A new model spec object with updated and/or inserted information.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">si</span> <span class="op">=</span> <span class="fu"><a href="mp_tmb_library.html">mp_tmb_library</a></span><span class="op">(</span><span class="st">"starter_models"</span>, <span class="st">"si"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Update the mixing process to include </span></span></span>
<span class="r-in"><span><span class="co">## optional phenomenological heterogeneity.</span></span></span>
<span class="r-in"><span><span class="co">## We need mp_tmb_update here so that </span></span></span>
<span class="r-in"><span><span class="co">## the previous infection expression is</span></span></span>
<span class="r-in"><span><span class="co">## overwritten.</span></span></span>
<span class="r-in"><span><span class="fu">mp_tmb_update</span><span class="op">(</span><span class="va">si</span>, phase <span class="op">=</span> <span class="st">"during"</span></span></span>
<span class="r-in"><span>  , at <span class="op">=</span> <span class="fl">1</span></span></span>
<span class="r-in"><span>  , expressions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">infection</span> <span class="op">~</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">*</span> <span class="op">(</span><span class="va">S</span><span class="op">/</span><span class="va">N</span><span class="op">)</span><span class="op">^</span><span class="va">zeta</span><span class="op">)</span></span></span>
<span class="r-in"><span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>zeta <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---------------------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Default values:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---------------------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  matrix row col value</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       N         100.0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    beta           0.2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       I           1.0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    zeta           1.0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---------------------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Before the simulation loop (t = 0):</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---------------------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1: S ~ N - I</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---------------------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> At every iteration of the simulation loop (t = 1 to T):</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---------------------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1: infection ~ beta * I * (S/N)^zeta</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2: S ~ S - infection</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3: I ~ I + infection</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## Parameterize with log_beta in place of beta.</span></span></span>
<span class="r-in"><span><span class="co">## We need mp_tmb_insert here so that the</span></span></span>
<span class="r-in"><span><span class="co">## existing expression for computing the initial</span></span></span>
<span class="r-in"><span><span class="co">## number of susceptible indiviudals is not</span></span></span>
<span class="r-in"><span><span class="co">## overwritten.</span></span></span>
<span class="r-in"><span><span class="fu">mp_tmb_insert</span><span class="op">(</span><span class="va">si</span>, phase <span class="op">=</span> <span class="st">"before"</span></span></span>
<span class="r-in"><span>  , at <span class="op">=</span> <span class="fl">1</span></span></span>
<span class="r-in"><span>  , expressions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">beta</span> <span class="op">~</span> <span class="fu"><a href="engine_functions.html">exp</a></span><span class="op">(</span><span class="va">log_beta</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>log_beta <span class="op">=</span> <span class="fu"><a href="engine_functions.html">log</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---------------------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Default values:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---------------------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    matrix row col       value</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         N         100.0000000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      beta           0.2000000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         I           1.0000000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>  log_beta          -0.6931472</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---------------------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Before the simulation loop (t = 0):</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---------------------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1: beta ~ exp(log_beta)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2: S ~ N - I</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---------------------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> At every iteration of the simulation loop (t = 1 to T):</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ---------------------</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1: infection ~ beta * S * I/N</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2: S ~ S - infection</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3: I ~ I + infection</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p></p><p>Developed by Steve Walker, Weiguang Guan, Ben Bolker, Jen Freeman, Darren Flynn-Primrose.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer></div>

  

  

  </body></html>

