<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Create TMB Model Specification — mp_tmb_model_spec • macpan2</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Create TMB Model Specification — mp_tmb_model_spec"><meta name="description" content='Specify a simulation model in the TMB engine. A detailed explanation of this
function is covered in vignette("quickstart").'><meta property="og:description" content='Specify a simulation model in the TMB engine. A detailed explanation of this
function is covered in vignette("quickstart").'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous"><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.5.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/quickstart.html">Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/example_models.html">Example Models</a></li>
    <li><a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a></li>
    <li><a class="dropdown-item" href="../articles/real_data.html">Fitting to Real Data</a></li>
    <li><a class="dropdown-item" href="../articles/options.html">Options</a></li>
    <li><a class="dropdown-item" href="../articles/FAQs.html">FAQs</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Create TMB Model Specification</h1>
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/main/R/mp_tmb_model_spec.R" class="external-link"><code>R/mp_tmb_model_spec.R</code></a></small>
      <div class="d-none name"><code>mp_tmb_model_spec.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Specify a simulation model in the TMB engine. A detailed explanation of this
function is covered in <code><a href="../articles/quickstart.html">vignette("quickstart")</a></code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">mp_tmb_model_spec</span><span class="op">(</span></span>
<span>  before <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  during <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  after <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  inits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  integers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  must_save <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  must_not_save <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  sim_exprs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  state_update <span class="op">=</span> <span class="fu"><a href="engine_functions.html">c</a></span><span class="op">(</span><span class="st">"euler"</span>, <span class="st">"rk4"</span>, <span class="st">"discrete_stoch"</span>, <span class="st">"hazard"</span>, <span class="st">"rk4_old"</span>,</span>
<span>    <span class="st">"euler_multinomial"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-before">before<a class="anchor" aria-label="anchor" href="#arg-before"></a></dt>
<dd><p>List of formulas to be evaluated (in the order provided)
before the simulation loop begins. These formulas must be standard
two-sided R <code><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></code> objects. See <code>details</code> below for the
rules for these formulas.</p></dd>


<dt id="arg-during">during<a class="anchor" aria-label="anchor" href="#arg-during"></a></dt>
<dd><p>List of formulas or calls to flow functions (e.g.,
<code><a href="mp_per_capita_flow.html">mp_per_capita_flow</a></code>) to be evaluated at every iteration of the
simulation loop.</p></dd>


<dt id="arg-after">after<a class="anchor" aria-label="anchor" href="#arg-after"></a></dt>
<dd><p>List of formulas to be evaluated (in the order provided)
before the simulation loop begins. These formulas must be standard
two-sided R <code><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></code> objects. See <code>details</code> below for the
rules for these formulas.</p></dd>


<dt id="arg-default">default<a class="anchor" aria-label="anchor" href="#arg-default"></a></dt>
<dd><p>Named list of objects, each of which can be coerced into
a <code><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></code> <code><a href="engine_functions.html">matrix</a></code>. The names refer to
quantities that appear in <code>before</code>, <code>during</code>, and <code>after</code>.
Each quantity that is used in <code>before</code>, <code>during</code>, or <code>after</code>
before it is defined must be given a numerical value in this <code>default</code>
list.</p></dd>


<dt id="arg-inits">inits<a class="anchor" aria-label="anchor" href="#arg-inits"></a></dt>
<dd><p>Named list of initial values of state variables.  These
initial values can be added to the <code>default</code> list with identical results,
but adding them to <code>inits</code> is better practice because it makes it clear
that they are initial values that will change as the state updates.</p></dd>


<dt id="arg-integers">integers<a class="anchor" aria-label="anchor" href="#arg-integers"></a></dt>
<dd><p>Named list of vectors that can be coerced to integer
vectors. These integer vectors can be used by name in model formulas to
provide indexing of matrices and as grouping factors in
<code><a href="engine_functions.html">group_sums</a></code>.</p></dd>


<dt id="arg-must-save">must_save<a class="anchor" aria-label="anchor" href="#arg-must-save"></a></dt>
<dd><p>Character vector of the names of variables that must have
their values stored at every iteration of the simulation loop. For example,
a variable that you do not want to be returned, but that impacts
dynamics with a time lag, must be saved and therefore must be in this list.</p></dd>


<dt id="arg-must-not-save">must_not_save<a class="anchor" aria-label="anchor" href="#arg-must-not-save"></a></dt>
<dd><p>Character vector of the names of variables that must
not have their values stored at every iteration of the simulation loop. For
example, the user may ask to return a very large matrix that would create
performance issues if stored at each iteration. The creator of the model
can mark such variables making it impossible for the user of the model to
save their full simulation history.</p></dd>


<dt id="arg-sim-exprs">sim_exprs<a class="anchor" aria-label="anchor" href="#arg-sim-exprs"></a></dt>
<dd><p>Character vector of the names of <code>before</code>,
<code>during</code>, and <code>after</code> expressions that must only be evaluated
when simulations are being produced and not when the objective function is
being evaluated. For example, expressions that generate stochasticity should
be listed in <code>sim_exprs</code> because TMB objective functions must be
continuous.</p></dd>


<dt id="arg-state-update">state_update<a class="anchor" aria-label="anchor" href="#arg-state-update"></a></dt>
<dd><p>Optional character vector for how to update the state
variables when it is relevant. Options include <code>"euler"</code> (the default),
<code>"rk4"</code>, and <code>"discrete_stoch"</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Expressions in the <code>before</code>, <code>during</code>, and <code>after</code> lists can be standard
R <code><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula</a></code> objects for defining variables in the model. These
formulas must have a left hand side that gives the name of the (possibly
matrix-valued) variable being updated, and a right hand side giving an
expression containing only (1) the names of quantities in the model, (2)
numerical literals (e.g., <code>3.14</code>), or (3) functions defined in the TMB
engine (described in <code><a href="engine_functions.html">engine_functions</a></code>). For example, the
expression <code>N ~ S + I + R</code> updates the value of <code>N</code> to be the sum of the
variables <code>S</code>, <code>I</code>, and <code>R</code>.</p>
<p>Names can be provided for the components of the <code>before</code>, <code>during</code>, and
<code>after</code> lists, and these names do not have to be unique. These names are
used by the <code>sim_exprs</code> argument.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co">## A simple SI model.</span></span></span>
<span class="r-in"><span><span class="va">spec</span> <span class="op">=</span> <span class="fu">mp_tmb_model_spec</span><span class="op">(</span></span></span>
<span class="r-in"><span>    during <span class="op">=</span> <span class="fu"><a href="mp_per_capita_flow.html">mp_per_capita_flow</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"beta * I / N"</span>, <span class="st">"infection"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, S <span class="op">=</span> <span class="fl">99</span>, I <span class="op">=</span> <span class="fl">1</span>, beta <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">spec</span> </span></span>
<span class="r-in"><span>  <span class="op">|&gt;</span> <span class="fu"><a href="mp_simulator.html">mp_simulator</a></span><span class="op">(</span>time_steps <span class="op">=</span> <span class="fl">5L</span>, output <span class="op">=</span> <span class="st">"infection"</span><span class="op">)</span> </span></span>
<span class="r-in"><span>  <span class="op">|&gt;</span> <span class="fu"><a href="mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      matrix time row col     value</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 infection    1   0   0 0.1980000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 infection    2   0   0 0.2367296</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 infection    3   0   0 0.2828290</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4 infection    4   0   0 0.3376117</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 infection    5   0   0 0.4025866</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## The `~` can be used for flexibly defining dynamical variables.</span></span></span>
<span class="r-in"><span><span class="va">spec2</span> <span class="op">=</span> <span class="fu">mp_tmb_model_spec</span><span class="op">(</span></span></span>
<span class="r-in"><span>    during <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>          <span class="va">force_of_infection</span> <span class="op">~</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span></span></span>
<span class="r-in"><span>        , <span class="fu"><a href="mp_per_capita_flow.html">mp_per_capita_flow</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"force_of_infection"</span>, <span class="st">"infection"</span><span class="op">)</span></span></span>
<span class="r-in"><span>    <span class="op">)</span></span></span>
<span class="r-in"><span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, S <span class="op">=</span> <span class="fl">99</span>, I <span class="op">=</span> <span class="fl">1</span>, beta <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">spec2</span></span></span>
<span class="r-in"><span>  <span class="op">|&gt;</span> <span class="fu"><a href="mp_simulator.html">mp_simulator</a></span><span class="op">(</span>time_steps <span class="op">=</span> <span class="fl">5L</span>, output <span class="op">=</span> <span class="st">"force_of_infection"</span><span class="op">)</span> </span></span>
<span class="r-in"><span>  <span class="op">|&gt;</span> <span class="fu"><a href="mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>               matrix time row col       value</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 force_of_infection    1   0   0 0.002000000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 force_of_infection    2   0   0 0.002396000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 force_of_infection    3   0   0 0.002869459</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4 force_of_infection    4   0   0 0.003435117</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 force_of_infection    5   0   0 0.004110341</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## The `before` argument can be used to pre-compute quantities before</span></span></span>
<span class="r-in"><span><span class="co">## the simulation loop begins. Here we compute `S` from `N` and `I`,</span></span></span>
<span class="r-in"><span><span class="co">## instead of specifying `S` in the `default` list. The potential</span></span></span>
<span class="r-in"><span><span class="co">## benefit here is that one could make `I` a parameter to be fitted,</span></span></span>
<span class="r-in"><span><span class="co">## while ensuring consistent values for `S`.</span></span></span>
<span class="r-in"><span><span class="va">spec3</span> <span class="op">=</span> <span class="fu">mp_tmb_model_spec</span><span class="op">(</span></span></span>
<span class="r-in"><span>    before <span class="op">=</span> <span class="va">S</span> <span class="op">~</span> <span class="va">N</span> <span class="op">-</span> <span class="va">I</span></span></span>
<span class="r-in"><span>  , during <span class="op">=</span> <span class="fu"><a href="mp_per_capita_flow.html">mp_per_capita_flow</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"beta * I / N"</span>, <span class="st">"infection"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100</span>, I <span class="op">=</span> <span class="fl">1</span>, beta <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">spec3</span> </span></span>
<span class="r-in"><span>  <span class="op">|&gt;</span> <span class="fu"><a href="mp_simulator.html">mp_simulator</a></span><span class="op">(</span>time_steps <span class="op">=</span> <span class="fl">5L</span>, output <span class="op">=</span> <span class="st">"infection"</span><span class="op">)</span> </span></span>
<span class="r-in"><span>  <span class="op">|&gt;</span> <span class="fu"><a href="mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      matrix time row col     value</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 1 infection    1   0   0 0.1980000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 2 infection    2   0   0 0.2367296</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 3 infection    3   0   0 0.2828290</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 4 infection    4   0   0 0.3376117</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 5 infection    5   0   0 0.4025866</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Walker, Weiguang Guan, Jen Freeman, Ben Bolker, Darren Flynn-Primrose.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

