<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Optimize Simulation Model — mp_optimize • macpan2</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Optimize Simulation Model — mp_optimize"><meta name="description" content="Calibrate a model that has been parameterized, typically by using
mp_tmb_calibrator to produce such a model."><meta property="og:description" content="Calibrate a model that has been parameterized, typically by using
mp_tmb_calibrator to produce such a model."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.16.8</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/quickstart.html">Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/example_models.html">Example Models</a></li>
    <li><a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a></li>
    <li><a class="dropdown-item" href="../articles/real_data.html">Fitting to Real Data</a></li>
    <li><a class="dropdown-item" href="../articles/state_updaters.html">ODE Solvers, Process Error, and Difference Equations</a></li>
    <li><a class="dropdown-item" href="../articles/options.html">Options</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Optimize Simulation Model</h1>
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/main/R/mp_tmb_calibrator.R" class="external-link"><code>R/mp_tmb_calibrator.R</code></a></small>
      <div class="d-none name"><code>mp_optimize.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Calibrate a model that has been parameterized, typically by using
<code><a href="mp_tmb_calibrator.html">mp_tmb_calibrator</a></code> to produce such a model.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">mp_optimize</span><span class="op">(</span><span class="va">model</span>, <span class="va">optimizer</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'TMBCalibrator'</span></span>
<span><span class="fu">mp_optimize</span><span class="op">(</span></span>
<span>  <span class="va">model</span>,</span>
<span>  optimizer <span class="op">=</span> <span class="fu"><a href="engine_functions.html">c</a></span><span class="op">(</span><span class="st">"nlminb"</span>, <span class="st">"optim"</span>, <span class="st">"DEoptim"</span>, <span class="st">"optimize"</span>, <span class="st">"optimise"</span><span class="op">)</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-model">model<a class="anchor" aria-label="anchor" href="#arg-model"></a></dt>
<dd><p>A model object capable of being optimized. Typically
this object will be produced using <code><a href="mp_tmb_calibrator.html">mp_tmb_calibrator</a></code>.</p></dd>


<dt id="arg-optimizer">optimizer<a class="anchor" aria-label="anchor" href="#arg-optimizer"></a></dt>
<dd><p>Name of an implemented optimizer. See below for the
options and details on using each option.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Arguments to pass to the <code>optimizer</code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>The output of the <code>optimizer</code>. The <code>model</code> object is modified
and saves the history of optimization outputs. These outputs can be
obtained using <code><a href="mp_optimizer_output.html">mp_optimizer_output</a></code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The <code><a href="mp_tmb_calibrator.html">mp_tmb_calibrator</a></code> models that get passed to
<code>mp_optimize</code> will remember both their original default parameters
set at the time the model was created, and their currently best
parameters that get the updated when <code>mp_optimize</code> is run. The
optimization is started from the currently best parameter set.
Therefore, if you find yourself in a local minimum you might need
to either recreate the model using <code><a href="mp_tmb_calibrator.html">mp_tmb_calibrator</a></code>
or use <code>optimizer = "DEoptim"</code>, which is more robust to objective
functions with multiple optima.</p>
    </div>
    <div class="section level2">
    <h2 id="methods-by-class-">Methods (by class)<a class="anchor" aria-label="anchor" href="#methods-by-class-"></a></h2>

<ul><li><p><code>mp_optimize(TMBCalibrator)</code>: Optimize a TMB calibrator.</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="details-on-using-each-type-of-optimizer">Details on Using Each Type of Optimizer<a class="anchor" aria-label="anchor" href="#details-on-using-each-type-of-optimizer"></a></h2>

<div class="section">
<h3 id="nlminb"><code>nlminb</code><a class="anchor" aria-label="anchor" href="#nlminb"></a></h3>


<p>The default optimizer is <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></code>. This optimizer uses
gradients computed by the
<a href="https://kaskr.github.io/adcomp/_book/Introduction.html" class="external-link">Template Model Builder</a>
engine of <code>macpan2</code>. This optimizer is efficient at local optimization
by exploiting the gradient information computed by automatic differentiation.
However, like many nonlinear optimizers, it can struggle if the objective function has multiple optima.</p>
<p>To set control parameters (e.g., maximum number of iterations), you
can use the <code>control</code> argument:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">mp_optimize</span>(model, <span class="st">"nlminb"</span>, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">iter.max =</span> <span class="dv">800</span>))</span></code></pre><p></p></div>
<p>See the <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></code> help page for the complete list of
control parameters and what the output means.</p>
</div>

<div class="section">
<h3 id="optim"><code>optim</code><a class="anchor" aria-label="anchor" href="#optim"></a></h3>


<p>The <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></code> optimizer lets you choose from a variety
of optimization algorithms. The default, <code>method = "Nelder-Mead"</code>,
does not use second derivatives
(compare with the description of <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></code>), and so
could be less efficient at taking each step. However, we
find that it can be somewhat better at getting out of local optima,
although the <code>"DEoptim"</code> optimizer is designed for objective functions
with multiple optima (see description below).</p>
<p>To set control parameters (e.g., maximum number of iterations), one
may use the following.</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">mp_optimize</span>(model, <span class="st">"nlminb"</span>, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">maxit =</span> <span class="dv">800</span>))</span></code></pre><p></p></div>
<p>See the <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></code> help page for the complete list of
control parameters and what the output means.</p>
<p>If your model is parameterized by only a single parameter,
you'll get a warning asking you to use 'method = "Brent"' or optimizer = 'optimize()'.
You can ignore this warning if you are happy with your
answer, or can do either of the suggested options as follows.</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">mp_optimize</span>(model, <span class="st">"optim"</span>, <span class="at">method =</span> <span class="st">"Brent"</span>, <span class="at">lower =</span> <span class="dv">0</span>, <span class="at">upper =</span> <span class="fl">1.2</span>)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">mp_optimize</span>(model, <span class="st">"optimize"</span>, <span class="at">interval =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.2</span>))</span></code></pre><p></p></div>
<p>In this case you have to specify lower and upper bounds for the optimization.</p>
</div>

<div class="section">
<h3 id="deoptim"><code>DEoptim</code><a class="anchor" aria-label="anchor" href="#deoptim"></a></h3>


<p>The <code>DEoptim</code> optimizer comes from the <code>DEoptim</code> package;
you'll need to have that package installed to use this option.
It is designed for objective functions with multiple optima. Use
this method if you do not believe the fit you get by other methods.
The downsides of this method are that it doesn't use gradient
information and evaluates the objective function at many different
points, so is likely to be much slower than gradient-based optimizers
such as the default <code>nlminb</code> optimizer, or <code>optim</code> with <code>method = "BFGS"</code>.</p>
<p>Because this optimizer starts from multiple points in the parameter
space, you need to specify lower and upper bounds for each parameter
in the parameter vector.</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">mp_optimize</span>(model, <span class="st">"DEoptim"</span>, <span class="at">lower =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>), <span class="at">upper =</span> <span class="fu">c</span>(<span class="fl">1.2</span>, <span class="fl">1.2</span>))</span></code></pre><p></p></div>
<p>In this example we have two parameters, and therefore need
to specify two values each for <code>lower</code> and <code>upper</code></p>
</div>

<div class="section">
<h3 id="optimize-and-optimise"><code>optimize</code> and <code>optimise</code><a class="anchor" aria-label="anchor" href="#optimize-and-optimise"></a></h3>


<p>This optimizer can only be used for models parameterized with a single
parameter. You need to specify lower and upper bounds, e.g.</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">mp_optimize</span>(model, <span class="st">"optimize"</span>, <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">1.2</span>))</span></code></pre><p></p></div>
</div>

    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">spec</span> <span class="op">=</span> <span class="op">(</span><span class="st">"starter_models"</span></span></span>
<span class="r-in"><span>  <span class="op">|&gt;</span> <span class="fu"><a href="mp_tmb_library.html">mp_tmb_library</a></span><span class="op">(</span><span class="st">"seir"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">|&gt;</span> <span class="fu"><a href="mp_tmb_insert.html">mp_tmb_update</a></span><span class="op">(</span>default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">sim</span> <span class="op">=</span> <span class="fu"><a href="mp_simulator.html">mp_simulator</a></span><span class="op">(</span><span class="va">spec</span>, <span class="fl">50</span>, <span class="st">"infection"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## simulate data to fit to, but remove the start of the</span></span></span>
<span class="r-in"><span><span class="co">## simulated epidemic in order to make it more difficult</span></span></span>
<span class="r-in"><span><span class="co">## to fit.</span></span></span>
<span class="r-in"><span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">data</span> <span class="op">=</span> <span class="va">data</span><span class="op">[</span><span class="va">data</span><span class="op">$</span><span class="va">time</span> <span class="op">&gt;</span> <span class="fl">24</span>, <span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">data</span><span class="op">$</span><span class="va">time</span> <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">time</span> <span class="op">-</span> <span class="fl">24</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## time scale object that accounts for the true starting time</span></span></span>
<span class="r-in"><span><span class="co">## of the epidemic (in this example we are not trying to estimate</span></span></span>
<span class="r-in"><span><span class="co">## the initial number infected, so the starting time strongly</span></span></span>
<span class="r-in"><span><span class="co">## affects the fitting procedure)</span></span></span>
<span class="r-in"><span><span class="va">time</span> <span class="op">=</span> <span class="fu"><a href="mp_sim_offset.html">mp_sim_offset</a></span><span class="op">(</span><span class="fl">24</span>, <span class="fl">0</span>, <span class="st">"steps"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## model calibrator, estimating only the transmission parameter</span></span></span>
<span class="r-in"><span><span class="va">cal</span> <span class="op">=</span> <span class="fu"><a href="mp_tmb_calibrator.html">mp_tmb_calibrator</a></span><span class="op">(</span><span class="va">spec</span></span></span>
<span class="r-in"><span>  , data <span class="op">=</span> <span class="va">data</span></span></span>
<span class="r-in"><span>  , traj <span class="op">=</span> <span class="st">"infection"</span></span></span>
<span class="r-in"><span>  , par <span class="op">=</span> <span class="st">"beta"</span></span></span>
<span class="r-in"><span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span>  , time <span class="op">=</span> <span class="va">time</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## From the starting point at beta = 1 this takes us into a</span></span></span>
<span class="r-in"><span><span class="co">## local optimum at beta = 0.13, far from the true value of beta = 0.6.</span></span></span>
<span class="r-in"><span><span class="fu">mp_optimize</span><span class="op">(</span><span class="va">cal</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> outer mgc:  107.7808 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> outer mgc:  144.4986 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> outer mgc:  53.9732 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> outer mgc:  2.861121 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> outer mgc:  0.01056093 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> outer mgc:  1.460927e-07 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> outer mgc:  1.612044e-13 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $par</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    params </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.1274977 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $objective</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 15.81868</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $convergence</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $iterations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 7</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $evaluations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> function gradient </span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        8        7 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $message</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "both X-convergence and relative convergence (5)"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## In this case, one-dimensional optimization finds the true value.</span></span></span>
<span class="r-in"><span><span class="fu">mp_optimize</span><span class="op">(</span><span class="va">cal</span>, <span class="st">"optimize"</span>, <span class="fu"><a href="engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $minimum</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.5999964</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $objective</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 8.23869</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Walker, Weiguang Guan, Jen Freeman, Ben Bolker, Darren Flynn-Primrose.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

