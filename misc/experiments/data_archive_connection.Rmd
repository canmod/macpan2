---
title: "Fitting to Data in the International Infectious Disease Data Archive (IIDDA)"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Quickstart}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Setup

```{r installation, message=FALSE}
if (!require(iidda.api)) {
  install.packages("iidda.api", repos = c("https://canmod.r-universe.dev", "https://cran.r-project.org"))
}
```

```{r other_packages, message=FALSE}
library(macpan2)
library(dplyr)
library(ggplot2)
```

```{r api_hook}
api_hook = iidda.api::ops_staging
options(iidda_api_msgs = FALSE, macpan2_verbose = FALSE)
```


## One Scarlet Fever Outbreak in Ontario

```{r scarlet_fever_ontario}
scarlet_fever_ontario = api_hook$filter(resource_type = "CANMOD CDI"
  , iso_3166 = "CA"
  , iso_3166_2 = "CA-ON"
  , time_scale = "wk"
  , disease = "scarlet-fever"
  , period_end_date = "1929-08-01/1930-10-01"
)
print(scarlet_fever_ontario)
```

```{r scarlet_fever_ontario_plot, fig.width=7}
(scarlet_fever_ontario
  |> ggplot(aes(period_mid_date, cases_this_period))
  + geom_line() + geom_point()
  + ggtitle("Scarlet Fever Incidence in Ontario, Canada")
  + theme_bw()
)
```


## SIR Model

```{r}
sir = mp_tmb_library("starter_models", "sir", package = "macpan2")
print(sir)
```


Extract an estimate of the population of Ontario from the IIDDA dataset.
```{r}
N = median(scarlet_fever_ontario$population)
print(N)
```

TODO: Fit to longer time series that requires changing `N`, which we have as data.

```{r}
sir_simulator = mp_simulator(sir
  , time_steps = nrow(scarlet_fever_ontario)
  , outputs = "infection"
  , default = list(N = N, beta = 0.35, I = 10000)
)
print(sir_simulator)
head(mp_trajectory(sir_simulator))
```

## Observed Data Format

TODO: use this format below because it is closer to how it should be.

```{r}
observed_data = (scarlet_fever_ontario
  |> select(period_end_date, cases_this_period)
  |> mutate(matrix = "reports")
  |> rename(value = cases_this_period)
  |> mutate(time = seq_along(period_end_date))
)
print(head(observed_data))
```


## Modify Model for Reality

Change the population size to the population of Ontario at the time.

```{r}
sir = mp_tmb_insert(sir
  , default = list(N = median(scarlet_fever_ontario$population))
)
```

Modify the model to include under-reporting.

```{r}
sir = mp_tmb_insert(sir
  , phase = "during"
  , at = Inf
  , expressions = list(reports ~ infection * report_prob)
  , default = list(report_prob = 1/300)
)
```

The model has been modified.

```{r}
print(sir)
```


## Set up the Optimizer

```{r}
sir_cal = mp_tmb_calibrator(
    spec = sir
  , data = observed_data
  , traj = "reports"
  , par = c("gamma", "beta", "I", "report_prob")
  , outputs = "reports"
)
```


## Run the Optimization

```{r}
sir_opt = mp_optimize(sir_cal, "nlminb")
```



## Examine the fit

Note convergence ... etc...

```{r}
print(sir_opt)
```

Parameter estimates ...

```{r}
mp_tmb_coef(sir_cal, conf.int = TRUE)
```

Fitted trajectory ...

```{r, fig.width=7}
observed_data$fit = mp_trajectory_se(sir_cal, conf.int = TRUE)$value ## TODO: ugly
(ggplot(observed_data)
  + geom_line(aes(period_end_date, fit))
  + geom_point(aes(period_end_date, value))
  + theme_bw()
)
```


