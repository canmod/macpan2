---
title: "Quickstart Guide: specifying and simulating a simple compartmental model"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Quickstart Guide: specifying and simulating a simple compartmental model}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

[![status](https://img.shields.io/badge/status-stub-red)](https://canmod.github.io/macpan2/articles/vignette-status#stub)

```{r setup, echo = FALSE}
library(macpan2)
```


# Motivation/nomenclature

- goal is to teach a user how models are specified in `macpan2` via a familiar and simple model
- `macpan2`'s model specification is extremely flexible, which is also what can make it difficult to learn to work with at first

- unstructured model = a pure epidemic compartmental model, where each state is only denoted using a disease status (_e.g._ $S$ = susceptible, $I$ = infected, etc.)
- structured model = an epidemic model **crossed** with something else, like locations to generate a meta-population model or age groups to generate an age-stratified model

- while the model specification may seem like overkill for a simple model, we will demonstrate later how tthe model specification can be used to quickly and efficiently generate a complicated, structured model by expanding a simple model

# A simple, unstructured model

We will start with the SIR model, which is the simplest epidemic model that is routinely used as a basis for much more complicated epidemic models. The SIR model is generally cast as a system of ordinary differential equations:

\begin{align}
\frac{dS}{dt} &= -\beta S(t) I(t) \\ 
\frac{dI}{dt} &= \beta S(t) I(t) - \gamma I(t) \\ 
\frac{dR}{dt} &= \gamma I(t)
\label{eqn:SIR-ode}
\end{align}

However, it will be more useful to think of the SIR model in terms of a system of difference equations as that is how we will simulate it with `macpan2`:

\begin{align}
S_{t+1} &= -\beta S_t I_t \\ 
I_{t+1} &= \beta S_t I_t - \gamma I_t \\ 
R_{t+1} &= \gamma I_t
\label{eqn:SIR-difference}
\end{align}

Most flows in SIR-type compartmental models are of the form $rX$ where $r$ is a flow and $X$ is the name of the "from" compartment, that is the compartment from which the flow originates. We call the rates $r$ in such terms **flow rates**, and we could re-cast (\ref{eqn:SIR-difference}) to be purely in terms of flow rates, by setting $\lambda = \beta I_t$:

\begin{align}
S_{t+1} &= -\lambda S_t \\ 
I_{t+1} &= \lambda S_t - \gamma I_t \\ 
R_{t+1} &= \gamma I_t
\label{eqn:SIR-difference}
\end{align}

Now the model is stated purely in terms of the **flow rates** $\lambda$ and $\gamma$.^[In epidemic modelling, $\lambda$ is chosen suggestively as it models the [force of infection](https://en.wikipedia.org/wiki/Force_of_infection) denoted by the same character.] 

However, $\lambda$ is special from a simulation standpoint as it depends on a state variable ($I_t$), so it must be recomputed at every step of the simulation (unlike $\gamma$, which is generally fixed and chosen by the modeller when specifying the model). $\lambda$ also depends on $\beta$, which we call an **influence rate** as it is involved in a term 

In order to specify a model, we must first decide on the labels we will use for model components. For the SIR model (and most compartmental models), these components will be:

- **States**: Names of the compartments.
- **Flow rates**: Names of rates used in flow expressions of the form $rX$, where $r$ is the rate and $X$ is the "from" state---the state from which the flow originates. In the SIR model above, these would be $\gamma$ and $\lambda$.
- **Influence rates**: Names of rates used in flow expressions that additionally include a state other than the "from" state, such as (but not limited to) those of the form $rYX$, where $r$ is the influence rate, $X$ is the "from" state and $Y$ is the "to" state. In the SIR model above, $\beta$ would be an influence rate.

The distinction between flow and influence rates is not always made when working with compartmental epidemic models (_i.e._ $\beta$ is sometimes called a flow rate), but flow and influence rates are processed differently in `macpan2` for the purpose of simulating the model, and so we must also make this distinction when specifying the model.

For the SIR model, the labels (_indices_) are generated as follows:

```{r}
state = mp_index(Epi = c("S", "I", "R"))
flow_rates = mp_index(Epi = c("lambda", "gamma"))
influence_rates = mp_index(Epi = "beta")
```

We start by 

```{r}
state
```

```{r model-working}
expr_list = mp_expr_list(
  before = list(
    ## aggregations
      N ~ sum(state)
  ),
  during = list(
    ## influences
      flow_rates[infection_flow] ~
        state[infectious_state] * influence_rates[transmission] / N

    ## flows
    , flows_per_time ~ state[from] * flow_rates[edge]

    ## state update
    , total_inflow ~ groupSums(flows_per_time, to, state)
    , total_outflow ~ groupSums(flows_per_time, from, state)
    , state ~ state + total_inflow - total_outflow
  )
)

## basic model indexes -------------------------

state = mp_index(Epi = c("S", "I", "R"))
# flow_rates = mp_index(Epi = c("lambda", "gamma", "beta"))
flow_rates = mp_index(Epi = c("lambda", "gamma"))
influence_rates = mp_index(Epi = "beta")

## subset indexes -----------------

S      = mp_subset(state, Epi = "S")
I      = mp_subset(state, Epi = "I")
R      = mp_subset(state, Epi = "R")
lambda = mp_subset(flow_rates, Epi = "lambda")
gamma  = mp_subset(flow_rates, Epi = "gamma")
beta   = mp_subset(influence_rates, Epi = "beta")
# beta   = mp_subset(flow_rates, Epi = "beta")

## links between entries in the indexes -----------

# flows_per_time ~ state[from] * flow_rates[edge]
infection = mp_join(from = S, to = I, edge = lambda)
recovery  = mp_join(from = I, to = R, edge = gamma)

# flow_rates[infection_flow] ~
#         state[infectious_state] * influence_rates[transmission] / N
transmission =  mp_join(
  infectious_state = I,
  infection_flow = lambda,
  transmission = beta
)

link_data = list(
    influences = mp_link_data(transmission)
  , flows = mp_link_data(infection, recovery)
)

## Initialize indexed vectors (to all zeros) --------------

init_vecs = list(
  state = mp_vector(state),
  flow_rates = mp_vector(flow_rates),
  influence_rates = mp_vector(influence_rates)
)

## Final output -----------------

dynamic_model = DynamicModel(
  expr_list = expr_list,
  link_data = link_data,
  init_vecs = init_vecs,
  unstruc_mats = list()
)

sir_sim = mp_tmb_simulator(dynamic_model
  , vectors = list(
      state = c(S = 999, I = 1, R = 0),
      flow_rates = c(lambda = NA, gamma = 0.1),
      influence_rates = c(beta = 0.25)
    )
  , time_steps = 100L
)

mp_report(sir_sim)
```

```{r model-edited}
expr_list = mp_expr_list(
  before = list(
    ## aggregations
      N ~ sum(state)
  ),
  during = list(
    ## influences
      flow_rates[infection_flow] ~
        state[infectious_state] * flow_rates[transmission] / N

    ## flows
    , flows_per_time ~ state[from] * flow_rates[edge]

    ## state update
    , total_inflow ~ groupSums(flows_per_time, to, state)
    , total_outflow ~ groupSums(flows_per_time, from, state)
    , state ~ state + total_inflow - total_outflow
  )
)

## basic model indexes -------------------------

state = mp_index(Epi = c("S", "I", "R"))
flow_rates = mp_index(Epi = c("lambda", "gamma", "beta"))
# flow_rates = mp_index(Epi = c("lambda", "gamma"))
# influence_rates = mp_index(Epi = "beta")

## subset indexes -----------------

S      = mp_subset(state, Epi = "S")
I      = mp_subset(state, Epi = "I")
R      = mp_subset(state, Epi = "R")
lambda = mp_subset(flow_rates, Epi = "lambda")
gamma  = mp_subset(flow_rates, Epi = "gamma")
# beta   = mp_subset(influence_rates, Epi = "beta")
beta   = mp_subset(flow_rates, Epi = "beta")

## links between entries in the indexes -----------

# flows_per_time ~ state[from] * flow_rates[edge]
infection = mp_join(from = S, to = I, edge = lambda)
recovery  = mp_join(from = I, to = R, edge = gamma)

# flow_rates[infection_flow] ~
#         state[infectious_state] * influence_rates[transmission] / N
transmission =  mp_join(
  infectious_state = I,
  infection_flow = lambda,
  transmission = beta
)

# IP: what is this for?
link_data = list(
    influences = mp_link_data(transmission)
  , flows = mp_link_data(infection, recovery)
)

## Initialize indexed vectors (to all zeros) --------------

init_vecs = list(
  state = mp_vector(state),
  flow_rates = mp_vector(flow_rates)
)

## Final output -----------------

dynamic_model = DynamicModel(
  expr_list = expr_list,
  link_data = link_data,
  init_vecs = init_vecs,
  unstruc_mats = list()
)

sir_sim = mp_tmb_simulator(dynamic_model
  , vectors = list(
      state = c(S = 999, I = 1, R = 0),
      flow_rates = c(lambda = NA, gamma = 0.1, beta = 0.25)
    )
  , time_steps = 100L
)

mp_report(sir_sim)
```

