<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="macpan2">
<title>Specifying Time-Varying Parameters • macpan2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Specifying Time-Varying Parameters">
<meta property="og:description" content="macpan2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.5.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/quickstart.html">Quickstart</a>
    <a class="dropdown-item" href="../articles/example_models.html">Example Models</a>
    <a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a>
    <a class="dropdown-item" href="../articles/real_data.html">Fitting to Real Data</a>
    <a class="dropdown-item" href="../articles/state_updaters.html">ODE Solvers, Process Error, and Difference Equations</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Specifying Time-Varying Parameters</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/HEAD/vignettes/time_varying_parameters.Rmd" class="external-link"><code>vignettes/time_varying_parameters.Rmd</code></a></small>
      <div class="d-none name"><code>time_varying_parameters.Rmd</code></div>
    </div>

    
    
<p><a href="https://canmod.github.io/macpan2/articles/vignette-status#working-draft"><img src="https://img.shields.io/badge/status-working%20draft-red" alt="status"></a></p>
<div class="section level2">
<h2 id="baseline-sir-model">Baseline SIR Model<a class="anchor" aria-label="anchor" href="#baseline-sir-model"></a>
</h2>
<p>Here we modify an <a href="https://github.com/canmod/macpan2/tree/main/inst/starter_models/sir" class="external-link">SIR</a>
model so that transmission rate is time-varying.</p>
<p>We initialize a vector of state labels and parameter default values
for convenience and specify a simulation time of 50 time steps.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state_labels</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span><span class="op">)</span></span>
<span><span class="va">time_steps</span> <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="va">beta</span> <span class="op">=</span> <span class="fl">0.8</span> <span class="co"># per-capita transmission rate</span></span>
<span><span class="va">gamma</span> <span class="op">=</span> <span class="fl">0.2</span> <span class="co"># per-capita recovery rate</span></span></code></pre></div>
<p>Using a fixed transmission rate of 0.8 we visualize the baseline SIR
dynamics.
<img src="time_varying_parameters_files/figure-html/baseline_sir-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="piecewise-time-variation">Piecewise Time Variation<a class="anchor" aria-label="anchor" href="#piecewise-time-variation"></a>
</h2>
<p>To create a piecewise time-varying transmission rate, we need to
specify two variables:</p>
<ol style="list-style-type: decimal">
<li>
<code>beta_changepoints</code> - An integer vector containing the
starting time steps at which the tranmission rate <code>beta</code>
changes. This vector starts with a time step of 0 because we want to
specify an initial default value of <code>beta</code> followed by
changing transmission rates at the beginning of time-step 10 and 15</li>
<li>
<code>beta_values</code> A numeric vector containing the values
<code>beta</code> takes at each time step specified in
<code>beta_changepoints</code>.</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">beta_changepoints</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">beta_values</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.01</span>, <span class="fl">0.4</span><span class="op">)</span></span></code></pre></div>
<p>We then need to specify an expression that updates <code>beta</code>
to <code>beta_values</code> at the time steps in
<code>beta_changepoints</code>. To do this we use the <a href="https://canmod.github.io/macpan2/reference/engine_functions.html#time-indexing"><code>time_step</code></a>
function to get the current time step for each iteration in the loop. We
specify a time lag of 0 from the current time step with
<code>time_step(0)</code> because we want the value of the current time
step.</p>
<p>We then use the <a href="https://canmod.github.io/macpan2/reference/engine_functions.html#time-indexing"><code>time_var</code></a>
function that will return a value for <code>beta</code>, from
<code>beta_values</code>, by comparing the current time step with the
time steps in <code>beta_changepoints</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># see ?time_var for arguments</span></span>
<span><span class="va">expr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span> <span class="co">#beta ~ time_var(beta_values, beta_changepoints, time_step(1))</span></span>
<span> <span class="va">beta</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">time_var</a></span><span class="op">(</span><span class="va">beta_values</span>, <span class="va">beta_changepoints</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Let’s test that <code>time_var</code> is computing what we want for
20 time steps.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/simple_sims.html">simple_sims</a></span><span class="op">(</span></span>
<span>    iteration_exprs <span class="op">=</span> <span class="va">expr</span></span>
<span>  , time_steps <span class="op">=</span> <span class="fl">20</span></span>
<span>  </span>
<span>  <span class="co"># for integer vectors (usually indexing vectors) use `int_vecs`</span></span>
<span>  , int_vecs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta_changepoints <span class="op">=</span> <span class="va">beta_changepoints</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># for numeric vectors (model defaults) use `mats`</span></span>
<span>  <span class="co"># we need to initialize beta because it is a variable in our model</span></span>
<span>  <span class="co"># so we set to 0.8 - at the beginning of the simulation loop (time_step==1)</span></span>
<span>  <span class="co"># beta gets updated so the initial value of beta has no effect in this case</span></span>
<span>  , mats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      beta <span class="op">=</span> <span class="va">beta</span></span>
<span>    , beta_values <span class="op">=</span> <span class="va">beta_values</span><span class="op">)</span></span>
<span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span> <span class="op">==</span> <span class="st">"beta"</span><span class="op">)</span></span>
<span><span class="co">#&gt;    matrix time row col value</span></span>
<span><span class="co">#&gt; 1    beta    1   0   0  0.80</span></span>
<span><span class="co">#&gt; 2    beta    2   0   0  0.80</span></span>
<span><span class="co">#&gt; 3    beta    3   0   0  0.80</span></span>
<span><span class="co">#&gt; 4    beta    4   0   0  0.80</span></span>
<span><span class="co">#&gt; 5    beta    5   0   0  0.80</span></span>
<span><span class="co">#&gt; 6    beta    6   0   0  0.80</span></span>
<span><span class="co">#&gt; 7    beta    7   0   0  0.80</span></span>
<span><span class="co">#&gt; 8    beta    8   0   0  0.80</span></span>
<span><span class="co">#&gt; 9    beta    9   0   0  0.80</span></span>
<span><span class="co">#&gt; 10   beta   10   0   0  0.01</span></span>
<span><span class="co">#&gt; 11   beta   11   0   0  0.01</span></span>
<span><span class="co">#&gt; 12   beta   12   0   0  0.01</span></span>
<span><span class="co">#&gt; 13   beta   13   0   0  0.01</span></span>
<span><span class="co">#&gt; 14   beta   14   0   0  0.01</span></span>
<span><span class="co">#&gt; 15   beta   15   0   0  0.40</span></span>
<span><span class="co">#&gt; 16   beta   16   0   0  0.40</span></span>
<span><span class="co">#&gt; 17   beta   17   0   0  0.40</span></span>
<span><span class="co">#&gt; 18   beta   18   0   0  0.40</span></span>
<span><span class="co">#&gt; 19   beta   19   0   0  0.40</span></span>
<span><span class="co">#&gt; 20   beta   20   0   0  0.40</span></span></code></pre></div>
<p>Now that we know our expression is updating <code>beta</code>
correctly, we can modify the SIR model to include this piece-wise
transmission rate.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">piecewise_spec</span> <span class="op">=</span> <span class="op">(</span><span class="st">"starter_models"</span></span>
<span>  <span class="co"># read in model from library                    </span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_tmb_library.html">mp_tmb_library</a></span><span class="op">(</span><span class="st">"sir"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span></span>
<span>  <span class="co"># insert expression for updating beta at the beginning of the simulation loop</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_tmb_insert.html">mp_tmb_insert</a></span><span class="op">(</span></span>
<span>      phase<span class="op">=</span><span class="st">"during"</span></span>
<span>    , at<span class="op">=</span><span class="fl">1L</span></span>
<span>    , expressions <span class="op">=</span> <span class="va">expr</span></span>
<span>    , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        beta <span class="op">=</span> <span class="va">beta</span> <span class="co"># note this value doesnt not effect life</span></span>
<span>      , gamma <span class="op">=</span> <span class="va">gamma</span></span>
<span>      , beta_values <span class="op">=</span> <span class="va">beta_values</span></span>
<span>      <span class="op">)</span></span>
<span>    , integers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta_changepoints <span class="op">=</span> <span class="va">beta_changepoints</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">piecewise_spec</span><span class="op">)</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Default values:</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt;       matrix row col value</span></span>
<span><span class="co">#&gt;         beta         8e-01</span></span>
<span><span class="co">#&gt;        gamma         2e-01</span></span>
<span><span class="co">#&gt;            N         1e+02</span></span>
<span><span class="co">#&gt;            I         1e+00</span></span>
<span><span class="co">#&gt;            R         0e+00</span></span>
<span><span class="co">#&gt;  beta_values   0     8e-01</span></span>
<span><span class="co">#&gt;  beta_values   1     1e-02</span></span>
<span><span class="co">#&gt;  beta_values   2     4e-01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: S ~ N - I - R</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to T):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: beta ~ time_var(beta_values, beta_changepoints)</span></span>
<span><span class="co">#&gt; 2: infection ~ S * I * beta/N</span></span>
<span><span class="co">#&gt; 3: recovery ~ gamma * I</span></span>
<span><span class="co">#&gt; 4: S ~ S - infection</span></span>
<span><span class="co">#&gt; 5: I ~ I + infection - recovery</span></span>
<span><span class="co">#&gt; 6: R ~ R + recovery</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">piecewise_simulator</span> <span class="op">=</span> <span class="op">(</span><span class="va">piecewise_spec</span></span>
<span>   <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span>time_steps <span class="op">=</span> <span class="va">time_steps</span>, outputs<span class="op">=</span><span class="va">state_labels</span><span class="op">)</span></span>
<span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we plot the updated simulations using these change-points, which
we highlight with vertical lines.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># simulated data from model</span></span>
<span><span class="va">sim_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="va">piecewise_simulator</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">sim_data</span></span>
<span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">matrix</span>, <span class="va">state_labels</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span>, colour <span class="op">=</span> <span class="va">state</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">x</span><span class="op">)</span>,</span>
<span>    linetype <span class="op">=</span> <span class="st">"dashed"</span>,</span>
<span>    alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">beta_changepoints</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/time_varying_graph-1.png" width="576"></p>
<p>The clear kinks at times 10 and 15 are due the drop and then lift of
the transmission rate at these times.</p>
<!-- Not clear yet why trajectories are shifted by one time step, i think my expression is in the right place-->
</div>
<div class="section level2">
<h2 id="calibrating-time-variation-parameters">Calibrating Time Variation Parameters<a class="anchor" aria-label="anchor" href="#calibrating-time-variation-parameters"></a>
</h2>
<p>First we simulate data to fit our model to, to see if we can recover
the time-varying parameters.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">I_observed</span> <span class="op">=</span> <span class="op">(</span><span class="va">sim_data</span></span>
<span>              <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span><span class="op">==</span><span class="st">"I"</span><span class="op">)</span></span>
<span>              <span class="co"># add some noise</span></span>
<span>              <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rpois</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,<span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">I_observed</span><span class="op">$</span><span class="va">time</span>, <span class="va">I_observed</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/noisy_data-1.png" width="576"></p>
<!-- think I want to log transform -->
<p>We often want to include parameter constraints in our models, and one
way to do this implicitly is to transform the parameters <span class="citation">(<a href="#ref-bolker2008">Bolker 2008</a>)</span>.
Further, transformations can sometimes help when estimating parameters
by making the “likelihood surface closer to quadratic” and reducing
parameter correlation <span class="citation">(<a href="#ref-bolker2008">Bolker 2008</a>)</span>. Here we log-transform
<span class="math inline">\(\beta\)</span> because our constraint is
that <span class="math inline">\(\beta\)</span> must be positive and the
domain of the logarithm is <span class="math inline">\((0,
\infty)\)</span>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># need to insert transformation</span></span>
<span><span class="co"># not this simple, need to log transform beta_values</span></span>
<span><span class="va">transformed_spec</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_insert.html">mp_tmb_insert</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">piecewise_spec</span></span>
<span>  , phase <span class="op">=</span> <span class="st">"before"</span></span>
<span>  , at <span class="op">=</span> <span class="fl">1</span></span>
<span>  , expressions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">beta_values</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="va">log_beta_values</span><span class="op">)</span><span class="op">)</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>log_beta_values <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">log</a></span><span class="op">(</span><span class="va">beta_values</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">transformed_spec</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Default values:</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt;           matrix row col       value</span></span>
<span><span class="co">#&gt;             beta           0.8000000</span></span>
<span><span class="co">#&gt;            gamma           0.2000000</span></span>
<span><span class="co">#&gt;                N         100.0000000</span></span>
<span><span class="co">#&gt;                I           1.0000000</span></span>
<span><span class="co">#&gt;                R           0.0000000</span></span>
<span><span class="co">#&gt;      beta_values   0       0.8000000</span></span>
<span><span class="co">#&gt;      beta_values   1       0.0100000</span></span>
<span><span class="co">#&gt;      beta_values   2       0.4000000</span></span>
<span><span class="co">#&gt;  log_beta_values   0      -0.2231436</span></span>
<span><span class="co">#&gt;  log_beta_values   1      -4.6051702</span></span>
<span><span class="co">#&gt;  log_beta_values   2      -0.9162907</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: beta_values ~ exp(log_beta_values)</span></span>
<span><span class="co">#&gt; 2: S ~ N - I - R</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to T):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: beta ~ time_var(beta_values, beta_changepoints)</span></span>
<span><span class="co">#&gt; 2: infection ~ S * I * beta/N</span></span>
<span><span class="co">#&gt; 3: recovery ~ gamma * I</span></span>
<span><span class="co">#&gt; 4: S ~ S - infection</span></span>
<span><span class="co">#&gt; 5: I ~ I + infection - recovery</span></span>
<span><span class="co">#&gt; 6: R ~ R + recovery</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span></span>
<span><span class="co"># piecewise_calib = mp_tmb_calibrator(</span></span>
<span><span class="co">#     spec = transformed_spec</span></span>
<span><span class="co">#   , data = I_observed</span></span>
<span><span class="co">#   , traj = "I"</span></span>
<span><span class="co">#   , par = "log_beta_values"</span></span>
<span><span class="co">#   # can we actully estimate a vector of betas, or only one beta</span></span>
<span><span class="co">#   #, tv = "beta"</span></span>
<span><span class="co">#   , outputs = state_labels</span></span>
<span><span class="co">#   # we don't need to update any defaults in</span></span>
<span><span class="co">#   # `spec`</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># )</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># mp_optimize(piecewise_calib)</span></span>
<span><span class="co"># # if (piecewise_calib$optimization_history$get()[[1L]]$convergence  != 0) {</span></span>
<span><span class="co"># #   stop("time-varying optimization example is no longer converging")</span></span>
<span><span class="co"># # }</span></span>
<span><span class="co"># # # looking at coefficients and CIs</span></span>
<span><span class="co"># # # we need to back transform to interpret</span></span>
<span><span class="co"># cc &lt;- (mp_tmb_coef(piecewise_calib, conf.int=TRUE)</span></span>
<span><span class="co">#         |&gt; backtrans()</span></span>
<span><span class="co"># )</span></span>
<span><span class="co"># cc</span></span>
<span><span class="co"># beta_values</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># the old way of calibrating</span></span>
<span><span class="va">transformed_sim</span> <span class="op">=</span> <span class="va">transformed_spec</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span>time_steps <span class="op">=</span> <span class="va">time_steps</span>, outputs <span class="op">=</span> <span class="va">state_labels</span><span class="op">)</span></span>
<span></span>
<span><span class="va">default_beta</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">transformed_sim</span><span class="op">$</span><span class="va">get</span><span class="op">$</span><span class="fu">initial</span><span class="op">(</span><span class="st">"beta_values"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">params_to_fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    mat <span class="op">=</span> <span class="st">"log_beta_values"</span></span>
<span>  , row <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">2</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">log</a></span><span class="op">(</span><span class="va">default_beta</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">transformed_sim</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">params_frame</span><span class="op">(</span><span class="va">params_to_fit</span><span class="op">)</span></span>
<span><span class="va">transformed_sim</span><span class="op">$</span><span class="va">optimize</span><span class="op">$</span><span class="fu">nlminb</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; outer mgc:  0</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;     params     params     params </span></span>
<span><span class="co">#&gt; -0.9079919 -0.9079919 -0.9079919 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;        1        1 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "relative convergence (4)"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="radial-basis-functions-for-flexible-time-variation-in-progress">Radial Basis Functions for Flexible Time Variation
(In-Progress)<a class="anchor" aria-label="anchor" href="#radial-basis-functions-for-flexible-time-variation-in-progress"></a>
</h2>
<p>This section uses radial basis functions (RBFs) to generate models
with a flexible functional form for smooth changes in the transmission
rate.</p>
<p>Before we can add the fancy radial basis for the transmission rate,
we need a base model. We use an SIR model that has been modified to
include waning.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_waning</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_library.html">mp_tmb_library</a></span><span class="op">(</span><span class="st">"starter_models"</span></span>
<span>  , <span class="st">"sir_waning"</span></span>
<span>  , package <span class="op">=</span> <span class="st">"macpan2"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/rbf.html">macpan2::rbf</a></code> function can be used to produce a
matrix giving the values of each basis function (each column) at each
time step (each row). Using this matrix, <span class="math inline">\(X\)</span>, and a weights vector, <span class="math inline">\(b\)</span>, we can get a flexible output vector,
<span class="math inline">\(y\)</span>, with a shape that can be
modified by changing the weights vector.</p>
<p><span class="math display">\[
y = Xb
\]</span></p>
<p>The following code illustrates this approach.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="va">n</span> <span class="op">=</span> <span class="fl">2500</span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="../reference/rbf.html">rbf</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="va">d</span>, sd <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  , mar <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">X</span></span>
<span>  , type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="fl">1</span></span>
<span>  , ylab <span class="op">=</span> <span class="st">"basis functions"</span></span>
<span>  , axes <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span>side <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/box.html" class="external-link">box</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">b</span></span>
<span>  , xlab <span class="op">=</span> <span class="st">""</span></span>
<span>  , ylab <span class="op">=</span> <span class="st">"weights"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b</span></span>
<span>  , type <span class="op">=</span> <span class="st">"l"</span></span>
<span>  , xlab <span class="op">=</span> <span class="st">"time"</span></span>
<span>  , ylab <span class="op">=</span> <span class="st">"output"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/unnamed-chunk-2-1.png" width="576"></p>
<p>Here <code>d</code> is the dimension of the basis, or number of
functions, and <code>n</code> is the number of time steps. By
multiplying the uniform basis matrix (top panel) by a set of weights
(middle panel), we obtain a non-uniform curve (bottom panel). Note how
the peaks (troughs) in the output are associated with large positive
(negative) weights.</p>
<p>Now we want to transform the output of the (matrix) product of the
RBF matrix and the weights vector into a time-series for the
transmission rate, <span class="math inline">\(\beta\)</span>. Although
we could just use the output vector as the <span class="math inline">\(\beta\)</span> time series, it is more convenient
to transform it so that the <span class="math inline">\(\beta\)</span>
values yield more interesting dynamics in an SIR model. In particular,
our model for <span class="math inline">\(\beta_t\)</span> as a function
of time, <span class="math inline">\(t\)</span>, is</p>
<p><span class="math display">\[
\log(\beta_t) = \log(\gamma_t) + \log(N) - \log(S_t) + x_tb
\]</span></p>
<p>Here we have the recovery rate, <span class="math inline">\(\gamma_t\)</span>, and number of susceptibles,
<span class="math inline">\(S_t\)</span>, at time, <span class="math inline">\(t\)</span>, the total population, <span class="math inline">\(N\)</span>, and the <span class="math inline">\(t\)</span>th row of <span class="math inline">\(X\)</span>, <span class="math inline">\(x_t\)</span>. To better understand the rationale
for this equation note that if every element of <span class="math inline">\(b\)</span> is set to zero, we have the following
condition.</p>
<p><span class="math display">\[
\frac{\beta_t S_t}{N} = \gamma_t
\]</span></p>
<p>This condition assures that the number of infected individuals
remains constant at time, <span class="math inline">\(t\)</span>. This
means that positive values of <span class="math inline">\(b\)</span>
will tend to generate outbreaks and negative values will tend to reduce
transmission.</p>
<p><strong>fixme</strong>: I (BMB) understand why you’re setting the
model up this way, but it’s an odd/non-standard setup - may confuse
people who are already familiar with epidemic models (it confused me
initially).</p>
<p>Here is a simulation model with a radial basis for exogenous
transmission rate dynamics.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">simulator</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span><span class="va">sir_waning</span></span>
<span>  , time_steps <span class="op">=</span> <span class="va">n</span></span>
<span>  , outputs <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>, <span class="st">"infection"</span>, <span class="st">"beta"</span><span class="op">)</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      N <span class="op">=</span> <span class="fl">100000</span>, I <span class="op">=</span> <span class="fl">500</span>, R <span class="op">=</span> <span class="fl">0</span></span>
<span>    , beta <span class="op">=</span> <span class="fl">1</span>, gamma <span class="op">=</span> <span class="fl">0.2</span>, phi <span class="op">=</span> <span class="fl">0.01</span></span>
<span>    , X <span class="op">=</span> <span class="fu"><a href="../reference/rbf.html">rbf</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span><span class="op">)</span></span>
<span>    , b <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="va">d</span>, sd <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">eta</span> <span class="op">~</span> <span class="va">gamma</span> <span class="op">*</span> <span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"before"</span></span>
<span>  , .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">beta</span> <span class="op">~</span> <span class="va">eta</span><span class="op">[</span><span class="fu"><a href="../reference/engine_functions.html">time_step</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="../reference/engine_functions.html">clamp</a></span><span class="op">(</span><span class="va">S</span><span class="op">/</span><span class="va">N</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span>  , .at <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span></span>
<span>    eta <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">params</span><span class="op">(</span></span>
<span>    default <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="va">d</span>, sd <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>  , mat <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="va">d</span><span class="op">)</span></span>
<span>  , row <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1L</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">)</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: S ~ N - I - R</span></span>
<span><span class="co">#&gt; 2: eta ~ gamma * exp(X %*% b)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to 2500):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: beta ~ eta[time_step(1)]/clamp(S/N, 1/100)</span></span>
<span><span class="co">#&gt; 2: infection ~ S * I * beta/N</span></span>
<span><span class="co">#&gt; 3: recovery ~ gamma * I</span></span>
<span><span class="co">#&gt; 4: waning_immunity ~ phi * R</span></span>
<span><span class="co">#&gt; 5: S ~ S - infection + waning_immunity</span></span>
<span><span class="co">#&gt; 6: I ~ I + infection - recovery</span></span>
<span><span class="co">#&gt; 7: R ~ R + recovery - waning_immunity</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">simulator</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">matrix</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span></span>
<span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/plot_rbf-1.png" width="576"></p>
<div class="section level3">
<h3 id="calibration">Calibration<a class="anchor" aria-label="anchor" href="#calibration"></a>
</h3>
<p>Now we’re going to calibrate this model to data. The main innovation
here is that we will use a built-in feature of <a href="https://cran.r-project.org/package=TMB" class="external-link">TMB</a> (on which
<code>macpan2</code> is constructed), estimation of latent variables by
<a href="https://en.wikipedia.org/wiki/Laplace%27s_approximation" class="external-link">Laplace
approximation</a> to fit the time series efficiently without overfitting
(see section 5.10 of <span class="citation">Madsen and Thyregod (<a href="#ref-madsenIntroduction2011">2011</a>)</span>, <span class="citation">Kristensen et al. (<a href="#ref-kristensenTMB2016">2016</a>)</span>, or the <a href="https://kaskr.github.io/adcomp/_book/Tutorial.html#statistical-modelling" class="external-link">TMB
documentation</a> for more detail).</p>
<p>The next few steps will roughly follow the first example in the <a href="./calibration.html">Calibration</a> vignette: TODO: make sure to
line this state up with the specific code in the calibration
vignette.</p>
<p>1. Simulate from the model and add some noise:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs_I</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">simulator</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span> <span class="op">==</span> <span class="st">"I"</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="va">value</span>, <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">.</span>, sd <span class="op">=</span> <span class="fl">50</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">obs_I</span>, xlab <span class="op">=</span> <span class="st">"time"</span>, ylab <span class="op">=</span> <span class="st">"prevalence"</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/noisy_sim-1.png" width="576"></p>
<p>2. Add calibration information.</p>
<p>We start by adding standard boilerplate stuff to include the observed
data and store/return the results.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## copied from 'calibration/"hello world"' example</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span></span>
<span>    I_obs <span class="op">=</span> <span class="va">obs_I</span></span>
<span>  , I_sim <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>  , log_lik <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>  , .mats_to_save <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"I_sim"</span><span class="op">)</span></span>
<span>  , .mats_to_return <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"I_sim"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>     <span class="va">I_sim</span> <span class="op">~</span> <span class="va">I</span></span>
<span>   , .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span>   , .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we start to deviate from the previous example: in addition to a
parameter (<code>I_sd</code>) for the standard deviation of the noise in
<span class="math inline">\(I\)</span>, we also add a parameter
(<code>rbf_sd</code>) for the variance of the RBF coefficients, and
penalize the likelihood using</p>
<p><span class="math display">\[
\begin{split}
I_{\textrm{obs}} &amp; \sim \textrm{Normal}(I_\textrm{sim}(\phi,
{\mathbf b}), \sigma^2_I) \\
b_i &amp; \sim \textrm{Normal}(0, \sigma^2_{\textrm{rbf}})
\end{split}
\]</span> and the likelihood is defined as: <span class="math display">\[
\int {\cal L}(I_{\textrm{obs}}|\phi, {\mathbf b}', \sigma^2_I) \cdot
{\cal L}({\mathbf b}'|\sigma^2_{\textrm{rbf}}) \, d{\mathbf b}.
\]</span></p>
<p>The <span class="math inline">\(\phi\)</span> vector is a set of
<em>fixed-effect</em> (unpenalized) parameters; in this case it is
empty, but it could include (for example) time-constant recovery or
immune-waning rates, or a baseline transmission rate (see note below).
(The fixed-effect parameter is usually denoted as <span class="math inline">\(\beta\)</span> in statistical models, but we’ve
already used that symbol for the transmission coefficient …)</p>
<p>Although this looks awful, (1) the high-dimensional integral over
<span class="math inline">\(\mathbf b\)</span> can be separated into a
product of one-dimensional integrals and (2) the Laplace approximation
gives us a quick, reasonable approximation to the one-dimensional
integrals.</p>
<p>The <code>rbf_sd</code> parameter can be interpreted as a standard
deviation on a Gaussian random effect or as approximately <span class="math inline">\(1/\sqrt{\lambda}\)</span> where <span class="math inline">\(\lambda\)</span> is a ridge penalty.</p>
<p>Continuing with the coding, we add the parameters and negative
log-likelihood to the model, making the negative log-likelihood a
<em>sum</em> of the two terms in the integral above: the NLL of the data
(<code>-sum(dnorm(I_obs, ...))</code>) and the likelihood of the RBF
parameters (<code>-sum(dnorm(b, ...))</code>): we fit both of the SD
parameters on the log scale.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span></span>
<span>    I_sd <span class="op">=</span> <span class="fl">1</span></span>
<span>  , rbf_sd <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>     <span class="va">log_lik</span> <span class="op">~</span> </span>
<span>       <span class="op">-</span><span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">dnorm</a></span><span class="op">(</span><span class="va">I_obs</span>, <span class="fu"><a href="../reference/engine_functions.html">rbind_time</a></span><span class="op">(</span><span class="va">I_sim</span><span class="op">)</span>, <span class="va">I_sd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>       <span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">dnorm</a></span><span class="op">(</span><span class="va">b</span>, <span class="fl">0.0</span>, <span class="va">rbf_sd</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     .phase <span class="op">=</span> <span class="st">"after"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## initially forgot this: maybe we could warn when someone is missing this????</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">obj_fn</span><span class="op">(</span><span class="op">~</span> <span class="va">log_lik</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">transformations</span><span class="op">(</span><span class="fu"><a href="../reference/Transform.html">Log</a></span><span class="op">(</span><span class="st">"I_sd"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">transformations</span><span class="op">(</span><span class="fu"><a href="../reference/Transform.html">Log</a></span><span class="op">(</span><span class="st">"rbf_sd"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## not sure if this is required?</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.delim</a></span><span class="op">(</span>sep <span class="op">=</span> <span class="st">"|"</span>, header <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     strip.white <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co">## important!</span></span>
<span>                      text <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">mat         | default</span></span>
<span><span class="st">log_I_sd    | 0</span></span>
<span><span class="st">log_rbf_sd  | 1</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">params_frame</span><span class="op">(</span><span class="va">params</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we add the <code>b</code> vector as a set of <em>random</em>
parameters: this tells <code>macpan2</code> to apply the Laplace
approximation to these parameters …</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">matrix_version</span> <span class="op">=</span> <span class="st">"1.6-5"</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"Matrix"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">matrix_version</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">rparams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      mat  <span class="op">=</span> <span class="st">"b"</span>,</span>
<span>      row <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">19</span>,</span>
<span>      col <span class="op">=</span> <span class="fl">0</span>,</span>
<span>      default <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">random_frame</span><span class="op">(</span><span class="va">rparams</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Test the objective function:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"Matrix"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">matrix_version</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">simulator</span><span class="op">$</span><span class="fu">ad_fun</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">fn</span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Optimizing tape... Done</span></span>
<span><span class="co">#&gt; iter: 1  value: 5994496 mgc: 2058657968 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 1327494 mgc: 1334286157 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 539106 mgc: 359174176 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 4  value: 461675.4 mgc: 72820581 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 5  value: 458020.4 mgc: 9231141 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 6  value: 457980.9 mgc: 605743.9 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 7  value: 457980.9 mgc: 7692.96 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 8  value: 457980.9 mgc: 2.548907 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 9  value: 457980.9 mgc: 9.201847e-06 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 9.53875e-06</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 458152.8</span></span>
<span><span class="co">#&gt; attr(,"logarithm")</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre>
<p><strong>fixme</strong>: can’t get objective function to shut up.
Should have specified <code>silent = TRUE</code> when calling
<code>MakeADFun()</code> initially, now have tried assigning the value
in several different environments, without success …</p>
<p>This step normally produces lots of output (more output than a model
with random effects) because the Laplace approximation involves an
additional “inner” step where the <code>b</code> parameters are
optimized, even though we are only evaluating the objective for a single
set of fixed parameters (<code>log_I_sd</code>,
<code>log_rbf_sd</code>)</p>
<p><strong>fixme</strong>: note to developers, if we cache results we
may need to call the <code>$retape()</code> function to restore internal
structure when retrieving …</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"Matrix"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">matrix_version</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## testing: simulator$ad_fun()$fn()</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">simulator</span><span class="op">$</span><span class="va">optimize</span><span class="op">$</span><span class="fu">nlminb</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"Matrix"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">matrix_version</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co">## simulator$print$matrix_dims()</span></span>
<span>  <span class="co">## fixed effects only:</span></span>
<span>  <span class="co">## look at parameters, but skip the random-effects parameters</span></span>
<span>  <span class="co">## 'random' holds the indices of the parameters that are treated</span></span>
<span>  <span class="co">## as random effects</span></span>
<span>  <span class="op">(</span><span class="va">fixed_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="fu">ad_fun</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">env</span>,</span>
<span>                        <span class="va">last.par.best</span><span class="op">[</span><span class="op">-</span><span class="va">random</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">## ???</span></span>
<span>  <span class="co">## RE only</span></span>
<span>  <span class="op">(</span><span class="va">ran_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="fu">ad_fun</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">env</span>,</span>
<span>                      <span class="va">last.par.best</span><span class="op">[</span><span class="va">random</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt;        random        random        random        random        random </span></span>
<span><span class="co">#&gt;  0.0067466350  0.0116662413 -0.0036351505 -0.0151989880  0.0011403827 </span></span>
<span><span class="co">#&gt;        random        random        random        random        random </span></span>
<span><span class="co">#&gt;  0.0032615158 -0.0028962068 -0.0146686471 -0.0058110019  0.0073568463 </span></span>
<span><span class="co">#&gt;        random        random        random        random        random </span></span>
<span><span class="co">#&gt;  0.0097221102  0.0023726453  0.0007574901  0.0014761570 -0.0134865091 </span></span>
<span><span class="co">#&gt;        random        random        random        random        random </span></span>
<span><span class="co">#&gt; -0.0068787221 -0.0025147741  0.0027382985  0.0086679247  0.0033013692</span></span></code></pre></div>
<p><strong>fixme</strong>: we need an incantation to extract the full
parameters (including RE parameters) in order to make sure
<code>$report</code> works properly? (In general, should caution about
mutability/make sure we use <code>last.par.best</code> internally …)</p>
<p>Extract parameters, run the simulator for the best-fit parameters,
compare with data …</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"Matrix"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">matrix_version</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pp</span> <span class="op">&lt;-</span> <span class="va">simulator</span><span class="op">$</span><span class="fu">ad_fun</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par.best</span>  <span class="co">## FIXME: use this</span></span>
<span>  <span class="va">est_I</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">simulator</span></span>
<span>      <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span> <span class="op">==</span> <span class="st">"I"</span><span class="op">)</span></span>
<span>      <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>las <span class="op">=</span> <span class="fl">1</span>, bty <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">obs_I</span>, xlab <span class="op">=</span> <span class="st">"time"</span>, ylab <span class="op">=</span> <span class="st">"prevalence"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">est_I</span>, col <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/plot_sim-1.png" width="576"></p>
<p><strong>fixme</strong>: there are a few artificialities about this
example that could/should be relaxed</p>
<ul>
<li>the only fixed parameters are the standard deviations. Normally we
would also be estimating <code>gamma</code> (possibly with a prior? do
we have any examples, say in the calibration vignette, of adding
priors?)</li>
<li>the RBF function is penalized to zero. In general, we should augment
the penalized RBF component (which determines the variation around the
mean) with an unpenalized intercept/baseline transmission parameter. So,
for example, the transmission rate should be computed as
<code>b0 + exp(X %*% b)</code>, where <code>b0</code> represents an
unpenalized parameter that’s allowed to vary freely …</li>
</ul>
<p><strong>fixme</strong>: compare (1) unpenalized fit; (2) penalized
fit without Laplace approximation …</p>
<p><strong>fixme</strong>: discuss (somewhere) alternate bases for
latent variables (random-walk, Gaussian process, …)</p>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-bolker2008" class="csl-entry">
Bolker, Benjamin M. 2008. <em>Ecological Models and Data in r</em>.
Princeton: Princeton University Press. <a href="https://doi.org/doi:10.1515/9781400840908" class="external-link">https://doi.org/doi:10.1515/9781400840908</a>.
</div>
<div id="ref-kristensenTMB2016" class="csl-entry">
Kristensen, Kasper, Anders Nielsen, Casper W. Berg, Hans Skaug, and
Bradley M. Bell. 2016. <span>“<span>TMB</span>: Automatic
Differentiation and <span>Laplace</span> Approximation.”</span>
<em>Journal of Statistical Software</em> 70 (5). <a href="https://doi.org/10.18637/jss.v070.i05" class="external-link">https://doi.org/10.18637/jss.v070.i05</a>.
</div>
<div id="ref-madsenIntroduction2011" class="csl-entry">
Madsen, Henrik, and Poul Thyregod. 2011. <em>Introduction to General and
Generalized Linear Models</em>. CRC Press.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Walker, Weiguang Guan, Ben Bolker, Jen Freeman, Darren Flynn-Primrose.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
