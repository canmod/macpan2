<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="macpan2">
<title>Specifying Time-Varying Parameters • macpan2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Specifying Time-Varying Parameters">
<meta property="og:description" content="macpan2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/quickstart.html">Quickstart Guide: specifying and simulating a simple compartmental model</a>
    <a class="dropdown-item" href="../articles/quickstart2.html">Quickstart Guide, part 2: specifying and simulating a structured compartmental model</a>
    <a class="dropdown-item" href="../articles/time_varying_parameters.html">Specifying Time-Varying Parameters</a>
    <a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a>
    <a class="dropdown-item" href="../articles/example_models.html">Example Models</a>
    <a class="dropdown-item" href="../articles/flow_types.html">Flow Types</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Specifying Time-Varying Parameters</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/HEAD/vignettes/time_varying_parameters.Rmd" class="external-link"><code>vignettes/time_varying_parameters.Rmd</code></a></small>
      <div class="d-none name"><code>time_varying_parameters.Rmd</code></div>
    </div>

    
    
<p><a href="https://canmod.github.io/macpan2/articles/vignette-status#working-draft"><img src="https://img.shields.io/badge/status-working%20draft-red" alt="status"></a></p>
<div class="section level2">
<h2 id="baseline-sir-model">Baseline SIR Model<a class="anchor" aria-label="anchor" href="#baseline-sir-model"></a>
</h2>
<p>Here we modify an <a href="https://canmod.github.io/macpan2/articles/quickstart">SIR</a>
model so that transmission rate is time-varying.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir</span> <span class="op">=</span> <span class="fu"><a href="../reference/Compartmental.html">Compartmental</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"starter_models"</span>, <span class="st">"sir"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simulator</span> <span class="op">=</span> <span class="va">sir</span><span class="op">$</span><span class="va">simulators</span><span class="op">$</span><span class="fu">tmb</span><span class="op">(</span>time_steps <span class="op">=</span> <span class="fl">50</span></span>
<span>  , state <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">99</span>, I <span class="op">=</span> <span class="fl">1</span>, R <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  , flow <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>foi <span class="op">=</span> <span class="cn">NA</span>, gamma <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span>  , N <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>  , beta <span class="op">=</span> <span class="fl">0.8</span></span>
<span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span>.phases <span class="op">=</span> <span class="st">"during"</span><span class="op">)</span></span>
<span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>state <span class="op">=</span> <span class="va">row</span><span class="op">)</span></span>
<span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">sir</span><span class="op">$</span><span class="va">labels</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span>, colour <span class="op">=</span> <span class="va">state</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/baseline_sir-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="piecewise-time-variation">Piecewise Time Variation<a class="anchor" aria-label="anchor" href="#piecewise-time-variation"></a>
</h2>
<p>We now change the value of the transmission rate, <code>beta</code>,
at the beginning of time-step 10 and 15. In the first step we add to the
simulator a vector containing these change-points.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span>beta_changepoints <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">15</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next we add the values to which <code>beta</code> changes at these
time-steps.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span>beta_values <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.01</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We also need a variable to track the current value of
<code>beta</code>. This <code>beta_pointer</code> starts at time-step
equal to 0, and it will be incremented throughout the simulation.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span>beta_pointer <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>We increment <code>beta_pointer</code> using the <a href="https://canmod.github.io/macpan2/reference/engine_functions.html#time-indexing"><code>time_group</code>
function</a> that returns either <code>beta_pointer</code> or
<code>beta_pointer + 1</code> depending on whether or not the current
time-step is at a change-point in <code>beta_changepoints</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">beta_pointer</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">time_group</a></span><span class="op">(</span><span class="va">beta_pointer</span>, <span class="va">beta_changepoints</span><span class="op">)</span>, </span>
<span>    .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We update <code>beta</code> at every iteration of the simulation loop
using this <code>beta_pointer</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>  <span class="va">beta</span> <span class="op">~</span> <span class="va">beta_values</span><span class="op">[</span><span class="va">beta_pointer</span><span class="op">]</span>,</span>
<span>  .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>And that’s it. Now we plot the updated simulations using these
change-points, which we highlight with vertical lines.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">=</span> <span class="va">simulator</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span>.phases <span class="op">=</span> <span class="st">"during"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">s</span></span>
<span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>state <span class="op">=</span> <span class="va">row</span><span class="op">)</span></span>
<span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">state</span>, <span class="va">sir</span><span class="op">$</span><span class="va">labels</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span>, colour <span class="op">=</span> <span class="va">state</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">x</span><span class="op">)</span>, </span>
<span>    linetype <span class="op">=</span> <span class="st">"dashed"</span>, </span>
<span>    alpha <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">simulator</span><span class="op">$</span><span class="va">get</span><span class="op">$</span><span class="fu">initial</span><span class="op">(</span><span class="st">"beta_changepoints"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/time_varying_graph-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="calibrating-time-variation-parameters">Calibrating Time Variation Parameters<a class="anchor" aria-label="anchor" href="#calibrating-time-variation-parameters"></a>
</h2>
<p>First we simulate data to fit our model to, to see if we can recover
the time-varying parameters.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">I_observed</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rpois</a></span><span class="op">(</span></span>
<span>  <span class="fl">50</span>, </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">matrix</span> <span class="op">==</span> <span class="st">"state"</span>, <span class="va">row</span> <span class="op">==</span> <span class="st">"I"</span><span class="op">)</span><span class="op">$</span><span class="va">value</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">I_observed</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/noisy_data-1.png" width="700"></p>
<p>Then we add a few matrices to the model for keeping tracking of
information used in model fitting.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span></span>
<span>  </span>
<span>  <span class="co">## observed data</span></span>
<span>  I_obs <span class="op">=</span> <span class="va">I_observed</span>,</span>
<span>  </span>
<span>  <span class="co">## simulated trajectory to compare with data</span></span>
<span>  I_sim <span class="op">=</span> <span class="va">empty_matrix</span>, </span>
<span>  </span>
<span>  <span class="co">## location of I in the state vector</span></span>
<span>  <span class="co">## (the `-1L` bit is to get 0-based indices instead of 1-based)</span></span>
<span>  I_index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="st">"I"</span>, <span class="va">sir</span><span class="op">$</span><span class="va">labels</span><span class="op">$</span><span class="fu">state</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1L</span>, </span>
<span>  </span>
<span>  <span class="co">## matrix to contain the log likelihood values at </span></span>
<span>  <span class="co">## each time step</span></span>
<span>  log_lik <span class="op">=</span> <span class="va">empty_matrix</span>, </span>
<span>  </span>
<span>  <span class="co">## need to save the simulation history of each of these matrices</span></span>
<span>  .mats_to_save <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"I_sim"</span>, <span class="st">"log_lik"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we need some new expressions. The first expression pulls out the
I state from the state vector.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>  <span class="va">I_sim</span> <span class="op">~</span> <span class="va">state</span><span class="op">[</span><span class="va">I_index</span><span class="op">]</span>,</span>
<span>  .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The second expression computes a vector of Poisson log-likelihood
values – one for each time step.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>  <span class="va">log_lik</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">dpois</a></span><span class="op">(</span><span class="va">I_obs</span>, <span class="fu"><a href="../reference/engine_functions.html">clamp</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">rbind_time</a></span><span class="op">(</span><span class="va">I_sim</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  .phase <span class="op">=</span> <span class="st">"after"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">obj_fn</span><span class="op">(</span><span class="op">~</span> <span class="op">-</span><span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="va">log_lik</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next we declare the beta values as parameters to be optimized on the
log scale.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">transformations</span><span class="op">(</span><span class="fu"><a href="../reference/Transform.html">Log</a></span><span class="op">(</span><span class="st">"beta_values"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">params</span><span class="op">(</span></span>
<span>  default <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="va">get</span><span class="op">$</span><span class="fu">initial</span><span class="op">(</span><span class="st">"beta_values"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  mat <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="st">"log_beta_values"</span>, <span class="fl">3L</span><span class="op">)</span>,</span>
<span>  row <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Finally we fit the model back to the simulation data.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">optimize</span><span class="op">$</span><span class="fu">nlminb</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Constructing atomic D_lgamma</span></span>
<span><span class="co">#&gt; outer mgc:  736.1414 </span></span>
<span><span class="co">#&gt; Constructing atomic D_lgamma</span></span>
<span><span class="co">#&gt; outer mgc:  112.6655 </span></span>
<span><span class="co">#&gt; outer mgc:  71.38648 </span></span>
<span><span class="co">#&gt; outer mgc:  13.6616 </span></span>
<span><span class="co">#&gt; outer mgc:  12.58091 </span></span>
<span><span class="co">#&gt; outer mgc:  3.638083 </span></span>
<span><span class="co">#&gt; outer mgc:  1.399513 </span></span>
<span><span class="co">#&gt; outer mgc:  1.609453 </span></span>
<span><span class="co">#&gt; outer mgc:  1.140347 </span></span>
<span><span class="co">#&gt; outer mgc:  0.5870909 </span></span>
<span><span class="co">#&gt; outer mgc:  0.2527136 </span></span>
<span><span class="co">#&gt; outer mgc:  0.09938628 </span></span>
<span><span class="co">#&gt; outer mgc:  0.03753935 </span></span>
<span><span class="co">#&gt; outer mgc:  0.01394885 </span></span>
<span><span class="co">#&gt; outer mgc:  0.005150654 </span></span>
<span><span class="co">#&gt; outer mgc:  0.001897432 </span></span>
<span><span class="co">#&gt; outer mgc:  0.0006983805 </span></span>
<span><span class="co">#&gt; outer mgc:  0.0002569678 </span></span>
<span><span class="co">#&gt; outer mgc:  9.453969e-05 </span></span>
<span><span class="co">#&gt; outer mgc:  3.478009e-05 </span></span>
<span><span class="co">#&gt; outer mgc:  1.2795e-05 </span></span>
<span><span class="co">#&gt; outer mgc:  4.707033e-06 </span></span>
<span><span class="co">#&gt; outer mgc:  1.731623e-06 </span></span>
<span><span class="co">#&gt; outer mgc:  6.370286e-07 </span></span>
<span><span class="co">#&gt; outer mgc:  2.3435e-07 </span></span>
<span><span class="co">#&gt; outer mgc:  8.621247e-08 </span></span>
<span><span class="co">#&gt; outer mgc:  3.171579e-08</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;      params      params      params </span></span>
<span><span class="co">#&gt;  -0.1710158 -22.8268369  -0.8291142 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 99.74231</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 26</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       28       27 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "relative convergence (4)"</span></span></code></pre></div>
<p>We can see that the optimizer converges
(i.e. <code>$convergence = 0</code>) in 26 iterations.</p>
<p>On the log scale we see that the optimizer finds different values
(<code>current</code>) than it started at (<code>default</code>).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">current</span><span class="op">$</span><span class="fu">params_frame</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   par_id             mat row col    default     current</span></span>
<span><span class="co">#&gt; 1      0 log_beta_values   0   0 -0.9079919  -0.1710158</span></span>
<span><span class="co">#&gt; 2      1 log_beta_values   1   0 -0.9079919 -22.8268369</span></span>
<span><span class="co">#&gt; 3      2 log_beta_values   2   0 -0.9079919  -0.8291142</span></span></code></pre></div>
<p>More importantly the beta values on the untransformed scale recover
to the values used in the simulations, although the second fitted beta
value is much smaller than the true value.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  fitted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/formatc.html" class="external-link">formatC</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="va">current</span><span class="op">$</span><span class="fu">params_frame</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">current</span><span class="op">)</span>,</span>
<span>    format <span class="op">=</span> <span class="st">"e"</span>, digits <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span>,</span>
<span>  true <span class="op">=</span> <span class="va">simulator</span><span class="op">$</span><span class="va">get</span><span class="op">$</span><span class="fu">initial</span><span class="op">(</span><span class="st">"beta_values"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     fitted true</span></span>
<span><span class="co">#&gt; 1 8.43e-01 0.80</span></span>
<span><span class="co">#&gt; 2 1.22e-10 0.01</span></span>
<span><span class="co">#&gt; 3 4.36e-01 0.40</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="smooth-time-variation-todo">Smooth Time Variation (TODO)<a class="anchor" aria-label="anchor" href="#smooth-time-variation-todo"></a>
</h2>
</div>
<div class="section level2">
<h2 id="generalized-linear-models-todo">Generalized Linear Models (TODO)<a class="anchor" aria-label="anchor" href="#generalized-linear-models-todo"></a>
</h2>
</div>
<div class="section level2">
<h2 id="radial-basis-functions-for-flexible-time-variation-in-progress">Radial Basis Functions for Flexible Time Variation
(In-Progress)<a class="anchor" aria-label="anchor" href="#radial-basis-functions-for-flexible-time-variation-in-progress"></a>
</h2>
<p>This section uses radial basis functions to generate models with a
flexible functional form for smooth changes in the transmission
rate.</p>
<p>Before we can add the fancy radial basis for the transmission rate,
we need a base model. We use an SIR model that has been modified to
include waning.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir</span> <span class="op">=</span> <span class="fu"><a href="../reference/Compartmental.html">Compartmental</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"starter_models"</span>, <span class="st">"sir_waning"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sir</span><span class="op">$</span><span class="fu">flows</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   from to  flow       type</span></span>
<span><span class="co">#&gt; 1    S  I   foi per_capita</span></span>
<span><span class="co">#&gt; 2    I  R gamma per_capita</span></span>
<span><span class="co">#&gt; 3    R  S  wane per_capita</span></span></code></pre></div>
<p>The <code><a href="../reference/rbf.html">macpan2::rbf</a></code> function can be used to produce a
matrix giving the values of each basis function (each column) at each
time step (each row). Using this matrix, <span class="math inline">\(X\)</span>, and a weights vector, <span class="math inline">\(b\)</span>, we can get a flexible output vector,
<span class="math inline">\(y\)</span>, with a shape that can be
modified into a wide variety of shapes by changing the weights
vector.</p>
<p><span class="math display">\[
y = Xb
\]</span></p>
<p>The following code illustrates this approach.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="va">n</span> <span class="op">=</span> <span class="fl">2500</span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="../reference/rbf.html">rbf</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="va">d</span>, sd <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"time"</span>, ylab <span class="op">=</span> <span class="st">"basis functions"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">d</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">b</span>, xlab <span class="op">=</span> <span class="st">""</span>, ylab <span class="op">=</span> <span class="st">"weights"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"time"</span>, ylab <span class="op">=</span> <span class="st">"output"</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/unnamed-chunk-2-1.png" width="576"></p>
<p>Here <code>d</code> is the dimension of the basis, or number of
functions, and <code>n</code> is the number of time steps. By
multiplying the uniform basis matrix (top panel) to a set of weights
(middle panel), one can obtain a non-uniform curve (bottom panel). Note
how the peaks in the output are associated with large positive
weights.</p>
<p>To transform the output of the matrix multiplication of the radial
basis function matrix and the weights vector into a time-series for the
transmission rate, <span class="math inline">\(\beta\)</span>. Although
we could just use the output vector as the <span class="math inline">\(\beta\)</span> time series, it is more convenient
to transform it a little so that the <span class="math inline">\(\beta\)</span> values yield more interesting
dynamics in an SIR model. In particular, our model for <span class="math inline">\(\beta_t\)</span> as a function of time, <span class="math inline">\(t\)</span>, is as follows.</p>
<p><span class="math display">\[
\log(\beta_t) = \log(\gamma_t) + \log(N) - \log(S_t) + x_tb
\]</span></p>
<p>Here we have the recovery rate, <span class="math inline">\(\gamma_t\)</span>, and number of susceptibles,
<span class="math inline">\(S_t\)</span>, at time, <span class="math inline">\(t\)</span>, the total population, <span class="math inline">\(N\)</span>, and the <span class="math inline">\(t\)</span>th row of <span class="math inline">\(X\)</span>, <span class="math inline">\(x_t\)</span>. To better understand the rationale
for this equation note that if every element of <span class="math inline">\(b\)</span> is set to zero, we have the following
condition.</p>
<p><span class="math display">\[
\frac{\beta_t S_t}{N} = \gamma_t
\]</span></p>
<p>This condition assures that the number of infected individuals
remains constant at time, <span class="math inline">\(t\)</span>. This
means that positive values of <span class="math inline">\(b\)</span>
will tend to generate outbreaks and negative values will tend to reduce
transmission. Because of the local nature of radial basis functions, it
is not necessary to set all coefficients of <span class="math inline">\(b\)</span> to zero to achieve the same results in
practice – it is only necessary to work with the coefficients of the
basis functions that are appreciably greater than zero at <span class="math inline">\(t\)</span>.</p>
<p>Here is a simulation model with a radial basis for exogenous
transmission rate dynamics.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">simulator</span> <span class="op">=</span> <span class="va">sir</span><span class="op">$</span><span class="va">simulators</span><span class="op">$</span><span class="fu">tmb</span><span class="op">(</span></span>
<span>      time_steps <span class="op">=</span> <span class="va">n</span></span>
<span>    , state <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">100000</span> <span class="op">-</span> <span class="fl">500</span>, I <span class="op">=</span> <span class="fl">500</span>, R <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    , flow <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>foi <span class="op">=</span> <span class="cn">NA</span>, gamma <span class="op">=</span> <span class="fl">0.2</span>, wane <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>    , beta <span class="op">=</span> <span class="fl">1</span></span>
<span>    , N <span class="op">=</span> <span class="fl">100000</span></span>
<span>    , X <span class="op">=</span> <span class="fu"><a href="../reference/rbf.html">rbf</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span><span class="op">)</span></span>
<span>    , b <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="va">d</span>, sd <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>    , incidence <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>    , eta <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>    , .mats_to_save <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"incidence"</span>, <span class="st">"beta"</span><span class="op">)</span></span>
<span>    , .mats_to_return <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"incidence"</span>, <span class="st">"beta"</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">eta</span> <span class="op">~</span> <span class="va">gamma</span> <span class="op">*</span> <span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"before"</span></span>
<span>  , .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">beta</span> <span class="op">~</span> <span class="va">eta</span><span class="op">[</span><span class="fu"><a href="../reference/engine_functions.html">time_step</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="../reference/engine_functions.html">clamp</a></span><span class="op">(</span><span class="va">S</span><span class="op">/</span><span class="va">N</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span>  , .at <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">incidence</span> <span class="op">~</span> <span class="va">I</span></span>
<span>  , .vec_by_states <span class="op">=</span> <span class="st">"total_inflow"</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span>  , .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">params</span><span class="op">(</span></span>
<span>    default <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="va">d</span>, sd <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>  , mat <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="va">d</span><span class="op">)</span></span>
<span>  , row <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1L</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span><span class="co">## rnorm(d, sd = 0.01),</span></span>
<span>                  .phases <span class="op">=</span> <span class="st">"during"</span>  <span class="co">## report only 'during' time steps</span></span>
<span>                  <span class="op">)</span></span>
<span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">matrix</span> <span class="op">==</span> <span class="st">"state"</span>, <span class="va">row</span>, <span class="va">matrix</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">variable</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/plot_rbf-1.png" width="576"></p>
<div class="section level3">
<h3 id="now-calibrate">now calibrate???<a class="anchor" aria-label="anchor" href="#now-calibrate"></a>
</h3>
<p>Simulate and add some noise:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs_incidence</span> <span class="op">&lt;-</span> <span class="op">(</span></span>
<span>    <span class="va">simulator</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span>.phases <span class="op">=</span> <span class="st">"during"</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">row</span> <span class="op">==</span> <span class="st">"I"</span>, <span class="va">matrix</span> <span class="op">==</span> <span class="st">"state"</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="va">value</span>, <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">.</span>, sd <span class="op">=</span> <span class="fl">50</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">obs_incidence</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/noisy_sim-1.png" width="700"></p>
<p>Add basic calibration boilerplate, including a parameter for the
variance of the RBF term (<code>rbf_sd</code>); add a RBF penalty to the
log-likelihood (<strong>note for later</strong>, may want to add a
comment about centered/non-centered parameterizations of the penalty
term …)</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## copied from 'calibration/"hello world"' example</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span></span>
<span>              I_obs <span class="op">=</span> <span class="va">obs_incidence</span>,</span>
<span>              I_sim <span class="op">=</span> <span class="va">empty_matrix</span>, </span>
<span>              log_lik <span class="op">=</span> <span class="va">empty_matrix</span>,</span>
<span>              .mats_to_save <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"I_sim"</span>, <span class="st">"log_lik"</span><span class="op">)</span>,</span>
<span>              .mats_to_return <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"I_sim"</span>, <span class="st">"log_lik"</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>                     <span class="va">I_sim</span> <span class="op">~</span> <span class="va">I</span>,</span>
<span>                     .phase <span class="op">=</span> <span class="st">"during"</span>,</span>
<span>                     .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span>                 <span class="op">)</span></span>
<span><span class="co">## parameter for std dev of incidence</span></span>
<span><span class="co">##  *and* a penalty parameter for the RBF coefficients</span></span>
<span><span class="co">## (this is esentially a standard deviation on a Gaussian random effect ...</span></span>
<span><span class="co">##  or approximately 1/sqrt(lambda) if lambda is a ridge penalty ...</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span>I_sd <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                       rbf_sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>                         <span class="va">log_lik</span> <span class="op">~</span> <span class="op">-</span><span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">dnorm</a></span><span class="op">(</span><span class="va">I_obs</span>, <span class="fu"><a href="../reference/engine_functions.html">rbind_time</a></span><span class="op">(</span><span class="va">I_sim</span><span class="op">)</span>, <span class="va">I_sd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>                             <span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">dnorm</a></span><span class="op">(</span><span class="va">b</span>, <span class="fl">0.0</span>, <span class="va">rbf_sd</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                         .phase <span class="op">=</span> <span class="st">"after"</span></span>
<span>                 <span class="op">)</span></span>
<span><span class="co">## initially forgot this: maybe we could warn when someone is missing this????</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">obj_fn</span><span class="op">(</span><span class="op">~</span> <span class="va">log_lik</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">transformations</span><span class="op">(</span><span class="fu"><a href="../reference/Transform.html">Log</a></span><span class="op">(</span><span class="st">"I_sd"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">transformations</span><span class="op">(</span><span class="fu"><a href="../reference/Transform.html">Log</a></span><span class="op">(</span><span class="st">"rbf_sd"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## not sure if this is required?</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.delim</a></span><span class="op">(</span>sep <span class="op">=</span> <span class="st">"|"</span>, header <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     strip.white <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co">## important!</span></span>
<span>                      text <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">mat         | row | col | default</span></span>
<span><span class="st">log_I_sd    | 0   | 0   | 0</span></span>
<span><span class="st">log_rbf_sd  | 0   | 0   | 1</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="co">## add b as a RANDOM parameter</span></span>
<span><span class="va">rparams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    mat  <span class="op">=</span> <span class="st">"b"</span>,</span>
<span>    row <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">19</span>,</span>
<span>    col <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    default <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">params_frame</span><span class="op">(</span><span class="va">params</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">random_frame</span><span class="op">(</span><span class="va">rparams</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## testing: simulator$ad_fun()$fn()</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">simulator</span><span class="op">$</span><span class="va">optimize</span><span class="op">$</span><span class="fu">nlminb</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Optimizing tape... Done</span></span>
<span><span class="co">#&gt; iter: 1  value: 43081304 mgc: 14984665332 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 9324443 mgc: 9697127198 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 3692729 mgc: 2600980382 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 4  value: 3159319 mgc: 522572536 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 5  value: 3135896 mgc: 63731265 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 6  value: 3135673 mgc: 3886467 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 7  value: 3135673 mgc: 43255.5 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 8  value: 3135673 mgc: 10.67544 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 9  value: 3135673 mgc: 8.158166e-06 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 1.12217e-05 </span></span>
<span><span class="co">#&gt; iter: 1  value: 3135673 mgc: 1.12217e-05 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 1.065613e-05 </span></span>
<span><span class="co">#&gt; iter: 1  value: 3135673 mgc: 1.12217e-05 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 1.065613e-05 </span></span>
<span><span class="co">#&gt; Matching hessian patterns... Done</span></span>
<span><span class="co">#&gt; outer mgc:  6264195 </span></span>
<span><span class="co">#&gt; iter: 1  value: 428886.9 mgc: 0.002498154 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 428886.9 mgc: 7.879339e-06 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 3.996211e-06 </span></span>
<span><span class="co">#&gt; iter: 1  value: 428886.9 mgc: 3.996211e-06 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 1.582521e-06 </span></span>
<span><span class="co">#&gt; outer mgc:  845622.3 </span></span>
<span><span class="co">#&gt; iter: 1  value: 315578 mgc: 0.01870879 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 315578 mgc: 2.316653e-06 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 9.394006e-07 </span></span>
<span><span class="co">#&gt; iter: 1  value: 315578 mgc: 9.394006e-07 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 2.473763e-06 </span></span>
<span><span class="co">#&gt; outer mgc:  618263.9 </span></span>
<span><span class="co">#&gt; iter: 1  value: 139059.7 mgc: 23.31714 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 139059.7 mgc: 1.523019 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 8.284675e-07 </span></span>
<span><span class="co">#&gt; iter: 1  value: 139059.7 mgc: 8.284675e-07 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 6.849825e-07 </span></span>
<span><span class="co">#&gt; outer mgc:  263244.4 </span></span>
<span><span class="co">#&gt; iter: 1  value: 78489.15 mgc: 26701.02 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 78489.14 mgc: 11350.18 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 78489.14 mgc: 1.465361 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 1.32219e-06 </span></span>
<span><span class="co">#&gt; iter: 1  value: 78489.14 mgc: 1.32219e-06 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 8.074626e-07 </span></span>
<span><span class="co">#&gt; outer mgc:  139312.3 </span></span>
<span><span class="co">#&gt; iter: 1  value: 37879.17 mgc: 7746.4 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 37879.16 mgc: 4600.689 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 37879.16 mgc: 0.6835434 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 4  value: 37879.16 mgc: 2.015579e-07 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 4.565403e-07 </span></span>
<span><span class="co">#&gt; iter: 1  value: 37879.16 mgc: 4.565403e-07 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 4.375074e-07 </span></span>
<span><span class="co">#&gt; outer mgc:  57147.79 </span></span>
<span><span class="co">#&gt; iter: 1  value: 23273.39 mgc: 26851.96 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 23273.34 mgc: 9248.633 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 23273.34 mgc: 8.432313 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 4  value: 23273.34 mgc: 3.287019e-05 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 8.09174e-08 </span></span>
<span><span class="co">#&gt; iter: 1  value: 23273.34 mgc: 8.09174e-08 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 1.612473e-07 </span></span>
<span><span class="co">#&gt; outer mgc:  24879.82 </span></span>
<span><span class="co">#&gt; iter: 1  value: 15115.03 mgc: 5860.238 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 15115.01 mgc: 3032.709 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 15115.01 mgc: 4.20483 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 4  value: 15115.01 mgc: 5.335738e-05 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 1.092644e-07 </span></span>
<span><span class="co">#&gt; iter: 1  value: 15115.01 mgc: 1.092644e-07 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 4.101234e-08 </span></span>
<span><span class="co">#&gt; outer mgc:  7030.615 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13908.47 mgc: 26682.99 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 13907.65 mgc: 17782.25 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 13907.65 mgc: 140.1179 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 4  value: 13907.65 mgc: 0.02705945 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 6.360988e-09 </span></span>
<span><span class="co">#&gt; iter: 1  mgc: 6.360988e-09 </span></span>
<span><span class="co">#&gt; outer mgc:  1603.064 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13285.33 mgc: 8014.252 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 13284.57 mgc: 9679.024 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 13284.57 mgc: 136.3248 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 4  value: 13284.57 mgc: 0.1822533 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 5  value: 13284.57 mgc: 7.841439e-07 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 4.041782e-09 </span></span>
<span><span class="co">#&gt; iter: 1  mgc: 4.041782e-09 </span></span>
<span><span class="co">#&gt; outer mgc:  194.9082 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13279.62 mgc: 2.532248 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 13279.62 mgc: 0.09123741 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 1.740445e-08 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13279.62 mgc: 1.740445e-08 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 8.130244e-09 </span></span>
<span><span class="co">#&gt; outer mgc:  91.94347 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13275.45 mgc: 8.641502 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 13275.45 mgc: 0.7492179 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 13275.45 mgc: 2.131929e-07 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 4.74397e-09 </span></span>
<span><span class="co">#&gt; iter: 1  mgc: 4.74397e-09 </span></span>
<span><span class="co">#&gt; outer mgc:  60.48549 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13273.87 mgc: 7.599565 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 13273.87 mgc: 0.4100377 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 13273.87 mgc: 6.322979e-08 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 8.88368e-09 </span></span>
<span><span class="co">#&gt; iter: 1  mgc: 8.88368e-09 </span></span>
<span><span class="co">#&gt; outer mgc:  82.4271 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13267.83 mgc: 53.18646 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 13267.83 mgc: 7.870479 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 13267.83 mgc: 2.689114e-05 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 1.012824e-08 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13264.12 mgc: 268.9679 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 13264.12 mgc: 35.90084 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 13264.12 mgc: 0.001497525 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 5.589939e-09 </span></span>
<span><span class="co">#&gt; iter: 1  mgc: 5.589939e-09 </span></span>
<span><span class="co">#&gt; outer mgc:  169.2105 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13264.26 mgc: 181.388 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 13264.26 mgc: 17.50901 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 13264.26 mgc: 0.000446337 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 9.888506e-09 </span></span>
<span><span class="co">#&gt; iter: 1  mgc: 9.888506e-09 </span></span>
<span><span class="co">#&gt; outer mgc:  67.38602 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13262.66 mgc: 49.69669 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 13262.66 mgc: 1.669537 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 13262.66 mgc: 3.309544e-06 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 4.93619e-09 </span></span>
<span><span class="co">#&gt; iter: 1  mgc: 4.93619e-09 </span></span>
<span><span class="co">#&gt; outer mgc:  34.54276 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13261.97 mgc: 49.11243 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 13261.97 mgc: 1.26423 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 13261.97 mgc: 2.319474e-06 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 3.895491e-09 </span></span>
<span><span class="co">#&gt; iter: 1  mgc: 3.895491e-09 </span></span>
<span><span class="co">#&gt; outer mgc:  1.886538 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13262.09 mgc: 10.75282 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 13262.09 mgc: 0.05741338 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  mgc: 5.448606e-09 </span></span>
<span><span class="co">#&gt; iter: 1  mgc: 5.448606e-09 </span></span>
<span><span class="co">#&gt; outer mgc:  0.8187962 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13262.09 mgc: 0.2886684 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 13262.09 mgc: 4.204783e-05 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 5.74693e-09 </span></span>
<span><span class="co">#&gt; iter: 1  mgc: 5.74693e-09 </span></span>
<span><span class="co">#&gt; outer mgc:  0.06537638 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13262.09 mgc: 0.01798474 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 13262.09 mgc: 1.886835e-07 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 3.251445e-08 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13262.09 mgc: 3.251445e-08 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 1.753477e-08 </span></span>
<span><span class="co">#&gt; outer mgc:  5.147544e-05 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13262.09 mgc: 3.251445e-08 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 1.753477e-08 </span></span>
<span><span class="co">#&gt; iter: 1  value: 13262.09 mgc: 3.251445e-08 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 1.753477e-08</span></span>
<span><span class="co">## simulator$print$matrix_dims()</span></span>
<span><span class="co">## fixed effects only:</span></span>
<span><span class="co">## look at parameters, but skip the random-effects parameters</span></span>
<span><span class="co">## 'random' holds the indices of the parameters that are treated</span></span>
<span><span class="co">## as random effects</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="fu">ad_fun</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">env</span>,</span>
<span>     <span class="va">last.par.best</span><span class="op">[</span><span class="op">-</span><span class="va">random</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;    params    params </span></span>
<span><span class="co">#&gt;  3.916658 -4.764201</span></span>
<span><span class="co">## RE only</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="fu">ad_fun</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">env</span>,</span>
<span>     <span class="va">last.par.best</span><span class="op">[</span><span class="va">random</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;        random        random        random        random        random </span></span>
<span><span class="co">#&gt;  0.0077623594  0.0106462453 -0.0033241271 -0.0152209556  0.0018056818 </span></span>
<span><span class="co">#&gt;        random        random        random        random        random </span></span>
<span><span class="co">#&gt;  0.0036394012 -0.0049338054 -0.0138082058 -0.0043197178  0.0074629697 </span></span>
<span><span class="co">#&gt;        random        random        random        random        random </span></span>
<span><span class="co">#&gt;  0.0067332443  0.0039721353  0.0027104366 -0.0021796443 -0.0103571897 </span></span>
<span><span class="co">#&gt;        random        random        random        random        random </span></span>
<span><span class="co">#&gt; -0.0069793171 -0.0028926299  0.0006549716  0.0079703675  0.0090849416</span></span>
<span><span class="co">## https://kaskr.github.io/adcomp/_book/Introduction.html</span></span>
<span><span class="co">## https://kaskr.github.io/adcomp/_book/Tutorial.html#statistical-modelling</span></span>
<span><span class="co">## https://arxiv.org/pdf/1509.00660.pdf</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="generalized-linear-mixed-models-in-progress">Generalized Linear Mixed Models (In-Progress)<a class="anchor" aria-label="anchor" href="#generalized-linear-mixed-models-in-progress"></a>
</h2>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#set.seed(6L)</span></span>
<span><span class="va">sir</span> <span class="op">=</span> <span class="fu"><a href="../reference/Compartmental.html">Compartmental</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"starter_models"</span>, <span class="st">"sir"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simulator_rand_beta</span> <span class="op">=</span> <span class="va">sir</span><span class="op">$</span><span class="va">simulators</span><span class="op">$</span><span class="fu">tmb</span><span class="op">(</span>time_steps <span class="op">=</span> <span class="fl">50</span></span>
<span>  , state <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">99</span>, I <span class="op">=</span> <span class="fl">1</span>, R <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  , flow <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>foi <span class="op">=</span> <span class="cn">NA</span>, gamma <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span>  , N <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>  , beta <span class="op">=</span> <span class="fl">0.4</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator_rand_beta</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span></span>
<span>  beta_eps <span class="op">=</span> <span class="va">norm_beta</span>,</span>
<span>  beta_mean <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">log</a></span><span class="op">(</span><span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator_rand_beta</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">beta</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">beta_mean</span> <span class="op">-</span> <span class="va">beta_eps</span><span class="op">)</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span>  , .at <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">simulator_rand_beta</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span>.phases <span class="op">=</span> <span class="st">"during"</span><span class="op">)</span></span>
<span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">row</span> <span class="op">==</span> <span class="st">"I"</span>, <span class="va">matrix</span> <span class="op">==</span> <span class="st">"state"</span><span class="op">)</span></span>
<span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">matrix</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">observed_I</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">simulator_rand_beta</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span>.phases <span class="op">=</span> <span class="st">"during"</span><span class="op">)</span>, <span class="va">row</span> <span class="op">==</span> <span class="st">"I"</span>, <span class="va">matrix</span> <span class="op">==</span> <span class="st">"state"</span><span class="op">)</span><span class="op">$</span><span class="va">value</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir</span> <span class="op">=</span> <span class="fu"><a href="../reference/Compartmental.html">Compartmental</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"starter_models"</span>, <span class="st">"sir"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simulator_step_level_re</span> <span class="op">=</span> <span class="va">sir</span><span class="op">$</span><span class="va">simulators</span><span class="op">$</span><span class="fu">tmb</span><span class="op">(</span>time_steps <span class="op">=</span> <span class="fl">50</span></span>
<span>  , state <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">99</span>, I <span class="op">=</span> <span class="fl">1</span>, R <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  , flow <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>foi <span class="op">=</span> <span class="cn">NA</span>, gamma <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span>  , N <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>  , beta <span class="op">=</span> <span class="fl">0.8</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator_step_level_re</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span></span>
<span>    beta_mean <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">log</a></span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></span>
<span>  , beta_sd <span class="op">=</span> <span class="fl">1</span></span>
<span>  , beta_time_step <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">0</span>, <span class="fl">0.2</span><span class="op">)</span></span>
<span>  , beta_log_density <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>  , I_observed <span class="op">=</span> <span class="va">observed_I</span></span>
<span>  , log_lik <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>  , total_log_lik <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>  , .mats_to_save <span class="op">=</span> <span class="st">"log_lik"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator_step_level_re</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">beta_log_density</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">dnorm</a></span><span class="op">(</span></span>
<span>      <span class="va">beta_time_step</span>, </span>
<span>      <span class="fl">0</span>, </span>
<span>      <span class="va">beta_sd</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"before"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator_step_level_re</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">beta</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="va">beta_mean</span> <span class="op">+</span> <span class="va">beta_time_step</span><span class="op">[</span><span class="fu"><a href="../reference/engine_functions.html">time_step</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator_step_level_re</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">log_lik</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">dpois</a></span><span class="op">(</span><span class="va">I_observed</span><span class="op">[</span><span class="fu"><a href="../reference/engine_functions.html">time_step</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span>, <span class="fu"><a href="../reference/engine_functions.html">clamp</a></span><span class="op">(</span><span class="va">I</span><span class="op">)</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span>  , .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator_step_level_re</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">total_log_lik</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">rbind_time</a></span><span class="op">(</span><span class="va">log_lik</span><span class="op">)</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"after"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator_step_level_re</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">params</span><span class="op">(</span></span>
<span>  default <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  mat <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"beta_mean"</span>, <span class="st">"beta_sd"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator_step_level_re</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">random</span><span class="op">(</span></span>
<span>  default <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  mat <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="st">"beta_time_step"</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>  row <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">49</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator_step_level_re</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">obj_fn</span><span class="op">(</span></span>
<span>  <span class="op">~</span> <span class="op">-</span><span class="va">total_log_lik</span><span class="op">-</span><span class="va">beta_log_density</span><span class="op">-</span><span class="fu"><a href="../reference/engine_functions.html">dnorm</a></span><span class="op">(</span><span class="va">beta_sd</span>, <span class="fl">0.2</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator_step_level_re</span><span class="op">$</span><span class="va">optimize</span><span class="op">$</span><span class="fu">nlminb</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">simulator_step_level_re</span><span class="op">$</span><span class="va">optimize</span><span class="op">$</span><span class="fu">optim</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#simulator_step_level_re$current$random_frame()</span></span>
<span><span class="co">#simulator_step_level_re$current$params_frame()</span></span>
<span><span class="co">#simulator_step_level_re$ad_fun()$fn(0)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">simulator_step_level_re</span><span class="op">$</span><span class="va">current</span><span class="op">$</span><span class="fu">random_frame</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">row</span>, <span class="va">current</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#simulator_step_level_re$cache$invalidate()</span></span>
<span><span class="co">#simulator_step_level_re$ad_fun()$gr(-1.23)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">simulator_step_level_re</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span>.phases <span class="op">=</span> <span class="st">"during"</span><span class="op">)</span>, <span class="va">row</span> <span class="op">==</span> <span class="st">"I"</span>, <span class="va">matrix</span> <span class="op">==</span> <span class="st">"state"</span><span class="op">)</span><span class="op">$</span><span class="va">value</span>,</span>
<span>  <span class="va">observed_I</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Steve Walker, Darren Flynn-Primrose, Weiguang Guan, Ben Bolker.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
