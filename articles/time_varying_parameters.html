<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Specifying Time-Varying Parameters • macpan2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Specifying Time-Varying Parameters">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.7.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/quickstart.html">Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/example_models.html">Example Models</a></li>
    <li><a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a></li>
    <li><a class="dropdown-item" href="../articles/real_data.html">Fitting to Real Data</a></li>
    <li><a class="dropdown-item" href="../articles/state_updaters.html">ODE Solvers, Process Error, and Difference Equations</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Specifying Time-Varying Parameters</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/main/vignettes/time_varying_parameters.Rmd" class="external-link"><code>vignettes/time_varying_parameters.Rmd</code></a></small>
      <div class="d-none name"><code>time_varying_parameters.Rmd</code></div>
    </div>

    
    
<p><a href="https://canmod.github.io/macpan2/articles/vignette-status#working-draft"><img src="https://img.shields.io/badge/status-working%20draft-red" alt="status"></a></p>
<div class="section level2">
<h2 id="baseline-sir-model">Baseline SIR Model<a class="anchor" aria-label="anchor" href="#baseline-sir-model"></a>
</h2>
<p>Here we modify an <a href="https://github.com/canmod/macpan2/tree/main/inst/starter_models/sir" class="external-link">SIR</a>
model so that transmission rate is time-varying.</p>
<p>We initialize a vector of state labels and parameter default values
for convenience and specify a simulation time of 50 time steps.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state_labels</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span><span class="op">)</span></span>
<span><span class="va">time_steps</span> <span class="op">=</span> <span class="fl">50</span></span>
<span><span class="va">beta</span> <span class="op">=</span> <span class="fl">0.8</span> <span class="co"># per-capita transmission rate</span></span>
<span><span class="va">gamma</span> <span class="op">=</span> <span class="fl">0.2</span> <span class="co"># per-capita recovery rate</span></span></code></pre></div>
<p>Using a fixed transmission rate of 0.8 we visualize the baseline SIR
dynamics.
<img src="time_varying_parameters_files/figure-html/baseline_sir-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="piecewise-time-variation">Piecewise Time Variation<a class="anchor" aria-label="anchor" href="#piecewise-time-variation"></a>
</h2>
<p>To create a piecewise time-varying transmission rate, we need to
specify two variables:</p>
<ol style="list-style-type: decimal">
<li>
<code>beta_changepoints</code> - An integer vector containing the
starting time steps at which the transmission rate <code>beta</code>
changes. This vector starts with a time step of 0 because we want to
specify an initial default value of <code>beta</code> followed by
changing transmission rates at the beginning of time-step 10 and 15.
(<strong>Note: Currently <code><a href="../reference/engine_functions.html">macpan2::time_var</a></code> expects the
argument <code>change_points</code> to start at 0, so the default value
of <code>beta</code> in this example is not used. In future development,
<code>time_var</code> will accept <code>change_points[1] &gt; 0</code>
and will use the default value of the parameter for time steps before
<code>change_points[1]</code>. See <a href="https://github.com/canmod/macpan2/issues/196" class="external-link">Update time_var to
incorporate default value</a></strong>)</li>
<li>
<code>beta_values</code> A numeric vector containing the values
<code>beta</code> takes at each time step specified in
<code>beta_changepoints</code>.</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">beta_changepoints</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">15</span><span class="op">)</span></span>
<span><span class="va">beta_values</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.01</span>, <span class="fl">0.4</span><span class="op">)</span></span></code></pre></div>
<p>We then need to specify an expression that updates <code>beta</code>
to <code>beta_values</code> at the time steps in
<code>beta_changepoints</code>. We use the <a href="https://canmod.github.io/macpan2/reference/engine_functions.html#time-indexing"><code>time_var</code></a>
function that will return a value for <code>beta</code>, from
<code>beta_values</code>, by comparing the current time step with the
time steps in <code>beta_changepoints</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># see ?time_var for arguments</span></span>
<span><span class="va">expr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span> <span class="va">beta</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">time_var</a></span><span class="op">(</span><span class="va">beta_values</span>, <span class="va">beta_changepoints</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Let’s test that <code>time_var</code> is computing what we want for
20 time steps.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/simple_sims.html">simple_sims</a></span><span class="op">(</span></span>
<span>    iteration_exprs <span class="op">=</span> <span class="va">expr</span></span>
<span>  , time_steps <span class="op">=</span> <span class="fl">20</span></span>
<span>  </span>
<span>  <span class="co"># for integer vectors (usually indexing vectors) use `int_vecs`</span></span>
<span>  , int_vecs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta_changepoints <span class="op">=</span> <span class="va">beta_changepoints</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># for numeric vectors (model defaults) use `mats`</span></span>
<span>  <span class="co"># we need to initialize beta because it is a variable in our model</span></span>
<span>  <span class="co"># so we set to 0.8 - at the beginning of the simulation loop (time_step==1)</span></span>
<span>  <span class="co"># beta gets updated so the initial value of beta has no effect in this case</span></span>
<span>  , mats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      beta <span class="op">=</span> <span class="va">beta</span></span>
<span>    , beta_values <span class="op">=</span> <span class="va">beta_values</span><span class="op">)</span></span>
<span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span> <span class="op">==</span> <span class="st">"beta"</span><span class="op">)</span></span>
<span><span class="co">#&gt;    matrix time row col value</span></span>
<span><span class="co">#&gt; 1    beta    1   0   0  0.80</span></span>
<span><span class="co">#&gt; 2    beta    2   0   0  0.80</span></span>
<span><span class="co">#&gt; 3    beta    3   0   0  0.80</span></span>
<span><span class="co">#&gt; 4    beta    4   0   0  0.80</span></span>
<span><span class="co">#&gt; 5    beta    5   0   0  0.80</span></span>
<span><span class="co">#&gt; 6    beta    6   0   0  0.80</span></span>
<span><span class="co">#&gt; 7    beta    7   0   0  0.80</span></span>
<span><span class="co">#&gt; 8    beta    8   0   0  0.80</span></span>
<span><span class="co">#&gt; 9    beta    9   0   0  0.80</span></span>
<span><span class="co">#&gt; 10   beta   10   0   0  0.01</span></span>
<span><span class="co">#&gt; 11   beta   11   0   0  0.01</span></span>
<span><span class="co">#&gt; 12   beta   12   0   0  0.01</span></span>
<span><span class="co">#&gt; 13   beta   13   0   0  0.01</span></span>
<span><span class="co">#&gt; 14   beta   14   0   0  0.01</span></span>
<span><span class="co">#&gt; 15   beta   15   0   0  0.40</span></span>
<span><span class="co">#&gt; 16   beta   16   0   0  0.40</span></span>
<span><span class="co">#&gt; 17   beta   17   0   0  0.40</span></span>
<span><span class="co">#&gt; 18   beta   18   0   0  0.40</span></span>
<span><span class="co">#&gt; 19   beta   19   0   0  0.40</span></span>
<span><span class="co">#&gt; 20   beta   20   0   0  0.40</span></span></code></pre></div>
<p>Now that we know our expression is updating <code>beta</code>
correctly, we can modify the SIR model to include this piece-wise
transmission rate.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># model specification with piece-wise transmission rates</span></span>
<span><span class="va">piecewise_spec</span> <span class="op">=</span> <span class="op">(</span></span>
<span>  <span class="st">"starter_models"</span></span>
<span>  <span class="co"># read in model from library                    </span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_tmb_library.html">mp_tmb_library</a></span><span class="op">(</span><span class="st">"sir"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span></span>
<span>  <span class="co"># insert expression for updating beta at the beginning of the simulation loop</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_tmb_insert.html">mp_tmb_insert</a></span><span class="op">(</span></span>
<span>      phase<span class="op">=</span><span class="st">"during"</span></span>
<span>    , at<span class="op">=</span><span class="fl">1</span></span>
<span>    , expressions <span class="op">=</span> <span class="va">expr</span></span>
<span>    , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="co"># Note: the default value of beta here has no effect, because at the</span></span>
<span>        <span class="co"># first time step beta is updated to beta_values[1]</span></span>
<span>        beta <span class="op">=</span> <span class="va">beta</span></span>
<span>      , gamma <span class="op">=</span> <span class="va">gamma</span></span>
<span>      , beta_values <span class="op">=</span> <span class="va">beta_values</span></span>
<span>      <span class="op">)</span></span>
<span>    , integers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta_changepoints <span class="op">=</span> <span class="va">beta_changepoints</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># check that model spec was updated accordingly</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">piecewise_spec</span><span class="op">)</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Default values:</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt;       matrix row col value</span></span>
<span><span class="co">#&gt;         beta         8e-01</span></span>
<span><span class="co">#&gt;        gamma         2e-01</span></span>
<span><span class="co">#&gt;            N         1e+02</span></span>
<span><span class="co">#&gt;            I         1e+00</span></span>
<span><span class="co">#&gt;            R         0e+00</span></span>
<span><span class="co">#&gt;  beta_values   0     8e-01</span></span>
<span><span class="co">#&gt;  beta_values   1     1e-02</span></span>
<span><span class="co">#&gt;  beta_values   2     4e-01</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: S ~ N - I - R</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to T):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: beta ~ time_var(beta_values, beta_changepoints)</span></span>
<span><span class="co">#&gt; 2: mp_per_capita_flow(from = "S", to = "I", rate = infection ~ I * </span></span>
<span><span class="co">#&gt;      beta/N)</span></span>
<span><span class="co">#&gt; 3: mp_per_capita_flow(from = "I", to = "R", rate = recovery ~ gamma)</span></span>
<span></span>
<span><span class="co"># create simulator object</span></span>
<span><span class="va">piecewise_simulator</span> <span class="op">=</span> <span class="op">(</span><span class="va">piecewise_spec</span></span>
<span>   <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span>time_steps <span class="op">=</span> <span class="va">time_steps</span>, outputs<span class="op">=</span><span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="va">state_labels</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we plot the updated simulations using these change-points, which
we highlight with vertical lines.
<img src="time_varying_parameters_files/figure-html/time_varying_graph-1.png" width="576"></p>
<p>The clear changes in dynamics at times 10 and 15 are due to the drop
and then lift of the transmission rate at these time steps.</p>
</div>
<div class="section level2">
<h2 id="calibrating-time-variation-parameters">Calibrating Time Variation Parameters<a class="anchor" aria-label="anchor" href="#calibrating-time-variation-parameters"></a>
</h2>
<p>First we simulate data to fit our model to, to see if we can recover
the time-varying parameters.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">I_observed</span> <span class="op">=</span> <span class="op">(</span><span class="va">sim_data</span></span>
<span>              <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span><span class="op">==</span><span class="st">"I"</span><span class="op">)</span></span>
<span>              <span class="co"># add some poisson noise</span></span>
<span>              <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rpois</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>,<span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">I_observed</span><span class="op">$</span><span class="va">time</span>, <span class="va">I_observed</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/obs_data-1.png" width="576"></p>
<p>We often want to include parameter constraints in our models, and one
way to do this implicitly is to transform the parameters <span class="citation">(<a href="#ref-bolker2008">Bolker 2008</a>)</span>.
Further, transformations can sometimes help when estimating parameters
by making the “likelihood surface closer to quadratic” and reducing
parameter correlation <span class="citation">(<a href="#ref-bolker2008">Bolker 2008</a>)</span>. Here we log-transform
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
because our constraint is that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
must be positive and the domain of the logarithm is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mi>∞</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(0, \infty)</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># transformed model specification</span></span>
<span><span class="va">transformed_spec</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_insert.html">mp_tmb_insert</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">piecewise_spec</span></span>
<span>  , phase <span class="op">=</span> <span class="st">"before"</span></span>
<span>  , at <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="co"># we need to exponentiate log transformed values so beta is on the appropriate</span></span>
<span>  <span class="co"># scale when computing model dynamics</span></span>
<span>  , expressions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">beta_values</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="va">log_beta_values</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># we also need to specify default values for log_beta_values</span></span>
<span>  <span class="co"># here we set all default values for beta to the mean of the true values</span></span>
<span>  <span class="co"># i.e. mean(log(beta_values))</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      log_beta_values <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">mean</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">log</a></span><span class="op">(</span><span class="va">beta_values</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">beta_values</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Note the true values of beta (`beta_values`) are still included in the default</span></span>
<span><span class="co"># list, however they get updated before the simulation loop, so they are not</span></span>
<span><span class="co"># informing our estimates for these values when calibrating.</span></span>
<span><span class="va">transformed_spec</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Default values:</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt;           matrix row col      value</span></span>
<span><span class="co">#&gt;             beta           0.800000</span></span>
<span><span class="co">#&gt;            gamma           0.200000</span></span>
<span><span class="co">#&gt;                N         100.000000</span></span>
<span><span class="co">#&gt;                I           1.000000</span></span>
<span><span class="co">#&gt;                R           0.000000</span></span>
<span><span class="co">#&gt;      beta_values   0       0.800000</span></span>
<span><span class="co">#&gt;      beta_values   1       0.010000</span></span>
<span><span class="co">#&gt;      beta_values   2       0.400000</span></span>
<span><span class="co">#&gt;  log_beta_values   0      -1.914868</span></span>
<span><span class="co">#&gt;  log_beta_values   1      -1.914868</span></span>
<span><span class="co">#&gt;  log_beta_values   2      -1.914868</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: beta_values ~ exp(log_beta_values)</span></span>
<span><span class="co">#&gt; 2: S ~ N - I - R</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to T):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: beta ~ time_var(beta_values, beta_changepoints)</span></span>
<span><span class="co">#&gt; 2: mp_per_capita_flow(from = "S", to = "I", rate = infection ~ I * </span></span>
<span><span class="co">#&gt;      beta/N)</span></span>
<span><span class="co">#&gt; 3: mp_per_capita_flow(from = "I", to = "R", rate = recovery ~ gamma)</span></span></code></pre></div>
<p>Next we create the calibrator object and specify that we want to
estimate the vector of time varying transmission rates,
<code>log_beta_values</code>, by passing this parameter name to the
<code>par</code> argument.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set up calibrator object</span></span>
<span><span class="va">piecewise_calib</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_calibrator.html">mp_tmb_calibrator</a></span><span class="op">(</span></span>
<span>    spec <span class="op">=</span> <span class="va">transformed_spec</span></span>
<span>  , data <span class="op">=</span> <span class="va">I_observed</span></span>
<span>  , traj <span class="op">=</span> <span class="st">"I"</span></span>
<span>  <span class="co"># we want to estimate the log-transformed parameters</span></span>
<span>  , par <span class="op">=</span> <span class="st">"log_beta_values"</span></span>
<span>  , outputs <span class="op">=</span> <span class="va">state_labels</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># optimization step</span></span>
<span><span class="fu"><a href="../reference/mp_optimize.html">mp_optimize</a></span><span class="op">(</span><span class="va">piecewise_calib</span><span class="op">)</span></span>
<span><span class="co">#&gt; outer mgc:  486.7233</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; outer mgc:  699.5397 </span></span>
<span><span class="co">#&gt; outer mgc:  148.8469 </span></span>
<span><span class="co">#&gt; outer mgc:  190.1806 </span></span>
<span><span class="co">#&gt; outer mgc:  118.6255 </span></span>
<span><span class="co">#&gt; outer mgc:  48.17214 </span></span>
<span><span class="co">#&gt; outer mgc:  3.120084 </span></span>
<span><span class="co">#&gt; outer mgc:  0.5353311 </span></span>
<span><span class="co">#&gt; outer mgc:  0.01025667 </span></span>
<span><span class="co">#&gt; outer mgc:  1.863369e-05 </span></span>
<span><span class="co">#&gt; outer mgc:  4.034157e-11</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;     params     params     params </span></span>
<span><span class="co">#&gt; -0.2144229 -2.8405257 -0.8566479 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 94.85064</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       14       11 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "relative convergence (4)"</span></span></code></pre></div>
<p>After optimizing, we can make a coefficient plot with the estimated
values and their confidence intervals, to compare with the true
values.</p>
<p><img src="time_varying_parameters_files/figure-html/piecewise_est-1.png" width="576"></p>
<p>In general, the transmission rate estimates follow the expected
pattern changing from high, to low, to moderate. The most precise
estimate, for the true value of 0.8, results because the observed
prevalence data is most informative about the transmission rate when the
infection is initially spreading. It makes sense that we get the most
accurate estimate for the final transmission rate because most of the
observed data is simulated with the final known transmission rate. We
lose accuracy and precision for the middle rate because there is only 5
time steps of observed data informing this parameter.</p>
</div>
<div class="section level2">
<h2 id="radial-basis-functions-for-flexible-time-variation-in-progress">Radial Basis Functions for Flexible Time Variation
(In-Progress)<a class="anchor" aria-label="anchor" href="#radial-basis-functions-for-flexible-time-variation-in-progress"></a>
</h2>
<p>This section uses radial basis functions (RBFs) to generate models
with a flexible functional form for smooth changes in the transmission
rate.</p>
<p>Before we can add the fancy radial basis for the transmission rate,
we need a base model. We use an SIR model that has been modified to
include waning.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_waning</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_library.html">mp_tmb_library</a></span><span class="op">(</span><span class="st">"starter_models"</span></span>
<span>  , <span class="st">"sir_waning"</span></span>
<span>  , package <span class="op">=</span> <span class="st">"macpan2"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/rbf.html">macpan2::rbf</a></code> function can be used to produce a
matrix giving the values of each basis function (each column) at each
time step (each row). Using this matrix,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>,
and a weights vector,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>,
we can get a flexible output vector,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics></math>,
with a shape that can be modified by changing the weights vector.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mi>X</mi><mi>b</mi></mrow><annotation encoding="application/x-tex">
y = Xb
</annotation></semantics></math></p>
<p>The following code illustrates this approach.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="va">n</span> <span class="op">=</span> <span class="fl">2500</span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="../reference/rbf.html">rbf</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="va">d</span>, sd <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  , mar <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">X</span></span>
<span>  , type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="fl">1</span></span>
<span>  , ylab <span class="op">=</span> <span class="st">"basis functions"</span></span>
<span>  , axes <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span>side <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/box.html" class="external-link">box</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">b</span></span>
<span>  , xlab <span class="op">=</span> <span class="st">""</span></span>
<span>  , ylab <span class="op">=</span> <span class="st">"weights"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b</span></span>
<span>  , type <span class="op">=</span> <span class="st">"l"</span></span>
<span>  , xlab <span class="op">=</span> <span class="st">"time"</span></span>
<span>  , ylab <span class="op">=</span> <span class="st">"output"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/unnamed-chunk-1-1.png" width="576"></p>
<p>Here <code>d</code> is the dimension of the basis, or number of
functions, and <code>n</code> is the number of time steps. By
multiplying the uniform basis matrix (top panel) by a set of weights
(middle panel), we obtain a non-uniform curve (bottom panel). Note how
the peaks (troughs) in the output are associated with large positive
(negative) weights.</p>
<p>Now we want to transform the output of the (matrix) product of the
RBF matrix and the weights vector into a time-series for the
transmission rate,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>.
Although we could just use the output vector as the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
time series, it is more convenient to transform it so that the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
values yield more interesting dynamics in an SIR model. In particular,
our model for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\beta_t</annotation></semantics></math>
as a function of time,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>,
is</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>β</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>γ</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>N</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>x</mi><mi>t</mi></msub><mi>b</mi></mrow><annotation encoding="application/x-tex">
\log(\beta_t) = \log(\gamma_t) + \log(N) - \log(S_t) + x_tb
</annotation></semantics></math></p>
<p>Here we have the recovery rate,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\gamma_t</annotation></semantics></math>,
and number of susceptibles,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>S</mi><mi>t</mi></msub><annotation encoding="application/x-tex">S_t</annotation></semantics></math>,
at time,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>,
the total population,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>,
and the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>th
row of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mi>t</mi></msub><annotation encoding="application/x-tex">x_t</annotation></semantics></math>.
To better understand the rationale for this equation note that if every
element of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>
is set to zero, we have the following condition.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><msub><mi>β</mi><mi>t</mi></msub><msub><mi>S</mi><mi>t</mi></msub></mrow><mi>N</mi></mfrac><mo>=</mo><msub><mi>γ</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">
\frac{\beta_t S_t}{N} = \gamma_t
</annotation></semantics></math></p>
<p>This condition assures that the number of infected individuals
remains constant at time,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.
This means that positive values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>
will tend to generate outbreaks and negative values will tend to reduce
transmission.</p>
<p><strong>fixme</strong>: I (BMB) understand why you’re setting the
model up this way, but it’s an odd/non-standard setup - may confuse
people who are already familiar with epidemic models (it confused me
initially).</p>
<p>Here is a simulation model with a radial basis for exogenous
transmission rate dynamics.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span></span>
<span><span class="va">spec_waning</span> <span class="op">=</span> <span class="op">(</span><span class="va">sir_waning</span></span>
<span>             <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_tmb_insert.html">mp_tmb_insert</a></span><span class="op">(</span></span>
<span>                 phase <span class="op">=</span> <span class="st">"before"</span></span>
<span>               , at <span class="op">=</span> <span class="cn">Inf</span></span>
<span>               , expressions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">eta</span> <span class="op">~</span> <span class="va">gamma</span> <span class="op">*</span> <span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span>               , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>eta <span class="op">=</span> <span class="va">empty_matrix</span>, X <span class="op">=</span> <span class="va">X</span>, b <span class="op">=</span> <span class="va">b</span><span class="op">)</span></span>
<span>             <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_tmb_insert.html">mp_tmb_insert</a></span><span class="op">(</span></span>
<span>                 phase <span class="op">=</span> <span class="st">"during"</span></span>
<span>               , at <span class="op">=</span> <span class="fl">1</span></span>
<span>               , expressions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">beta</span>  <span class="op">~</span> <span class="va">eta</span><span class="op">[</span><span class="fu"><a href="../reference/engine_functions.html">time_step</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="../reference/engine_functions.html">clamp</a></span><span class="op">(</span><span class="va">S</span><span class="op">/</span><span class="va">N</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span>
<span>             <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">simulator_waning</span> <span class="op">=</span> <span class="op">(</span><span class="va">spec_waning</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span></span>
<span>    time_steps <span class="op">=</span> <span class="va">n</span></span>
<span>  , outputs <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>, <span class="st">"infection"</span>, <span class="st">"beta"</span><span class="op">)</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      N <span class="op">=</span> <span class="fl">100000</span>, I <span class="op">=</span> <span class="fl">500</span>, R <span class="op">=</span> <span class="fl">0</span></span>
<span>    , beta <span class="op">=</span> <span class="fl">1</span>, gamma <span class="op">=</span> <span class="fl">0.2</span>, phi <span class="op">=</span> <span class="fl">0.01</span></span>
<span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">simulator_waning</span><span class="op">)</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: S ~ N - I - R</span></span>
<span><span class="co">#&gt; 2: eta ~ gamma * exp(X %*% b)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to 2500):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: beta ~ eta[time_step(1)]/clamp(S/N, 1/100)</span></span>
<span><span class="co">#&gt; 2: infection ~ S * I * beta/N</span></span>
<span><span class="co">#&gt; 3: recovery ~ gamma * I</span></span>
<span><span class="co">#&gt; 4: waning_immunity ~ phi * R</span></span>
<span><span class="co">#&gt; 5: S ~ S - infection + waning_immunity</span></span>
<span><span class="co">#&gt; 6: I ~ I + infection - recovery</span></span>
<span><span class="co">#&gt; 7: R ~ R + recovery - waning_immunity</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">simulator_waning</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">matrix</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span></span>
<span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_files/figure-html/plot_rbf-1.png" width="576"></p>
<div class="section level3">
<h3 id="calibration">Calibration<a class="anchor" aria-label="anchor" href="#calibration"></a>
</h3>
<p>We can perform calibration with a time-varying parameter specified
with a radial basis, by using the function
<code><a href="../reference/mp_rbf.html">macpan2::mp_rbf()</a></code>. We follow the ususal steps in
calibration.</p>
<p>1. Simulate from the model and add some poisson noise:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs_rbf</span> <span class="op">=</span> <span class="op">(</span><span class="va">simulator_waning</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span><span class="op">==</span><span class="st">"I"</span><span class="op">)</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="va">value</span>, <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">rpois</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>2. Add calibration information.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calib_rbf</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_calibrator.html">mp_tmb_calibrator</a></span><span class="op">(</span><span class="va">sir_waning</span></span>
<span>   , data <span class="op">=</span> <span class="va">obs_rbf</span></span>
<span>   , traj <span class="op">=</span> <span class="st">"I"</span></span>
<span>   <span class="co">## estimate </span></span>
<span>   , par <span class="op">=</span> <span class="st">"beta"</span></span>
<span>   , tv <span class="op">=</span> <span class="fu"><a href="../reference/mp_rbf.html">mp_rbf</a></span><span class="op">(</span><span class="st">"beta"</span>, dimension <span class="op">=</span> <span class="va">d</span>, initial_weights <span class="op">=</span> <span class="va">b</span><span class="op">)</span></span>
<span>   <span class="co">## pass all defaults, including dimension of the rbf `d` and initial weights vector `b`</span></span>
<span>   , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fl">100000</span>, I <span class="op">=</span> <span class="fl">500</span>, R <span class="op">=</span> <span class="fl">0</span>, beta <span class="op">=</span> <span class="fl">1</span>, gamma <span class="op">=</span> <span class="fl">0.2</span>, phi <span class="op">=</span> <span class="fl">0.01</span>, d <span class="op">=</span> <span class="va">d</span>, b <span class="op">=</span> <span class="va">b</span><span class="op">)</span></span>
<span></span>
<span>  </span>
<span><span class="op">)</span>   </span>
<span><span class="fu"><a href="../reference/mp_optimize.html">mp_optimize</a></span><span class="op">(</span><span class="va">calib_rbf</span><span class="op">)</span></span>
<span><span class="co">#&gt; outer mgc:  260404.5 </span></span>
<span><span class="co">#&gt; outer mgc:  516278.6 </span></span>
<span><span class="co">#&gt; outer mgc:  587174.9 </span></span>
<span><span class="co">#&gt; outer mgc:  650089 </span></span>
<span><span class="co">#&gt; outer mgc:  551580.4 </span></span>
<span><span class="co">#&gt; outer mgc:  577141 </span></span>
<span><span class="co">#&gt; outer mgc:  544591 </span></span>
<span><span class="co">#&gt; outer mgc:  343582.7 </span></span>
<span><span class="co">#&gt; outer mgc:  219354.8 </span></span>
<span><span class="co">#&gt; outer mgc:  474385.6 </span></span>
<span><span class="co">#&gt; outer mgc:  759175.8 </span></span>
<span><span class="co">#&gt; outer mgc:  1981896 </span></span>
<span><span class="co">#&gt; outer mgc:  572674.8 </span></span>
<span><span class="co">#&gt; outer mgc:  130718.1 </span></span>
<span><span class="co">#&gt; outer mgc:  11623.46 </span></span>
<span><span class="co">#&gt; outer mgc:  2573.963 </span></span>
<span><span class="co">#&gt; outer mgc:  250.8778 </span></span>
<span><span class="co">#&gt; outer mgc:  3.075834 </span></span>
<span><span class="co">#&gt; outer mgc:  0.0004771355 </span></span>
<span><span class="co">#&gt; outer mgc:  1.20179e-08</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;      params      params      params      params      params      params </span></span>
<span><span class="co">#&gt; -1.27641280 -0.23972069 -0.88918700 -0.48246900 -0.71662892 -0.54489211 </span></span>
<span><span class="co">#&gt;      params      params      params      params      params      params </span></span>
<span><span class="co">#&gt; -0.66403205 -0.55987089 -0.60953016 -0.48826067 -0.53743851 -0.35883656 </span></span>
<span><span class="co">#&gt;      params      params      params      params      params      params </span></span>
<span><span class="co">#&gt;  0.01438706 -0.51734442 -0.50528656 -0.51390784 -0.56715449 -0.36571049 </span></span>
<span><span class="co">#&gt;      params      params      params </span></span>
<span><span class="co">#&gt; -0.67953264  0.38050808  0.55256297 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 30057.53</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 20</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       33       20 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "both X-convergence and relative convergence (5)"</span></span>
<span><span class="co">## check estimates</span></span>
<span><span class="fu"><a href="../reference/mp_tmb_coef.html">mp_tmb_coef</a></span><span class="op">(</span><span class="va">calib_rbf</span>,conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; outer mgc:  1.20179e-08 </span></span>
<span><span class="co">#&gt; outer mgc:  10106.35 </span></span>
<span><span class="co">#&gt; outer mgc:  10244.65 </span></span>
<span><span class="co">#&gt; outer mgc:  18039.69 </span></span>
<span><span class="co">#&gt; outer mgc:  18377.17 </span></span>
<span><span class="co">#&gt; outer mgc:  17661.5 </span></span>
<span><span class="co">#&gt; outer mgc:  18052.09 </span></span>
<span><span class="co">#&gt; outer mgc:  17007.5 </span></span>
<span><span class="co">#&gt; outer mgc:  17390.3 </span></span>
<span><span class="co">#&gt; outer mgc:  12227.71 </span></span>
<span><span class="co">#&gt; outer mgc:  12481.76 </span></span>
<span><span class="co">#&gt; outer mgc:  9350.09 </span></span>
<span><span class="co">#&gt; outer mgc:  9523.219 </span></span>
<span><span class="co">#&gt; outer mgc:  8689.409 </span></span>
<span><span class="co">#&gt; outer mgc:  8849.081 </span></span>
<span><span class="co">#&gt; outer mgc:  7212.485 </span></span>
<span><span class="co">#&gt; outer mgc:  7337.635 </span></span>
<span><span class="co">#&gt; outer mgc:  4499.09 </span></span>
<span><span class="co">#&gt; outer mgc:  4557.787 </span></span>
<span><span class="co">#&gt; outer mgc:  2639.332 </span></span>
<span><span class="co">#&gt; outer mgc:  2663.877 </span></span>
<span><span class="co">#&gt; outer mgc:  1474.115 </span></span>
<span><span class="co">#&gt; outer mgc:  1484.504 </span></span>
<span><span class="co">#&gt; outer mgc:  630.3664 </span></span>
<span><span class="co">#&gt; outer mgc:  632.9975 </span></span>
<span><span class="co">#&gt; outer mgc:  367.2692 </span></span>
<span><span class="co">#&gt; outer mgc:  368.5147 </span></span>
<span><span class="co">#&gt; outer mgc:  926.993 </span></span>
<span><span class="co">#&gt; outer mgc:  932.217 </span></span>
<span><span class="co">#&gt; outer mgc:  2072.398 </span></span>
<span><span class="co">#&gt; outer mgc:  2092.068 </span></span>
<span><span class="co">#&gt; outer mgc:  2411.296 </span></span>
<span><span class="co">#&gt; outer mgc:  2433.905 </span></span>
<span><span class="co">#&gt; outer mgc:  2161.669 </span></span>
<span><span class="co">#&gt; outer mgc:  2180.24 </span></span>
<span><span class="co">#&gt; outer mgc:  1396.096 </span></span>
<span><span class="co">#&gt; outer mgc:  1405.354 </span></span>
<span><span class="co">#&gt; outer mgc:  696.5062 </span></span>
<span><span class="co">#&gt; outer mgc:  699.8151 </span></span>
<span><span class="co">#&gt; outer mgc:  211.0486 </span></span>
<span><span class="co">#&gt; outer mgc:  211.5534 </span></span>
<span><span class="co">#&gt; outer mgc:  89.27029 </span></span>
<span><span class="co">#&gt; outer mgc:  90.08174 </span></span>
<span><span class="co">#&gt; outer mgc:  7442.986</span></span>
<span><span class="co">#&gt;         term           mat row col       default  type    estimate   std.error</span></span>
<span><span class="co">#&gt; 1     params time_var_beta   0   0 -0.0062645381 fixed -1.27641280 0.001463832</span></span>
<span><span class="co">#&gt; 2   params.1 time_var_beta   1   0  0.0018364332 fixed -0.23972069 0.001977560</span></span>
<span><span class="co">#&gt; 3  params.10 time_var_beta  10   0  0.0151178117 fixed -0.53743851 0.002792037</span></span>
<span><span class="co">#&gt; 4  params.11 time_var_beta  11   0  0.0038984324 fixed -0.35883656 0.003704611</span></span>
<span><span class="co">#&gt; 5  params.12 time_var_beta  12   0 -0.0062124058 fixed  0.01438706 0.004098547</span></span>
<span><span class="co">#&gt; 6  params.13 time_var_beta  13   0 -0.0221469989 fixed -0.51734442 0.003224495</span></span>
<span><span class="co">#&gt; 7  params.14 time_var_beta  14   0  0.0112493092 fixed -0.50528656 0.002548279</span></span>
<span><span class="co">#&gt; 8  params.15 time_var_beta  15   0 -0.0004493361 fixed -0.51390784 0.002403806</span></span>
<span><span class="co">#&gt; 9  params.16 time_var_beta  16   0 -0.0001619026 fixed -0.56715449 0.002599612</span></span>
<span><span class="co">#&gt; 10 params.17 time_var_beta  17   0  0.0094383621 fixed -0.36571049 0.003240611</span></span>
<span><span class="co">#&gt; 11 params.18 time_var_beta  18   0  0.0082122120 fixed -0.67953264 0.004104058</span></span>
<span><span class="co">#&gt; 12 params.19 time_var_beta  19   0  0.0059390132 fixed  0.38050808 0.004919260</span></span>
<span><span class="co">#&gt; 13  params.2 time_var_beta   2   0 -0.0083562861 fixed -0.88918700 0.002074339</span></span>
<span><span class="co">#&gt; 14 params.20 prior_sd_beta   0   0  1.0000000000 fixed  0.55256297 0.003339349</span></span>
<span><span class="co">#&gt; 15  params.3 time_var_beta   3   0  0.0159528080 fixed -0.48246900 0.001927518</span></span>
<span><span class="co">#&gt; 16  params.4 time_var_beta   4   0  0.0032950777 fixed -0.71662892 0.001755581</span></span>
<span><span class="co">#&gt; 17  params.5 time_var_beta   5   0 -0.0082046838 fixed -0.54489211 0.001597672</span></span>
<span><span class="co">#&gt; 18  params.6 time_var_beta   6   0  0.0048742905 fixed -0.66403205 0.001506794</span></span>
<span><span class="co">#&gt; 19  params.7 time_var_beta   7   0  0.0073832471 fixed -0.55987089 0.001518645</span></span>
<span><span class="co">#&gt; 20  params.8 time_var_beta   8   0  0.0057578135 fixed -0.60953016 0.001727385</span></span>
<span><span class="co">#&gt; 21  params.9 time_var_beta   9   0 -0.0030538839 fixed -0.48826067 0.002143931</span></span>
<span><span class="co">#&gt;        conf.low   conf.high</span></span>
<span><span class="co">#&gt; 1  -1.279281858 -1.27354374</span></span>
<span><span class="co">#&gt; 2  -0.243596641 -0.23584475</span></span>
<span><span class="co">#&gt; 3  -0.542910801 -0.53196622</span></span>
<span><span class="co">#&gt; 4  -0.366097459 -0.35157565</span></span>
<span><span class="co">#&gt; 5   0.006354052  0.02242006</span></span>
<span><span class="co">#&gt; 6  -0.523664313 -0.51102453</span></span>
<span><span class="co">#&gt; 7  -0.510281099 -0.50029203</span></span>
<span><span class="co">#&gt; 8  -0.518619216 -0.50919647</span></span>
<span><span class="co">#&gt; 9  -0.572249636 -0.56205934</span></span>
<span><span class="co">#&gt; 10 -0.372061971 -0.35935901</span></span>
<span><span class="co">#&gt; 11 -0.687576449 -0.67148884</span></span>
<span><span class="co">#&gt; 12  0.370866505  0.39014965</span></span>
<span><span class="co">#&gt; 13 -0.893252629 -0.88512137</span></span>
<span><span class="co">#&gt; 14  0.546017962  0.55910797</span></span>
<span><span class="co">#&gt; 15 -0.486246869 -0.47869114</span></span>
<span><span class="co">#&gt; 16 -0.720069797 -0.71318804</span></span>
<span><span class="co">#&gt; 17 -0.548023491 -0.54176073</span></span>
<span><span class="co">#&gt; 18 -0.666985316 -0.66107879</span></span>
<span><span class="co">#&gt; 19 -0.562847379 -0.55689440</span></span>
<span><span class="co">#&gt; 20 -0.612915777 -0.60614455</span></span>
<span><span class="co">#&gt; 21 -0.492462697 -0.48405864</span></span></code></pre></div>
<p>3. Review results.</p>
<p>The fit to the observed data looks reasonable, however there are some
obvious wiggly deviations.</p>
<p><img src="time_varying_parameters_files/figure-html/rbf_fit_plot-1.png" width="576"></p>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-bolker2008" class="csl-entry">
Bolker, Benjamin M. 2008. <em>Ecological Models and Data in
<span>R</span></em>. Princeton: Princeton University Press. <a href="https://doi.org/doi:10.1515/9781400840908" class="external-link">https://doi.org/doi:10.1515/9781400840908</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Walker, Weiguang Guan, Ben Bolker, Jen Freeman, Darren Flynn-Primrose.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
