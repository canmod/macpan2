<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Fitting to Real Data • macpan2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fitting to Real Data">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.10.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/quickstart.html">Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/example_models.html">Example Models</a></li>
    <li><a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a></li>
    <li><a class="dropdown-item" href="../articles/real_data.html">Fitting to Real Data</a></li>
    <li><a class="dropdown-item" href="../articles/state_updaters.html">ODE Solvers, Process Error, and Difference Equations</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Fitting to Real Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/main/vignettes/real_data.Rmd" class="external-link"><code>vignettes/real_data.Rmd</code></a></small>
      <div class="d-none name"><code>real_data.Rmd</code></div>
    </div>

    
    
<p><a href="https://canmod.github.io/macpan2/articles/vignette-status#mature-draft"><img src="https://img.shields.io/badge/status-mature%20draft-yellow" alt="status"></a></p>
<p>The <code><a href="../articles/quickstart.html">vignette("quickstart")</a></code> and
<code><a href="../articles/calibration.html">vignette("calibration")</a></code> articles work with simulated data,
but it is more interesting to fit models to real data. The <a href="https://canmod.github.io/iidda-tools/iidda.api" class="external-link">International
Infectious Disease Data Archive (IIDDA)</a> is a useful place to look
for incidence, mortality, and population data for illustrating
<code>macpan2</code>. This archive contains data from <a href="http://canmod.net/digitization" class="external-link">this data digitization
project</a>, which we will use here. What we find is that with real
data, even with relatively simple models and calibration problems,
issues can arise that require careful thought.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>As usual we need the following packages. If you don’t have them,
please get them in the usual way (i.e. using
<code>install.packages</code>).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://canmod.github.io/macpan2/">macpan2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed" class="external-link">broom.mixed</a></span><span class="op">)</span></span></code></pre></div>
<p>In addition, we need the <code>iidda.api</code> package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://canmod.github.io/iidda-tools/iidda.api" class="external-link">iidda.api</a></span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">repos</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"https://canmod.r-universe.dev"</span></span>
<span>    , <span class="st">"https://cran.r-project.org"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"iidda.api"</span>, repos <span class="op">=</span> <span class="va">repos</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Warning in check_rapiclient(): Your installation of rapiclient does not support</span></span>
<span><span class="co">#&gt; passing vectors to the arguments of iidda.api functions. If you wish to pass</span></span>
<span><span class="co">#&gt; vectors, please follow installation instructions for rapiclient here:</span></span>
<span><span class="co">#&gt; https://canmod.r-universe.dev/rapiclient</span></span>
<span><span class="va">api_hook</span> <span class="op">=</span> <span class="fu">iidda.api</span><span class="fu">::</span><span class="va"><a href="https://canmod.github.io/iidda-tools/iidda.api/reference/ops.html" class="external-link">ops_staging</a></span></span></code></pre></div>
<p>And we set a few options for convenience.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>iidda_api_msgs <span class="op">=</span> <span class="cn">FALSE</span>, macpan2_verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="one-scarlet-fever-outbreak-in-ontario">One Scarlet Fever Outbreak in Ontario<a class="anchor" aria-label="anchor" href="#one-scarlet-fever-outbreak-in-ontario"></a>
</h2>
<p>The following code will pull data for a single scarlet fever outbreak
in Ontario that ended in 1930.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scarlet_fever_ontario</span> <span class="op">=</span> <span class="va">api_hook</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span></span>
<span>    resource_type <span class="op">=</span> <span class="st">"Compilation"</span></span>
<span>  , dataset_ids <span class="op">=</span> <span class="st">"canmod-cdi-harmonized"</span></span>
<span>  , iso_3166_2 <span class="op">=</span> <span class="st">"CA-ON"</span>  <span class="co">## get ontario data</span></span>
<span>  , time_scale <span class="op">=</span> <span class="st">"wk"</span>  <span class="co">## weekly incidence data only </span></span>
<span>  , disease <span class="op">=</span> <span class="st">"scarlet-fever"</span></span>
<span>  </span>
<span>  <span class="co"># get data between 1929-08-01 and 1930-10-01</span></span>
<span>  , period_end_date <span class="op">=</span> <span class="st">"1929-08-01..1930-10-01"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">scarlet_fever_ontario</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 61 × 18</span></span></span>
<span><span class="co">#&gt;    basal_disease cases_this_period dataset_id            digitization_id disease</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                 <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> scarlet-fever                23 canmod-cdi-harmonized cdi_sf_ca_1924… scarle…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> scarlet-fever                27 canmod-cdi-harmonized cdi_sf_ca_1924… scarle…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> scarlet-fever                47 canmod-cdi-harmonized cdi_sf_ca_1924… scarle…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> scarlet-fever                24 canmod-cdi-harmonized cdi_sf_ca_1924… scarle…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> scarlet-fever                24 canmod-cdi-harmonized cdi_sf_ca_1924… scarle…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> scarlet-fever                45 canmod-cdi-harmonized cdi_sf_ca_1924… scarle…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> scarlet-fever                57 canmod-cdi-harmonized cdi_sf_ca_1924… scarle…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> scarlet-fever                46 canmod-cdi-harmonized cdi_sf_ca_1924… scarle…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> scarlet-fever                45 canmod-cdi-harmonized cdi_sf_ca_1924… scarle…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> scarlet-fever                67 canmod-cdi-harmonized cdi_sf_ca_1924… scarle…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 51 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 13 more variables: historical_disease &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   historical_disease_family &lt;chr&gt;, historical_disease_subclass &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   iso_3166 &lt;chr&gt;, iso_3166_2 &lt;chr&gt;, location &lt;chr&gt;, location_type &lt;chr&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   nesting_disease &lt;chr&gt;, original_dataset_id &lt;chr&gt;, period_end_date &lt;date&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   period_start_date &lt;date&gt;, scan_id &lt;chr&gt;, time_scale &lt;chr&gt;</span></span></span></code></pre></div>
<p>This is what the data looks like.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">scarlet_fever_ontario</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">period_end_date</span>, <span class="va">cases_this_period</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Scarlet Fever Incidence in Ontario, Canada"</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="real_data_files/figure-html/scarlet_fever_ontario_plot-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="sir-model">SIR Model<a class="anchor" aria-label="anchor" href="#sir-model"></a>
</h2>
<p>We will begin by pulling the simple sir model from the model
library.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_library.html">mp_tmb_library</a></span><span class="op">(</span><span class="st">"starter_models"</span>, <span class="st">"sir"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">sir</span><span class="op">)</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Default values:</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt;  matrix row col value</span></span>
<span><span class="co">#&gt;    beta           0.2</span></span>
<span><span class="co">#&gt;   gamma           0.1</span></span>
<span><span class="co">#&gt;       N         100.0</span></span>
<span><span class="co">#&gt;       I           1.0</span></span>
<span><span class="co">#&gt;       R           0.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: S ~ N - I - R</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to T):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: mp_per_capita_flow(from = "S", to = "I", rate = infection ~ I * </span></span>
<span><span class="co">#&gt;      beta/N)</span></span>
<span><span class="co">#&gt; 2: mp_per_capita_flow(from = "I", to = "R", rate = recovery ~ gamma)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="modify-model-for-reality">Modify Model for Reality<a class="anchor" aria-label="anchor" href="#modify-model-for-reality"></a>
</h2>
<p>Once we take any library model off the shelf we need to modify it a
bit to be more realistic. We do this with the
<code><a href="../reference/mp_tmb_insert.html">mp_tmb_insert()</a></code> function, which inserts new default values
and model expressions.</p>
<p>We first change the population size to the population of Ontario at
the time.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ontario_population</span> <span class="op">=</span> <span class="va">api_hook</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span></span>
<span>    resource_type <span class="op">=</span> <span class="st">"Compilation"</span></span>
<span>  , dataset_ids <span class="op">=</span> <span class="st">"canmod-pop-normalized"</span></span>
<span>  , iso_3166_2 <span class="op">=</span> <span class="st">"CA-ON"</span>  <span class="co">## get ontario data</span></span>
<span>  </span>
<span>  <span class="co"># get data between 1929-08-01 and 1930-10-01</span></span>
<span>  , date <span class="op">=</span> <span class="st">"1929-08-01..1930-10-01"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sf_sir</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_insert.html">mp_tmb_insert</a></span><span class="op">(</span><span class="va">sir</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">ontario_population</span><span class="op">$</span><span class="va">population</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Second, our SIR model assumes that all of the cases are recorded in
the data, but this is not realistic. We therefore modify the model to
include under-reporting, by creating a case <code>reports</code>
variable that is given by the product of incidence (i.e. weekly
<code>infection</code> rate) and a reporting probability.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sf_sir</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_insert.html">mp_tmb_insert</a></span><span class="op">(</span><span class="va">sf_sir</span></span>
<span>    <span class="co">## insert this expression ...</span></span>
<span>  , expressions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">reports</span> <span class="op">~</span> <span class="va">infection</span> <span class="op">*</span> <span class="va">report_prob</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## at the end (i.e. Infinity) of the expressions evaluated</span></span>
<span>    <span class="co">## 'during' each iteration of the simulation loop ...</span></span>
<span>  , at <span class="op">=</span> <span class="cn">Inf</span>  </span>
<span>  , phase <span class="op">=</span> <span class="st">"during"</span></span>
<span>  </span>
<span>    <span class="co">## add a new default value for the reporting probability</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>report_prob <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">300</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here we can print out the modified model to see if our changes were
made successfully.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">sf_sir</span><span class="op">)</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Default values:</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt;       matrix row col        value</span></span>
<span><span class="co">#&gt;         beta         2.000000e-01</span></span>
<span><span class="co">#&gt;        gamma         1.000000e-01</span></span>
<span><span class="co">#&gt;            N         3.393512e+06</span></span>
<span><span class="co">#&gt;            I         1.000000e+00</span></span>
<span><span class="co">#&gt;            R         0.000000e+00</span></span>
<span><span class="co">#&gt;  report_prob         3.333333e-03</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: S ~ N - I - R</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to T):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: mp_per_capita_flow(from = "S", to = "I", rate = infection ~ I * </span></span>
<span><span class="co">#&gt;      beta/N)</span></span>
<span><span class="co">#&gt; 2: mp_per_capita_flow(from = "I", to = "R", rate = recovery ~ gamma)</span></span>
<span><span class="co">#&gt; 3: reports ~ infection * report_prob</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="preparing-the-data">Preparing the Data<a class="anchor" aria-label="anchor" href="#preparing-the-data"></a>
</h2>
<p>The first step in preparing data for <code>macpan2</code> is to
simulate from the model that you are considering. Here we simulate the
<code>"reports"</code> variable because it corresponds to the reported
incidence (the number of new cases per time-step, which in our case is
one week, multiplied by a reporting probability).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_simulator</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span><span class="va">sf_sir</span></span>
<span>  , time_steps <span class="op">=</span> <span class="fl">5</span></span>
<span>  , outputs <span class="op">=</span> <span class="st">"reports"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="va">sir_simulator</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;    matrix time row col        value</span></span>
<span><span class="co">#&gt; 1 reports    1   0   0 0.0006666665</span></span>
<span><span class="co">#&gt; 2 reports    2   0   0 0.0007333330</span></span>
<span><span class="co">#&gt; 3 reports    3   0   0 0.0008066662</span></span>
<span><span class="co">#&gt; 4 reports    4   0   0 0.0008873327</span></span>
<span><span class="co">#&gt; 5 reports    5   0   0 0.0009760658</span></span></code></pre></div>
<p>The next step is to get our data into a format that is compatible
with the format of these simulations. In particular, we need
<code>matrix</code>, <code>time</code>, and <code>value</code> columns.
We can omit the <code>row</code> and <code>col</code> columns, because
all of the ‘matrices’ in the model are 1-by-1 scalars.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">observed_data</span> <span class="op">=</span> <span class="op">(</span><span class="va">scarlet_fever_ontario</span></span>
<span>  <span class="co">## select the variables to be modelled -- a time-series of case reports.</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">period_end_date</span>, <span class="va">cases_this_period</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## change the column headings so that they match the columns</span></span>
<span>  <span class="co">## in the simulated trajectories.</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>matrix <span class="op">=</span> <span class="st">"reports"</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>value <span class="op">=</span> <span class="va">cases_this_period</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## create a `time` column with the time-step IDs that will correspond</span></span>
<span>  <span class="co">## to the time-steps in the simulation. this column heading also </span></span>
<span>  <span class="co">## must match the column with the time-steps in the simulated trajectories</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">period_end_date</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">observed_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 4</span></span></span>
<span><span class="co">#&gt;   period_end_date value matrix   time</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 1929-08-03         23 reports     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 1929-08-10         27 reports     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 1929-08-17         47 reports     3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 1929-08-24         24 reports     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 1929-08-31         24 reports     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 1929-09-07         45 reports     6</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="set-up-the-optimizer">Set up the Optimizer<a class="anchor" aria-label="anchor" href="#set-up-the-optimizer"></a>
</h2>
<p>Now we can create an object that can be calibrated.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_cal</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_calibrator.html">mp_tmb_calibrator</a></span><span class="op">(</span></span>
<span>    spec <span class="op">=</span> <span class="va">sf_sir</span></span>
<span>  , data <span class="op">=</span> <span class="va">observed_data</span></span>
<span>  </span>
<span>  <span class="co">## name the trajectory variable, with a name that</span></span>
<span>  <span class="co">## is the same in both the spec and the data</span></span>
<span>  , traj <span class="op">=</span> <span class="st">"reports"</span>  </span>
<span>  </span>
<span>  <span class="co">## fit the following parameters</span></span>
<span>  , par <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="st">"gamma"</span>, <span class="st">"I"</span>, <span class="st">"report_prob"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here we assert that we will fit <code>beta</code>,
<code>gamma</code>, (the initial value of) <code>I</code>, and
<code>report_prob</code>. Note that we can only choose to fit parameters
in the <code>default</code> list of the model spec. In particular,
<code>I</code> is in the default list because the model requires the
initial number of infectious individuals, whereas <code>S</code> is not
because it is derived before the simulation loop as
<code>S ~ N - I - R</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">sf_sir</span><span class="op">)</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Default values:</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt;       matrix row col        value</span></span>
<span><span class="co">#&gt;         beta         2.000000e-01</span></span>
<span><span class="co">#&gt;        gamma         1.000000e-01</span></span>
<span><span class="co">#&gt;            N         3.393512e+06</span></span>
<span><span class="co">#&gt;            I         1.000000e+00</span></span>
<span><span class="co">#&gt;            R         0.000000e+00</span></span>
<span><span class="co">#&gt;  report_prob         3.333333e-03</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: S ~ N - I - R</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to T):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: mp_per_capita_flow(from = "S", to = "I", rate = infection ~ I * </span></span>
<span><span class="co">#&gt;      beta/N)</span></span>
<span><span class="co">#&gt; 2: mp_per_capita_flow(from = "I", to = "R", rate = recovery ~ gamma)</span></span>
<span><span class="co">#&gt; 3: reports ~ infection * report_prob</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-the-optimization">Run the Optimization<a class="anchor" aria-label="anchor" href="#run-the-optimization"></a>
</h2>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_opt</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_optimize.html">mp_optimize</a></span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span></code></pre></div>
<p>Not off to a good start. Those warnings are not necessarily bad, but
they might get us thinking.</p>
</div>
<div class="section level2">
<h2 id="examine-the-fit">Examine the fit<a class="anchor" aria-label="anchor" href="#examine-the-fit"></a>
</h2>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">sir_opt</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;     params     params     params     params </span></span>
<span><span class="co">#&gt; 34.7694070 34.6536331  2.0572289  0.3480618 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 428.1971</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 143</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;      200      144 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "function evaluation limit reached without convergence (9)"</span></span></code></pre></div>
<p>OK, things are not great. The <code>convergence</code> code is
<code>1</code>, indicating that the model did <em>not</em> converge
(<code>convergence == 0</code> is good). Examining the parameter
estimates, which are stored internally in the calibrator object, things
get worse.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mp_tmb_coef.html">mp_tmb_coef</a></span><span class="op">(</span><span class="va">sir_cal</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;       term         mat row col     default  type   estimate  std.error</span></span>
<span><span class="co">#&gt; 1   params        beta   0   0 0.200000000 fixed 34.7694070 25.7158953</span></span>
<span><span class="co">#&gt; 2 params.1       gamma   0   0 0.100000000 fixed 34.6536331 25.7160472</span></span>
<span><span class="co">#&gt; 3 params.2           I   0   0 1.000000000 fixed  2.0572289  3.0405887</span></span>
<span><span class="co">#&gt; 4 params.3 report_prob   0   0 0.003333333 fixed  0.3480618  0.2575428</span></span>
<span><span class="co">#&gt;      conf.low  conf.high</span></span>
<span><span class="co">#&gt; 1 -15.6328217 85.1716356</span></span>
<span><span class="co">#&gt; 2 -15.7488932 85.0561594</span></span>
<span><span class="co">#&gt; 3  -3.9022155  8.0166732</span></span>
<span><span class="co">#&gt; 4  -0.1567128  0.8528364</span></span></code></pre></div>
<p>That doesn’t look right! Those are very high <code>beta</code> and
<code>gamma</code> values, and the confidence intervals are enormous and
overlap zero.</p>
<p>But the model fit doesn’t look all that bad.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory_sd</a></span><span class="op">(</span><span class="va">sir_cal</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">observed_data</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span></span>
<span>    , data <span class="op">=</span> <span class="va">fitted_data</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span></span>
<span>    , data <span class="op">=</span> <span class="va">fitted_data</span></span>
<span>    , alpha <span class="op">=</span> <span class="fl">0.2</span></span>
<span>    , colour <span class="op">=</span> <span class="st">"red"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">matrix</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="real_data_files/figure-html/unnamed-chunk-13-1.png" width="672"></p>
<p>What is going on? Can we modify this model and/or fitting procedure
to get both reasonable parameter estimates and a reasonable
trajectory?</p>
</div>
<div class="section level2">
<h2 id="fixing-the-optimization-problem">Fixing the Optimization Problem<a class="anchor" aria-label="anchor" href="#fixing-the-optimization-problem"></a>
</h2>
<p>One way to address the lack of convergence of the optimizer is to
assess the degree to which the parameter estimates are biologically
reasonable. Take the recovery rate, which is estimated as
<code>gamma ~ 26.5</code> per time-step. Given that a time-step is one
week in this model, this estimate implies that individuals recover from
scarlet fever in <code>1/26.5</code> weeks – much less than a day. A
quick search suggests to me that this recovery rate is not reasonable
for scarlet fever, and that a rough guess that the infectious stage
lasts one week is much more plausible than <code>1/26.5</code> weeks.
Now look at the transmission rate, <code>beta</code>. It is also
estimated to be pretty large, but what is more interesting is the large
standard errors for both <code>beta</code> and <code>gamma</code>. These
standard errors suggest that the estimates are not precise. However, the
estimated correlation between <code>beta</code> and <code>gamma</code>
is very close to <code>1</code>, suggesting that many values for these
parameters would fit the data well as long as they are both of similar
magnitude.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mp_tmb_fixef_cov.html">mp_tmb_fixef_cov</a></span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov2cor</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   beta      gamma          I report_prob</span></span>
<span><span class="co">#&gt; beta         1.0000000  1.0000000 -0.9998561   0.9996857</span></span>
<span><span class="co">#&gt; gamma        1.0000000  1.0000000 -0.9998553   0.9996870</span></span>
<span><span class="co">#&gt; I           -0.9998561 -0.9998553  1.0000000  -0.9993009</span></span>
<span><span class="co">#&gt; report_prob  0.9996857  0.9996870 -0.9993009   1.0000000</span></span></code></pre></div>
<p>This diagnosis, if correct, suggests that the data are not
sufficiently informative to identify values for both <code>beta</code>
and <code>gamma</code>. Resolving such identifiability issues is often
best done by introducing prior information, such as our rough guess that
<code>gamma</code> is close to <code>1</code>. The simplest way to
include such prior information is to move <code>gamma</code> out of the
<code>pars</code> argument to <code>mp_tmb_calibrator</code> and into
the <code>default</code> argument, as below.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_cal_assume_gamma</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_calibrator.html">mp_tmb_calibrator</a></span><span class="op">(</span></span>
<span>    spec <span class="op">=</span> <span class="va">sf_sir</span></span>
<span>  , data <span class="op">=</span> <span class="va">observed_data</span></span>
<span>  </span>
<span>  <span class="co">## name the trajectory variable, with a name that</span></span>
<span>  <span class="co">## is the same in both the spec and the data</span></span>
<span>  , traj <span class="op">=</span> <span class="st">"reports"</span>  </span>
<span>  </span>
<span>  <span class="co">## fit the following parameters</span></span>
<span>  , par <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="st">"I"</span>, <span class="st">"report_prob"</span><span class="op">)</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>gamma <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This calibration specification does not try to jointly fit both
<code>beta</code> and <code>gamma</code>, but rather fits only
<code>beta</code> while assuming that <code>gamma = 1</code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_opt_assume_gamma</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_optimize.html">mp_optimize</a></span><span class="op">(</span><span class="va">sir_cal_assume_gamma</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">sir_opt_assume_gamma</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;       params       params       params </span></span>
<span><span class="co">#&gt; 1.121602e+00 1.878305e+03 1.125689e-02 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 430.0021</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 79</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;      131       80 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "relative convergence (4)"</span></span></code></pre></div>
<p>More warnings, but now the optimizer converges. And the standard
errors in the coefficient table and fixed effect correlations seem more
plausible.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mp_tmb_coef.html">mp_tmb_coef</a></span><span class="op">(</span><span class="va">sir_cal_assume_gamma</span><span class="op">)</span></span>
<span><span class="co">#&gt;       term         mat row col     default  type     estimate    std.error</span></span>
<span><span class="co">#&gt; 1   params        beta   0   0 0.200000000 fixed 1.121602e+00 1.801964e-03</span></span>
<span><span class="co">#&gt; 2 params.1           I   0   0 1.000000000 fixed 1.878305e+03 5.445606e+01</span></span>
<span><span class="co">#&gt; 3 params.2 report_prob   0   0 0.003333333 fixed 1.125689e-02 1.927763e-04</span></span>
<span><span class="fu"><a href="../reference/mp_tmb_fixef_cov.html">mp_tmb_fixef_cov</a></span><span class="op">(</span><span class="va">sir_cal_assume_gamma</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov2cor</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   beta          I report_prob</span></span>
<span><span class="co">#&gt; beta         1.0000000 -0.7988821  -0.7608921</span></span>
<span><span class="co">#&gt; I           -0.7988821  1.0000000   0.5802420</span></span>
<span><span class="co">#&gt; report_prob -0.7608921  0.5802420   1.0000000</span></span></code></pre></div>
<p>And the fit looks similar to the four-parameter model, which is
consistent with our diagnosis of non-identifiability.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory_sd</a></span><span class="op">(</span><span class="va">sir_cal_assume_gamma</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">observed_data</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span></span>
<span>    , data <span class="op">=</span> <span class="va">fitted_data</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span></span>
<span>    , data <span class="op">=</span> <span class="va">fitted_data</span></span>
<span>    , alpha <span class="op">=</span> <span class="fl">0.2</span></span>
<span>    , colour <span class="op">=</span> <span class="st">"red"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">matrix</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="real_data_files/figure-html/unnamed-chunk-18-1.png" width="672"></p>
<p>Caution: Ben, what is that paper that you always recommend about
being careful when prior information is included without prior
uncertainty? This one <span class="citation">(<a href="#ref-elderdUncertainty2006">Elderd, Dukic, and Dwyer
2006</a>)</span></p>
</div>
<div class="section level2">
<h2 id="learning-the-functional-form-of-time-variation-in-transmission-new">Learning the Functional form of Time Variation in Transmission
(New!)<a class="anchor" aria-label="anchor" href="#learning-the-functional-form-of-time-variation-in-transmission-new"></a>
</h2>
<p>Let’s get a bit more data to see two seasons.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scarlet_fever_ontario</span> <span class="op">=</span> <span class="va">api_hook</span><span class="op">$</span><span class="fu">filter</span><span class="op">(</span></span>
<span>    resource_type <span class="op">=</span> <span class="st">"Compilation"</span></span>
<span>  , dataset_ids <span class="op">=</span> <span class="st">"canmod-cdi-harmonized"</span></span>
<span>  , iso_3166_2 <span class="op">=</span> <span class="st">"CA-ON"</span>  <span class="co">## get ontario data</span></span>
<span>  , time_scale <span class="op">=</span> <span class="st">"wk"</span>  <span class="co">## weekly incidence data only </span></span>
<span>  , disease <span class="op">=</span> <span class="st">"scarlet-fever"</span></span>
<span>  </span>
<span>  <span class="co"># get data between 1929-08-01 and 1931-10-01</span></span>
<span>  , period_end_date <span class="op">=</span> <span class="st">"1929-08-01..1931-10-01"</span>  </span>
<span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">scarlet_fever_ontario</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">period_end_date</span>, <span class="va">cases_this_period</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Scarlet Fever Incidence in Ontario, Canada"</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="real_data_files/figure-html/unnamed-chunk-19-1.png" width="672"></p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">observed_data</span> <span class="op">=</span> <span class="op">(</span><span class="va">scarlet_fever_ontario</span></span>
<span>  <span class="co">## select the variables to be modelled -- a time-series of case reports.</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">period_end_date</span>, <span class="va">cases_this_period</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## change the column headings so that they match the columns</span></span>
<span>  <span class="co">## in the simulated trajectories.</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>matrix <span class="op">=</span> <span class="st">"reports"</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>value <span class="op">=</span> <span class="va">cases_this_period</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## create a `time` column with the time-step IDs that will correspond</span></span>
<span>  <span class="co">## to the time-steps in the simulation. this column heading also </span></span>
<span>  <span class="co">## must match the column with the time-steps in the simulated trajectories</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">period_end_date</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">observed_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 4</span></span></span>
<span><span class="co">#&gt;   period_end_date value matrix   time</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 1929-08-03         23 reports     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 1929-08-10         27 reports     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 1929-08-17         47 reports     3</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 1929-08-24         24 reports     4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 1929-08-31         24 reports     5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 1929-09-07         45 reports     6</span></span></code></pre></div>
<p>Prepare to fit to the data. We make a function so that we can easily
update the dimension of the radial basis.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_rbf_calibrator</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dimension</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/mp_tmb_calibrator.html">mp_tmb_calibrator</a></span><span class="op">(</span></span>
<span>      spec <span class="op">=</span> <span class="va">sf_sir</span></span>
<span>    , data <span class="op">=</span> <span class="va">observed_data</span></span>
<span>    , traj <span class="op">=</span> <span class="st">"reports"</span>  </span>
<span>    </span>
<span>    <span class="co">## -----------------------------</span></span>
<span>    <span class="co">## this is the key bit</span></span>
<span>    , tv <span class="op">=</span> <span class="fu"><a href="../reference/mp_rbf.html">mp_rbf</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="va">dimension</span><span class="op">)</span></span>
<span>    <span class="co">## -----------------------------</span></span>
<span>    </span>
<span>    , par <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"gamma"</span>, <span class="st">"I"</span>, <span class="st">"report_prob"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>And it is also convenient to make a function for plotting the
results</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_fit</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">cal_object</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">fitted_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory_sd</a></span><span class="op">(</span><span class="va">cal_object</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">(</span><span class="va">observed_data</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span></span>
<span>      , data <span class="op">=</span> <span class="va">fitted_data</span></span>
<span>      , colour <span class="op">=</span> <span class="st">"red"</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span></span>
<span>      , data <span class="op">=</span> <span class="va">fitted_data</span></span>
<span>      , alpha <span class="op">=</span> <span class="fl">0.2</span></span>
<span>      , colour <span class="op">=</span> <span class="st">"red"</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now we try fitting for a number of different dimensions.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_cal</span> <span class="op">=</span> <span class="fu">make_rbf_calibrator</span><span class="op">(</span>dimension <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/mp_optimize.html">mp_optimize</a></span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;       params       params       params       params       params </span></span>
<span><span class="co">#&gt;   1.07372447 365.34139607   0.21804031   0.09069968   0.86580386 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 2897.368</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 150</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;      174      151 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "iteration limit reached without convergence (10)"</span></span>
<span><span class="fu">plot_fit</span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span></code></pre></div>
<p><img src="real_data_files/figure-html/unnamed-chunk-22-1.png" width="672"></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_cal</span> <span class="op">=</span> <span class="fu">make_rbf_calibrator</span><span class="op">(</span>dimension <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/mp_optimize.html">mp_optimize</a></span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;     params     params     params     params     params     params </span></span>
<span><span class="co">#&gt;  0.4662692 15.7705637  8.5178748 -0.5631177 -0.6997072  0.6673706 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 2977.803</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 150</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;      200      150 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "function evaluation limit reached without convergence (9)"</span></span>
<span><span class="fu">plot_fit</span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span></code></pre></div>
<p><img src="real_data_files/figure-html/unnamed-chunk-23-1.png" width="672"></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_cal</span> <span class="op">=</span> <span class="fu">make_rbf_calibrator</span><span class="op">(</span>dimension <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/mp_optimize.html">mp_optimize</a></span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt;  7.480423e-01  7.126562e+03  5.678344e-03 -1.637587e-01 -2.970186e-02 </span></span>
<span><span class="co">#&gt;        params        params </span></span>
<span><span class="co">#&gt;  9.244461e-01  6.246204e-01 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 1574.227</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 67</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       98       68 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "relative convergence (4)"</span></span>
<span><span class="fu">plot_fit</span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span></code></pre></div>
<p><img src="real_data_files/figure-html/unnamed-chunk-24-1.png" width="672"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_cal</span> <span class="op">=</span> <span class="fu">make_rbf_calibrator</span><span class="op">(</span>dimension <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/mp_optimize.html">mp_optimize</a></span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;      params      params      params      params      params      params </span></span>
<span><span class="co">#&gt;  1.24671910 61.38245959  0.16124566  0.40605614 -0.11477326  0.33939236 </span></span>
<span><span class="co">#&gt;      params      params </span></span>
<span><span class="co">#&gt; -0.07429845  0.61040344 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 1601.549</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 129</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;      200      130 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "function evaluation limit reached without convergence (9)"</span></span>
<span><span class="fu">plot_fit</span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span></code></pre></div>
<p><img src="real_data_files/figure-html/unnamed-chunk-25-1.png" width="672"></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_cal</span> <span class="op">=</span> <span class="fu">make_rbf_calibrator</span><span class="op">(</span>dimension <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/mp_optimize.html">mp_optimize</a></span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;       params       params       params       params       params       params </span></span>
<span><span class="co">#&gt; -0.003169677 50.290111756 30.026102089 -4.450364816  1.919450463 -6.177605279 </span></span>
<span><span class="co">#&gt;       params       params       params </span></span>
<span><span class="co">#&gt;  1.776699439 -7.022692636  0.596297469 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 1433.989</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 122</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;      200      122 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "function evaluation limit reached without convergence (9)"</span></span>
<span><span class="fu">plot_fit</span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span></code></pre></div>
<p><img src="real_data_files/figure-html/unnamed-chunk-26-1.png" width="672"></p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_cal</span> <span class="op">=</span> <span class="fu">make_rbf_calibrator</span><span class="op">(</span>dimension <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/mp_optimize.html">mp_optimize</a></span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;     params     params     params     params     params     params     params </span></span>
<span><span class="co">#&gt;  0.7802570  7.7900568  5.2024837 -0.2791101  0.2589907 -0.5956717  0.3101396 </span></span>
<span><span class="co">#&gt;     params     params     params </span></span>
<span><span class="co">#&gt; -0.3747950 -0.1376810  0.5863554 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 1441.466</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 128</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;      200      128 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "function evaluation limit reached without convergence (9)"</span></span>
<span><span class="fu">plot_fit</span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span></code></pre></div>
<p><img src="real_data_files/figure-html/unnamed-chunk-27-1.png" width="672"></p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_cal</span> <span class="op">=</span> <span class="fu">make_rbf_calibrator</span><span class="op">(</span>dimension <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/mp_optimize.html">mp_optimize</a></span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;      params      params      params      params      params      params </span></span>
<span><span class="co">#&gt;  0.02862238 13.83679544  6.50568272 -0.64364604 -1.38502686 -0.17206797 </span></span>
<span><span class="co">#&gt;      params      params      params      params      params </span></span>
<span><span class="co">#&gt; -3.83455289 -0.06296071 -1.56407525 -3.70588098  0.58017538 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 1471.266</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 116</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;      200      116 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "function evaluation limit reached without convergence (9)"</span></span>
<span><span class="fu">plot_fit</span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span></code></pre></div>
<p><img src="real_data_files/figure-html/unnamed-chunk-28-1.png" width="672"></p>
<p>Interestingly we have now managed to fit <code>gamma</code></p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mp_tmb_coef.html">mp_tmb_coef</a></span><span class="op">(</span><span class="va">sir_cal</span><span class="op">)</span></span>
<span><span class="co">#&gt;         term           mat row col     default  type    estimate   std.error</span></span>
<span><span class="co">#&gt; 1     params         gamma   0   0 0.100000000 fixed  0.02862238  0.00652316</span></span>
<span><span class="co">#&gt; 2   params.1             I   0   0 1.000000000 fixed 13.83679544 19.17824368</span></span>
<span><span class="co">#&gt; 3  params.10 prior_sd_beta   0   0 1.000000000 fixed  0.58017538  0.01825558</span></span>
<span><span class="co">#&gt; 4   params.2   report_prob   0   0 0.003333333 fixed  6.50568272  9.02118967</span></span>
<span><span class="co">#&gt; 5   params.3 time_var_beta   0   0 0.000000000 fixed -0.64364604  0.18346250</span></span>
<span><span class="co">#&gt; 6   params.4 time_var_beta   1   0 0.000000000 fixed -1.38502686  0.14960302</span></span>
<span><span class="co">#&gt; 7   params.5 time_var_beta   2   0 0.000000000 fixed -0.17206797  0.11830797</span></span>
<span><span class="co">#&gt; 8   params.6 time_var_beta   3   0 0.000000000 fixed -3.83455289  0.13803399</span></span>
<span><span class="co">#&gt; 9   params.7 time_var_beta   4   0 0.000000000 fixed -0.06296071  0.16608048</span></span>
<span><span class="co">#&gt; 10  params.8 time_var_beta   5   0 0.000000000 fixed -1.56407525  0.10524492</span></span>
<span><span class="co">#&gt; 11  params.9 time_var_beta   6   0 0.000000000 fixed -3.70588098  0.24480729</span></span></code></pre></div>
<p>This is a much slower recovery rate. Expected time in the R box is
about one year! Not believeable, but the point is to make it easier to
fit models so you can try more things.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mp_tmb_calibrator.html">mp_tmb_calibrator</a></span><span class="op">(</span></span>
<span>    spec <span class="op">=</span> <span class="va">sf_sir</span></span>
<span>  , data <span class="op">=</span> <span class="va">observed_data</span></span>
<span>  , traj <span class="op">=</span> <span class="st">"reports"</span>  </span>
<span>  , tv <span class="op">=</span> <span class="fu"><a href="../reference/mp_rbf.html">mp_rbf</a></span><span class="op">(</span><span class="st">"beta"</span>, dimension <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span>
<span>  , par <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"gamma"</span>, <span class="st">"I"</span>, <span class="st">"report_prob"</span><span class="op">)</span></span>
<span>  , outputs <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"reports"</span>, <span class="st">"beta"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: S ~ N - I - R</span></span>
<span><span class="co">#&gt; 2: outputs_var_beta ~ group_sums(values_var_beta * time_var_beta[col_indexes_beta], row_indexes_beta, outputs_var_beta)</span></span>
<span><span class="co">#&gt; 3: outputs_var_beta ~ c(outputs_var_beta[0], outputs_var_beta)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to T):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: beta ~ exp(time_var(outputs_var_beta, data_time_indexes_beta))</span></span>
<span><span class="co">#&gt; 2: infection ~ S * (I * beta/N)</span></span>
<span><span class="co">#&gt; 3: recovery ~ I * (gamma)</span></span>
<span><span class="co">#&gt; 4: S ~ S - infection</span></span>
<span><span class="co">#&gt; 5: I ~ I + infection - recovery</span></span>
<span><span class="co">#&gt; 6: R ~ R + recovery</span></span>
<span><span class="co">#&gt; 7: reports ~ infection * report_prob</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; After the simulation loop (t = T + 1):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: sim_reports ~ rbind_time(reports, obs_times_reports)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Objective function:</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; ~-sum(dpois(obs_reports, clamp(sim_reports))) - sum(dnorm(values_var_beta, 0, prior_sd_beta))</span></span></code></pre></div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-elderdUncertainty2006" class="csl-entry">
Elderd, Bret D., Vanja M. Dukic, and Greg Dwyer. 2006.
<span>“Uncertainty in Predictions of Disease Spread and Public Health
Responses to Bioterrorism and Emerging Diseases.”</span> <em>Proceedings
of the National Academy of Sciences</em> 103 (42): 15693–97. <a href="https://doi.org/10.1073/pnas.0600816103" class="external-link">https://doi.org/10.1073/pnas.0600816103</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Walker, Weiguang Guan, Jen Freeman, Ben Bolker, Darren Flynn-Primrose.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
