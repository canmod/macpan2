<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Engine-Agnostic Model Specification Grammar • macpan2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Engine-Agnostic Model Specification Grammar">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.3.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/quickstart.html">Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/example_models.html">Example Models</a></li>
    <li><a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a></li>
    <li><a class="dropdown-item" href="../articles/real_data.html">Fitting to Real Data</a></li>
    <li><a class="dropdown-item" href="../articles/state_updaters.html">ODE Solvers, Process Error, and Difference Equations</a></li>
    <li><a class="dropdown-item" href="../articles/options.html">Options</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Engine-Agnostic Model Specification Grammar</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/main/vignettes/engine_agnostic_grammar.Rmd" class="external-link"><code>vignettes/engine_agnostic_grammar.Rmd</code></a></small>
      <div class="d-none name"><code>engine_agnostic_grammar.Rmd</code></div>
    </div>

    
    
<p><a href="https://canmod.github.io/macpan2/articles/vignette-status#working-draft"><img src="https://img.shields.io/badge/status-working%20draft-red" alt="status"></a></p>
<p>One of the main goals of <code>macpan2</code> is to provide a
flexible grammar for model specification that reduces friction when
building upon and expanding an existing model. This goal complements the
standard approach of modelling, which is to start simply and add
complexity as needed.</p>
<p>There is a trade-off between the flexibility and the simplicity of
the model grammar: specifying a simple model may not always be very
concise, and there is a learning curve to the model grammar. However, it
can be very powerful when it comes to specifying
<strong>structured</strong> models, especially when they are cast as
expansions of simple models. Such <a href="https://idpjournal.biomedcentral.com/articles/10.1186/s40249-022-01001-y" class="external-link">structured
models</a> can include:</p>
<ul>
<li>multiple pathogen strains</li>
<li>multiple infection types (<em>e.g.</em>, asymptomatic and
symptomatic or mild and severe)</li>
<li>age-structure</li>
<li>multiple locations (a metapopulation model)</li>
<li>testing processes to identify infections</li>
<li>vaccination status</li>
</ul>
<p>This vignette seeks to explain <code>macpan2</code>’s model
specification grammar and in particular how one could take a simple
model and expand it with additional structure.</p>
<div class="section level2">
<h2 id="amuse-bouche">Amuse bouche: a structured SIR model<a class="anchor" aria-label="anchor" href="#amuse-bouche"></a>
</h2>
<p>A key to <code>macpan2</code>’s flexible model grammar is the use of
<strong>functional forms</strong> to repeat the same kinds of
calculations across model structures. For instance, consider an SIR
model that has two pathogen strains (without co-infections):</p>
<p><img src="../reference/figures//two-strain.svg"><!-- --></p>
<p>Here,</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>I</mi><mi>x</mi></msub><annotation encoding="application/x-tex">I_x</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
are the numbers of individuals that are susceptible, infected with
strain
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>A</mi><annotation encoding="application/x-tex">A</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>B</mi><annotation encoding="application/x-tex">B</annotation></semantics></math>),
and recovered, respectively,</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mi>S</mi><mo>+</mo><msub><mi>I</mi><mi>A</mi></msub><mo>+</mo><msub><mi>I</mi><mi>B</mi></msub><mo>+</mo><mi>R</mi></mrow><annotation encoding="application/x-tex">N= S + I_A + I_B + R</annotation></semantics></math>
is the total population size,</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mi>x</mi></msub><annotation encoding="application/x-tex">\beta_x</annotation></semantics></math>
is the transmission rate for strain
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>,</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>γ</mi><annotation encoding="application/x-tex">\gamma</annotation></semantics></math>
is the recovery rate for infected individuals,<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;In this model we are choosing to make the recovery rate
(and hence the infectious period) the same for both strains, but it
would be easy to relax this assumption in the model specification by
following the way in which we stratify the state variable
&lt;math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"&gt;&lt;semantics&gt;&lt;mi&gt;I&lt;/mi&gt;&lt;annotation encoding="application/x-tex"&gt;I&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;
by strain below.&lt;/p&gt;'><sup>1</sup></a>
</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>x</mi></msub><mo>=</mo><msub><mi>β</mi><mi>x</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>x</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><mi>N</mi></mrow><annotation encoding="application/x-tex">\lambda_x = \beta_x (I_x)/N</annotation></semantics></math>
is the force of infection for strain
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>x</mi><annotation encoding="application/x-tex">x</annotation></semantics></math>.</li>
</ul>
<p>We can cast this model as a system of difference equations, since
this is how we will iterate them numerically in our simulation:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>S</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>−</mo><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>β</mi><mi>A</mi></msub><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>A</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>t</mi></msub><mi>/</mi><mi>N</mi><mo>+</mo><msub><mi>β</mi><mi>B</mi></msub><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>B</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>t</mi></msub><mi>/</mi><mi>N</mi><mo stretchy="true" form="postfix">]</mo></mrow><msub><mi>S</mi><mi>t</mi></msub><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>A</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mphantom><mrow><mo>−</mo><mo stretchy="false" form="prefix">[</mo></mrow></mphantom><msub><mi>β</mi><mi>A</mi></msub><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>A</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>t</mi></msub><mi>/</mi><mi>N</mi><mo>−</mo><mi>γ</mi><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>A</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>t</mi></msub><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>B</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mphantom><mrow><mo>−</mo><mo stretchy="false" form="prefix">[</mo></mrow></mphantom><msub><mi>β</mi><mi>B</mi></msub><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>B</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>t</mi></msub><mi>/</mi><mi>N</mi><mo>−</mo><mi>γ</mi><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>B</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>t</mi></msub><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>R</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mphantom><mrow><mo>−</mo><mo stretchy="false" form="prefix">[</mo></mrow></mphantom><mi>γ</mi><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>A</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>t</mi></msub><mo>+</mo><mi>γ</mi><msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>B</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>t</mi></msub><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
S_{t+1} &amp; = - [\beta_A (I_A)_t/N + \beta_B (I_B)_t/N] S_t, \\ 
(I_A)_{t+1} &amp;= \phantom{-[} \beta_A (I_A)_t/N - \gamma (I_A)_t, \\ 
(I_B)_{t+1} &amp;= \phantom{-[} \beta_B (I_B)_t/N - \gamma (I_B)_t, \\ 
R_{t+1} &amp;= \phantom{-[}  \gamma (I_A)_t + \gamma (I_B)_t.
\end{align}</annotation></semantics></math></p>
<p>Each force of infection,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>A</mi></msub><mo>=</mo><msub><mi>β</mi><mi>A</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>A</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><mi>N</mi></mrow><annotation encoding="application/x-tex">\lambda_A = \beta_A (I_A)/N</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>λ</mi><mi>B</mi></msub><mo>=</mo><msub><mi>β</mi><mi>B</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mi>B</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><mi>N</mi></mrow><annotation encoding="application/x-tex">\lambda_B = \beta_B (I_B)/N</annotation></semantics></math>
has the same <strong>functional form</strong>, that is, using an
expression like
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>=</mo><mi>β</mi><mi>I</mi><mi>/</mi><mi>N</mi></mrow><annotation encoding="application/x-tex">\lambda = \beta I / N</annotation></semantics></math>.
When numerically simulating this model, it doesn’t take much effort to
write out each calculation separately as something like:</p>
<pre><code><span><span class="va">lambda.A</span> <span class="op">=</span> <span class="va">beta.A</span> <span class="op">*</span> <span class="va">I.A</span> <span class="op">/</span> <span class="va">N</span></span>
<span><span class="va">lambda.B</span> <span class="op">=</span> <span class="va">beta.B</span> <span class="op">*</span> <span class="va">I.B</span> <span class="op">/</span> <span class="va">N</span></span></code></pre>
<p>However, in <code>macpan2</code>, we can specify a single functional
form for it, for instance</p>
<pre><code><span><span class="va">lambda</span> <span class="op">=</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span></span></code></pre>
<p>and then attach a <strong>ledger</strong> to the model object that
tabulates specific instances of when this functional form is used to
define a component of the model. In other words, this ledger should
enumerate which specific subscripted <code>lambda</code>,
<code>beta</code>, and <code>I</code> to use each time we invoke the
associated functional form during the simulation.</p>
<p>In this case, there would only be two calculations in the force of
infection ledger (one calculation per strain), but one can easily
imagine a more complicated case. For instance, consider a relatively
simple two-city age-structured metapopulation model with 10 age groups
within each of two patches: there would be 10x10x2 = 200 force of
infection terms of the same form (one per combination of age groups to
capture the options for susceptible and infected interaction, repeated
for each of the two patches).</p>
<p><strong>Using functional forms and ledgers allows the modeller to
focus on modelling questions</strong>, like the design of the model
structure and the choice of expressions for the forces of infection,
while <strong><code>macpan2</code> handles the bookkeeping</strong>,
matching stratified variables with each other when calculating
expressions. This approach cuts down on rote repetition when setting up
model calculations, which in turn reduces the opportunity for bugs in
the simulation code. It also means that expanding a model can be as
simple as updating the calculation ledger, rather than error-prone
editing of calculations in the simulation code.</p>
<p>While a modeller could write their own code to cut down on repetition
when expanding a simple model (and many do), <code>macpan2</code>
provides a ready-made model specification grammar that enables easy
model extension, especially when building <a href="https://arxiv.org/abs/2307.10308" class="external-link">product models</a>, and that can
readily interface with fast simulation and calibration engines, like <a href="https://cran.r-project.org/web/packages/TMB/index.html" class="external-link">TMB</a>.</p>
</div>
<div class="section level2">
<h2 id="appetizer-specifying-the-basic-sir-model">Appetizer: specifying the basic SIR model<a class="anchor" aria-label="anchor" href="#appetizer-specifying-the-basic-sir-model"></a>
</h2>
<p>Let’s start with specifying the basic SIR model, the foundation of
the two-strain model above, in <code>macpan2</code>:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>S</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>−</mo><mi>β</mi><msub><mi>S</mi><mi>t</mi></msub><msub><mi>I</mi><mi>t</mi></msub><mi>/</mi><mi>N</mi><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>I</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mphantom><mo>−</mo></mphantom><mi>β</mi><msub><mi>S</mi><mi>t</mi></msub><msub><mi>I</mi><mi>t</mi></msub><mi>/</mi><mi>N</mi><mo>−</mo><mi>γ</mi><msub><mi>I</mi><mi>t</mi></msub><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>R</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mphantom><mo>−</mo></mphantom><mi>γ</mi><msub><mi>I</mi><mi>t</mi></msub><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
S_{t+1} &amp;= -\beta S_t I_t/N, \\ 
I_{t+1} &amp;= \phantom{-} \beta S_t I_t/N - \gamma I_t, \\ 
R_{t+1} &amp;=  \phantom{-} \gamma I_t.
\end{align}</annotation></semantics></math></p>
<p>It will be helpful to set
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>=</mo><mi>β</mi><mi>I</mi><mi>/</mi><mi>N</mi></mrow><annotation encoding="application/x-tex">\lambda = \beta I/N</annotation></semantics></math>
and recast the equations as:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>S</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mo>−</mo><mi>λ</mi><msub><mi>S</mi><mi>t</mi></msub><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>I</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mphantom><mo>−</mo></mphantom><mi>λ</mi><msub><mi>S</mi><mi>t</mi></msub><mo>−</mo><mi>γ</mi><msub><mi>I</mi><mi>t</mi></msub><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>R</mi><mrow><mi>t</mi><mo>+</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><mphantom><mo>−</mo></mphantom><mi>γ</mi><msub><mi>I</mi><mi>t</mi></msub><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
S_{t+1} &amp;= -\lambda S_t, \\ 
I_{t+1} &amp;=  \phantom{-} \lambda S_t - \gamma I_t, \\ 
R_{t+1} &amp;=  \phantom{-} \gamma I_t.
\end{align}</annotation></semantics></math></p>
<p>Since the focus of this quickstart guide is <code>macpan2</code>’s
model specification grammar, we have defined an
<code>SIR_starter()</code> function to sweep some of the details of
initializing a model object under the rug (for now, though we will
revisit it <a href="#dessert">later</a>). All you need to know about
<code>SIR_starter()</code> at this stage is that we will pass it some
inputs to define the model using the model grammar and it will output a
model object from which we can build a simulator. Our primary focus for
the remainder of this vignette will be how the inputs to
<code>SIR_starter()</code> are created.</p>
<p>The inputs to <code>SIR_starter()</code> are of two types:</p>
<ul>
<li>
<strong>index tables</strong> containing indices (labels) of model
quantities,</li>
<li>
<strong>ledgers</strong> that tabulate specific calculations
required to simulate the model equations (based on the included
functional forms).</li>
</ul>
<p>The index tables we need to specify fall into two groups:</p>
<ul>
<li>
<code>state</code>: state names,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>,
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
from the model equations</li>
<li>
<code>rate</code>: rate names,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>γ</mi><annotation encoding="application/x-tex">\gamma</annotation></semantics></math>,
and the derived rate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>λ</mi><annotation encoding="application/x-tex">\lambda</annotation></semantics></math>
</li>
</ul>
<p>We have identified two useful <strong>functional forms</strong> that
we have baked into <code>SIR_starter()</code>. In this case, we’re
thinking of these forms not necessarily as repeated calculations in this
particular model, but as calculations that a modeller may want to repeat
down the line, as they expand this simple model with additional
structure (as we will do <a href="#main-course">below</a>). The forms
are:</p>
<ul>
<li>
<strong>flow</strong>: Unsigned flows from one class to another of
the form
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mi>X</mi></mrow><annotation encoding="application/x-tex">rX</annotation></semantics></math>,
with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">r&gt;0</annotation></semantics></math>
being the <em>per capita</em> flow rate and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
being the occupancy of the state from which the flow originates. This
calculation is repeated for all terms on the right-hand side of the
recast system of difference equations above.</li>
<li>
<strong>force of infection</strong>: The prevalence-dependent
<em>per capita</em> rate of flow from susceptible classes to infectious
classes of the form
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>=</mo><mi>β</mi><mi>I</mi><mi>/</mi><mi>N</mi></mrow><annotation encoding="application/x-tex">\lambda = \beta I /N</annotation></semantics></math>,
used in calculating infection flows.</li>
</ul>
<p>In this case, the flow form is repeated within these model equations,
while the force of infection form is used only once. We’ve identified
the force of infection as a functional form since we will want to repeat
it later when <a href="#main-course">expanding into the two-strain
model</a>. Either way, these forms are already baked into
<code>SIR_starter()</code>, so our task will be creating a ledger for
each of these forms to input into the function.</p>
<p>We start by creating the <code>state</code> and <code>rate</code>
index tables:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## index tables to label model quantities -------------------------</span></span>
<span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_index.html">mp_index</a></span><span class="op">(</span>Epi <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_index.html">mp_index</a></span><span class="op">(</span>Epi <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="st">"gamma"</span>, <span class="st">"lambda"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/mp_index.html">mp_index()</a></code> function sets structures like data frames
that tabulate the model quantity labels:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state</span></span></code></pre></div>
<pre><code><span><span class="co">##  Epi</span></span>
<span><span class="co">##    S</span></span>
<span><span class="co">##    I</span></span>
<span><span class="co">##    R</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rate</span></span></code></pre></div>
<pre><code><span><span class="co">##     Epi</span></span>
<span><span class="co">##    beta</span></span>
<span><span class="co">##   gamma</span></span>
<span><span class="co">##  lambda</span></span></code></pre>
<p>The <code>Epi</code> column name is unimportant in this simple model,
but it will be key to stratifying model quantities with different
features (such as epidemiological status, infection type, age group,
location) in more complicated models.</p>
<p>For the flow form, we will create two ledgers: <code>infection</code>
for the flow from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>S</mi><annotation encoding="application/x-tex">S</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>
and <code>recovery</code> for the flow from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>
to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>R</mi><annotation encoding="application/x-tex">R</annotation></semantics></math>
and then pass these as a list to the <code>flow</code> argument of
<code>SIR_starter()</code>. We specify flows using the name of the state
from which it originates (<code>from_states</code>), the state to which
it goes (<code>to_states</code>), and a flow rate name
(<code>flow_rates</code>).</p>
<p>We use the <code><a href="../reference/mp_join.html">mp_join()</a></code> function to create the
<code>infection</code> ledger like so:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## infection ledger -------------------------</span></span>
<span><span class="va">infection</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_join.html">mp_join</a></span><span class="op">(</span></span>
<span>  from_states <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"S"</span><span class="op">)</span>,</span>
<span>  to_states <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"I"</span><span class="op">)</span>, </span>
<span>  flow_rates <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">rate</span>, Epi <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/mp_join.html">mp_join()</a></code> function takes the options provided in
each argument <code>from_states</code>, <code>to_states</code>, and
<code>flow_rates</code>, e.g.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"S"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  Epi</span></span>
<span><span class="co">##    S</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"I"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  Epi</span></span>
<span><span class="co">##    I</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">rate</span>, Epi <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     Epi</span></span>
<span><span class="co">##  lambda</span></span></code></pre>
<p>and by default creates one entry in the ledger for each combination
of these values (<em>i.e.</em>, a <a href="https://dplyr.tidyverse.org/reference/mutate-joins.html#outer-joins" class="external-link">full
join</a>). However, since there is only one value in each column, there
is only one entry in the resulting ledger:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">infection</span></span></code></pre></div>
<pre><code><span><span class="co">##  from_states to_states flow_rates</span></span>
<span><span class="co">##            S         I     lambda</span></span></code></pre>
<p>The names of the arguments in the <code><a href="../reference/mp_join.html">mp_join()</a></code> function are
tied to how the functional form baked into <code>SIR_starter()</code> is
specified, but in general modellers can define their functional forms
and the corresponding <code><a href="../reference/mp_join.html">mp_join()</a></code> argument names however they
like.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;There is only one &lt;code&gt;&lt;a href="../reference/mp_join.html"&gt;mp_join()&lt;/a&gt;&lt;/code&gt; argument name
that is not available to the user — &lt;code&gt;by&lt;/code&gt;, which has a special
role that we will see &lt;a href="#main-course"&gt;later&lt;/a&gt;.&lt;/p&gt;'><sup>2</sup></a></p>
<p>We create the <code>recovery</code> ledger in a similar way:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## recovery ledger -------------------------</span></span>
<span><span class="va">recovery</span>  <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_join.html">mp_join</a></span><span class="op">(</span></span>
<span>  from_states <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"I"</span><span class="op">)</span>,</span>
<span>  to_states <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"R"</span><span class="op">)</span>,</span>
<span>  flow_rates <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">rate</span>, Epi <span class="op">=</span> <span class="st">"gamma"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">recovery</span></span></code></pre></div>
<pre><code><span><span class="co">##  from_states to_states flow_rates</span></span>
<span><span class="co">##            I         R      gamma</span></span></code></pre>
<p>Finally, the <code>force_of_infection</code> ledger is slightly
different as it corresponds to a different functional form in
<code>SIR_starter()</code> (so the <code><a href="../reference/mp_join.html">mp_join()</a></code> argument names
are different):</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## force of infection ledger -------------------------</span></span>
<span><span class="co"># infection additionally involves the calculation of a force of infection</span></span>
<span><span class="va">force_of_infection</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_join.html">mp_join</a></span><span class="op">(</span></span>
<span>  infectious_states <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"I"</span><span class="op">)</span>,</span>
<span>  transmission_rates <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">rate</span>, Epi <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span>,</span>
<span>  infection_flow_rates <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">rate</span>, Epi <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>For this functional form, we need to specify the
<code>transmission_rates</code> and <code>infectious_states</code>
involved in computing the force of infection, as well as the names where
we want to store the results of this calculation
(<code>infection_flow_rates</code>) for use in the
<code>infection</code> flow calculations.</p>
<p>Now we can use the <code>SIR_starter()</code> function to initialize
our model object:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## SIR model object -------------------------</span></span>
<span><span class="va">sir</span> <span class="op">&lt;-</span> <span class="fu">SIR_starter</span><span class="op">(</span></span>
<span>  <span class="co"># index tables</span></span>
<span>  state <span class="op">=</span> <span class="va">state</span>,</span>
<span>  rate <span class="op">=</span> <span class="va">rate</span>,</span>
<span>  <span class="co"># ledgers</span></span>
<span>  flow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="va">infection</span>,</span>
<span>    <span class="va">recovery</span></span>
<span>  <span class="op">)</span>,</span>
<span>  force_of_infection <span class="op">=</span> <span class="va">force_of_infection</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can create a model simulator using
<code><a href="../reference/mp_dynamic_simulator.html">mp_dynamic_simulator()</a></code><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;code&gt;tmb&lt;/code&gt; stands for “template model builder”,
the underlying simulation engine provided by the &lt;a href="https://kaskr.github.io/adcomp/Introduction.html" class="external-link"&gt;TMB
package&lt;/a&gt;&lt;/p&gt;'><sup>3</sup></a>, giving it the model object
(<code>model</code>), initial values for each index
(<code>vectors</code>), as well as the number of total time steps in the
simulation (<code>time_steps</code>):</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## SIR model simulator -------------------------</span></span>
<span><span class="va">sir_simulator</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_dynamic_simulator.html">mp_dynamic_simulator</a></span><span class="op">(</span></span>
<span>  dynamic_model <span class="op">=</span> <span class="va">sir</span>,</span>
<span>  vectors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    state <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">999</span>, I <span class="op">=</span> <span class="fl">1</span>, R <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    rate <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.25</span>, gamma <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  time_steps <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that we’ve specified <code>NA</code> for <code>lambda</code> as
it will be calculated for us using the force of infection functional
form.</p>
<p>Then we can actually simulate the model by passing our model
simulator to <code><a href="../reference/mp_trajectory.html">mp_trajectory()</a></code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## SIR model simulation results -------------------------</span></span>
<span><span class="va">sir_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="va">sir_simulator</span><span class="op">)</span></span></code></pre></div>
<p>The output of the simulation is a <a href="https://r4ds.had.co.nz/tidy-data.html#longer" class="external-link">long data
frame</a>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sir_results</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   matrix time    row col     value</span></span>
<span><span class="co">## 1  state    1      S     998.75025</span></span>
<span><span class="co">## 2  state    1      I       1.14975</span></span>
<span><span class="co">## 3  state    1      R       0.10000</span></span>
<span><span class="co">## 4   rate    1   beta       0.25000</span></span>
<span><span class="co">## 5   rate    1  gamma       0.10000</span></span>
<span><span class="co">## 6   rate    1 lambda       0.00025</span></span></code></pre>
<p>The simulation output has several columns:</p>
<ul>
<li>
<code>matrix</code>: The matrix storing our values internally,
corresponding to our two index tables, <code>state</code> and
<code>rate</code>.</li>
<li>
<code>time</code>: An internal time index, where
<code>time = 1</code> is the result after the first step through the
simulation loop.</li>
<li>
<code>row</code>: The primary label for the <code>value</code> (the
row name in the corresponding <code>matrix</code>).</li>
<li>
<code>col</code>: A secondary label for the <code>value</code> (the
column name in the corresponding <code>matrix</code>). Since the outputs
of this model (i.e. states and rates) are specified as vectors and not
matrices, this column is empty for all entries. TODO: When would this be
useful?</li>
<li>
<code>value</code>: The numerical value.</li>
</ul>
<p>This output can be manipulated and plotted with standard tools, like
<code>dplyr</code> and <code>ggplot2</code>, e.g.:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">sir_results</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span> <span class="op">==</span> <span class="st">"state"</span><span class="op">)</span> <span class="co"># keep just the state variables at each point in time</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">row</span>, levels <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># to enforce logical state ordering in legend</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span>, colour <span class="op">=</span> <span class="va">state</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/sir-ggplot-example-1.png" width="576"></p>
<p>(Above, we used the <a href="https://www.tidyverse.org/blog/2023/04/base-vs-magrittr-pipe/#pipes" class="external-link">base
R pipe operator</a>, <code>|&gt;</code>.)</p>
<p>If you prefer to make plots in base R, you can convert the long
format data to wide format:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_results_wide</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">sir_results</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span> <span class="op">==</span> <span class="st">"state"</span><span class="op">)</span> <span class="co"># keep state variables at each point in time</span></span>
<span>    <span class="co">## drop unneeded columns before pivoting</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="va">matrix</span>, <span class="va">col</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="va">time</span>, names_from <span class="op">=</span> <span class="va">row</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sir_results_wide</span>, n <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 4</span></span></span>
<span><span class="co">##    time     S     I     R</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     1  999.  1.15 0.1  </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>     2  998.  1.32 0.215</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span>     3  998.  1.52 0.347</span></span></code></pre>
<p>We can plot one state like so</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">sir_results_wide</span>,</span>
<span>     <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>,</span>
<span>          y <span class="op">=</span> <span class="va">I</span>,</span>
<span>          type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/sir-base-plot-ex-1.png" width="576"></p>
<p>or multiple states on the same plot with</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co">## horizontal y-axis ticks</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">sir_results_wide</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>        <span class="va">sir_results_wide</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>        type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>        xlab <span class="op">=</span> <span class="st">"time"</span>, ylab <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"left"</span>, col <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, legend <span class="op">=</span> <span class="va">state</span><span class="op">$</span><span class="fu">labels</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/sir-base-matplot-ex-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="main-course">Main course: expanding the basic SIR with additional structure<a class="anchor" aria-label="anchor" href="#main-course"></a>
</h2>
<p>As previously noted, we created a force of infection functional form
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>β</mi><mi>I</mi><mi>/</mi><mi>N</mi></mrow><annotation encoding="application/x-tex">\beta I / N</annotation></semantics></math>)
despite it only being used once to define the SIR model. However, if we
consider the two-strain model from <a href="#amuse-bouche">before</a>,
we see this calculation is repeated for each strain:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>λ</mi><mi>A</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>β</mi><mi>A</mi></msub><msub><mi>I</mi><mi>A</mi></msub><mi>/</mi><mi>N</mi></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>λ</mi><mi>B</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>=</mo><msub><mi>β</mi><mi>B</mi></msub><msub><mi>I</mi><mi>B</mi></msub><mi>/</mi><mi>N</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{align}
\lambda_A &amp;= \beta_A I_A/N \\ 
\lambda_B &amp;= \beta_B I_B/N
\end{align}</annotation></semantics></math></p>
<p>Since we already have a form for the force of infection, we can
easily expand our basic SIR with the strain-related structure to get the
two-strain SIR model.</p>
<p>To define the two-strain model, we again must specify our
<code>state</code> and <code>rate</code> index tables, as well as our
<code>infection</code>, <code>recovery</code>, and
<code>force_of_infection</code> ledgers.</p>
<p>We start by creating a new set of indices for the strains:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Strain_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span></span></code></pre></div>
<p>A simple approach would be to define a table of the new state and
rate indices directly using the <code><a href="../reference/mp_index.html">mp_index()</a></code> function, as we
did above:</p>
<pre><code><span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_index.html">mp_index</a></span><span class="op">(</span></span>
<span>  Epi <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="st">"I"</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"R"</span><span class="op">)</span>,</span>
<span>  Strain <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="va">Strain_indices</span>, <span class="st">""</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rate</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_index.html">mp_index</a></span><span class="op">(</span></span>
<span>  Epi <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="st">"lambda"</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"gamma"</span><span class="op">)</span>,</span>
<span>  Strain <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="st">""</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
<p>However, this approach is less flexible if we want to build a complex
model or if we already have a simpler, working model (like the SIR
above) and want expand it with many strata and/or several different
types of strata. We present an alternative approach below that is more
verbose but far more flexible.</p>
<p>For the state, we want to cross
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>
with the different strains to create one
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>
compartment name per strain. We can do so using the
<code><a href="../reference/mp_cartesian.html">mp_cartesian()</a></code> function, which takes the <a href="https://en.wikipedia.org/wiki/Cartesian_product" class="external-link">Cartesian
product</a> of indices (all possible combinations across sets)<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;&lt;code&gt;&lt;a href="../reference/mp_cartesian.html"&gt;mp_cartesian()&lt;/a&gt;&lt;/code&gt; is analogous to
&lt;code&gt;&lt;a href="https://rdrr.io/r/base/expand.grid.html" class="external-link"&gt;expand.grid()&lt;/a&gt;&lt;/code&gt; in base R, or &lt;code&gt;&lt;a href="https://tidyr.tidyverse.org/reference/expand.html" class="external-link"&gt;tidyr::expand()&lt;/a&gt;&lt;/code&gt; in
the tidyverse&lt;/p&gt;'><sup>4</sup></a>:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">I_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_cartesian.html">mp_cartesian</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"I"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/mp_index.html">mp_index</a></span><span class="op">(</span>Strain <span class="op">=</span> <span class="va">Strain_indices</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">I_indices</span></span></code></pre></div>
<pre><code><span><span class="co">##  Epi Strain</span></span>
<span><span class="co">##    I      A</span></span>
<span><span class="co">##    I      B</span></span></code></pre>
<p>This table stores all indices associated with the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>
compartment.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;In standard mathematical notation, one would typically
write
&lt;math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"&gt;&lt;semantics&gt;&lt;msub&gt;&lt;mi&gt;I&lt;/mi&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;/msub&gt;&lt;annotation encoding="application/x-tex"&gt;I_A&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;
and
&lt;math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"&gt;&lt;semantics&gt;&lt;msub&gt;&lt;mi&gt;I&lt;/mi&gt;&lt;mi&gt;B&lt;/mi&gt;&lt;/msub&gt;&lt;annotation encoding="application/x-tex"&gt;I_B&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;,
with only
&lt;math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"&gt;&lt;semantics&gt;&lt;mi&gt;A&lt;/mi&gt;&lt;annotation encoding="application/x-tex"&gt;A&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;
and
&lt;math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"&gt;&lt;semantics&gt;&lt;mi&gt;B&lt;/mi&gt;&lt;annotation encoding="application/x-tex"&gt;B&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;
referred to as indices, but we’ve taken the abstraction one step further
and chosen to refer to state variable names, like
&lt;math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"&gt;&lt;semantics&gt;&lt;mi&gt;I&lt;/mi&gt;&lt;annotation encoding="application/x-tex"&gt;I&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;,
as indices as well. This choice was made deliberately when developing
&lt;code&gt;macpan2&lt;/code&gt; so that state variable names get treated like any
other component used to label a particular compartment (like location or
age group).&lt;/p&gt;'><sup>5</sup></a></p>
<p>We then combine the newly-stratified
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>
indices with the other states that remain unchanged using the
<code><a href="../reference/mp_union.html">mp_union()</a></code> function to make a <code>state</code> index
table:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_union.html">mp_union</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"S"</span><span class="op">)</span>,</span>
<span>  <span class="va">I_indices</span>, </span>
<span>  <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"R"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">state</span></span></code></pre></div>
<pre><code><span><span class="co">##  Epi Strain</span></span>
<span><span class="co">##    S       </span></span>
<span><span class="co">##    I      A</span></span>
<span><span class="co">##    I      B</span></span>
<span><span class="co">##    R</span></span></code></pre>
<p>We update the <code>rate</code> index table similarly:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rate</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/mp_union.html">mp_union</a></span><span class="op">(</span></span>
<span>  <span class="co"># stratify rates involved in the infection process by strain</span></span>
<span>  <span class="fu"><a href="../reference/mp_cartesian.html">mp_cartesian</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">rate</span>, Epi <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"beta"</span>, <span class="st">"lambda"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/mp_index.html">mp_index</a></span><span class="op">(</span>Strain <span class="op">=</span> <span class="va">Strain_indices</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># recovery rate will be the same across strains</span></span>
<span>  <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">rate</span>, Epi <span class="op">=</span> <span class="st">"gamma"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rate</span></span></code></pre></div>
<pre><code><span><span class="co">##     Epi Strain</span></span>
<span><span class="co">##    beta      A</span></span>
<span><span class="co">##  lambda      A</span></span>
<span><span class="co">##    beta      B</span></span>
<span><span class="co">##  lambda      B</span></span>
<span><span class="co">##   gamma</span></span></code></pre>
<p>For the <code>infection</code> ledger, let’s see what our previous
code for generating it yields now that we are (partially) stratifying by
<code>Strain</code>:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># infection ledger from before</span></span>
<span><span class="fu"><a href="../reference/mp_join.html">mp_join</a></span><span class="op">(</span></span>
<span>  from_states <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"S"</span><span class="op">)</span>,</span>
<span>  to_states <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"I"</span><span class="op">)</span>, </span>
<span>  flow_rates <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">rate</span>, Epi <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  from_states to_states flow_rates</span></span>
<span><span class="co">##           S.       I.A   lambda.A</span></span>
<span><span class="co">##           S.       I.B   lambda.A</span></span>
<span><span class="co">##           S.       I.A   lambda.B</span></span>
<span><span class="co">##           S.       I.B   lambda.B</span></span></code></pre>
<p>As before, the default in <code><a href="../reference/mp_join.html">mp_join()</a></code> is to give all
possible combinations for the indices (the full join), where the
individual indices, denoted by values in the <code>Epi</code> and
<code>Strain</code> columns, are dot-concatenated for the full quantity
labels.</p>
<p>For this model, we want only two of these flows:</p>
<ul>
<li>a flow between <code>S</code> and <code>I.A</code> with flow rate
<code>lambda.A</code>
</li>
<li>a flow between <code>S</code> and <code>I.B</code> with flow rate
<code>lambda.B</code>
</li>
</ul>
<p>In other words, we want the <code>Strain</code> index on
<code>I</code> to match with the <code>Strain</code> index on
<code>lambda</code>. We can specify this within <code><a href="../reference/mp_join.html">mp_join()</a></code>
when building the ledger like so:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## new infection ledger -------------------------</span></span>
<span><span class="va">infection</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_join.html">mp_join</a></span><span class="op">(</span></span>
<span>  from_states <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"S"</span><span class="op">)</span>,</span>
<span>  to_states <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"I"</span><span class="op">)</span>, </span>
<span>  flow_rates <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">rate</span>, Epi <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    to_states.flow_rates <span class="op">=</span> <span class="st">"Strain"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">infection</span></span></code></pre></div>
<pre><code><span><span class="co">##  from_states to_states flow_rates</span></span>
<span><span class="co">##           S.       I.A   lambda.A</span></span>
<span><span class="co">##           S.       I.B   lambda.B</span></span></code></pre>
<p>Note the syntax of the <code>by</code> argument here. Each
<code>by</code> list element will correspond to a pairwise join of two
of the index tables passed to <code><a href="../reference/mp_join.html">mp_join()</a></code>. Which indices are
involved in the join will correspond to the dot concatenated list
element name (<code>to_states.flow_rates</code>), with the names coming
from <code><a href="../reference/mp_join.html">mp_join()</a></code>’s argument names (<code>to_states</code>,
<code>flow_rates</code>). The list element value should be a character
string corresponding to the index table column name upon which to
perform matches. In this case, the value is <code>"Strain"</code>
because we want the “to state” labels and the “flow rate” labels to
match based on the <code>Strain</code> index table column
(<code>I.A</code> with <code>lambda.A</code> and <code>I.B</code> with
<code>lambda.B</code>).</p>
<p>For the recovery ledger, we haven’t stratified <code>gamma</code> or
<code>R</code>, so the default full join with the <code>I</code> labels
yields exactly the flows we want:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">recovery</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_join.html">mp_join</a></span><span class="op">(</span></span>
<span>    from_states <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"I"</span><span class="op">)</span>,</span>
<span>    to_states <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"R"</span><span class="op">)</span>,</span>
<span>    flow_rates <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">rate</span>, Epi <span class="op">=</span> <span class="st">"gamma"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">recovery</span></span></code></pre></div>
<pre><code><span><span class="co">##  from_states to_states flow_rates</span></span>
<span><span class="co">##          I.A        R.     gamma.</span></span>
<span><span class="co">##          I.B        R.     gamma.</span></span></code></pre>
<p>For the force of infection ledger, the full join yields many
combinations that we don’t want:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mp_join.html">mp_join</a></span><span class="op">(</span></span>
<span>  infection_flow_rates <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">rate</span>, Epi <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span>,</span>
<span>  infectious_states <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"I"</span><span class="op">)</span>,</span>
<span>  transmission_rates <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">rate</span>, Epi <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  infection_flow_rates infectious_states transmission_rates</span></span>
<span><span class="co">##              lambda.A               I.A             beta.A</span></span>
<span><span class="co">##              lambda.B               I.A             beta.A</span></span>
<span><span class="co">##              lambda.A               I.B             beta.A</span></span>
<span><span class="co">##              lambda.B               I.B             beta.A</span></span>
<span><span class="co">##              lambda.A               I.A             beta.B</span></span>
<span><span class="co">##              lambda.B               I.A             beta.B</span></span>
<span><span class="co">##              lambda.A               I.B             beta.B</span></span>
<span><span class="co">##              lambda.B               I.B             beta.B</span></span></code></pre>
<p>We want the <code>lambda</code>, <code>I</code>, and
<code>beta</code> labels all matched on the <code>Strain</code> column
of the respective index tables. Internally, <code><a href="../reference/mp_join.html">mp_join()</a></code>
performs pairwise joins, so we cannot specify a three-way
<code>by</code> argument. Instead, we will specify two pairwise joins to
the same effect:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## new force of infection ledger -------------------------</span></span>
<span><span class="va">force_of_infection</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_join.html">mp_join</a></span><span class="op">(</span></span>
<span>  infection_flow_rates <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">rate</span>, Epi <span class="op">=</span> <span class="st">"lambda"</span><span class="op">)</span>,</span>
<span>  infectious_states <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">state</span>, Epi <span class="op">=</span> <span class="st">"I"</span><span class="op">)</span>,</span>
<span>  transmission_rates <span class="op">=</span> <span class="fu"><a href="../reference/mp_subset.html">mp_subset</a></span><span class="op">(</span><span class="va">rate</span>, Epi <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    infection_flow_rates.infectious_states <span class="op">=</span> <span class="st">"Strain"</span>, <span class="co"># first pairwise join</span></span>
<span>    infectious_states.transmission_rates <span class="op">=</span> <span class="st">"Strain"</span> <span class="co"># second pairwise join</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">force_of_infection</span></span></code></pre></div>
<pre><code><span><span class="co">##  infection_flow_rates infectious_states transmission_rates</span></span>
<span><span class="co">##              lambda.A               I.A             beta.A</span></span>
<span><span class="co">##              lambda.B               I.B             beta.B</span></span></code></pre>
<p>Now we’re ready to build the two-strain model object and simulate
it:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">two_strain_model</span> <span class="op">&lt;-</span> <span class="fu">SIR_starter</span><span class="op">(</span></span>
<span>  <span class="co"># index tables</span></span>
<span>  state <span class="op">=</span> <span class="va">state</span>,</span>
<span>  rate <span class="op">=</span> <span class="va">rate</span>,</span>
<span>  <span class="co"># ledgers</span></span>
<span>  flow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="va">infection</span>,</span>
<span>    <span class="va">recovery</span></span>
<span>  <span class="op">)</span>,</span>
<span>  force_of_infection <span class="op">=</span> <span class="va">force_of_infection</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">two_strain_simulator</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_dynamic_simulator.html">mp_dynamic_simulator</a></span><span class="op">(</span></span>
<span>  dynamic_model <span class="op">=</span> <span class="va">two_strain_model</span>,</span>
<span>  vectors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    state <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">998</span>, I.A <span class="op">=</span> <span class="fl">1</span>, I.B <span class="op">=</span> <span class="fl">1</span>, R <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>    rate <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>beta.A <span class="op">=</span> <span class="fl">0.25</span>, gamma <span class="op">=</span> <span class="fl">0.1</span>, beta.B <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  time_steps <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">two_strain_results</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="va">two_strain_simulator</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span> <span class="op">==</span> <span class="st">"state"</span><span class="op">)</span>                    </span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">two_strain_results</span><span class="op">$</span><span class="va">row</span><span class="op">)</span> <span class="co"># get state variables in the desired order</span></span>
<span></span>
<span><span class="op">(</span><span class="va">two_strain_results</span> <span class="co"># keep state variables at each point in time</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">row</span>, levels <span class="op">=</span> <span class="va">levels</span><span class="op">)</span><span class="op">)</span> <span class="co"># to enforce logical state ordering in plot</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span>, colour <span class="op">=</span> <span class="va">state</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/two-strain-results-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="dessert">Dessert: understanding model simulation in <code>macpan2</code><a class="anchor" aria-label="anchor" href="#dessert"></a>
</h2>
<p>As mentioned, we’ve hidden some of the details of initializing a
model object within the <code>SIR_starter()</code> function:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## helper function to simplify the exposition in this vigette -----------</span></span>
<span><span class="va">SIR_starter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="co"># index tables for model quantities</span></span>
<span>  <span class="va">state</span>,</span>
<span>  <span class="va">rate</span>,</span>
<span>  <span class="co"># ledgers tabulating the use of different functional forms</span></span>
<span>  <span class="va">flow</span>, <span class="co"># list of individual ledgers</span></span>
<span>  <span class="va">force_of_infection</span></span>
<span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">## Set up expressions list for each functional form --------------</span></span>
<span>  <span class="co">## names refer to when the calculation gets performed relative to </span></span>
<span>  <span class="co">## the simulation time-step loop (before, during, ...)</span></span>
<span>  <span class="co">## FIXME: we should not be referring to a specific engine in</span></span>
<span>  <span class="co">## a vignette about an 'engine-agnostic grammar'</span></span>
<span>  <span class="va">expr_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mp_tmb_expr_list.html">mp_tmb_expr_list</a></span><span class="op">(</span></span>
<span>    before <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="co">## aggregations</span></span>
<span>        <span class="va">N</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    during <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="co">## force of infections</span></span>
<span>        <span class="va">rate</span><span class="op">[</span><span class="va">infection_flow_rates</span><span class="op">]</span> <span class="op">~</span></span>
<span>          <span class="va">state</span><span class="op">[</span><span class="va">infectious_states</span><span class="op">]</span> <span class="op">*</span> <span class="va">rate</span><span class="op">[</span><span class="va">transmission_rates</span><span class="op">]</span> <span class="op">/</span> <span class="va">N</span></span>
<span>  </span>
<span>      <span class="co">## unsigned individual flows</span></span>
<span>      , <span class="va">flow_per_time</span> <span class="op">~</span> <span class="va">state</span><span class="op">[</span><span class="va">from_states</span><span class="op">]</span> <span class="op">*</span> <span class="va">rate</span><span class="op">[</span><span class="va">flow_rates</span><span class="op">]</span></span>
<span>  </span>
<span>      <span class="co">## state update</span></span>
<span>      , <span class="va">total_inflow</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">group_sums</a></span><span class="op">(</span><span class="va">flow_per_time</span>, <span class="va">to_states</span>, <span class="va">state</span><span class="op">)</span></span>
<span>      , <span class="va">total_outflow</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">group_sums</a></span><span class="op">(</span><span class="va">flow_per_time</span>, <span class="va">from_states</span>, <span class="va">state</span><span class="op">)</span></span>
<span>      , <span class="va">state</span> <span class="op">~</span> <span class="va">state</span> <span class="op">+</span> <span class="va">total_inflow</span> <span class="op">-</span> <span class="va">total_outflow</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## Ledgers for each specific calculation --------------</span></span>
<span>  <span class="va">ledgers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    flow <span class="op">=</span> <span class="fu"><a href="../reference/mp_ledgers.html">mp_ledgers</a></span><span class="op">(</span><span class="va">flow</span><span class="op">)</span>,</span>
<span>    force_of_infection <span class="op">=</span> <span class="fu"><a href="../reference/mp_ledgers.html">mp_ledgers</a></span><span class="op">(</span><span class="va">force_of_infection</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## Initialize vectors from index tables (with all zeros for values) --------------</span></span>
<span>  <span class="co"># used as placeholders for user input</span></span>
<span>  <span class="va">init_vecs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    state <span class="op">=</span> <span class="fu"><a href="../reference/mp_structured_vector.html">mp_structured_vector</a></span><span class="op">(</span><span class="va">state</span><span class="op">)</span>,</span>
<span>    rate <span class="op">=</span> <span class="fu"><a href="../reference/mp_structured_vector.html">mp_structured_vector</a></span><span class="op">(</span><span class="va">rate</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## Initialize model object -----------------</span></span>
<span>  <span class="fu"><a href="../reference/mp_dynamic_model.html">mp_dynamic_model</a></span><span class="op">(</span></span>
<span>    expr_list <span class="op">=</span> <span class="va">expr_list</span>,</span>
<span>    ledgers <span class="op">=</span> <span class="va">ledgers</span>,</span>
<span>    init_vecs <span class="op">=</span> <span class="va">init_vecs</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This function definition shows how all the pieces fit together. The
expressions list <code>expr_list</code> is perhaps the most interesting
as it contains all of the functional forms used to simulate the model,
including some we explored above (unsigned flows, force of infection),
as well as some that we didn’t discuss (total inflow, total outflow,
state update). The <code>ledgers</code> and <code>init_vecs</code> are
just set up to ensure that the ledgers and initial conditions for
simulation get attached to the model object correctly.</p>
<p>These topics will be discussed fully in a future vignette.</p>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Walker, Weiguang Guan, Jen Freeman, Ben Bolker, Darren Flynn-Primrose.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
