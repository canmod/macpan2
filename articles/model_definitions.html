<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="macpan2">
<title>Compartmental Model Definitions • macpan2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Compartmental Model Definitions">
<meta property="og:description" content="macpan2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/quickstart.html">Quickstart Guide: specifying and simulating a simple compartmental model</a>
    <a class="dropdown-item" href="../articles/quickstart2.html">Quickstart Guide, part 2: specifying and simulating a structured compartmental model</a>
    <a class="dropdown-item" href="../articles/time_varying_parameters.html">Specifying Time-Varying Parameters</a>
    <a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a>
    <a class="dropdown-item" href="../articles/example_models.html">Example Models</a>
    <a class="dropdown-item" href="../articles/flow_types.html">Flow Types</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Compartmental Model Definitions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/HEAD/vignettes/model_definitions.Rmd" class="external-link"><code>vignettes/model_definitions.Rmd</code></a></small>
      <div class="d-none name"><code>model_definitions.Rmd</code></div>
    </div>

    
    
<p><a href="https://canmod.github.io/macpan2/articles/vignette-status#mature-draft"><img src="https://img.shields.io/badge/status-mature%20draft-yellow" alt="status"></a></p>
<div class="section level2">
<h2 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h2>
<p>This document assumes knowledge of compartmental epidemic models. We
will not be defining terms and symbols that we consider to be widely
understood by mathematical epidemiologists.</p>
</div>
<div class="section level2">
<h2 id="document-goals">Document Goals<a class="anchor" aria-label="anchor" href="#document-goals"></a>
</h2>
<p>This document describes a specification for a data structure to
represent compartmental models. The goal of this document is not to
define a spec for a user interface for constructing compartmental
models. Instead, we define the data structure here so that interfaces
for creating instances of compartmental models can be designed without
needing to grapple with issues of how to represent and store model
definitions.</p>
</div>
<div class="section level2">
<h2 id="user-stories">User Stories<a class="anchor" aria-label="anchor" href="#user-stories"></a>
</h2>
<p>This spec design has been guided by several high-level user stories,
which we outline briefly.</p>
<blockquote>
<p>As a modeller, I want to use software that provides an extensive set
of modelling capabilities, so that I can address specific and changing
public health needs.</p>
</blockquote>
<blockquote>
<p>As a modeller, I want to build complex models out of simpler – easier
to understand – modular sub-models, so that I can more easily modify the
structure of my model as public health needs change.</p>
</blockquote>
<blockquote>
<p>As a developer, I want to be able to quickly add a new modelling
capability, so that I can support public health modellers in as timely a
manner as possible.</p>
</blockquote>
<p>These and other <a href="https://canmod.github.io/macpan-book/index.html#vision-and-direction" class="external-link">user-stories</a>
were developed by working with public-health modellers during the
COVID-19 pandemic in Canada.</p>
</div>
<div class="section level2">
<h2 id="labelled-partitions-in-progress">Labelled Partitions (in progress)<a class="anchor" aria-label="anchor" href="#labelled-partitions-in-progress"></a>
</h2>
<p>Before describing a data structure for representing <a href="#compartmental-models">Compartmental Models</a>, we need to define
the concept of labelled partitions. This concept allows for a
consistent, flexible, compact, and readable mechanism for identifying
model variables and sets of variables. For example, in a spatially
structured model we might want to refer to all states in a particular
location (e.g. Toronto) and a specific state within that location
(e.g. susceptible individuals in Toronto). Labelled partitions can be
stored as a data frame. The rows of the data frame represent the things
being represented. Our primary example of a ‘thing’ is a variable in a
compartmental model (e.g. number of susceptible individuals in Toronto,
or the force of infection). The columns of the data frame represent
different ways to partition the rows.</p>
<pre><code><span><span class="co">#&gt;   Epi   Vax</span></span>
<span><span class="co">#&gt; 1   S unvax</span></span>
<span><span class="co">#&gt; 2   E unvax</span></span>
<span><span class="co">#&gt; 3   I unvax</span></span>
<span><span class="co">#&gt; 4   R unvax</span></span>
<span><span class="co">#&gt; 5   S   vax</span></span>
<span><span class="co">#&gt; 6   E   vax</span></span>
<span><span class="co">#&gt; 7   I   vax</span></span>
<span><span class="co">#&gt; 8   R   vax</span></span></code></pre>
<p>Non-empty values in each cell must contain only letters, numbers,
underscores, and must start with a letter. Empty labels are zero-length
strings that can be used to indicate that some partitions are not
applicable to some variables. The purpose for these restrictions is to
facilitate the construction of strings and character vectors that
summarize different aspects of the labelled partition. When taken
together, these summaries can be inverted to restore the full labelled
partition and so they represent zero information loss. This equivalence
allows us to go back-and-forth between the two representations without
loosing information, but perhaps gaining convenience. There are three
types of summaries: the names, the name, and the labels. The names of a
labelled partition are the column names of the corresponding data
frame.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span><span class="op">$</span><span class="fu">names</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Epi" "Vax"</span></span></code></pre></div>
<p>The name of a labelled partition is a dot-concatenation of the
names,</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span><span class="op">$</span><span class="fu">name</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Epi.Vax"</span></span></code></pre></div>
<p>The labels of a labelled partition is a dot-concatenation of the
columns.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span><span class="op">$</span><span class="fu">labels</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "S.unvax" "E.unvax" "I.unvax" "R.unvax" "S.vax"   "E.vax"   "I.vax"  </span></span>
<span><span class="co">#&gt; [8] "R.vax"</span></span></code></pre></div>
<p>These labels give a unique single character string for referring to
each variable. With only the labels and one of either the names or the
name, one may recover the labelled partition. The labels provide
convenient names for the variables – i.e. rownames. By convention we use
<a href="https://en.wikipedia.org/wiki/Camel_case" class="external-link">UpperCamelCase</a>
for partition names and a modified form of <a href="https://en.wikipedia.org/wiki/Snake_case" class="external-link">snake_case</a> for
variable labels. Our modification of snake case allows for single
uppercase letters in order to accommodate the convention in epidemiology
for using single uppercase letters to refer to state variables. For
example, <code>S</code>, <code>I</code>, and <code>R</code>, as well as
<code>I_mild</code> and <code>I_severe</code>, would be consistent with
our modified snake case style.</p>
</div>
<div class="section level2">
<h2 id="compartmental-models">Compartmental Models<a class="anchor" aria-label="anchor" href="#compartmental-models"></a>
</h2>
<p>A <a href="https://canmod.github.io/macpan2/articles/model_definitions">compartmental
model</a> can be represented as a directory with the following four
files.</p>
<ol style="list-style-type: decimal">
<li>
<code>variables</code> – A CSV file describing the variables in the
model.</li>
<li>
<code>derivations</code> – JSON file with an array of instructions
on how to update the <code>variables</code> at each iteration of a model
simulation.</li>
<li>
<code>flows</code> – A CSV file describing what variables are state
variables and the magnitudes of flows to and from compartments.</li>
<li>
<code>settings</code> – A JSON file with an object of elements that
determine how files 1-3 are used by the software.</li>
</ol>
<p>The following sections describe each of these files in more
detail.</p>
</div>
<div class="section level2">
<h2 id="variables-and-partitions">Variables and Partitions<a class="anchor" aria-label="anchor" href="#variables-and-partitions"></a>
</h2>
<p>The <code>variables.csv</code> file has a row for each variable in
the model and one column for each labelled partition of the variables. A
labelled partition is a character vector of labels that describes the
variables. Each row in this file must be unique so that it uniquely
identifies each variable.</p>
<p>For example, here is a list of variables for the standard SIR
model.</p>
<pre><code><span><span class="co">#&gt;     Epi</span></span>
<span><span class="co">#&gt; 1     S</span></span>
<span><span class="co">#&gt; 2     I</span></span>
<span><span class="co">#&gt; 3     R</span></span>
<span><span class="co">#&gt; 4     N</span></span>
<span><span class="co">#&gt; 5  beta</span></span>
<span><span class="co">#&gt; 6   foi</span></span>
<span><span class="co">#&gt; 7 gamma</span></span></code></pre>
<p>This example has a single labelled partition, <code>Epi</code>. This
partition uniquely identifies each variable and so we do not need other
partitions to comply with the uniqueness requirement.</p>
<p>To stratify by another factor (e.g. age groups or locations) we can
add other labelled partitions.</p>
<p>We emphasize that the list with the single <code>Epi</code> partition
did not violate this spec, as it is not required to add a partition to
make a distinction between state variables and parameters. The spec
distinguishes <a href="#variable-roles">Variable Roles</a> like this in
the <code>settings</code> file. In this example, the addition of the
<code>Type</code> and <code>Infect</code> partitions are for
convenience. The point is that the user is free to add any number of
partitions even if they are not required for uniqueness.</p>
<p>We use the term <em>names</em> for strings that identify partitions
and the term <em>labels</em> for strings that identify variables with
respect to a particular partition.</p>
<p>Note that we do not provide a column for the numeric quantity of each
variable because this is a spec for a compartmental model data
structure. By working with pure model structure objects, we can combine
different atomic models to more easily produce models with more
structure. When it comes time to use a model, the <a href="https://canmod.net/misc/cpp_side" class="external-link">computational engine</a> can be
used to associate model variables with numerical quantities.</p>
</div>
<div class="section level2">
<h2 id="required-partitions">Required Partitions<a class="anchor" aria-label="anchor" href="#required-partitions"></a>
</h2>
<p>There is a component, <code>settings$required_partitions</code>,
which is a character vector of the names of the partitions that are used
to uniquely identify each variable. In the previous example with
<code>Type</code>, <code>Infect</code>, and <code>Epi</code> partitions
we have <code>settings$required_partitions == "Epi"</code>. We refer to
the labels associated with required partitions as required labels. Every
variable must have at least one non-empty required label. The required
partitions are used to generate <a href="#variable-names">Variable
Names</a>.</p>
</div>
<div class="section level2">
<h2 id="atomic-and-non-atomic-models">Atomic and Non-Atomic Models<a class="anchor" aria-label="anchor" href="#atomic-and-non-atomic-models"></a>
</h2>
<p>We refer to models with exactly one required partition as atomic. One
may combine two atomic models to get another model with two required
labelled partitions. An example combination of atomic models is the SEIR
model stratified by the states of an atomic vaccination model with
required partition, <code>Vax</code>.</p>
<pre><code><span><span class="co">#&gt;         Vax</span></span>
<span><span class="co">#&gt; 1     unvax</span></span>
<span><span class="co">#&gt; 2       vax</span></span>
<span><span class="co">#&gt; 3 dose_rate</span></span></code></pre>
<p>In this atomic model <code>unvax</code> and <code>vax</code> are
state variables representing the numbers of individuals who are
unvaccinated and vaccinated. The <code>dose_rate</code> variable is a
parameter giving the proportion of unvaccinated individuals who receive
a vaccination each day.</p>
<p>We combine these two atomic models to produce a non-atomic model with
required partitions, <code>Epi</code> and <code>Vax</code>.</p>
<pre><code><span><span class="co">#&gt;      Epi       Vax</span></span>
<span><span class="co">#&gt; 1      S     unvax</span></span>
<span><span class="co">#&gt; 2      E     unvax</span></span>
<span><span class="co">#&gt; 3      I     unvax</span></span>
<span><span class="co">#&gt; 4      R     unvax</span></span>
<span><span class="co">#&gt; 5   beta     unvax</span></span>
<span><span class="co">#&gt; 6  alpha          </span></span>
<span><span class="co">#&gt; 7  gamma          </span></span>
<span><span class="co">#&gt; 8      N     unvax</span></span>
<span><span class="co">#&gt; 9    foi     unvax</span></span>
<span><span class="co">#&gt; 10     S       vax</span></span>
<span><span class="co">#&gt; 11     E       vax</span></span>
<span><span class="co">#&gt; 12     I       vax</span></span>
<span><span class="co">#&gt; 13     R       vax</span></span>
<span><span class="co">#&gt; 14  beta       vax</span></span>
<span><span class="co">#&gt; 15 alpha          </span></span>
<span><span class="co">#&gt; 16 gamma          </span></span>
<span><span class="co">#&gt; 17     N       vax</span></span>
<span><span class="co">#&gt; 18   foi       vax</span></span>
<span><span class="co">#&gt; 19       dose_rate</span></span></code></pre>
<p>Note here that the state variables, <code>S</code>, <code>E</code>,
<code>I</code>, and <code>R</code>, as well as the transmission rate,
<code>beta</code>, are stratified by vaccination status, but the latency
and recovery parameters, <code>alpha</code> and <code>gamma</code>, are
not stratified indicating that latency and recovery is not influenced by
vaccination status. Similarly the <code>dose_rate</code> is also not
stratified by epidemiological state.</p>
<p>Consider one more example with different symptomatic statuses, where
infectious individuals have either mild or severe symptoms and these
different statuses recover at different rates.</p>
<pre><code><span><span class="co">#&gt;               Epi   Symp       Vax</span></span>
<span><span class="co">#&gt; 1               S            unvax</span></span>
<span><span class="co">#&gt; 2               E            unvax</span></span>
<span><span class="co">#&gt; 3               I   mild     unvax</span></span>
<span><span class="co">#&gt; 4               I severe     unvax</span></span>
<span><span class="co">#&gt; 5               R            unvax</span></span>
<span><span class="co">#&gt; 6            beta            unvax</span></span>
<span><span class="co">#&gt; 7               S              vax</span></span>
<span><span class="co">#&gt; 8               E              vax</span></span>
<span><span class="co">#&gt; 9               I   mild       vax</span></span>
<span><span class="co">#&gt; 10              I severe       vax</span></span>
<span><span class="co">#&gt; 11              R              vax</span></span>
<span><span class="co">#&gt; 12           beta              vax</span></span>
<span><span class="co">#&gt; 13          alpha                 </span></span>
<span><span class="co">#&gt; 14          gamma   mild          </span></span>
<span><span class="co">#&gt; 15          gamma severe          </span></span>
<span><span class="co">#&gt; 16 infectiousness   mild          </span></span>
<span><span class="co">#&gt; 17 infectiousness severe          </span></span>
<span><span class="co">#&gt; 18                       dose_rate</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="variable-names">Variable Names<a class="anchor" aria-label="anchor" href="#variable-names"></a>
</h2>
<p>Although each row of the <code>variables</code> list provides a
unique identifier for each variable, it is convenient to be able to
combine the required labels into a single string. We call this string
the variable name.</p>
<p>The name of a variable is the dot-delimited concatenation of the
partitions in <code>settings$required_partitions</code> associated with
the variable. For example, the following table contains the labelled
partitions of the
<code>Epi</code>-by-<code>Symp</code>-by-<code>Vax</code> variable list
with a fourth column giving the variable names.</p>
<pre><code><span><span class="co">#&gt;      Epi   Symp       Vax variable_names</span></span>
<span><span class="co">#&gt; 1      S            unvax       S..unvax</span></span>
<span><span class="co">#&gt; 2      E            unvax       E..unvax</span></span>
<span><span class="co">#&gt; 3      I   mild     unvax   I.mild.unvax</span></span>
<span><span class="co">#&gt; 4      I severe     unvax I.severe.unvax</span></span>
<span><span class="co">#&gt; 5      R            unvax       R..unvax</span></span>
<span><span class="co">#&gt; 6   beta            unvax    beta..unvax</span></span>
<span><span class="co">#&gt; 7      S              vax         S..vax</span></span>
<span><span class="co">#&gt; 8      E              vax         E..vax</span></span>
<span><span class="co">#&gt; 9      I   mild       vax     I.mild.vax</span></span>
<span><span class="co">#&gt; 10     I severe       vax   I.severe.vax</span></span>
<span><span class="co">#&gt; 11     R              vax         R..vax</span></span>
<span><span class="co">#&gt; 12  beta              vax      beta..vax</span></span>
<span><span class="co">#&gt; 13 alpha                         alpha..</span></span>
<span><span class="co">#&gt; 14 gamma   mild              gamma.mild.</span></span>
<span><span class="co">#&gt; 15 gamma severe            gamma.severe.</span></span>
<span><span class="co">#&gt; 16              dose_rate    ..dose_rate</span></span></code></pre>
<p>This choice of a dot delimiter leads to syntactically valid R names
even if the name begins with one or more dot. Because dots are not
allowed in the labels themselves, this delimiter also makes parsing the
labels into their respective partitions unambiguous. Note that it is
impossible to have names with all dots because all variables must have
at least one non-blank label.</p>
<p>The biggest downside to the choice of a dot delimiter is that it
conflicts with the <a href="https://style.tidyverse.org/syntax.html" class="external-link">tidyverse style</a>,
which requires using dots only to specify S3 method dispatch. The reason
for this guideline is to reduce the chances of ambiguity when the S3
machinery searches for methods. This disadvantage is in our opinion
outweighed by the advantages that we list above, because model variables
will not be involved in S3 dispatch.</p>
<p>Variable names are invertible, in that a vector of variable names can
be combined with a vector of partition names to reproduce the associated
labelled partitions. This fact allows us to choose either the labelled
partitions or names representation depending on convenience or
necessity.</p>
</div>
<div class="section level2">
<h2 id="variable-roles">Variable Roles<a class="anchor" aria-label="anchor" href="#variable-roles"></a>
</h2>
<p><a href="#variable-names">Variable Names</a> are used in lists that
identify variables with specific roles in the model. There are at least
two such lists in the <code>settings.json</code> file.</p>
<ul>
<li>
<code>settings$state_variables</code> – Character vector giving
names of variables, each of which tracks the number of individuals in a
compartment.</li>
<li>
<code>settings$rate_variables</code> – Character vector giving names
of variables, each of which determines the per-capita rate of flow
between one or more pairs of compartments.</li>
</ul>
<p>Additional variable lists may be used to accommodate such things as
absolute flow rates as well as sources and sinks.</p>
<p>All state variables and flow variables must be scalars.</p>
</div>
<div class="section level2">
<h2 id="partition-sets">Partition Sets<a class="anchor" aria-label="anchor" href="#partition-sets"></a>
</h2>
<p>The <code>required_paritions</code> component is a set of partitions
that are used to uniquely identify each variable and to generate
invertible variable names. The user is free to define other
<code>partition_sets</code> so that they can refer to groups of
variables by name. These sets can be used to filter the variables for a
specific purpose. Such <code>partition_sets</code> are useful when
combining models.</p>
<p>Variable names can be used with respect to a particular partition
set. Variable names with respect to some partition sets do not uniquely
identify each variable. For example, <code>Epi.Symp == "I.mild"</code>
occurs twice in the following example.</p>
<pre><code><span><span class="co">#&gt;      Epi   Symp       Vax     Epi.Symp    Epi.Vax</span></span>
<span><span class="co">#&gt; 1      S            unvax           S.    S.unvax</span></span>
<span><span class="co">#&gt; 2      E            unvax           E.    E.unvax</span></span>
<span><span class="co">#&gt; 3      I   mild     unvax       I.mild    I.unvax</span></span>
<span><span class="co">#&gt; 4      I severe     unvax     I.severe    I.unvax</span></span>
<span><span class="co">#&gt; 5      R            unvax           R.    R.unvax</span></span>
<span><span class="co">#&gt; 6   beta            unvax        beta. beta.unvax</span></span>
<span><span class="co">#&gt; 7      S              vax           S.      S.vax</span></span>
<span><span class="co">#&gt; 8      E              vax           E.      E.vax</span></span>
<span><span class="co">#&gt; 9      I   mild       vax       I.mild      I.vax</span></span>
<span><span class="co">#&gt; 10     I severe       vax     I.severe      I.vax</span></span>
<span><span class="co">#&gt; 11     R              vax           R.      R.vax</span></span>
<span><span class="co">#&gt; 12  beta              vax        beta.   beta.vax</span></span>
<span><span class="co">#&gt; 13 alpha                        alpha.     alpha.</span></span>
<span><span class="co">#&gt; 14 gamma   mild             gamma.mild     gamma.</span></span>
<span><span class="co">#&gt; 15 gamma severe           gamma.severe     gamma.</span></span>
<span><span class="co">#&gt; 16              dose_rate            . .dose_rate</span></span></code></pre>
<p>The ability to refer to multiple variables with a single name is
useful in many circumstances. Typically such non-unique names are unique
within groups of variables. For example,
<code>Epi.Symp == "I.mild"</code> is unique within
<code>Vax == "vax"</code> and within <code>Vax == "unvax"</code>.</p>
<p>As the examples above have illustrated, the name of a partition set
is the dot-delimited concatenation of the names of the partitions in the
set. For example, <code>Epi.Symp</code> is the name of the partition set
containing the <code>Epi</code> and <code>Symp</code> partitions.</p>
</div>
<div class="section level2">
<h2 id="derived-variables">Derived Variables<a class="anchor" aria-label="anchor" href="#derived-variables"></a>
</h2>
<p>Now that we have a solid mechanism for representing, referring to,
and grouping model variables, we can begin to consider defining <a href="#flow-between-compartments">Flow between Compartments</a>. When
the rate of flow from one compartment to another is given by a model
parameter (e.g. recovery rate, <code>gamma</code>), then it is
straightforward to describe the flow between those compartments
(e.g. <code>I</code> to <code>R</code>). However, when the flow rate is
a function of parameters and state variables (e.g. force of infection),
we first need to define how to compute such a rate.</p>
<p>In this section we describe a data structure for representing
mathematical expressions for deriving model variables that must be
recomputed at each iteration of a simulation. Flow rates such as the
force of infection is an example of such a derived variable. There are
many other examples, including sums of groups of (e.g. vaccinated)
compartments, model summaries such as <span class="math inline">\(\mathcal{R}_0\)</span>, and convolutions of
infected compartments for modelling under-reporting and reporting
delays.</p>
<p>Each derived variable must be represented by a row in the
<code>variables</code> list. Derived variables are distinguished from
input variables by being associated with an element in a list,
<code>derivations</code>. This list contains objects that describe how
to compute each derived variable. Each object contains the following
components.</p>
<ul>
<li>
<code>simulation_phase</code> [required] – Specifies when in the
simulation the variable should be evaluated. Must be one of four values:
“before”, “during_pre_update”, “during_post_update”, or “after”.
<ul>
<li>
<code>before</code>: Variable is computed before the simulation
loop. Intended for variables that must be computed once but will remain
constant throughout the simulation.</li>
<li>
<code>during_pre_update</code>: Variable is re-computed during each
loop of the simulation before the state variable has been updated.
Intended for variables that depend on the state during the previous
timestep.</li>
<li>
<code>during_post_update</code>: Variable is re-computed during each
loop of the simulation after the state variable has been updated.
Intended for variables that depend on the state during the current
timestep.</li>
<li>
<code>after</code>: Variable is computed after the simulation loop.
Intended for modifying simulation outputs to be comparable with observed
data.</li>
</ul>
</li>
<li>
<code>group_partition</code> [optional] – The name of a partition
set to use for filtering and grouping the variables so that (1) only a
subset of variables are utilized in order to produce the derived
variables and (2) a set of derived variables can be produced at the same
time by producing one derived variable per group. When
<code>group_partition</code> is missing, all variables are potentially
utilized by a single derived variable.</li>
<li>
<code>group_names</code> [required if <code>group_partition</code>
is not missing] – A vector of variable names with respect to the
<code>group_partition</code>, each of which will define a single group.
The <code>group_names</code> also determine the labels of variables that
distinguish groups from each other. There are three use cases.
<ul>
<li>
<code>group_names</code> and <code>group_partition</code> are both
missing – All variables are potentially utilized by a single derived
variable</li>
<li>
<code>length(group_names) == 1L</code> – A filtered subset of
variables get utilized by a single derived variable</li>
<li>
<code>length(group_names) == n</code> – The variables in each of
<code>n</code> groups are used to produce one of <code>n</code> derived
variables</li>
</ul>
</li>
<li>
<code>output_partition</code> [optional] – The name of a partition
set to use for declaring the labels of the derived variables within each
group (see <code>group_partition</code> and <code>group_names</code> for
producing one derived variable per group). If no
<code>output_partition</code> is given then all required partitions are
used.</li>
<li>
<code>output_names</code> [optional] – A vector of variable names
with respect to the <code>output_partition</code>, each of which will
determine the labels associated with the <code>output_partition</code>
of each derived variable within its group. If <code>group_names</code>
are missing then <code>output_names</code> must be a single variable
name with respect to the <code>output_partition</code> for determining
the labels for the derived variable. Otherwise, the <code>i</code>th
element of <code>output_names</code> determines the labels for the
derived variable produced by the <code>i</code>th element of
<code>group_names</code>.</li>
<li>
<code>input_partition</code> [optional] – The name of a partition
set to use for matching variables to arguments in the
<code>expression</code>. Every variable name with respect to the
<code>input_partition</code> must be both unique and exist within each
group. If no <code>input_partition</code> is given then all required
partitions are used.</li>
<li>
<code>arguments</code> [required if <code>expression</code> has
arguments other then <code>...</code>] – A vector of variable names with
respect to the <code>input_partition</code>.</li>
<li>
<code>argument_dots</code> [required if <code>expression</code> has
a <code>...</code> argument] – A vector of variable names with respect
to the <code>input_partition</code> for finding variables to pass to a
<code>...</code> argument in <code>expression</code>, if it exists.</li>
<li>
<code>expression</code> [required] – A mathematical function for
producing one derived variable per group. The names of the arguments of
this function are a subset of variable names with respect to the
<code>input_partition</code> and optionally a <code>...</code>
argument.</li>
</ul>
<p>TODO: Perhaps this should be a ‘compressed’ data format for
<code>derivations</code>, and the simple
<code>derived_var_name = function(...) ...</code> should be used as the
base case? The compressed format can be used to form the basis of an
interface design?</p>
<p>The spec for this file will be hard to understand on first reading.
To understand it better we provide several examples designed to justify
and clarify the description in the above bullet list.</p>
<p>We begin with defining the force of infection for an SEIR model with
the following variable list.</p>
<pre><code><span><span class="co">#&gt;     Epi</span></span>
<span><span class="co">#&gt; 1     S</span></span>
<span><span class="co">#&gt; 2     I</span></span>
<span><span class="co">#&gt; 3     R</span></span>
<span><span class="co">#&gt; 4     N</span></span>
<span><span class="co">#&gt; 5  beta</span></span>
<span><span class="co">#&gt; 6   foi</span></span>
<span><span class="co">#&gt; 7 gamma</span></span></code></pre>
<p>The force of infection for this model can be represented as
follows.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  output_partition <span class="op">=</span> <span class="st">"Epi"</span>,</span>
<span>  output_names <span class="op">=</span> <span class="st">"foi"</span>,</span>
<span>  input_partition <span class="op">=</span> <span class="st">"Epi"</span>,</span>
<span>  math_function <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">S</span>, <span class="va">E</span>, <span class="va">I</span>, <span class="va">R</span>, <span class="va">beta</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">I</span> <span class="op">*</span> <span class="va">beta</span> <span class="op">/</span> <span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="va">S</span>, <span class="va">E</span>, <span class="va">I</span>, <span class="va">R</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Because this is an <a href="#atomic-and-non-atomic-models">atomic
model</a>, by specifying <code>output_partition = "Epi"</code> and
<code>output_names "foi"</code>, we are really just saying that the name
of the output variable is <code>"foi"</code>. More technically we would
say that the derived variable will have the label <code>"foi"</code> in
the <code>"Epi"</code> partition. The <code>input_partition</code> and
<code>math_function</code> go together. The <code>math_function</code>
describes how to compute the derived variable, <code>foi</code>, in
terms of other variables. The <code>input_partition</code> gives the
name of a <a href="#partition-sets">partition set</a> to use for
matching model variables to the arguments of this function. For example,
the argument list contains <code>S</code>, which is a label in the
<code>Epi</code> partition set.</p>
<p>This description may seem unnecessarily complex, but it is useful for
representing more complex models as we will see. Also remember that this
is a spec for a data structure and not a user interface – it is likely
that a user interface for specifying this component would make it much
simpler to do so.</p>
<p>Updating derived variable specifications when taking model products
is reasonably straightforward with this data structure. For example,
consider stratifying <code>S</code>, <code>E</code>, <code>I</code>,
<code>R</code>, and <code>beta</code> by geographic location.</p>
<pre><code><span><span class="co">#&gt;      Epi                 Location</span></span>
<span><span class="co">#&gt; 1      S                 montreal</span></span>
<span><span class="co">#&gt; 2      E                 montreal</span></span>
<span><span class="co">#&gt; 3      I                 montreal</span></span>
<span><span class="co">#&gt; 4      R                 montreal</span></span>
<span><span class="co">#&gt; 5   beta                 montreal</span></span>
<span><span class="co">#&gt; 6      S                  toronto</span></span>
<span><span class="co">#&gt; 7      E                  toronto</span></span>
<span><span class="co">#&gt; 8      I                  toronto</span></span>
<span><span class="co">#&gt; 9      R                  toronto</span></span>
<span><span class="co">#&gt; 10  beta                  toronto</span></span>
<span><span class="co">#&gt; 11 alpha                         </span></span>
<span><span class="co">#&gt; 12 gamma                         </span></span>
<span><span class="co">#&gt; 13       montreal_to_toronto_rate</span></span>
<span><span class="co">#&gt; 14       toronto_to_montreal_rate</span></span></code></pre>
<p>In this new model, the functional form of the force of infection
remains constant and we simply update and add some of the <a href="#partition-sets">partition sets and variable names</a>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  group_partition <span class="op">=</span> <span class="st">"Location"</span>,</span>
<span>  group_names <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"montreal"</span>, <span class="st">"toronto"</span><span class="op">)</span>,</span>
<span>  output_partition <span class="op">=</span> <span class="st">"Epi"</span>,</span>
<span>  output_names <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"foi"</span>, <span class="st">"foi"</span><span class="op">)</span>,</span>
<span>  input_partition <span class="op">=</span> <span class="st">"Epi"</span>,</span>
<span>  math_function <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">S</span>, <span class="va">E</span>, <span class="va">I</span>, <span class="va">R</span>, <span class="va">beta</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">I</span> <span class="op">*</span> <span class="va">beta</span> <span class="op">/</span> <span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="va">S</span>, <span class="va">E</span>, <span class="va">I</span>, <span class="va">R</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This will define expressions to produce derived variables called
<code>foi.montreal</code> and <code>foi.toronto</code>. To get this list
we did the following.</p>
<ol style="list-style-type: decimal">
<li>Added geographical grouping information to specify how to stratify
the force of infection.</li>
<li>Repeat the entry in <code>output_names</code> once for each
location.</li>
</ol>
<p>This model product assumes that individuals in Toronto cannot be
infected by individuals in Montreal. This is a reasonable assumption for
this spatial stratification, but in models where the stratification does
not isolate compartments from each other we need to add an additional
derived variable that sums the force of infection components over the
strata. Consider for example the SEIR model stratified by vaccination
status.</p>
<pre><code><span><span class="co">#&gt;      Epi       Vax</span></span>
<span><span class="co">#&gt; 1      S     unvax</span></span>
<span><span class="co">#&gt; 2      E     unvax</span></span>
<span><span class="co">#&gt; 3      I     unvax</span></span>
<span><span class="co">#&gt; 4      R     unvax</span></span>
<span><span class="co">#&gt; 5   beta     unvax</span></span>
<span><span class="co">#&gt; 6  alpha          </span></span>
<span><span class="co">#&gt; 7  gamma          </span></span>
<span><span class="co">#&gt; 8      N     unvax</span></span>
<span><span class="co">#&gt; 9    foi     unvax</span></span>
<span><span class="co">#&gt; 10     S       vax</span></span>
<span><span class="co">#&gt; 11     E       vax</span></span>
<span><span class="co">#&gt; 12     I       vax</span></span>
<span><span class="co">#&gt; 13     R       vax</span></span>
<span><span class="co">#&gt; 14  beta       vax</span></span>
<span><span class="co">#&gt; 15 alpha          </span></span>
<span><span class="co">#&gt; 16 gamma          </span></span>
<span><span class="co">#&gt; 17     N       vax</span></span>
<span><span class="co">#&gt; 18   foi       vax</span></span>
<span><span class="co">#&gt; 19       dose_rate</span></span></code></pre>
<p>We can compute the force of infection components just as we did for
the spatial model.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  group_partition <span class="op">=</span> <span class="st">"Vax"</span>,</span>
<span>  group_names <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"unvax"</span>, <span class="st">"vax"</span><span class="op">)</span>,</span>
<span>  output_partition <span class="op">=</span> <span class="st">"Epi"</span>,</span>
<span>  output_names <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"foi"</span>, <span class="st">"foi"</span><span class="op">)</span>,</span>
<span>  input_partition <span class="op">=</span> <span class="st">"Epi"</span>,</span>
<span>  math_function <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">S</span>, <span class="va">E</span>, <span class="va">I</span>, <span class="va">R</span>, <span class="va">beta</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">I</span> <span class="op">*</span> <span class="va">beta</span> <span class="op">/</span> <span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="va">S</span>, <span class="va">E</span>, <span class="va">I</span>, <span class="va">R</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>But to complete the model product we must add a derived variable that
takes the sum of all of the <code>Epi == "foi"</code> variables.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  output_partition <span class="op">=</span> <span class="st">"epi.vax"</span>,</span>
<span>  output_names <span class="op">=</span> <span class="st">"foi.total"</span>,</span>
<span>  input_partition <span class="op">=</span> <span class="st">"epi.vax"</span>,</span>
<span>  input_names_dots <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"foi.unvax"</span>, <span class="st">"foi.vax"</span><span class="op">)</span>,</span>
<span>  math_function <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This will produce a single derived variable called
<code>foi.total</code>, which can be used as the force of infection for
all vaccination strata.</p>
<p>There are other operations on model space besides model products.
Another such operation is to convert a single compartment into several
compartments. An example of this operation is to break up the infectious
compartment into several symptomatic states.</p>
<pre><code><span><span class="co">#&gt;               Epi EpiEffective   Symp      Type</span></span>
<span><span class="co">#&gt; 1               S            S                 </span></span>
<span><span class="co">#&gt; 2               E            E                 </span></span>
<span><span class="co">#&gt; 3               I                mild component</span></span>
<span><span class="co">#&gt; 4               I              severe component</span></span>
<span><span class="co">#&gt; 5               I                        vector</span></span>
<span><span class="co">#&gt; 6               I            I                 </span></span>
<span><span class="co">#&gt; 7               R            R                 </span></span>
<span><span class="co">#&gt; 8            beta         beta                 </span></span>
<span><span class="co">#&gt; 9           alpha        alpha                 </span></span>
<span><span class="co">#&gt; 10          gamma        gamma   mild          </span></span>
<span><span class="co">#&gt; 11          gamma        gamma severe          </span></span>
<span><span class="co">#&gt; 12 infectiousness                mild component</span></span>
<span><span class="co">#&gt; 13 infectiousness              severe component</span></span>
<span><span class="co">#&gt; 14 infectiousness                        vector</span></span>
<span><span class="co">#&gt; 15            foi          foi</span></span></code></pre>
<p>Notice the <code>"Type"</code> partition that indicates the different
forms with which the symptomatic-status-structured variables are
represented. Here the scalar components of <code>I</code> and
<code>infectiousness</code> can be referred to, or one can refer to
vectors that contain all components. The components are
<code>I.mild.component</code>, <code>I.severe.component</code>,
<code>infectiousness.mild.component</code>, and
<code>infectiousness.severe.component</code>. The vectors are
<code>I..vector</code> and <code>infectiousness..vector</code>. The
variable <code>I..effective</code> refers to the the weighted sum given
by the inner product of <code>I..vector</code> and
<code>infectiousness..vector</code>.</p>
<p>Here we assume that the <code>component</code> types are input
variables, and that we derive the other <code>I</code> and
<code>infectiousness</code> variables with the following
definitions.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">group_partition =</span> <span class="st">"Epi.Symp"</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">group_names =</span> <span class="fu">c</span>(<span class="st">"I.mild"</span>, <span class="st">"I.severe"</span>, <span class="st">"infectiousness.mild"</span>, <span class="st">"infectiousness.severe"</span>),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_partition =</span> <span class="st">"Epi.Type"</span>,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_names =</span> <span class="fu">c</span>(<span class="st">"I.vector"</span>, <span class="st">"infectiousness.vector"</span>),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">input_partition =</span> <span class="st">"Symp"</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">input_names_dots =</span> <span class="fu">c</span>(<span class="st">"mild"</span>, <span class="st">"severe"</span>),</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">math_function =</span> <span class="cf">function</span>(...) <span class="fu">c</span>(...)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># list(</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   #group_partition = "Epi",</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   #group_names = c("I", "I", "infectiousness.mild", "infectiousness.severe"),</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   output_partition = "Epi.EpiEffective",</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   output_names = "I.I",</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   input_partition = "Epi.Symp",</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   input_names_dots = c("I.mild", "I.severe", "infectiousness.mild", "infectiousness.severe"),</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   math_function = function(...) {</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     l = unlist(list(...))</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">#     n = length(l)</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">#     sum(l[1:(n/2)] * l[((n/2)+1):n])</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">group_partition =</span> <span class="st">"Type"</span>,</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">group_names =</span> <span class="st">"vector"</span>,</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_partition =</span> <span class="st">"EpiEffective"</span>,</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_names =</span> <span class="st">"I"</span>,</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">input_partition =</span> <span class="st">"Epi"</span>,</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">math_function =</span> <span class="cf">function</span>(I, infectiousness) {</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(I <span class="sc">*</span> infectiousness)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_partition =</span> <span class="st">"Epi"</span>,</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_names =</span> <span class="st">"foi"</span>,</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">input_partition =</span> <span class="st">"Epi"</span>,</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">math_function =</span> <span class="cf">function</span>(S, E, I, R)</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>The ordering of the <code>derivations</code> list must be
topologically sorted so that the dependencies of each expression appear
earlier in the list. This topological sorting requirement presents a
technical challenge when models are combined, as it becomes necessary to
be able to merge lists of <code>derivations</code> so that they remain
topologically sorted.</p>
</div>
<div class="section level2">
<h2 id="flow-between-compartments">Flow between Compartments<a class="anchor" aria-label="anchor" href="#flow-between-compartments"></a>
</h2>
<p>We have another data frame, <code>flows</code>, with rows describing
how individuals flow between pairs of compartments. There are four
required columns in this data frame, <code>from</code>, <code>to</code>,
<code>flow</code>, and <code>type</code>.</p>
<ul>
<li>
<code>from</code> – The <a href="#variable-names">variable name</a>
of the compartment from which individuals are flowing.</li>
<li>
<code>to</code> – The <a href="#variable-names">variable name</a> of
the compartment to which individuals are flowing.</li>
<li>
<code>flow</code> – The name of the variable governing the magnitude
of the flow.</li>
<li>
<code>type</code> – A type describing the way in which the magnitude
of flow is quantified. The following options are available.
<ul>
<li>
<code>"per_capita"</code> – The flow from <code>from</code> and to
<code>to</code> equals <code>from * flow</code>.</li>
<li>
<code>"absolute"</code> – The flow from <code>from</code> and to
<code>to</code> equals <code>flow</code>.</li>
<li>
<code>"per_capita_inflow"</code> – The flow to <code>to</code>
equals <code>from * flow</code>.</li>
<li>
<code>"per_capita_outflow"</code> – The flow from <code>from</code>
equals <code>from * flow</code>.</li>
<li>
<code>"absolute_inflow"</code> – The flow to <code>to</code> equals
<code>flow</code>.</li>
<li>
<code>"absolute_outflow"</code> – The flow from <code>from</code>
equals <code>flow</code>.</li>
</ul>
</li>
</ul>
<p>For example, consider this SIR model.</p>
<pre><code><span><span class="co">#&gt;     epi</span></span>
<span><span class="co">#&gt; 1     S</span></span>
<span><span class="co">#&gt; 2     I</span></span>
<span><span class="co">#&gt; 3     R</span></span>
<span><span class="co">#&gt; 4  beta</span></span>
<span><span class="co">#&gt; 5 gamma</span></span>
<span><span class="co">#&gt; 6   foi</span></span></code></pre>
<p>We would have the following <code>flows.csv</code> file.</p>
<pre><code><span><span class="co">#&gt;   from to  flow       type</span></span>
<span><span class="co">#&gt; 1    S  I   foi per_capita</span></span>
<span><span class="co">#&gt; 2    I  R gamma per_capita</span></span></code></pre>
<p>Notice that all state variables appear in this table, and that it
contains no parameters. This is the mechanism for encoding whether a
model variable is a state variables or a parameter.</p>
<p>A more interesting example is the following
<code>Epi</code>-by-<code>Vax</code> model.</p>
<pre><code><span><span class="co">#&gt;      Epi       Vax</span></span>
<span><span class="co">#&gt; 1      S     unvax</span></span>
<span><span class="co">#&gt; 2      I     unvax</span></span>
<span><span class="co">#&gt; 3      R     unvax</span></span>
<span><span class="co">#&gt; 4   beta     unvax</span></span>
<span><span class="co">#&gt; 5      S       vax</span></span>
<span><span class="co">#&gt; 6      I       vax</span></span>
<span><span class="co">#&gt; 7      R       vax</span></span>
<span><span class="co">#&gt; 8   beta       vax</span></span>
<span><span class="co">#&gt; 9  alpha          </span></span>
<span><span class="co">#&gt; 10 gamma          </span></span>
<span><span class="co">#&gt; 11   foi          </span></span>
<span><span class="co">#&gt; 12       dose_rate</span></span></code></pre>
<p>The <code>flows</code> data frame for these variables could look like
the following.</p>
<pre><code><span><span class="co">#&gt;      from      to       flow       type</span></span>
<span><span class="co">#&gt; 1 S.unvax I.unvax  foi.total per_capita</span></span>
<span><span class="co">#&gt; 2 I.unvax R.unvax     gamma. per_capita</span></span>
<span><span class="co">#&gt; 3   S.vax   I.vax  foi.total per_capita</span></span>
<span><span class="co">#&gt; 4   I.vax   R.vax     gamma. per_capita</span></span>
<span><span class="co">#&gt; 5 S.unvax   S.vax .dose_rate per_capita</span></span>
<span><span class="co">#&gt; 6 I.unvax   I.vax .dose_rate per_capita</span></span>
<span><span class="co">#&gt; 7 R.unvax   R.vax .dose_rate per_capita</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="flows-in-structured-models">Flows in Structured Models<a class="anchor" aria-label="anchor" href="#flows-in-structured-models"></a>
</h2>
<p>Structured models can have a large number of flows making the above
<code>flows</code> data structure very long. For example, an SEIR model
with three symptomatic status’, five vaccination status’, in 30
geographic locations would have over 750 flows depending on the details
of the vaccination and geographic models. The length of the list is not
in-and-of-itself the main problem with this data structure. A bigger
problem is that the data structure does not preserve the model
structure, making it difficult to visualize the underlying simplicity.
For example, if the model structure was preserved in the
<code>flows</code> data it would be possible to automatically construct
box diagrams for communicating the simplicity of a seemingly complex
compartmental model.</p>
<p>On the other hand, the benefit of the more explicit data structure in
[Flows between Compartments] is that it is easy to read each line. For
example, the following line clearly tells me that unvaccinated exposed
individuals flow to unvaccinated infectious individuals with mild
symptoms at a rate that is independent of both vaccination status and
symptomatic status.</p>
<pre><code><span><span class="co">#&gt;       from           to    flow       type</span></span>
<span><span class="co">#&gt; 1 E..unvax I.mild.unvax alpha.. per_capita</span></span></code></pre>
<p>In this section we add more columns to the data structure for
encoding model structure. These additional columns make it possible to
shorten the list and retain model structure information, at the cost of
making the meaning of each line more difficult to decode. However, if
required, as we will see, the structured version can always be converted
to the simpler but longer unstructured version. But it is not possible
to go from unstructured to structured.</p>
<p>The first three additional columns contain partition sets to resolve
the names in <code>from</code>, <code>to</code>, and <code>flow</code>.
Consider the following example.</p>
<pre><code><span><span class="co">#&gt;   from to flow       type from_partition to_partition flow_partition</span></span>
<span><span class="co">#&gt; 1    S  E  foi per_capita            Epi          Epi            Epi</span></span></code></pre>
<p>Consider this example within the context of an SEIR model stratified
by two vaccination status’. In this case this data structure does not
allow us to distinguish between models where <code>S.unvax</code> flows
only to <code>E.unvax</code> from one where it is also allowed to flow
to <code>E.vax</code>. To address this problem, we need three more
partition columns for matching up valid <code>S</code>-<code>E</code>
pairs. The following table provides an example of this.</p>
<pre><code><span><span class="co">#&gt;   from to flow       type from_partition to_partition flow_partition</span></span>
<span><span class="co">#&gt; 1    S  E  foi per_capita            Epi          Epi            Epi</span></span>
<span><span class="co">#&gt;   from_to_partition from_flow_partition to_flow_partition</span></span>
<span><span class="co">#&gt; 1               Vax</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="transmission-matrices-in-progress">Transmission Matrices (in progress)<a class="anchor" aria-label="anchor" href="#transmission-matrices-in-progress"></a>
</h2>
</div>
<div class="section level2">
<h2 id="file-formats">File Formats<a class="anchor" aria-label="anchor" href="#file-formats"></a>
</h2>
<p>Both CSV files have the following format.</p>
<ul>
<li>Column delimiter is a comma.</li>
<li>There are no quotes anywhere in the file.</li>
<li>There are no special missing value tokens.</li>
<li>The first row gives the names of the partitions.</li>
<li>There are no row names.</li>
</ul>
<p>Additionally, the only characters that are allowed in this file are
uppercase and lowercase letters, digits, underscores, and commas. The
presence of any other character is sufficient to invalidate the
file.</p>
<p>The <code>settings.json</code> file contains a single object with the
following key-value pairs.</p>
<ul>
<li>
<code>required_partitions</code> – array of strings</li>
<li>
<code>state_variables</code> – array of strings</li>
<li>
<code>flow_variables</code> – array of strings</li>
</ul>
<p>The <code>derivations.json</code> file contains a single array of
objects. Each of these objects has the following required key-value
pairs.</p>
<ul>
<li>
<code>output_names</code> – array of strings</li>
<li>
<code>expression</code> – string</li>
</ul>
<p>Each of these objects has the following optional key-value pairs,
although some of these optional pairs become required given the
existence of others.</p>
<ul>
<li>
<code>filter_names</code> – array of strings</li>
<li>
<code>group_names</code> – array of strings</li>
<li>
<code>input_names</code> – array of strings</li>
<li>
<code>input_dots</code> – array of strings</li>
<li>
<code>filter_partition</code> – string</li>
<li>
<code>group_partition</code> – string</li>
<li>
<code>output_partition</code> – string</li>
<li>
<code>input_partition</code> – string</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Steve Walker, Darren Flynn-Primrose, Weiguang Guan, Ben Bolker, Steve Walker.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
