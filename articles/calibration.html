<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="macpan2">
<title>Calibrating Compartmental Models to Data • macpan2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calibrating Compartmental Models to Data">
<meta property="og:description" content="macpan2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.3</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/quickstart.html">Quickstart Guide: specifying and simulating a simple compartmental model</a>
    <a class="dropdown-item" href="../articles/quickstart2.html">Quickstart Guide, part 2: specifying and simulating a structured compartmental model</a>
    <a class="dropdown-item" href="../articles/time_varying_parameters.html">Specifying Time-Varying Parameters</a>
    <a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a>
    <a class="dropdown-item" href="../articles/example_models.html">Example Models</a>
    <a class="dropdown-item" href="../articles/flow_types.html">Flow Types</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Calibrating Compartmental Models to Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/HEAD/vignettes/calibration.Rmd" class="external-link"><code>vignettes/calibration.Rmd</code></a></small>
      <div class="d-none name"><code>calibration.Rmd</code></div>
    </div>

    
    
<p><a href="https://canmod.github.io/macpan2/articles/vignette-status#working-draft"><img src="https://img.shields.io/badge/status-working%20draft-red" alt="status"></a></p>
<p>Setup:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://canmod.github.io/macpan2/">macpan2</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in checkMatrixPackageVersion(): Package version inconsistency detected.</span></span>
<span><span class="co">#&gt; TMB was built with Matrix version 1.6.0</span></span>
<span><span class="co">#&gt; Current Matrix version is 1.5.4.1</span></span>
<span><span class="co">#&gt; Please re-install 'TMB' from source using install.packages('TMB', type = 'source') or ask CRAN for a binary version of 'TMB' matching CRAN's 'Matrix' package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/canmod/macpan2helpers" class="external-link">macpan2helpers</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>; <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>In addition to these packages, the <code>broom.mixed</code> package
is used below (if installed).</p>
<div class="section level2">
<h2 id="hello-world-an-easy-calibration-exercise">‘Hello, World’: an easy (??) calibration exercise<a class="anchor" aria-label="anchor" href="#hello-world-an-easy-calibration-exercise"></a>
</h2>
<p>We’ll do the first thing you should always do when trying out a new
fitting procedure: simulate clean, nice data from the model and see if
you can recover something close to the true parameters.</p>
<div class="section level3">
<h3 id="step-0-set-up-simulator-and-generate-data">Step 0: set up simulator and generate ‘data’<a class="anchor" aria-label="anchor" href="#step-0-set-up-simulator-and-generate-data"></a>
</h3>
<p>First set up the model from the quickstart guide:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir</span> <span class="op">=</span> <span class="fu"><a href="../reference/Compartmental.html">Compartmental</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"starter_models"</span>, <span class="st">"sir"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sir_simulator</span> <span class="op">=</span> <span class="va">sir</span><span class="op">$</span><span class="va">simulators</span><span class="op">$</span><span class="fu">tmb</span><span class="op">(</span></span>
<span>  time_steps <span class="op">=</span> <span class="fl">100</span>,</span>
<span>  state <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">99</span>, I <span class="op">=</span> <span class="fl">1</span>, R <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>  flow <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>foi <span class="op">=</span> <span class="cn">NA</span>, gamma <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>,</span>
<span>  beta <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>  N <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">## This is key!</span></span>
<span><span class="va">sir_results</span> <span class="op">=</span> <span class="va">sir_simulator</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span>.phases <span class="op">=</span> <span class="st">"during"</span><span class="op">)</span></span></code></pre></div>
<p><strong>fixme</strong>: providing mismatched time series (e.g. by
forgetting to specify <code>.phases = "during"</code> when generating
simulated data) gives cryptic/confusing errors and behaviour (warnings
about failure to recycle, objective function values equal to zero). (We
can make a reprex for this by leaving out
<code>.phases = "during"</code> above …</p>
<p>Add some noise to the prevalence (<code>I</code>) value:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">101</span><span class="op">)</span></span>
<span><span class="va">sir_prevalence</span> <span class="op">=</span> <span class="op">(</span><span class="va">sir_results</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="va">matrix</span>, <span class="va">col</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">row</span> <span class="op">==</span> <span class="st">"I"</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>obs_val <span class="op">=</span> <span class="va">value</span> <span class="op">+</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">gg0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sir_prevalence</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">obs_val</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">gg0</span><span class="op">)</span></span></code></pre></div>
<p><img src="calibration_files/figure-html/sir_noise-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="step-1-add-observed-data-and-slots-for-history-etc-">Step 1: add observed data and slots for history etc.<a class="anchor" aria-label="anchor" href="#step-1-add-observed-data-and-slots-for-history-etc-"></a>
</h3>
<p>While the files specified in the model definition
(<code>variables.csv</code>, <code>derivations.csv</code>,
<code>settings.json</code>, <code>flows.csv</code>) are sufficient to
define a simulator, we now need to add more structure to the model
object so we can do the calibration - specifically, both whatever
observed data we want to compare against, and whatever new variables
(“matrices”) and expressions we will evaluate to compute the goodness of
fit (aka the loss function or objective function) of a particular set of
parameters.</p>
<p><strong>fixme</strong>: any chance of adding an interface layer that
would do this stuff?</p>
<p>If we have a <code>TMBSimulator</code> object (i.e.,
<code>sir_simulator</code> in this example), the
<code>$add$matrices()</code> method will add new variables to the space
where the object has already stored the state variables, etc. (you use
<code>sir_simulator$matrix_names()</code> to list the existing matrices,
although this produces a long, scary list of internal variables that
<code>macpan2</code> has constructed)</p>
<p>Now we will use <code>$add$matrices()</code> to:</p>
<ol style="list-style-type: lower-alpha">
<li>add observed data</li>
<li>declare a matrix storing the simulation history of variables to
compare with observed data</li>
<li>declare a matrix to store the log-likelihood</li>
<li>specify which matrices to save and/or return in the report</li>
</ol>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span></span>
<span>  <span class="co">## observed data</span></span>
<span>  I_obs <span class="op">=</span> <span class="va">sir_prevalence</span><span class="op">$</span><span class="va">obs_val</span>,</span>
<span>  <span class="co">## simulated trajectory to compare with data</span></span>
<span>  I_sim <span class="op">=</span> <span class="va">empty_matrix</span>, </span>
<span>  <span class="co">## matrix to contain the log likelihood values at each time step</span></span>
<span>  log_lik <span class="op">=</span> <span class="va">empty_matrix</span>,</span>
<span>  <span class="co">## need to save the simulation history of each of these matrices</span></span>
<span>  .mats_to_save <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"I_sim"</span>, <span class="st">"log_lik"</span><span class="op">)</span>,</span>
<span>  .mats_to_return <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"I_sim"</span>, <span class="st">"log_lik"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>fixme</strong>: possibly comment that we <em>could</em> have
added some of these objects up-front, in the definition files …</p>
<p><strong>fixme</strong>: some examples show
<code>sir_simulator$print$matrix_dims()</code> at this point. What is
this good for/how do we interpret it?</p>
</div>
<div class="section level3">
<h3 id="step-2-collect-simulated-values">Step 2: collect simulated values<a class="anchor" aria-label="anchor" href="#step-2-collect-simulated-values"></a>
</h3>
<p>Collect simulated values into matrices to be compared with data. the
<code>.at = Inf</code> and <code>.phase = "during"</code> indicates that
this expression should come at the <em>end</em> of the expressions
evaluated during each iteration of the simulation loop.</p>
<p>Like <code>$add$matrices()</code>, <code>$insert$expressions</code>
adds components to an existing <code>TMBSimulator</code> object - in
this case, expressions that will be computed during the simulation. (In
this example, since we set <code>.phase = "during"</code>, the
expressions will be computed at each time step.)</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>  <span class="va">I_sim</span> <span class="op">~</span> <span class="va">I</span>,</span>
<span>  .phase <span class="op">=</span> <span class="st">"during"</span>,</span>
<span>  .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>fixme</strong>: what’s the best way to handle irregularly
sampled data/match up with timestamps of observed data? (not for here,
this should be a footnote or put in an ‘extra tricks’ section)</p>
</div>
</div>
<div class="section level2">
<h2 id="step-3-set-up-and-compute-objective-function">Step 3: set up and compute objective function<a class="anchor" aria-label="anchor" href="#step-3-set-up-and-compute-objective-function"></a>
</h2>
<p>We will use the log (by default) of the Gaussian density of the
observed <code>I</code> values with mean (i.e. predicted) value of the
simulated <code>I</code> values (this is equivalent to least-squares
estimation, with the added complication that we estimate the standard
deviation explicitly rather than computing it from the residuals).</p>
<ul>
<li>Add the new parameter (standard deviation of the observed
<code>I</code> distribution around the predicted <code>I</code>
values)</li>
<li>The <code>rbind_time</code> function gathers together the full
simulation history of the <code>I_sim</code> matrix by binding together
the rows at each iteration.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span> I_sd <span class="op">=</span> <span class="fl">1</span> <span class="op">)</span></span>
<span><span class="va">sir_simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>  <span class="va">log_lik</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">dnorm</a></span><span class="op">(</span><span class="va">I_obs</span>, <span class="fu"><a href="../reference/engine_functions.html">rbind_time</a></span><span class="op">(</span><span class="va">I_sim</span><span class="op">)</span>, <span class="va">I_sd</span><span class="op">)</span>,</span>
<span>  .phase <span class="op">=</span> <span class="st">"after"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Define the objective function (which will almost always be the sum of
the negative log-likelihoods for each point):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">obj_fn</span><span class="op">(</span><span class="op">~</span> <span class="op">-</span><span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="va">log_lik</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-4-declare-andor-transform-parameters-to-be-optimized-set-starting-values">Step 4: declare and/or transform parameters to be optimized, set
starting values<a class="anchor" aria-label="anchor" href="#step-4-declare-andor-transform-parameters-to-be-optimized-set-starting-values"></a>
</h2>
<ul>
<li>We could have postponed defining <code>I_sd</code> in the model
until this step (<strong>fixme</strong>: right?), but it would have been
confusing since we used it in the objective function.</li>
<li>For parameters that are restricted to be positive, it is almost
always best to estimate them on the log scale. This ensures that their
values will always be non-negative (and positive unless the transformed
values are negative and large enough in magnitude that
<code>exp(x)</code> underflows to zero) and has other advantages in
optimization (<strong>fixme</strong>: how much detail is needed here?
Shrink scale of optimization, make parameter magnitudes <span class="math inline">\({\cal O}(1)\)</span>, make Wald estimation more
reliable …)</li>
<li>In practice we would often read the parameter starting values in
from a CSV file (using <code>read.csv</code> from base R or
<code>readr::read_csv()</code> from tidyverse), but here we can set up
the data frame on the fly</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">transformations</span><span class="op">(</span><span class="fu"><a href="../reference/Transform.html">Log</a></span><span class="op">(</span><span class="st">"I_sd"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sir_simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">transformations</span><span class="op">(</span><span class="fu"><a href="../reference/Transform.html">Log</a></span><span class="op">(</span><span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.delim</a></span><span class="op">(</span>sep <span class="op">=</span> <span class="st">"|"</span>, header <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     strip.white <span class="op">=</span> <span class="cn">FALSE</span>, <span class="co">## important!</span></span>
<span>                     text <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">mat       | row | col | default</span></span>
<span><span class="st">log_I_sd  | 0   | 0   | 0</span></span>
<span><span class="st">log_beta  | 0   | 0   | 1</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="va">sir_simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">params_frame</span><span class="op">(</span><span class="va">params</span><span class="op">)</span></span></code></pre></div>
<p>Using <code>$add_transformations(Log("var"))</code> automatically
adds a variable called <code>log_var</code> to the list of matrices.</p>
<p><strong>fixme</strong>: if I fail to use
<code>strip.white = TRUE</code> (so the <code>mat</code> names have
trailing whitespace), then on the last line above I get a
less-than-perfectly-useful error message:</p>
<blockquote>
<p>Error in valid$consistency_params_mats$check(self$model) :
optimization parameters are not consistent with matrices but validity
could not be checked because:<br> Error in if (any(!valid_pars)) { :
missing value where TRUE/FALSE needed</p>
</blockquote>
<div class="section level3">
<h3 id="step-5-do-the-fit">Step 5: do the fit<a class="anchor" aria-label="anchor" href="#step-5-do-the-fit"></a>
</h3>
<p>It’s always a good idea to do some quick sanity checks on the
objective function before you try to optimize: do you get finite values
(for reasonable inputs)? Does changing the inputs change the returned
value?</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_simulator</span><span class="op">$</span><span class="fu">objective</span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 3565.546</span></span>
<span><span class="va">sir_simulator</span><span class="op">$</span><span class="fu">objective</span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 25020</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## these were some other things I tried out when debugging ...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sir_simulator</span><span class="op">$</span><span class="va">get</span><span class="op">$</span><span class="fu">initial</span><span class="op">(</span><span class="st">"log_I_sd"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sir_simulator</span><span class="op">$</span><span class="va">get</span><span class="op">$</span><span class="fu">initial</span><span class="op">(</span><span class="st">"log_beta"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">sir_simulator</span><span class="op">$</span><span class="va">current</span><span class="op">$</span><span class="fu">params_frame</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sir_simulator</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">sir_simulator</span><span class="op">$</span><span class="va">optimize</span><span class="op">$</span><span class="fu">nlminb</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>Print the results of <code>nlminb</code> - <strong>always check the
value of the convergence code</strong> (if it’s not 0, then something
<em>may</em> have gone wrong …)</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;      params      params </span></span>
<span><span class="co">#&gt; -0.07942465 -1.61413121 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 133.9514</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 12</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       19       13 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "relative convergence (4)"</span></span></code></pre></div>
<p>Back-transform the parameters:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">par</span><span class="op">)</span></span>
<span><span class="co">#&gt;    params    params </span></span>
<span><span class="co">#&gt; 0.9236476 0.1990635</span></span></code></pre></div>
<p>Get more information:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ff</span> <span class="op">&lt;-</span> <span class="va">sir_simulator</span><span class="op">$</span><span class="fu">ad_fun</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">ff</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"TMB"</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"broom.mixed"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="op">(</span><span class="fu">broom.mixed</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">ff</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>        <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="va">type</span>, <span class="va">std.error</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="co">## ugh, shouldn't need to do this by hand</span></span>
<span>        <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>term <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"I_sd"</span>, <span class="st">"beta"</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html" class="external-link">where</a></span><span class="op">(</span><span class="va">is.numeric</span><span class="op">)</span>, <span class="va">exp</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; Loading required namespace: broom.mixed</span></span>
<span><span class="co">#&gt; outer mgc:  3.953665e-07 </span></span>
<span><span class="co">#&gt; outer mgc:  0.1998001 </span></span>
<span><span class="co">#&gt; outer mgc:  0.2002002 </span></span>
<span><span class="co">#&gt; outer mgc:  63.85069 </span></span>
<span><span class="co">#&gt; outer mgc:  63.73186</span></span>
<span><span class="co">#&gt;   term  estimate  conf.low conf.high</span></span>
<span><span class="co">#&gt; 1 I_sd 0.9236476 0.8041134 1.0609510</span></span>
<span><span class="co">#&gt; 2 beta 0.1990635 0.1975248 0.2006143</span></span></code></pre></div>
<p>These correspond to true values of 0.2, 1, so pretty close.</p>
<p><strong>fixme</strong>: can we handle back-transformation/parameter
naming more nicely? <code><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef()</a></code>, <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> methods
… ??</p>
<p>The best-fit parameters are stored <em>internally</em>, so if we
re-run the <code>$report()</code> method we will get information about
the predicted best-fit trajectory:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_vals</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">sir_simulator</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span>.phases <span class="op">=</span> <span class="st">"during"</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span> <span class="op">==</span> <span class="st">"state"</span>, <span class="va">row</span> <span class="op">==</span> <span class="st">"I"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">gg0</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sim_vals</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span> <span class="va">value</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="calibration_files/figure-html/plot_results-1.png" width="700"></p>
<p><strong>fixme</strong>: what next? Show a fit to real data?
Comparison with <a href="https://github.com/parksw3/fitode" class="external-link">fitode</a>
?</p>
<p><strong>fixme</strong>: examples of (statistical) diagnostics?
e.g. compute residuals, plot vs. time or vs fitted values,
scale-location plot, etc. ?</p>
<p><strong>fixme</strong>: add some <em>intermediate</em> examples
(simple time-varying parameters, Poisson/negative binomial responses,
irregularly sampled data, fitting prevalence/hospitalization/death,
fitting multiple data streams …) try to minimize ‘boiler plate’, focus
on added features in each model …</p>
</div>
</div>
<div class="section level2">
<h2 id="measles-data">Measles Data<a class="anchor" aria-label="anchor" href="#measles-data"></a>
</h2>
<p>Here is a reasonably difficult problem – fit an SIR model to weekly
measles incidence data from London UK over about six decades.</p>
<!-- FIXME: store data locally, don't rely on IIDA ... -->
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">measles</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span></span>
<span>    <span class="st">"https://raw.githubusercontent.com/davidearn/iidda/master/data"</span>,</span>
<span>    <span class="st">"meas_uk__lon_1944-94_wk/source-data/meas_uk__lon_1944-94_wk.csv"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  comment <span class="op">=</span> <span class="st">"#"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">measles</span><span class="op">$</span><span class="va">date</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>  <span class="st">"%s-%s-%s"</span>, <span class="va">measles</span><span class="op">$</span><span class="va">year</span>, <span class="va">measles</span><span class="op">$</span><span class="va">month</span>, <span class="va">measles</span><span class="op">$</span><span class="va">day</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">measles</span><span class="op">$</span><span class="va">date</span>, <span class="va">measles</span><span class="op">$</span><span class="va">cases</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span></code></pre></div>
<p><img src="calibration_files/figure-html/sir_plot-1.png" width="576"></p>
<p>We need to slightly extend the standard SIR model to include waning
immunity.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir</span> <span class="op">=</span> <span class="fu"><a href="../reference/Compartmental.html">Compartmental</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"starter_models"</span>, <span class="st">"sir_waning"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sir</span><span class="op">$</span><span class="fu">flows</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   from to  flow       type</span></span>
<span><span class="co">#&gt; 1    S  I   foi per_capita</span></span>
<span><span class="co">#&gt; 2    I  R gamma per_capita</span></span>
<span><span class="co">#&gt; 3    R  S  wane per_capita</span></span></code></pre></div>
<p>We use <a href="https://canmod.github.io/macpan2/articles/time_varying_parameters.html#radial-basis-functions-for-flexible-time-variation-in-progress">radial
basis functions</a> to model time-variation in the transmission rate. We
also make a variety of questionable assumptions (TODO: fix these), but
the point at the moment is just to illustrate usage and provide a proof
of concept.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">measles</span><span class="op">)</span></span>
<span><span class="va">simulator</span> <span class="op">=</span> <span class="va">sir</span><span class="op">$</span><span class="va">simulators</span><span class="op">$</span><span class="fu">tmb</span><span class="op">(</span></span>
<span>      time_steps <span class="op">=</span> <span class="va">n</span></span>
<span>    , state <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">100000</span> <span class="op">-</span> <span class="fl">500</span>, I <span class="op">=</span> <span class="fl">500</span>, R <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    , flow <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>foi <span class="op">=</span> <span class="cn">NA_real_</span>, gamma <span class="op">=</span> <span class="fl">0.2</span>, wane <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## this beta does not matter because we will overwrite</span></span>
<span>    <span class="co">## it with the output of the radial basis functions</span></span>
<span>    , beta <span class="op">=</span> <span class="cn">NA_real_</span></span>
<span>    </span>
<span>    <span class="co">## FIXME: this is surely not the population of London at</span></span>
<span>    <span class="co">##        all in the series</span></span>
<span>    , N <span class="op">=</span> <span class="fl">100000</span> </span>
<span>    </span>
<span>    <span class="co">## matrices involved in radial basis functions</span></span>
<span>    , X <span class="op">=</span> <span class="fu"><a href="../reference/rbf.html">rbf</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span><span class="op">)</span></span>
<span>    , b <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="va">d</span>, sd <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>    , incidence <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>    , eta <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>    </span>
<span>    , .mats_to_save <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"incidence"</span>, <span class="st">"beta"</span><span class="op">)</span></span>
<span>    , .mats_to_return <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"incidence"</span>, <span class="st">"beta"</span><span class="op">)</span></span>
<span>    </span>
<span><span class="co">## initial S is a function of initial I, which we</span></span>
<span><span class="co">## fit to data below</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">S</span> <span class="op">~</span> <span class="va">N</span> <span class="op">-</span> <span class="va">I</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"before"</span></span>
<span>  , .at <span class="op">=</span> <span class="fl">1</span></span>
<span>  </span>
<span><span class="co">## radial basis function evaluations</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">eta</span> <span class="op">~</span> <span class="va">gamma</span> <span class="op">*</span> <span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"before"</span></span>
<span>  , .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">beta</span> <span class="op">~</span> <span class="va">eta</span><span class="op">[</span><span class="fu"><a href="../reference/engine_functions.html">time_step</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="../reference/engine_functions.html">clamp</a></span><span class="op">(</span><span class="va">S</span><span class="op">/</span><span class="va">N</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span>  , .at <span class="op">=</span> <span class="fl">1</span></span>
<span>  </span>
<span><span class="co">## save the simulated incidence trajectory to</span></span>
<span><span class="co">## compare with data</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">incidence</span> <span class="op">~</span> <span class="va">I</span></span>
<span>  , .vec_by_states <span class="op">=</span> <span class="st">"total_inflow"</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span>  , .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here is an example simulation from this model, before fitting to
data.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">simulated_incidence</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span>.phases <span class="op">=</span> <span class="st">"during"</span><span class="op">)</span>, <span class="va">matrix</span> <span class="op">==</span> <span class="st">"incidence"</span><span class="op">)</span><span class="op">$</span><span class="va">value</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">measles</span><span class="op">$</span><span class="va">date</span>, <span class="va">simulated_incidence</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span></span></code></pre></div>
<p><img src="calibration_files/figure-html/rbf_ex-1.png" width="576"></p>
<p>It looks nothing like the observed measles series, but illustrates
the ability to generate complex incidence patterns not present in the
simple SIR model without radial basis functions and waning immunity.</p>
<p>We modify the simulation object to be able to fit to the measles
data.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span></span>
<span>    reports <span class="op">=</span> <span class="va">measles</span><span class="op">$</span><span class="va">cases</span></span>
<span>  , log_lik <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>  , sim_reports <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">sim_reports</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">rbind_time</a></span><span class="op">(</span><span class="va">incidence</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"after"</span></span>
<span>  , .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">params</span><span class="op">(</span></span>
<span>  default <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.01</span><span class="op">)</span></span>
<span>    , <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">d</span><span class="op">)</span></span>
<span>    , <span class="fl">500</span></span>
<span>  <span class="op">)</span></span>
<span>  , mat <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="st">"flow"</span>, <span class="fl">2L</span><span class="op">)</span></span>
<span>    , <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="va">d</span><span class="op">)</span>  </span>
<span>    , <span class="st">"state"</span></span>
<span>  <span class="op">)</span></span>
<span>  , row <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span></span>
<span>      <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span></span>
<span>    , <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1L</span></span>
<span>    , <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">obj_fn</span><span class="op">(</span><span class="op">~</span> <span class="op">-</span> <span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">dpois</a></span><span class="op">(</span><span class="va">reports</span>, <span class="va">sim_reports</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The optimization takes quite a few minutes, and still doesn’t
converge in 10000 function evaluations.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">optimize</span><span class="op">$</span><span class="fu">nlminb</span><span class="op">(</span>control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>eval.max <span class="op">=</span> <span class="fl">10000</span>, iter.max <span class="op">=</span> <span class="fl">10000</span>, trace <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">optimization_history</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>  <span class="co">## the 3 is there because we tried two other times</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt;  6.703610e-01  7.526679e-03 -2.162259e-01  1.126783e-01  1.543212e-01 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt; -2.604592e-01  1.668384e-01  2.362683e-02 -1.469025e-01  1.003317e-01 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt;  8.794944e-02 -2.221838e-01  2.361532e-01 -4.625439e-02 -1.112743e-01 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt;  1.922560e-01  4.819028e-03 -1.147457e-01  8.483063e-02  1.043099e-01 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt; -5.263295e-02 -1.705089e-01  5.913537e-02  2.166735e-01 -6.042527e-02 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt; -1.215896e-01  6.958421e-02  2.000553e-01 -1.625052e-01 -9.811385e-02 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt;  1.243763e-01  1.010677e-01 -1.360912e-01 -1.548706e-01  1.815481e-01 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt;  1.510911e-01 -1.712425e-01 -7.163212e-02  1.810955e-01  8.962858e-02 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt; -2.150714e-01 -3.808731e-02  2.005794e-01  2.046720e-02 -1.889520e-01 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt;  5.045731e-02  1.254563e-01 -5.315440e-03 -1.319711e-01  4.561258e-02 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt;  1.574013e-01 -8.553873e-02 -1.130256e-01  1.392581e-01  1.081628e-02 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt; -7.757039e-02 -3.295611e-02  2.639818e-02  8.123818e-02 -3.865452e-02 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt; -6.998228e-02  1.467173e-02  7.241144e-02 -1.128534e-02 -8.720973e-02 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt;  8.108630e-03  8.316732e-02 -2.468066e-02  2.586809e-03 -7.554319e-04 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt; -7.257835e-02  3.037401e-02  1.165830e-01 -1.002377e-01 -9.919561e-02 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt;  1.209433e-01  3.064010e-02 -8.642897e-02  7.491963e-02 -4.535475e-02 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt; -6.703071e-02  8.723632e-02  4.807756e-02 -9.014383e-02  1.343315e-02 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt;  4.295778e-03 -4.030916e-02  7.575340e-02  1.585366e-02 -9.703117e-02 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt;  7.145315e-03  2.509495e-02 -1.568298e-02 -1.155331e-02  1.704822e-03 </span></span>
<span><span class="co">#&gt;        params        params        params        params        params </span></span>
<span><span class="co">#&gt;  3.350791e-03  1.860049e-03 -4.582404e-03 -1.358521e-03  1.805979e-02 </span></span>
<span><span class="co">#&gt;        params        params        params </span></span>
<span><span class="co">#&gt;  3.190466e-03 -1.310191e-02  5.000000e+02 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 161891.9</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 3250</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;    10000     3250 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "function evaluation limit reached without convergence (9)"</span></span></code></pre></div>
<p>Here the red data are fitted and black observed.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulated_incidence</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span>.phases <span class="op">=</span> <span class="st">"during"</span><span class="op">)</span>, <span class="va">matrix</span> <span class="op">==</span> <span class="st">"incidence"</span><span class="op">)</span><span class="op">$</span><span class="va">value</span></span>
<span><span class="co">#&gt; Constructing atomic D_lgamma</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">measles</span><span class="op">$</span><span class="va">date</span>, <span class="va">measles</span><span class="op">$</span><span class="va">cases</span>, xlab <span class="op">=</span> <span class="st">"time"</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">measles</span><span class="op">$</span><span class="va">date</span>, <span class="va">simulated_incidence</span>, col <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="calibration_files/figure-html/plot_rbf_res-1.png" width="576"></p>
<p>Not a perfect fit, but not bad for now (TODO: work on this, without
papering over the real challenges).</p>
</div>
<div class="section level2">
<h2 id="challenging-logistic-variation-in-transmission-rate">Challenging Logistic Variation in Transmission Rate<a class="anchor" aria-label="anchor" href="#challenging-logistic-variation-in-transmission-rate"></a>
</h2>
<p>Here we consider the problem of fitting an SIR model to a simulated
dataset from this model, such that the simulations pose challenges to
the fitting machinery.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir</span> <span class="op">=</span> <span class="fu"><a href="../reference/Compartmental.html">Compartmental</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"starter_models"</span>, <span class="st">"sir"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sir</span><span class="op">$</span><span class="fu">flows_expanded</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   from to  flow       type</span></span>
<span><span class="co">#&gt; 1    S  I   foi per_capita</span></span>
<span><span class="co">#&gt; 2    I  R gamma per_capita</span></span></code></pre></div>
<p>Our simulation model includes a logistically time-varying
transmission rate.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">=</span> <span class="fl">2500</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">simulator</span> <span class="op">=</span> <span class="va">sir</span><span class="op">$</span><span class="va">simulators</span><span class="op">$</span><span class="fu">tmb</span><span class="op">(</span></span>
<span>      time_steps <span class="op">=</span> <span class="va">n</span></span>
<span>    , state <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">100000</span> <span class="op">-</span> <span class="fl">500</span>, I <span class="op">=</span> <span class="fl">500</span>, R <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    , flow <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span>foi <span class="op">=</span> <span class="cn">NA</span>, gamma <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span><span class="co">#, wane = 0.01)</span></span>
<span>    , beta <span class="op">=</span> <span class="fl">1</span></span>
<span>    , N <span class="op">=</span> <span class="fl">100000</span></span>
<span>    , X <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    , b <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>    , incidence <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>    , beta_values <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>    , .mats_to_save <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"incidence"</span>, <span class="st">"beta"</span><span class="op">)</span></span>
<span>    , .mats_to_return <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"incidence"</span>, <span class="st">"beta"</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">beta_values</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"before"</span></span>
<span>  , .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">beta</span> <span class="op">~</span> <span class="va">beta_values</span><span class="op">[</span><span class="fu"><a href="../reference/engine_functions.html">time_step</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span>  , .at <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">incidence</span> <span class="op">~</span> <span class="va">I</span></span>
<span>  , .vec_by_states <span class="op">=</span> <span class="st">"total_inflow"</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span>  , .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">params</span><span class="op">(</span></span>
<span>    default <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  , mat <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  , row <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">5L</span><span class="op">)</span></span>
<span><span class="va">sims</span> <span class="op">=</span> <span class="va">simulator</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span>.phases <span class="op">=</span> <span class="st">"during"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">sims</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>variable <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">matrix</span> <span class="op">==</span> <span class="st">"state"</span>, <span class="va">row</span>, <span class="va">matrix</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">variable</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="calibration_files/figure-html/logistic_plot2-1.png" width="576"></p>
<p>Fitting to the simulation data, manages to converge, but to the wrong
value.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">3L</span><span class="op">)</span> <span class="co">## different seeds do result in convergence on the correct value</span></span>
<span><span class="va">reports</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">sims</span>, <span class="va">matrix</span> <span class="op">==</span> <span class="st">"incidence"</span><span class="op">)</span><span class="op">$</span><span class="va">value</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span>reports <span class="op">=</span> <span class="va">reports</span>, report_sim <span class="op">=</span> <span class="va">empty_matrix</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">report_sim</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">rbind_time</a></span><span class="op">(</span><span class="va">incidence</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"after"</span></span>
<span>  , .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">obj_fn</span><span class="op">(</span><span class="op">~</span> <span class="op">-</span><span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">dpois</a></span><span class="op">(</span><span class="va">reports</span>, <span class="va">report_sim</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">params</span><span class="op">(</span></span>
<span>    default <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="fl">2L</span><span class="op">)</span> <span class="co">## random starting values for the optimizer</span></span>
<span>  , mat <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  , row <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">optimize</span><span class="op">$</span><span class="fu">nlminb</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; outer mgc:  11268970 </span></span>
<span><span class="co">#&gt; Constructing atomic D_lgamma</span></span>
<span><span class="co">#&gt; outer mgc:  7215054 </span></span>
<span><span class="co">#&gt; outer mgc:  3087372 </span></span>
<span><span class="co">#&gt; outer mgc:  3522804 </span></span>
<span><span class="co">#&gt; outer mgc:  470268.8 </span></span>
<span><span class="co">#&gt; outer mgc:  802897.8 </span></span>
<span><span class="co">#&gt; outer mgc:  133686.6 </span></span>
<span><span class="co">#&gt; outer mgc:  4449.854 </span></span>
<span><span class="co">#&gt; outer mgc:  5.260259 </span></span>
<span><span class="co">#&gt; outer mgc:  8.0225e-06</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;     params     params </span></span>
<span><span class="co">#&gt; -1.0929130  0.1633477 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 326073.6</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 9</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       12       10 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "both X-convergence and relative convergence (5)"</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">current</span><span class="op">$</span><span class="fu">params_frame</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   par_id mat row col    default    current</span></span>
<span><span class="co">#&gt; 1      0   b   0   0 -0.9619334 -1.0929130</span></span>
<span><span class="co">#&gt; 2      1   b   1   0 -0.2925257  0.1633477</span></span>
<span><span class="va">fitted_incidence</span> <span class="op">=</span> <span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="va">current</span><span class="op">$</span><span class="fu">params_vector</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="va">simulator</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span> <span class="op">==</span> <span class="st">"incidence"</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">reports</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">fitted_incidence</span>, col <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="calibration_files/figure-html/logistic_bad_converge-1.png" width="576"></p>
<p>The fit is not good! Why? To find out we plot the likelihood surface
with arrows representing the magnitude and direction of the down-hill
gradient towards the optimum. Notice the very flat gradient in the
direction along the valley containing the optimum at <span class="math inline">\((0, 1)\)</span>. The gradient is pointing towards
the valley but not along it. I do not understand why.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_liksurf</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">lwr</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>, <span class="va">upr</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                         <span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">41</span>, <span class="fl">41</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">lik_surf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span></span>
<span>        intercept_parameter <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">lwr</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, to <span class="op">=</span> <span class="va">upr</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>                                  length.out <span class="op">=</span> <span class="va">n</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,</span>
<span>        slope_parameter <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="va">lwr</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, to <span class="op">=</span> <span class="va">upr</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>                              length.out <span class="op">=</span> <span class="va">n</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">gr</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">lik_surf</span>, <span class="fl">1</span>, <span class="va">simulator</span><span class="op">$</span><span class="va">gradient</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">lik_surf</span><span class="op">$</span><span class="va">z</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">lik_surf</span>, <span class="fl">1</span>, <span class="va">simulator</span><span class="op">$</span><span class="va">objective</span><span class="op">)</span></span>
<span>    <span class="va">gr</span> <span class="op">=</span> <span class="fl">0.1</span> <span class="op">*</span> <span class="va">gr</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">gr</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">lik_surf</span><span class="op">$</span><span class="va">gx</span> <span class="op">=</span> <span class="va">gr</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span>    <span class="va">lik_surf</span><span class="op">$</span><span class="va">gy</span> <span class="op">=</span> <span class="va">gr</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">lik_surf</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">lik_surf</span> <span class="op">&lt;-</span> <span class="fu">make_liksurf</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mk_plot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dd</span>, <span class="va">arrows</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">contours</span> <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    <span class="va">arrow_len</span> <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>                    <span class="va">cbrks</span> <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">*</span><span class="fl">1e5</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">gg0</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">dd</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">intercept_parameter</span>, <span class="va">slope_parameter</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">z</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span>        <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span>        <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"point"</span>, x <span class="op">=</span> <span class="fl">0</span>, y <span class="op">=</span> <span class="fl">1</span>, colour <span class="op">=</span> <span class="st">"yellow"</span>, size <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                   pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span>
<span>        <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_continuous.html" class="external-link">scale_fill_continuous</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log10"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">contours</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">gg0</span> <span class="op">&lt;-</span> <span class="va">gg0</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_contour.html" class="external-link">geom_contour</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>z <span class="op">=</span> <span class="va">z</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span>,</span>
<span>                                  breaks <span class="op">=</span> <span class="va">cbrks</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">arrows</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">gg0</span> <span class="op">&lt;-</span> <span class="va">gg0</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span></span>
<span>                         data <span class="op">=</span> <span class="va">dd</span><span class="op">[</span><span class="fu"><a href="../reference/engine_functions.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">dd</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">5</span> <span class="op">==</span> <span class="fl">0</span> , <span class="op">]</span>,</span>
<span>                         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>                             xend <span class="op">=</span> <span class="va">intercept_parameter</span> <span class="op">-</span> <span class="va">gx</span>, </span>
<span>                             yend <span class="op">=</span> <span class="va">slope_parameter</span> <span class="op">-</span> <span class="va">gy</span></span>
<span>                         <span class="op">)</span>, </span>
<span>                         arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html" class="external-link">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="va">arrow_len</span>, <span class="st">"inches"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                         colour <span class="op">=</span> <span class="st">'white'</span></span>
<span>                     <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">gg0</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">mk_plot</span><span class="op">(</span><span class="va">lik_surf</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="calibration_files/figure-html/logistic_plot_surf2-1.png" width="672"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lik_surf2</span> <span class="op">&lt;-</span> <span class="fu">make_liksurf</span><span class="op">(</span>lwr <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1</span>, <span class="fl">0.9</span><span class="op">)</span>, upr <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">1.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">mk_plot</span><span class="op">(</span><span class="va">lik_surf2</span>, arrows <span class="op">=</span> <span class="cn">FALSE</span>, cbrks <span class="op">=</span> <span class="fl">1e4</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="calibration_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<p>Explore more carefully:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">make_mat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="../reference/engine_functions.html">matrix</a></span><span class="op">(</span><span class="va">z</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">intercept_parameter</span><span class="op">)</span>,</span>
<span>                            slope <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">slope_parameter</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>       <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/dmurdoch/rgl" class="external-link">rgl</a></span><span class="op">)</span></span>
<span><span class="va">z1</span> <span class="op">&lt;-</span> <span class="fu">make_mat</span><span class="op">(</span><span class="va">lik_surf</span><span class="op">)</span></span>
<span><span class="fu">persp3d</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span></span>
<span><span class="va">z2</span> <span class="op">&lt;-</span> <span class="fu">make_mat</span><span class="op">(</span><span class="va">lik_surf2</span><span class="op">)</span></span>
<span><span class="fu">persp3d</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">z2</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">z2</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">z2</span><span class="op">)</span>,</span>
<span>        col <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span></span></code></pre></div>
<p><strong>fixme</strong>: what causes spikiness along the ridge? Add
points where each optimization attempt stopped?</p>
<p><strong>experimental</strong>: working with <code>DEoptim</code>
(haven’t included yet because I don’t want to have to
<code>Suggest:</code> DEoptim …</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ArdiaD/DEoptim" class="external-link">DEoptim</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">101</span><span class="op">)</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">DEoptim</span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="va">objective</span>, lower <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">2</span><span class="op">)</span>, upper <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fitted_incidence</span> <span class="op">=</span> <span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="fu">ad_fun</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par.best</span></span>
<span>    <span class="op">|&gt;</span> <span class="va">simulator</span><span class="op">$</span><span class="fu">report</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span> <span class="op">==</span> <span class="st">"incidence"</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">reports</span>, type <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">fitted_incidence</span>, col <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<ul>
<li><p><strong>fixme</strong>: also add multi-start example (i.e. less
fancy than DEoptim, suitable for surfaces like this one that are
multimodal but smooth (ref. Raue et al. “Lessons Learned from
Quantitative Dynamical Modeling in Systems Biology” 2013)?)</p></li>
<li><p><strong>fixme</strong>: warning that
<code>$current$params_vector()</code> is mutable/unreliable. Extractor
for <code>$ad_fun()$env$last.par.best</code> (or equivalently for the
optim fit)?</p></li>
<li><p><strong>fixme</strong>: add (abbreviated)
<code>sessionInfo</code> output? (Package versions?)</p></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Steve Walker, Darren Flynn-Primrose, Weiguang Guan, Ben Bolker.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
