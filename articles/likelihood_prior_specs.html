<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Specifying Likelihood and Prior Components • macpan2</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Specifying Likelihood and Prior Components">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">3.5.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/quickstart.html">Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/example_models.html">Example Models</a></li>
    <li><a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a></li>
    <li><a class="dropdown-item" href="../articles/real_data.html">Fitting to Real Data</a></li>
    <li><a class="dropdown-item" href="../articles/options.html">Options</a></li>
    <li><a class="dropdown-item" href="../articles/FAQs.html">FAQs</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Specifying Likelihood and Prior Components</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/v3.5.1/vignettes/likelihood_prior_specs.Rmd" class="external-link"><code>vignettes/likelihood_prior_specs.Rmd</code></a></small>
      <div class="d-none name"><code>likelihood_prior_specs.Rmd</code></div>
    </div>

    
    
<p><a href="https://canmod.github.io/macpan2/articles/vignette-status#status-stub-red"><img src="https://img.shields.io/badge/status-stub-red" alt="status"></a></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://canmod.github.io/macpan2/">macpan2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed" class="external-link">broom.mixed</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>macpan2_verbose <span class="op">=</span>  <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="calibration-defaults">Calibration Defaults<a class="anchor" aria-label="anchor" href="#calibration-defaults"></a>
</h2>
<!-- https://canmod.github.io/macpan2/articles/calibration.html#statistical-model -->
<p>The calibration interface allows for the direct specification of
likelihood and prior components. The objective function in calibration
is the summation of negative log likelihoods and negative log prior
densities.</p>
<p>By default, the interface assumes <strong>poisson
likelihoods</strong> and <strong>uniform priors</strong>. This is
demonstrated in the objective function in this <a href="https://canmod.github.io/macpan2/articles/calibration.html#step-1-add-calibration-information">calibration
example</a>. The calibration output shows a poisson likelihood is used
for the trajectory variable <code>I</code> and no additional objective
function terms indicate the parameters <code>beta</code> and
<code>R</code> have an improper uniform prior density. Indicating we
have no prior information about these parameters.</p>
</div>
<div class="section level2">
<h2 id="customizing-the-objective-function">Customizing the Objective Function<a class="anchor" aria-label="anchor" href="#customizing-the-objective-function"></a>
</h2>
<p>To specify a likelihood and/or prior for a variable in our model we
can select a distribution from the list of available
distributions,<code><a href="../reference/distribution.html">?macpan2::distribution</a></code>.</p>
</div>
<div class="section level2">
<h2 id="use-cases">Use Cases<a class="anchor" aria-label="anchor" href="#use-cases"></a>
</h2>
<div class="section level3">
<h3 id="priors-on-model-parameters">Priors on model parameters<a class="anchor" aria-label="anchor" href="#priors-on-model-parameters"></a>
</h3>
<!-- is this the only way to specify priors ? -->
<p>Specifying priors is usually done through the <code>par</code>
argument of <code>mp_tmb_calibrator</code>. <a href="https://github.com/canmod/macpan2/tree/main/inst/starter_models/shiver#re-parameterizing-and-introducing-transformations" class="external-link">Here</a>
is an example of prior specification in the SHIVER model. The parameter
<code>logit_p</code>, the logit transformed proportion <code>p</code>,
is given a normal prior using the distribution function
<code><a href="../reference/distribution.html">macpan2::mp_norm</a></code> and two numeric inputs for the
<code>location</code> and standard deviation, <code>sd</code>. The
remaining parameters are given an improper uniform prior using
<code><a href="../reference/distribution.html">macpan2::mp_unif</a></code>.
<!-- No example of the SHIVER prior specification output to see the change in the objective function --></p>
</div>
<div class="section level3">
<h3 id="likelihoods-on-model-parameters">Likelihoods on model parameters<a class="anchor" aria-label="anchor" href="#likelihoods-on-model-parameters"></a>
</h3>
<p>A likelihood can be specified for the trajectory variables in our
calibration set-up, those identified in the <code>traj</code> argument
of <code>mp_tmb_calibrator</code>.</p>
<p>Further into the SHIVER <a href="https://github.com/canmod/macpan2/tree/main/inst/starter_models/shiver#fitting-to-multiple-trajectories" class="external-link">example</a>,
the variables hospitalizations(<code>H</code>) and
<code>reported_incidence</code> are both specified with a negative
binomial likelihood using the <code><a href="../reference/distribution.html">macpan2::mp_nbinom</a></code> function.
For likelihoods the location parameter is not set because the
calibration machinery will use the simulated value for this trajectory
as the location. The dispersion parameter for <code>mp_nbinom</code> is
required.</p>
</div>
<div class="section level3">
<h3 id="fixed-distributional-parameters">Fixed distributional parameters<a class="anchor" aria-label="anchor" href="#fixed-distributional-parameters"></a>
</h3>
<p>Distributional parameters are those parameters that characterize the
distribution. Often these are the location and standard deviation. By
default, these parameters are assumed fixed and not fit. This was the
case in the previous [Prior Specification] example where the
distributional parameters for <code>location</code> and <code>sd</code>
were specified as numeric constants.</p>
<p>Distributional parameters are also assumed fixed when set to the name
of an existing variable in the model. Ex.
<code>mp_norm(sd = "sd_var")</code>
<!-- no existing example of this --></p>
</div>
<div class="section level3">
<h3 id="fitting-distributional-parameters">Fitting Distributional Parameters<a class="anchor" aria-label="anchor" href="#fitting-distributional-parameters"></a>
</h3>
<p>Distributional parameters however, can be fit in the calibration
framework in addition to other parameters using
<code><a href="../reference/fit_distr_params.html">macpan2::mp_fit</a></code>. See
<code><a href="../reference/fit_distr_params.html">?macpan2::fit_distr_params</a></code> for details. The previous
example in [Likelihood Specification] shows the negative binomial
dispersion parameter being fit with <code>mp_fit</code>. The numeric
value provided for dispersion is the starting value for the optimization
routine. After optimization, we can see the fitted dispersion
distributional parameters in the coefficient table. By default, they are
named with a leading <code>distr_params_</code> followed by their
distributional parameter name and corresponding model variable name.</p>
<div class="section level4">
<h4 id="distributional-parameter-transformations">Distributional Parameter Transformations<a class="anchor" aria-label="anchor" href="#distributional-parameter-transformations"></a>
</h4>
<p>Distributional parameters have default parameter transformations
inherited from their respective distribution. See the
<code>default_trans</code> argument for each distribution
(<code><a href="../reference/distribution.html">?macpan2::distribution</a></code>). For example, standard deviations
by definition are a strictly positive number, so the log transformation
is convenient to use to ensure this condition is met.</p>
<p>Defaults can be changed by either passing a distributional parameter
transformation function <code><a href="../reference/transform_distr_param.html">?macpan2::transform_distr_param</a></code> to
the <code>trans_distr_param</code> argument in
<code><a href="../reference/fit_distr_params.html">?macpan2::fit_distr_params</a></code> functions to change a single
transformation. To update all transformations, a named list of
transformations from <code><a href="../reference/transform_distr_param.html">?macpan2::transform_distr_param</a></code> for
each distributional parameter can be given to the
<code>default_trans</code> argument of the distribution.</p>
</div>
</div>
<div class="section level3">
<h3 id="priors-on-distributional-parameters">Priors on distributional parameters<a class="anchor" aria-label="anchor" href="#priors-on-distributional-parameters"></a>
</h3>
<p>We can specify priors on distributional parameters by:</p>
<ol style="list-style-type: decimal">
<li>creating a variable in the model for this distributional
parameter</li>
<li>referring to the distributional parameter name when specifying the
prior on the focal parameter</li>
<li>using the distributional parameter name to specify its own prior in
the usual way</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spec</span> <span class="op">=</span> <span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/mp_tmb_library.html">mp_tmb_library</a></span><span class="op">(</span><span class="st">"starter_models"</span>, <span class="st">"sir"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## 1. update the spec to include a new variable named 'my_var' to serve as</span></span>
<span>  <span class="co">## the standard deviation parameter for the Normal prior on 'beta'.</span></span>
<span>  <span class="co">## A numeric value of 0.1 is specified as the default for 'my_var', the </span></span>
<span>  <span class="co">## starting value in optimization.</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_tmb_insert.html">mp_tmb_insert</a></span><span class="op">(</span>default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>my_var <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## generate data for calibration</span></span>
<span><span class="va">data</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span><span class="va">spec</span>, <span class="fl">50</span>, <span class="st">"infection"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## set-up calibrator</span></span>
<span><span class="va">cal</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_calibrator.html">mp_tmb_calibrator</a></span><span class="op">(</span></span>
<span>    <span class="va">spec</span></span>
<span>  , <span class="va">data</span></span>
<span>  , traj <span class="op">=</span> <span class="st">"infection"</span></span>
<span>    <span class="co">## 2. We set a Normal prior on beta, and set the `sd` argument to 'my_var'</span></span>
<span>    <span class="co">## (would it ever make sense to use mp_fit for `sd` here?)</span></span>
<span>  , par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fu"><a href="../reference/distribution.html">mp_norm</a></span><span class="op">(</span>location <span class="op">=</span> <span class="fl">0.35</span>, sd <span class="op">=</span> <span class="fu"><a href="../reference/fit_distr_params.html">mp_nofit</a></span><span class="op">(</span><span class="st">"my_var"</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="co">## 3. setting a log-normal prior on 'my_var'</span></span>
<span>    , my_var <span class="op">=</span> <span class="fu"><a href="../reference/distribution.html">mp_lnorm</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span> </span>
<span>  <span class="op">)</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">## we can see the prior density for both 'beta' and 'my_var' in the calibration</span></span>
<span><span class="co">## objective function</span></span>
<span><span class="va">cal</span><span class="op">$</span><span class="va">simulator</span><span class="op">$</span><span class="va">tmb_model</span><span class="op">$</span><span class="va">obj_fn</span><span class="op">$</span><span class="va">obj_fn_expr</span></span>
<span><span class="co">#&gt; ~-sum(dpois(obs_infection, clamp(sim_infection))) - sum(dnorm(beta, </span></span>
<span><span class="co">#&gt;     0.35, exp(my_var))) - sum(dnorm(log(my_var), 1, 1))</span></span>
<span><span class="co">#&gt; &lt;environment: 0x557f753e8b38&gt;</span></span>
<span></span>
<span><span class="fu"><a href="../reference/mp_optimize.html">mp_optimize</a></span><span class="op">(</span><span class="va">cal</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;    params    params </span></span>
<span><span class="co">#&gt; 0.2000017 1.0015207 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 53.08736</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 9</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       10       10 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "relative convergence (4)"</span></span>
<span><span class="fu"><a href="../reference/mp_tmb_coef.html">mp_tmb_coef</a></span><span class="op">(</span><span class="va">cal</span><span class="op">)</span></span>
<span><span class="co">#&gt;       term    mat row col default  type  estimate   std.error</span></span>
<span><span class="co">#&gt; 1   params   beta   0   0    0.25 fixed 0.2000017 0.009166585</span></span>
<span><span class="co">#&gt; 2 params.1 my_var   0   0    0.10 fixed 1.0015207 0.707373865</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Walker, Weiguang Guan, Jen Freeman, Ben Bolker, Darren Flynn-Primrose.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
