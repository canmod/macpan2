<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Development Principles and Patterns • macpan2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Development Principles and Patterns">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.5.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/quickstart.html">Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/example_models.html">Example Models</a></li>
    <li><a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a></li>
    <li><a class="dropdown-item" href="../articles/real_data.html">Fitting to Real Data</a></li>
    <li><a class="dropdown-item" href="../articles/state_updaters.html">ODE Solvers, Process Error, and Difference Equations</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Development Principles and Patterns</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/macpan1.5_data/vignettes/development_patterns.Rmd" class="external-link"><code>vignettes/development_patterns.Rmd</code></a></small>
      <div class="d-none name"><code>development_patterns.Rmd</code></div>
    </div>

    
    
<p><a href="https://canmod.github.io/macpan2/articles/vignette-status#stub"><img src="https://img.shields.io/badge/status-stub-red" alt="status"></a></p>
<div class="section level2">
<h2 id="prerequisits">Prerequisits<a class="anchor" aria-label="anchor" href="#prerequisits"></a>
</h2>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>macpan2</code> package uses the standard S3 object-oriented
framework for <code>R</code>. All objects in <code>macpan2</code> are
standard <code>R</code> <code>environments</code>, with standard S3
<code>class</code> <code>attributes</code>. This approach allows us to
integrate with standard generic S3 methods (e.g. <code>print</code>,
<code>predict</code>), while retaining the benefits of programming
styles that are common outside of <code>R</code> such as data-code
bundling and passing by reference. We can get these benefits without
dependencies on third-party packages such as <code>R6</code> and instead
use standard <code>R</code> tools, but in an unorthodox yet interesting
(to us) way.</p>
</div>
<div class="section level2">
<h2 id="basics-of-the-macpan2-object-oriented-framework">Basics of the <code>macpan2</code> Object Oriented Framework<a class="anchor" aria-label="anchor" href="#basics-of-the-macpan2-object-oriented-framework"></a>
</h2>
<div class="section level3">
<h3 id="constructing-and-using-objects">Constructing and Using Objects<a class="anchor" aria-label="anchor" href="#constructing-and-using-objects"></a>
</h3>
<p>To understand <code>macpan2</code>, users and developers need to
understand how to construct objects. Objects in <code>macpan2</code>
have <code>S3</code> class attributes and are standard <code>R</code>
<code>environment</code>s with some additional restrictions. Before
looking at those restrictions, we will illustrate the basic idea with an
example.</p>
<p>The <code>macpan2</code> package comes with a set of
<code><a href="../articles/example_models.html">vignette("example_models", package = "macpan2")</a></code>. One simple
example is an SIR model stored here.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">sir_path</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"model_library"</span>, <span class="st">"sir_vax"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/macpan2/model_library/sir_vax"</span></span></code></pre></div>
<p>This path points to a directory with the following files.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">sir_path</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "derivations.json"            "flows.csv"                  </span></span>
<span><span class="co">#&gt; [3] "README.md"                   "settings.json"              </span></span>
<span><span class="co">#&gt; [5] "trans.csv"                   "transmission_dimensions.csv"</span></span>
<span><span class="co">#&gt; [7] "transmission_matrices.csv"   "variables.csv"</span></span></code></pre></div>
<p>We could read in one of these files using standard R methods, but
here we illustrate objects by using the <code>CSVReader</code> function.
This function returns an object of class <code>CSVReader</code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_flows_reader</span> <span class="op">=</span> <span class="fu"><a href="../reference/Reader.html">CSVReader</a></span><span class="op">(</span><span class="va">sir_path</span>, <span class="st">"flows.csv"</span><span class="op">)</span></span>
<span><span class="va">sir_flows_reader</span></span>
<span><span class="co">#&gt; Classes 'CSVReader', 'Reader', 'Base' &lt;environment: 0x56304c5c1868&gt; </span></span>
<span><span class="co">#&gt; read : function ()  </span></span>
<span><span class="co">#&gt; read_base : function ()</span></span></code></pre></div>
<p>We get a print out of the <code>S3</code> class of the object, which
is a vector with three items.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">sir_flows_reader</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "CSVReader" "Reader"    "Base"</span></span></code></pre></div>
<p>Why are there three items? This is the standard <code>S3</code>
method of inheritance. If this doesn’t make sense, it doesn’t matter
now.</p>
<p>We also saw that this item is just an <code>R</code>
<code>environment</code>. More about this later.</p>
<p>The more important thing is that there is a <code>read</code>
function listed. This function is a method, but importantly this is not
a standard <code>S3</code> method. Why is it not an <code>S3</code>
method? You guessed it, we will cover that below.</p>
<p>We call methods, like the <code>read()</code> method, in the
following way.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_flows_reader</span><span class="op">$</span><span class="fu">read</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;      from      to        flow               type from_partition to_partition</span></span>
<span><span class="co">#&gt; 1       S       I   infection         per_capita            Epi          Epi</span></span>
<span><span class="co">#&gt; 2       I       R       gamma         per_capita            Epi          Epi</span></span>
<span><span class="co">#&gt; 3 S.unvax   S.vax vaccination         per_capita        Epi.Vax      Epi.Vax</span></span>
<span><span class="co">#&gt; 4       S S.unvax       birth  per_capita_inflow            Epi      Epi.Vax</span></span>
<span><span class="co">#&gt; 5       I S.unvax       birth  per_capita_inflow            Epi      Epi.Vax</span></span>
<span><span class="co">#&gt; 6       R S.unvax       birth  per_capita_inflow            Epi      Epi.Vax</span></span>
<span><span class="co">#&gt; 7       S               death per_capita_outflow            Epi         Null</span></span>
<span><span class="co">#&gt; 8       I               death per_capita_outflow            Epi         Null</span></span>
<span><span class="co">#&gt; 9       R               death per_capita_outflow            Epi         Null</span></span>
<span><span class="co">#&gt;   flow_partition from_to_partition from_flow_partition to_flow_partition</span></span>
<span><span class="co">#&gt; 1            Epi               Vax                 Vax              Null</span></span>
<span><span class="co">#&gt; 2            Epi               Vax                 Vax              Null</span></span>
<span><span class="co">#&gt; 3            Vax                                                    Null</span></span>
<span><span class="co">#&gt; 4            Epi                                                    Null</span></span>
<span><span class="co">#&gt; 5            Epi                                                    Null</span></span>
<span><span class="co">#&gt; 6            Epi                                                    Null</span></span>
<span><span class="co">#&gt; 7            Epi              Null                                  Null</span></span>
<span><span class="co">#&gt; 8            Epi              Null                                  Null</span></span>
<span><span class="co">#&gt; 9            Epi              Null                                  Null</span></span></code></pre></div>
<p>This <code>sir_flows_reader</code> has read in the CSV file that it
is configured to read.</p>
<p>This syntax might look strange to many R users, who will be used to
something more like this.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">sir_path</span>, <span class="st">"flows.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       from       to         flow                type  from_partition</span></span>
<span><span class="co">#&gt; 1 S        I        infection    per_capita          Epi            </span></span>
<span><span class="co">#&gt; 2 I        R        gamma        per_capita          Epi            </span></span>
<span><span class="co">#&gt; 3 S.unvax  S.vax    vaccination  per_capita          Epi.Vax        </span></span>
<span><span class="co">#&gt; 4 S        S.unvax  birth        per_capita_inflow   Epi            </span></span>
<span><span class="co">#&gt; 5 I        S.unvax  birth        per_capita_inflow   Epi            </span></span>
<span><span class="co">#&gt; 6 R        S.unvax  birth        per_capita_inflow   Epi            </span></span>
<span><span class="co">#&gt; 7 S                 death        per_capita_outflow  Epi            </span></span>
<span><span class="co">#&gt; 8 I                 death        per_capita_outflow  Epi            </span></span>
<span><span class="co">#&gt; 9 R                 death        per_capita_outflow  Epi            </span></span>
<span><span class="co">#&gt;    to_partition  flow_partition  from_to_partition  from_flow_partition</span></span>
<span><span class="co">#&gt; 1 Epi           Epi             Vax                Vax                 </span></span>
<span><span class="co">#&gt; 2 Epi           Epi             Vax                Vax                 </span></span>
<span><span class="co">#&gt; 3 Epi.Vax       Vax                                                    </span></span>
<span><span class="co">#&gt; 4 Epi.Vax       Epi                                                    </span></span>
<span><span class="co">#&gt; 5 Epi.Vax       Epi                                                    </span></span>
<span><span class="co">#&gt; 6 Epi.Vax       Epi                                                    </span></span>
<span><span class="co">#&gt; 7 Null          Epi             Null                                   </span></span>
<span><span class="co">#&gt; 8 Null          Epi             Null                                   </span></span>
<span><span class="co">#&gt; 9 Null          Epi             Null                                   </span></span>
<span><span class="co">#&gt;   to_flow_partition</span></span>
<span><span class="co">#&gt; 1              Null</span></span>
<span><span class="co">#&gt; 2              Null</span></span>
<span><span class="co">#&gt; 3              Null</span></span>
<span><span class="co">#&gt; 4              Null</span></span>
<span><span class="co">#&gt; 5              Null</span></span>
<span><span class="co">#&gt; 6              Null</span></span>
<span><span class="co">#&gt; 7              Null</span></span>
<span><span class="co">#&gt; 8              Null</span></span>
<span><span class="co">#&gt; 9              Null</span></span></code></pre></div>
<p>The reason why <code>sir_reader$read()</code> works without any
arguments is that the path to read is stored in the
<code>sir_reader</code> object. We can see (almost) everything stored in
an object using the <code>ls</code> function.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="va">sir_flows_reader</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "file"      "read"      "read_base"</span></span></code></pre></div>
<p>Here we see that, along with the <code>read</code> method, there is
something else called <code>file</code>, which is just the file path
that the reader is configured to read.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir_flows_reader</span><span class="op">$</span><span class="va">file</span></span>
<span><span class="co">#&gt; [1] "/home/runner/work/_temp/Library/macpan2/model_library/sir_vax/flows.csv"</span></span></code></pre></div>
<p>Object components like this <code>file</code> component, which are
not methods, are called fields.</p>
<p>That’s the basic idea of how to use objects in <code>macpan2</code>.
Here’s a summary.</p>
<ul>
<li>Objects are standard <code>R</code> <code>environment</code>s</li>
<li>Objects have standard <code>R</code> S3 <code>class</code>es</li>
<li>Objects have fields and methods</li>
<li>Object methods are functions that can make use of other object
components</li>
</ul>
</div>
<div class="section level3">
<h3 id="defining-classes">Defining Classes<a class="anchor" aria-label="anchor" href="#defining-classes"></a>
</h3>
<p>To define a class we write a function called a constructor. We have
aleady seen a constructor – the <code>CSVReader</code> function above.
Let’s make our own. Let’s make a class that can generate sequences of
numbers.</p>
<p>To warm up we will create a class that does nothing and contains
nothing, but which illustrates the basic boilerplate code for creating a
class.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DoesNothing</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">self</span> <span class="op">=</span> <span class="fu">Base</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu">return_object</span><span class="op">(</span><span class="va">self</span>, <span class="st">"DoesNothing"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">does_nothing</span> <span class="op">=</span> <span class="fu">DoesNothing</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">does_nothing</span></span>
<span><span class="co">#&gt; Classes 'DoesNothing', 'Base' &lt;environment: 0x56304d16f128&gt;</span></span></code></pre></div>
<p>The first line in this constructor uses the <code>Base</code>
function to create an <code>environment</code> called <code>self</code>.
The second line sets <code>self</code>s S3 <code>class</code> to
<code>DoesNothing</code> and returns this newly created S3 object.</p>
<p>To make this class more interesting we store an integer as a
field.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DoesNothing</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">self</span> <span class="op">=</span> <span class="fu">Base</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">n</span> <span class="op">=</span> <span class="va">n</span>  <span class="co">## save value of the argument in the object</span></span>
<span>  <span class="fu">return_object</span><span class="op">(</span><span class="va">self</span>, <span class="st">"DoesNothing"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">does_nothing</span> <span class="op">=</span> <span class="fu">DoesNothing</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">does_nothing</span></span>
<span><span class="co">#&gt; Classes 'DoesNothing', 'Base' &lt;environment: 0x56304d3e5e88&gt;</span></span></code></pre></div>
<p>This looks identical to the first version, but now we have stored a
value for <code>n</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">does_nothing</span><span class="op">$</span><span class="va">n</span> <span class="op">==</span> <span class="fl">10</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>Finally we add a method so that we can do something, and change the
name do describe what it can do.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">SimpleSequence</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">self</span> <span class="op">=</span> <span class="fu">Base</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">n</span> <span class="op">=</span> <span class="va">n</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">generate</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">n</span><span class="op">)</span></span>
<span>  <span class="fu">return_object</span><span class="op">(</span><span class="va">self</span>, <span class="st">"SimpleSequence"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">simple_sequence</span> <span class="op">=</span> <span class="fu">SimpleSequence</span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">simple_sequence</span><span class="op">$</span><span class="fu">generate</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1]  1  2  3  4  5  6  7  8  9 10</span></span></code></pre></div>
<p>Notice that all fields and methods stored in <code>self</code>
(e.g. <code>self$n</code>) can be used in methods by using the
<code>$</code> operator to extract the value of the field or method from
<code>self</code>. The technical reason why this works is that the
<code>self</code> <code>environment</code> is in the
<code>environment</code> of every method in the <code>self</code>
<code>environment</code>. In fact, the <code>self</code>
<code>environment</code> is the only thing in the
<code>environment</code> of each method. If this seems mind-bending,
don’t worry about it.</p>
<p>Those are the basics of class definitions. Here’s a summary.</p>
<ul>
<li>Class definitions are functions for constructing objects of that
class</li>
<li>The first thing to do in a class definition is create the
<code>self</code> <code>environment</code>
</li>
<li>The last thing to do in a class definition is return the
<code>self</code> <code>environment</code> as an S3 object</li>
<li>In the middle of a class definition one adds methods and fields to
the <code>self</code> <code>environment</code>
</li>
<li>The <code>self</code> <code>environment</code> is the only thing in
the <code>environment</code>s of the methods in <code>self</code> (don’t
worry about it)</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a>
</h2>
<div class="section level3">
<h3 id="objects">Objects<a class="anchor" aria-label="anchor" href="#objects"></a>
</h3>
<p>In <code>macpan2</code>, objects are standard <code>R</code>
<code>environment</code>s with an S3 <code>class</code> attribute.
Therefore, our object oriented style involves only basic foundational
<code>R</code> concepts: <code>environment</code>s and S3 classes.</p>
<p>There are two types of <code>environment</code>s in this setup. The
first kind of <code>environment</code> is the</p>
<ul>
<li>An S3 <code>class</code> <code>attribute</code>
</li>
<li>The <code>environment</code> of every function in this
<code>environment</code> is an</li>
</ul>
</div>
<div class="section level3">
<h3 id="class-definitions">Class Definitions<a class="anchor" aria-label="anchor" href="#class-definitions"></a>
</h3>
<p>Developers can define a class by defining a standard R function that
returns an instance of that class.</p>
<p>We talked a bit about technical details that you shouldn’t worry
about in the basics of defining classes. But there is one technicality
that you should worry about. Objects created in a constructor can only
be used in methods if they are accessible through the <code>self</code>
<code>environment</code>. So for example, the following code fails.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">BadClass</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">self</span> <span class="op">=</span> <span class="fu">Base</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">=</span> <span class="fl">10</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">f</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="fu">return_object</span><span class="op">(</span><span class="va">self</span>, <span class="st">"BadClass"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu">BadClass</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">f</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in BadClass()$f() : object 'x' not found</span></span></code></pre></div>
<p>This is good because it forces you to be specific about where method
dependencies are coming from. What would have been worse is if the above
code succeeded in the following way.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="fu">BadClass</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">f</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 100</span></span></code></pre></div>
<p>Why did this ‘work’ now? It doesn’t matter because you will never
have this problem if you just always refer to <code>self</code>
explicitly in methods. In particular, the proper approach would be the
following.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">GoodClass</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">self</span> <span class="op">=</span> <span class="fu">Base</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">x</span> <span class="op">=</span> <span class="fl">10</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">f</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">self</span><span class="op">$</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="fu">return_object</span><span class="op">(</span><span class="va">self</span>, <span class="st">"GoodClass"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">GoodClass</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">f</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 100</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="inheritance">Inheritance<a class="anchor" aria-label="anchor" href="#inheritance"></a>
</h3>
</div>
</div>
<div class="section level2">
<h2 id="principles">Principles<a class="anchor" aria-label="anchor" href="#principles"></a>
</h2>
<p>There will be trade-offs among these principles, but they are good
guidelines.</p>
<div class="section level3">
<h3 id="small-classes">Small Classes<a class="anchor" aria-label="anchor" href="#small-classes"></a>
</h3>
<p>You should be able to see the whole constructor definition on a
single screen – it is OK if it doesn’t happen though.</p>
</div>
<div class="section level3">
<h3 id="avoid-modifying-well-tested-classes">Avoid Modifying Well-Tested Classes<a class="anchor" aria-label="anchor" href="#avoid-modifying-well-tested-classes"></a>
</h3>
<p>Extension is better done by introducing new classes, rather than new
methods. Big classes are hard to reason about, test, and stabilize.</p>
</div>
<div class="section level3">
<h3 id="linear-inheritance">Linear Inheritance<a class="anchor" aria-label="anchor" href="#linear-inheritance"></a>
</h3>
<p>Classes should not inherit from multiple parents.</p>
</div>
<div class="section level3">
<h3 id="shallow-inheritance-hierarchy">Shallow Inheritance Hierarchy<a class="anchor" aria-label="anchor" href="#shallow-inheritance-hierarchy"></a>
</h3>
<p>Parent classes may have multiple children, but in these cases the
hierarchy should be shallow and simple. For example, consider
alternatives if some children inherit directly from an intermediate
parent. When things like this start to happen, it is usually best to
just extend the intermediate parent so that it can inherit directly from
the <code>Base</code> class.</p>
</div>
<div class="section level3">
<h3 id="balance-regeneration-with-consistency">Balance Regeneration with Consistency<a class="anchor" aria-label="anchor" href="#balance-regeneration-with-consistency"></a>
</h3>
<p>A naive approach to keeping the components of objects consistent is
to regenerate the object with every change. But continual regeneration
can be expensive. It is best to avoid this trade-off as much as possible
by making fields that are cheap to compute into methods that always
recompute what the user is asking for. But some fields are too expensive
to regenerate and therefore need to be stored and only regenerated when
necessary.</p>
</div>
</div>
<div class="section level2">
<h2 id="patterns">Patterns<a class="anchor" aria-label="anchor" href="#patterns"></a>
</h2>
<p>Here are some design patterns for complying with these
principles.</p>
<div class="section level3">
<h3 id="alternative-classes">Alternative Classes<a class="anchor" aria-label="anchor" href="#alternative-classes"></a>
</h3>
<p>Alternative versions of a class have the same set of methods as the
initial version. It needs change then it becomes easy to swap out one
alternative for another. For example, the <code><a href="../reference/Reader.html">Reader()</a></code> classes
all have a single method – <code>$read()</code> – without arguments.
Therefore, any bit of functionality that requires data to be read in can
be modified simply by writing a new reader and swapping it in for the
old one, without needing to modify any of the code that calls the
<code>$read()</code> method. The methods in alternative classes should
return the same type of object, but obviously the return value itself
can and should vary.</p>
</div>
<div class="section level3">
<h3 id="argument-fields">Argument Fields<a class="anchor" aria-label="anchor" href="#argument-fields"></a>
</h3>
<p>These are the simplest kinds of object components, and essentially
behave as lists. Argument fields store arguments to the constructor. For
example here is an object with two argument fields.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">x</span> <span class="op">=</span> <span class="va">x</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">y</span> <span class="op">=</span> <span class="va">y</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>These fields can be accessed using the standard <code>$</code> or
<code>[[</code> operators.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">=</span> <span class="fu">A</span><span class="op">(</span>x <span class="op">=</span> <span class="fl">10</span>, y <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">a</span><span class="op">$</span><span class="va">x</span> <span class="op">==</span> <span class="fl">10</span> <span class="co">## TRUE</span></span>
<span><span class="va">a</span><span class="op">$</span><span class="va">y</span> <span class="op">==</span> <span class="fl">20</span> <span class="co">## TRUE</span></span></code></pre></div>
<p>Note that although it is possible to set such fields, it is not
recommended. Rather one should use <code>$refresh()</code> methods as
described below.</p>
</div>
<div class="section level3">
<h3 id="static-fields">Static Fields<a class="anchor" aria-label="anchor" href="#static-fields"></a>
</h3>
<p>Static fields store values derived from arguments to the constructor.
Static fields are similar to argument fields, but they contain derived
quantities that depend on the arguments rather than the arguments
themselves. A simple example is to store the sum of two arguments in a
static field.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">z</span> <span class="op">=</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Note that static fields may need to be updated by
<code>$refresh()</code> methods.</p>
</div>
<div class="section level3">
<h3 id="standard-methods">Standard Methods<a class="anchor" aria-label="anchor" href="#standard-methods"></a>
</h3>
<p>Standard methods compute and return values derived from arguments to
the constructor. These methods should only be used if they are cheap to
run, so that regeneration and consistency are balanced. But this pattern
is generally the preferred option, because it is simplest to reason
about and maintain because it more directly ensures consistency.</p>
</div>
<div class="section level3">
<h3 id="composition">Composition<a class="anchor" aria-label="anchor" href="#composition"></a>
</h3>
<p>Objects can be composed of other objects. Composition of objects and
classes looks like this.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">b</span> <span class="op">=</span> <span class="fu">B</span><span class="op">(</span><span class="va">self</span><span class="op">)</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span></span>
<span><span class="va">...</span></span>
<span><span class="va">B</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">a</span> <span class="op">=</span> <span class="va">a</span></span>
<span>  <span class="va">...</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then other developers and users can do the following.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">=</span> <span class="fu">A</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="va">a</span><span class="op">$</span><span class="va">b</span><span class="op">$</span><span class="fu">method</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span></code></pre></div>
<p>This keeps classes small because <code>B</code> can have methods
instead of <code>A</code>, and small classes are easier to test and
stabilize. Testing of <code>A</code> can focus on the methods directly
in <code>A</code>, and then <code>A</code> can be extended by composing
new classes like <code>B</code>.</p>
</div>
<div class="section level3">
<h3 id="refresh-methods">Refresh Methods<a class="anchor" aria-label="anchor" href="#refresh-methods"></a>
</h3>
<p>Methods refreshing fields when shallow copies of those fields are in
several composed objects … When a field gets edited, the simplest thing
to do is</p>
</div>
<div class="section level3">
<h3 id="private-methods">Private Methods<a class="anchor" aria-label="anchor" href="#private-methods"></a>
</h3>
<p>Private methods should only be used by other methods in the class.
There is nothing stoping a developer or a user from calling a private
method, but there is no guarantee that the private method with have
consistent behaviour or even exist. To communicate privacy, private
methods should start with a dot as the following example shows.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">.private</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span><span class="va">...</span><span class="op">}</span></span>
<span>  <span class="va">...</span></span>
<span>  <span class="va">self</span><span class="op">$</span><span class="va">public</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">...</span></span>
<span>    <span class="fu">self.private</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>    <span class="va">...</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="object-editing">Object Editing<a class="anchor" aria-label="anchor" href="#object-editing"></a>
</h3>
</div>
<div class="section level3">
<h3 id="method-caching">Method Caching<a class="anchor" aria-label="anchor" href="#method-caching"></a>
</h3>
<p>Developers can manage the performance costs of computationally
expensive methods through method caching. When a developer calls a
cached method for the first time, it computes the result, stores it in a
cache, and returns the result. Subsequent method evaluations simply
retrieve the cached value, improving efficiency. Developers can ensure
consistency by invalidating the cache whenever objects change, allowing
them to balance the cost of regeneration with the need for
consistency.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>A <span class="ot">=</span> <span class="cf">function</span>(..., method_dependency, ...) {</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>  ...</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>  self<span class="sc">$</span>method_dependency <span class="ot">=</span> method_dependency</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>  ...</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>  self<span class="sc">$</span>expensive_method_1 <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>    ...</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a>  }</span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a>  ...</span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a>  self<span class="sc">$</span>expensive_method_2 <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>    ...</span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a>  }</span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a>  ...</span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>  self<span class="sc">$</span>cheap_method <span class="ot">=</span> <span class="cf">function</span>() {</span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a>    ...</span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a>  }</span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a>  ...</span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a>  self<span class="sc">$</span>modify_dependency <span class="ot">=</span> <span class="cf">function</span>(...) {</span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a>    ...</span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a>    self<span class="sc">$</span>cache<span class="sc">$</span>expensive_method_1<span class="sc">$</span><span class="fu">invalidate</span>()</span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a>    self<span class="sc">$</span>cache<span class="sc">$</span>expensive_method_2<span class="sc">$</span><span class="fu">invalidate</span>()</span>
<span id="cb22-21"><a href="#cb22-21" tabindex="-1"></a>    ...</span>
<span id="cb22-22"><a href="#cb22-22" tabindex="-1"></a>  }</span>
<span id="cb22-23"><a href="#cb22-23" tabindex="-1"></a>  ...</span>
<span id="cb22-24"><a href="#cb22-24" tabindex="-1"></a>  <span class="fu">initialize_cache</span>(self, <span class="st">"expensive_method_1"</span>, <span class="st">"expensive_method_2"</span>)</span>
<span id="cb22-25"><a href="#cb22-25" tabindex="-1"></a>  ...</span>
<span id="cb22-26"><a href="#cb22-26" tabindex="-1"></a>}</span>
<span id="cb22-27"><a href="#cb22-27" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" tabindex="-1"></a>a <span class="ot">=</span> <span class="fu">A</span>()</span>
<span id="cb22-29"><a href="#cb22-29" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" tabindex="-1"></a><span class="co"># takes time to return</span></span>
<span id="cb22-31"><a href="#cb22-31" tabindex="-1"></a>a<span class="sc">$</span><span class="fu">expensive_method</span>() </span>
<span id="cb22-32"><a href="#cb22-32" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" tabindex="-1"></a><span class="co"># return immediately by returning the same value computed previously </span></span>
<span id="cb22-34"><a href="#cb22-34" tabindex="-1"></a><span class="co"># and stored in the cache</span></span>
<span id="cb22-35"><a href="#cb22-35" tabindex="-1"></a>a<span class="sc">$</span><span class="fu">expensive_method</span>()</span>
<span id="cb22-36"><a href="#cb22-36" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" tabindex="-1"></a><span class="co"># change object and invalidate the cache to enforce consistency</span></span>
<span id="cb22-38"><a href="#cb22-38" tabindex="-1"></a>a<span class="sc">$</span><span class="fu">modify_dependency</span>(...)</span>
<span id="cb22-39"><a href="#cb22-39" tabindex="-1"></a></span>
<span id="cb22-40"><a href="#cb22-40" tabindex="-1"></a><span class="co"># again takes time to return, but the value is different because the</span></span>
<span id="cb22-41"><a href="#cb22-41" tabindex="-1"></a><span class="co"># object was modified</span></span>
<span id="cb22-42"><a href="#cb22-42" tabindex="-1"></a>a<span class="sc">$</span><span class="fu">expensive_method</span>()</span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Walker, Weiguang Guan, Ben Bolker, Jen Freeman, Darren Flynn-Primrose.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
