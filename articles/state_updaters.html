<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="macpan2">
<title>ODE Solvers, Process Error, and Difference Equations • macpan2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="ODE Solvers, Process Error, and Difference Equations">
<meta property="og:description" content="macpan2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.5.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/quickstart.html">Quickstart</a>
    <a class="dropdown-item" href="../articles/example_models.html">Example Models</a>
    <a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a>
    <a class="dropdown-item" href="../articles/real_data.html">Fitting to Real Data</a>
    <a class="dropdown-item" href="../articles/state_updaters.html">ODE Solvers, Process Error, and Difference Equations</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>ODE Solvers, Process Error, and Difference Equations</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/HEAD/vignettes/state_updaters.Rmd" class="external-link"><code>vignettes/state_updaters.Rmd</code></a></small>
      <div class="d-none name"><code>state_updaters.Rmd</code></div>
    </div>

    
    
<p>The <code>McMasterPandemic</code> project has focused on using
discrete time difference equations to solve the dynamical system. Here
we describe experimental features that allow one to update the data
differently. In particular, it is now possible to use a Runge-Kutta 4
ODE solver (to approximate the solution to the continuous time analogue)
as well as the Euler Multinomial distribution to generate process error.
These features have in principle been available for most of the life of
<code>macpan2</code>, but only recently have they been given a more
convenient interface.</p>
<p>In order to use this interface, models must be rewritten using
explicit declarations of state updates. By explicitly declaring what
expressions correspond to state updates, <code>macpan2</code> is able to
modify the method of updating without further user input. This makes it
easier to compare difference equations (i.e. Euler steps), ODEs
(i.e. Runge-Kutta), and process error (i.e. Euler Multinomial) runs for
the same underlying dynamical model.</p>
<p>To declare a state update one replaces formulas in the
<code>during</code> argument of a model spec to include calls to the
<code><a href="../reference/mp_per_capita_flow.html">mp_per_capita_flow()</a></code> function. As an example we will modify
the SI model to include explicit state updates. The original form of the
model looks like this.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://canmod.github.io/macpan2/">macpan2</a></span><span class="op">)</span></span>
<span><span class="va">si_implicit</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_model_spec.html">mp_tmb_model_spec</a></span><span class="op">(</span></span>
<span>    before <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">S</span> <span class="op">~</span> <span class="va">N</span> <span class="op">-</span> <span class="va">I</span><span class="op">)</span></span>
<span>  , during <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="va">infection</span> <span class="op">~</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">S</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span></span>
<span>      , <span class="va">S</span> <span class="op">~</span> <span class="va">S</span> <span class="op">-</span> <span class="va">infection</span></span>
<span>      , <span class="va">I</span> <span class="op">~</span> <span class="va">I</span> <span class="op">+</span> <span class="va">infection</span></span>
<span>    <span class="op">)</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>I <span class="op">=</span> <span class="fl">1</span>, N <span class="op">=</span> <span class="fl">100</span>, beta <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">si_implicit</span><span class="op">)</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Default values:</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt;  matrix row col  value</span></span>
<span><span class="co">#&gt;       I           1.00</span></span>
<span><span class="co">#&gt;       N         100.00</span></span>
<span><span class="co">#&gt;    beta           0.25</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: S ~ N - I</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to T):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: infection ~ beta * S * I/N</span></span>
<span><span class="co">#&gt; 2: S ~ S - infection</span></span>
<span><span class="co">#&gt; 3: I ~ I + infection</span></span></code></pre></div>
<p>The modified version looks like this.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">si_explicit</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_model_spec.html">mp_tmb_model_spec</a></span><span class="op">(</span></span>
<span>    before <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">S</span> <span class="op">~</span> <span class="va">N</span> <span class="op">-</span> <span class="va">I</span><span class="op">)</span></span>
<span>  , during <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/mp_per_capita_flow.html">mp_per_capita_flow</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="va">infection</span> <span class="op">~</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span><span class="op">)</span><span class="op">)</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>I <span class="op">=</span> <span class="fl">1</span>, N <span class="op">=</span> <span class="fl">100</span>, beta <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">si_explicit</span><span class="op">)</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Default values:</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt;  matrix row col  value</span></span>
<span><span class="co">#&gt;       I           1.00</span></span>
<span><span class="co">#&gt;       N         100.00</span></span>
<span><span class="co">#&gt;    beta           0.25</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: S ~ N - I</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to T):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: mp_per_capita_flow(from = "S", to = "I", rate = infection ~ beta * </span></span>
<span><span class="co">#&gt;      I/N)</span></span></code></pre></div>
<p>With this explicit spec we can make three different simulators.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">si_euler</span> <span class="op">=</span> <span class="op">(</span><span class="va">si_explicit</span> </span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_euler.html">mp_euler</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span>time_steps <span class="op">=</span> <span class="fl">50</span>, outputs <span class="op">=</span> <span class="st">"infection"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">si_rk4</span> <span class="op">=</span> <span class="op">(</span><span class="va">si_explicit</span> </span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_euler.html">mp_rk4</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span>time_steps <span class="op">=</span> <span class="fl">50</span>, outputs <span class="op">=</span> <span class="st">"infection"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">si_euler_multinomial</span> <span class="op">=</span> <span class="op">(</span><span class="va">si_explicit</span> </span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_euler.html">mp_euler_multinomial</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span>time_steps <span class="op">=</span> <span class="fl">50</span>, outputs <span class="op">=</span> <span class="st">"infection"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:macpan2':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     all_equal</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trajectory_comparison</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    euler <span class="op">=</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="va">si_euler</span><span class="op">)</span></span>
<span>  , rk4 <span class="op">=</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="va">si_rk4</span><span class="op">)</span></span>
<span>  , euler_multinomial <span class="op">=</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="va">si_euler_multinomial</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"update_method"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">trajectory_comparison</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   update_method    matrix time row col     value</span></span>
<span><span class="co">#&gt; 1         euler infection    1   0   0 0.2475000</span></span>
<span><span class="co">#&gt; 2         euler infection    2   0   0 0.3079844</span></span>
<span><span class="co">#&gt; 3         euler infection    3   0   0 0.3828223</span></span>
<span><span class="co">#&gt; 4         euler infection    4   0   0 0.4751841</span></span>
<span><span class="co">#&gt; 5         euler infection    5   0   0 0.5888103</span></span>
<span><span class="co">#&gt; 6         euler infection    6   0   0 0.7280407</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">trajectory_comparison</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>`Time Step` <span class="op">=</span> <span class="va">time</span>, Incidence <span class="op">=</span> <span class="va">value</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">`Time Step`</span>, <span class="va">Incidence</span>, colour <span class="op">=</span> <span class="va">update_method</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="state_updaters_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
<p>The incidence trajectory is different for the three update methods,
even though the initial values of the state variables were identical in
all three cases.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mp_initial.html">mp_initial</a></span><span class="op">(</span><span class="va">si_euler</span><span class="op">)</span></span>
<span><span class="co">#&gt;   matrix time row col value</span></span>
<span><span class="co">#&gt; 1      N    0   0   0   100</span></span>
<span><span class="co">#&gt; 2      I    0   0   0     1</span></span>
<span><span class="co">#&gt; 3      S    0   0   0    99</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mp_initial.html">mp_initial</a></span><span class="op">(</span><span class="va">si_euler_multinomial</span><span class="op">)</span></span>
<span><span class="co">#&gt;   matrix time row col value</span></span>
<span><span class="co">#&gt; 1      N    0   0   0   100</span></span>
<span><span class="co">#&gt; 2      I    0   0   0     1</span></span>
<span><span class="co">#&gt; 3      S    0   0   0    99</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mp_initial.html">mp_initial</a></span><span class="op">(</span><span class="va">si_rk4</span><span class="op">)</span></span>
<span><span class="co">#&gt;   matrix time row col value</span></span>
<span><span class="co">#&gt; 1      N    0   0   0   100</span></span>
<span><span class="co">#&gt; 2      I    0   0   0     1</span></span>
<span><span class="co">#&gt; 3      S    0   0   0    99</span></span></code></pre></div>
<p>The incidence is different, even during the first time step, because
each state update method causes different numbers of susceptible
individuals to become infectious at each time step. Further, incidence
here is defined for a single time step and so this number of new
infectious individuals is exactly the incidence.</p>
<div class="section level2">
<h2 id="branching-flows-and-process-error">Branching Flows and Process Error<a class="anchor" aria-label="anchor" href="#branching-flows-and-process-error"></a>
</h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">siv</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_model_spec.html">mp_tmb_model_spec</a></span><span class="op">(</span></span>
<span>    before <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">S</span> <span class="op">~</span> <span class="va">N</span> <span class="op">-</span> <span class="va">I</span> <span class="op">-</span> <span class="va">V</span><span class="op">)</span></span>
<span>  , during <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="../reference/mp_per_capita_flow.html">mp_per_capita_flow</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="va">infection</span> <span class="op">~</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span><span class="op">)</span></span>
<span>      , <span class="fu"><a href="../reference/mp_per_capita_flow.html">mp_per_capita_flow</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"V"</span>, <span class="va">vaccination</span> <span class="op">~</span> <span class="va">rho</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>I <span class="op">=</span> <span class="fl">1</span>, V <span class="op">=</span> <span class="fl">0</span>, N <span class="op">=</span> <span class="fl">100</span>, beta <span class="op">=</span> <span class="fl">0.25</span>, rho <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">siv</span><span class="op">)</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Default values:</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt;  matrix row col  value</span></span>
<span><span class="co">#&gt;       I           1.00</span></span>
<span><span class="co">#&gt;       V           0.00</span></span>
<span><span class="co">#&gt;       N         100.00</span></span>
<span><span class="co">#&gt;    beta           0.25</span></span>
<span><span class="co">#&gt;     rho           0.10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: S ~ N - I - V</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to T):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: mp_per_capita_flow(from = "S", to = "I", rate = infection ~ beta * </span></span>
<span><span class="co">#&gt;      I/N)</span></span>
<span><span class="co">#&gt; 2: mp_per_capita_flow(from = "S", to = "V", rate = vaccination ~ </span></span>
<span><span class="co">#&gt;      rho)</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">siv</span> </span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_euler.html">mp_euler_multinomial</a></span><span class="op">(</span><span class="op">)</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span><span class="fl">50</span>, <span class="st">"infection"</span><span class="op">)</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="state_updaters_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="relationship-to-ordinary-differential-equation-solvers">Relationship to Ordinary Differential Equation Solvers<a class="anchor" aria-label="anchor" href="#relationship-to-ordinary-differential-equation-solvers"></a>
</h2>
<p>It is instructive to view these state update methods as approximate
solutions to ordinary differential equations (ODEs). We consider ODEs of
the following form.</p>
<p><span class="math display">\[
\frac{dx_i}{dt} = \sum_j x_j r_{ji} - \sum_i x_i r_{ij}
\]</span> Where the per-capita rate of flowing from compartment <span class="math inline">\(i\)</span> to compartment <span class="math inline">\(j\)</span> is <span class="math inline">\(r_{ij}\)</span>, and <span class="math inline">\(x_i\)</span> is the number of individuals in the
<span class="math inline">\(i\)</span>th compartment. We allow each
<span class="math inline">\(r_{ij}\)</span> to depend on any number of
state variables and time-varying parameters. For example, for an SIR
model we have <span class="math inline">\(x_S, x_I, x_R\)</span> (for
readability we use <span class="math inline">\(S, I, R\)</span>). In
this case <span class="math inline">\(r_{SI} = \beta I / N\)</span>,
<span class="math inline">\(r_{IR} = \gamma\)</span>, and all other
values of <span class="math inline">\(r_{ij}\)</span> are zero. Here the
force of infection, <span class="math inline">\(r_{SI}\)</span>, depends
on a state variable <span class="math inline">\(I\)</span>.</p>
<p>Although each state-update method presented below can be thought of
as an approximate solution to this ODE, they can also be thought of as
dynamical models in their own right. For example, the Euler-multinomial
model is a useful model of process error.</p>
<div class="section level3">
<h3 id="euler">Euler<a class="anchor" aria-label="anchor" href="#euler"></a>
</h3>
<p>The simplest approach is to just pretend that the ODEs are difference
equations. In this case, at each time-step, each state variable is
updated as follows. <span class="math display">\[
x_i = x_i - \sum_j x_i r_{ij} + \sum_j x_j r_{ji}
\]</span> The SIR example is as follows.</p>
<p><span class="math display">\[
S = S - Sr_{SI}
\]</span> <span class="math display">\[
I = I - Ir_{IR} + Sr_{SI}
\]</span> <span class="math display">\[
R = R + Ir_{IR}
\]</span></p>
</div>
<div class="section level3">
<h3 id="runge-kutta-4">Runge Kutta 4<a class="anchor" aria-label="anchor" href="#runge-kutta-4"></a>
</h3>
<p>TODO</p>
</div>
<div class="section level3">
<h3 id="euler-multinomial">Euler-Multinomial<a class="anchor" aria-label="anchor" href="#euler-multinomial"></a>
</h3>
<p>The Euler-multinomial state update method assumes that the number of
individuals that move from one box to another in a single time-step is a
random non-negative integer, coming from a particular multinomial
distribution.</p>
<p>Under this distribution, the probability of staying in the <span class="math inline">\(i\)</span>th box through an entire time-step is
assumed to be the following.</p>
<p><span class="math display">\[
p_{ii} = \exp\left(-\sum_j r_{ij}\right)
\]</span></p>
<p>This probability assumes the following.</p>
<ul>
<li>Individuals leave the box according to a Poisson process with rate
<span class="math inline">\(\exp\left(-\sum_j
r_{ij}\right)\)</span>.</li>
<li>The rates, <span class="math inline">\(r_{ij}\)</span>, are held
constant throughout the entire time-step, although they can change when
each time-step begins.</li>
</ul>
<p>The probability of moving from box <span class="math inline">\(i\)</span> to box <span class="math inline">\(j\)</span> in one time-step is given by the
following.</p>
<p><span class="math display">\[
p_{ij} = (1 - p_{ii}) \frac{r_{ij}}{\sum_j r_{ij}}
\]</span></p>
<p>This probability is just the probability of not staying in box <span class="math inline">\(i\)</span>, which is <span class="math inline">\(1
- p_{ii}\)</span>, and specifically going to box <span class="math inline">\(j\)</span>, which is assumed to be given by this
expression <span class="math inline">\(\frac{r_{ij}}{\sum_j
r_{ij}}\)</span>.</p>
<p>Let <span class="math inline">\(\rho_{ij}\)</span> be the random
number of individuals that move from box <span class="math inline">\(i\)</span> to box <span class="math inline">\(j\)</span> in one time-step. The expected value of
<span class="math inline">\(\rho_{ij}\)</span> is <span class="math inline">\(p_{ij} x_i\)</span>. However, these random
variables are not independent events, because the total number of
individuals, <span class="math inline">\(\sum_i x_i\)</span>, has to
remain constant through a single time-step (at least in the models that
we are currently considering).</p>
<p>To account for this non-independence, we collect the <span class="math inline">\(\rho_{ij}\)</span> associated with a from
compartment <span class="math inline">\(i\)</span> into a vector <span class="math inline">\(\rho_i\)</span>. We collect similar vector of
probabilities, <span class="math inline">\(p_i\)</span>. Each <span class="math inline">\(\rho_i\)</span> is a random draw from a
multinomial distribution with <span class="math inline">\(x_i\)</span>
trials and probability vector, <span class="math inline">\(p_i\)</span>.</p>
<p>Once these random draws have been made, the state variables can be
updated at each time-step as follows.</p>
<p><span class="math display">\[
x_i = x_i - \sum_j \rho_{ij} + \sum_j \rho_{ji}
\]</span></p>
<p>Note that we do not actually need to generate values for the diagonal
elements, <span class="math inline">\(\rho_{ii}\)</span>, because they
cancel out in this update equation. We also can ignore any <span class="math inline">\(\rho_{ij}\)</span> such that <span class="math inline">\(r_{ij} = 0\)</span>.</p>
<p>Under the SIR example we have a particularly simple Euler-binomial
distribution because there are no branching flows – when individuals
leave S they can only go to I and when they leave I they can only go to
R. These two flows are given by the following distributions.</p>
<p><span class="math display">\[
\rho_{SI} \sim \text{Binomial}(S, p_{SI})
\]</span></p>
<p><span class="math display">\[
\rho_{IR} \sim \text{Binomial}(I, p_{IR})
\]</span></p>
<p>In models with branching flows we would have multinomial
distributions. But in this model the state update is given by the
following equations.</p>
<p><span class="math display">\[
S = S - \rho_{SI}
\]</span> <span class="math display">\[
I = I - \rho_{IR} + \rho_{SI}
\]</span> <span class="math display">\[
R = R + \rho_{IR}
\]</span></p>
</div>
<div class="section level3">
<h3 id="hazard">Hazard<a class="anchor" aria-label="anchor" href="#hazard"></a>
</h3>
<p>The Hazard update-method uses the expected values associated with the
Euler-multinomial described above. In particular, the state variables
are updated as follows.</p>
<p><span class="math display">\[
x_i = x_i - \sum_j x_i p_{ij} + \sum_j x_j p_{ji}
\]</span></p>
<p>The SIR model would be as follows.</p>
<p><span class="math display">\[
S = S - Sp_{SI}
\]</span> <span class="math display">\[
I = I - Ip_{IR} + Sp_{SI}
\]</span> <span class="math display">\[
R = R + Ip_{IR}
\]</span></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Walker, Weiguang Guan, Ben Bolker, Jen Freeman, Darren Flynn-Primrose.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
