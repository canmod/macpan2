<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>FAQs • macpan2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="FAQs">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">3.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/quickstart.html">Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/example_models.html">Example Models</a></li>
    <li><a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a></li>
    <li><a class="dropdown-item" href="../articles/real_data.html">Fitting to Real Data</a></li>
    <li><a class="dropdown-item" href="../articles/options.html">Options</a></li>
    <li><a class="dropdown-item" href="../articles/FAQs.html">FAQs</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>FAQs</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/main/vignettes/FAQs.Rmd" class="external-link"><code>vignettes/FAQs.Rmd</code></a></small>
      <div class="d-none name"><code>FAQs.Rmd</code></div>
    </div>

    
    
<p><a href="https://canmod.github.io/macpan2/articles/vignette-status#working-draft"><img src="https://img.shields.io/badge/status-working%20draft-red" alt="status"></a></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Incomplete and growing set of answers to Frequently Asked Questions
(FAQs).</p>
</div>
<div class="section level2">
<h2 id="setup-and-example-models-and-data">Setup and Example Models and Data<a class="anchor" aria-label="anchor" href="#setup-and-example-models-and-data"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://canmod.github.io/macpan2/">macpan2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed" class="external-link">broom.mixed</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>macpan2_verbose <span class="op">=</span>  <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://canmod.github.io/macpan2/">macpan2</a></span><span class="op">)</span></span>
<span><span class="va">si</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_model_spec.html">mp_tmb_model_spec</a></span><span class="op">(</span></span>
<span>    before <span class="op">=</span> <span class="va">S</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">I</span></span>
<span>  , during <span class="op">=</span> <span class="fu"><a href="../reference/mp_per_capita_flow.html">mp_per_capita_flow</a></span><span class="op">(</span></span>
<span>        from      <span class="op">=</span> <span class="st">"S"</span>         <span class="co">## compartment from which individuals flow</span></span>
<span>      , to        <span class="op">=</span> <span class="st">"I"</span>         <span class="co">## compartment to which individuals flow</span></span>
<span>      , rate      <span class="op">=</span> <span class="st">"beta * I"</span>  <span class="co">## expression giving _per-capita_ flow rate</span></span>
<span>      , flow_name <span class="op">=</span> <span class="st">"infection"</span> <span class="co">## name for _absolute_ flow rate = beta * I * S</span></span>
<span>    <span class="op">)</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>I <span class="op">=</span> <span class="fl">0.01</span>, beta <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">si</span><span class="op">)</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Default values:</span></span>
<span><span class="co">#&gt;  quantity value</span></span>
<span><span class="co">#&gt;         I  0.01</span></span>
<span><span class="co">#&gt;      beta  0.20</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: S ~ 1 - I</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to T):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: mp_per_capita_flow(from = "S", to = "I", rate = "beta * I", flow_name = "infection")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">example_data</span> <span class="op">=</span> <span class="op">(</span><span class="va">si</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span>time_steps <span class="op">=</span> <span class="fl">50</span>, outputs <span class="op">=</span> <span class="st">"infection"</span><span class="op">)</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">incidence_example</span> <span class="op">=</span> <span class="op">(</span><span class="va">example_data</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fl">100</span> <span class="op">*</span> <span class="va">value</span><span class="op">)</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="naming-conventions">Naming Conventions<a class="anchor" aria-label="anchor" href="#naming-conventions"></a>
</h2>
<div class="section level3">
<h3 id="what-does-macpan2-mean">What does <code>macpan2</code> mean?<a class="anchor" aria-label="anchor" href="#what-does-macpan2-mean"></a>
</h3>
<p>This <code>macpan2</code> package grew out of the <a href="https://github.com/mac-theobio/McMasterPandemic" class="external-link">McMasterPandemic</a>
project. Over the years the people involved in that project started
calling it macpan, and <code>macpan2</code> is the successor. There is
no package called <code>macpan</code>.</p>
</div>
<div class="section level3">
<h3 id="why-do-most-of-the-functions-start-with-mp_">Why do most of the functions start with <code>mp_</code>?<a class="anchor" aria-label="anchor" href="#why-do-most-of-the-functions-start-with-mp_"></a>
</h3>
<p>The <code>mp</code> stands for <strong>M</strong>cMaster
<strong>P</strong>andemic (i.e., <code>mac-pan</code>). The idea is to
make it easy to see in scripts what functions come from
<code>macpan2</code> and what functions come from other packages.</p>
</div>
<div class="section level3">
<h3 id="why-do-some-of-the-functions-start-with-mp_tmb_">Why do some of the functions start with <code>mp_tmb_</code>?<a class="anchor" aria-label="anchor" href="#why-do-some-of-the-functions-start-with-mp_tmb_"></a>
</h3>
<p>The <code>tmb</code> prefix refers to the <a href="https://github.com/kaskr/adcomp" class="external-link">TMB</a> package, on which
<code>macpan2</code> is built. We hope to one day use other
computational engines (e.g., <a href="https://mc-stan.org/" class="external-link">stan</a>),
at which point users will be able to see what computational engine is
being used in their scripts. For now <code>tmb</code>, is the only
computational engine supported; the only thing <code>mp_tmb_</code>
indicates is that you are using a function that is specific to
computations with TMB. Functions that do not start with
<code>mp_tmb_</code> should be engine-agnostic and will work with any
engine (when and if we develop support for other engines).</p>
</div>
</div>
<div class="section level2">
<h2 id="calibration-details-and-outputs">Calibration Details and Outputs<a class="anchor" aria-label="anchor" href="#calibration-details-and-outputs"></a>
</h2>
<div class="section level3">
<h3 id="how-does-macpan2-fit-models-to-data">How does <code>macpan2</code> fit models to data?<a class="anchor" aria-label="anchor" href="#how-does-macpan2-fit-models-to-data"></a>
</h3>
<p>In its standard mode, <code>macpan2</code> works by finding the
minimum of an <em>objective function</em>: normally, the objective
function is a negative log-likelihood function, so this minimum
corresponds to <em>maximum likelihood estimation</em>. More
specifically, <code>macpan2</code> only takes noise in the observation
process into account — in calibration (but not simulation) mode, it
ignores the randomness of the dynamical process itself — so it is using
a procedure called <em>trajectory matching</em> <span class="citation">[@bolker2008]</span>. <span class="citation">@earnFitting2024</span> give a more careful
introduction to this approach, although they focus on fitting
continuous-time (differential equation) models to data, whereas
<code>macpan2</code> defines discrete-time models by default (unless you
specify <a href="https://canmod.github.io/macpan2/reference/state_updates.html"><code>mp_rk4</code></a>
when defining the state updates in your model).</p>
<p>If you <a href="https://canmod.github.io/macpan2/articles/likelihood_prior_specs.html?q=prior#priors-on-distributional-parameters">specify
priors</a> for some of the parameters in your model, then by minimizing
the objective (negative log-posterior) function, you are performing <a href="https://en.wikipedia.org/wiki/Maximum_a_posteriori_estimation" class="external-link">maximum
a posteriori (MAP) estimation</a>.</p>
<p>You can also use random-effects parameters to fit smooth
nonparametric terms, or otherwise allow for latent Gaussian variables in
your model (this is an advanced topic: see the <a href="https://canmod.github.io/macpan2/articles/time_varying_parameters_advanced.html">advanced
time-varying parameters vignette</a>; in this case, <code>macpan2</code>
uses TMB’s built-in <a href="https://en.wikipedia.org/wiki/Laplace%27s_approximation" class="external-link">Laplace
approximation</a> engine to approximate this otherwise difficult
term.</p>
<p>If you want to do truly Bayesian estimation (rather than the MAP
approximation), you can feed <code>macpan2</code> models into the
<code>tmbstan</code> package to perform <a href="https://canmod.github.io/macpan2/articles/calibration_advanced.html#hamiltonian-mc">Hamiltonian
Monte Carlo sampling</a> and get corresponding estimates (and Bayesian
credible intervals, see below).</p>
<p>Example calibrations of varying levels of complexity.</p>
<ul>
<li><a href="https://canmod.github.io/macpan2/articles/calibration">Intro to
calibration using toy data</a></li>
<li><a href="https://canmod.github.io/macpan2/articles/real_data">Intro
to calibration using real scarlet fever data</a></li>
<li><a href="https://canmod.github.io/macpan2/articles/calibration_advanced.html">For
hackers only</a></li>
<li><a href="https://github.com/canmod/macpan2/tree/main/inst/starter_models/macpan_base#calibration" class="external-link">McMaster
COVID model</a></li>
<li><a href="https://github.com/canmod/macpan2/tree/main/inst/starter_models/ww#calibration" class="external-link">Wastewater
model of COVID</a></li>
<li><a href="https://github.com/canmod/macpan2/tree/main/inst/starter_models/shiver#calibration-example" class="external-link">SHIVER
model to COVID</a></li>
<li><a href="https://github.com/canmod/macpan2/tree/main/inst/starter_models/seir#calibration" class="external-link">SEIR
model using toy data</a></li>
</ul>
</div>
<div class="section level3">
<h3 id="how-does-macpan2-derive-confidence-intervals">How does <code>macpan2</code> derive confidence intervals?<a class="anchor" aria-label="anchor" href="#how-does-macpan2-derive-confidence-intervals"></a>
</h3>
<p>By default, <code>macpan2</code> assumes that the uncertainties of
all model parameters, coefficients, etc. are approximately
multivariate-Gaussian distributed; the resulting confidence intervals
are sometimes called <em>Wald</em> intervals <span class="citation">[@bolker2008]</span>. Since the models fitted by
<code>macpan2</code> are typically nonlinear, this approach also
requires use of the <a href="https://en.wikipedia.org/wiki/Delta_method" class="external-link">delta method</a>
(implemented automatically within <a href="https://github.com/kaskr/adcomp" class="external-link">TMB</a>) to compute the variances
of derived quantities such as trajectories (see <a href="https://kaskr.github.io/adcomp/_book/Appendix.html#theory-underlying-sdreport" class="external-link">here</a>).
(If we add priors and further assume that we are doing MAP estimation,
these intervals might be called credible rather than confidence
intervals.)</p>
<p>This approach can be used to obtain confidence / credible intervals
for any continuous function of model variables, e.g.</p>
<ol style="list-style-type: decimal">
<li>Confidence intervals on fitted parameters using
<code>mp_tmb_coef(., conf.int = TRUE)</code>.</li>
<li>Confidence intervals on fitted trajectories using
<code><a href="../reference/mp_trajectory.html">mp_trajectory_sd()</a></code>
</li>
</ol>
</div>
<div class="section level3">
<h3 id="what-likelihood-and-prior-distribution-assumptions-does-macpan2-make">What likelihood and prior distribution assumptions does
<code>macpan2</code> make?<a class="anchor" aria-label="anchor" href="#what-likelihood-and-prior-distribution-assumptions-does-macpan2-make"></a>
</h3>
<p>You are free to declare any value in the model to be a trajectory or
parameter. Trajectories are compared with observed data to produce a
likelihood component (e.g., case reports are distributed with a negative
binomial distribution with dispersion parameter <code>1</code>) and
parameters are used to produce a component of the prior distribution
(e.g., the transmission rate is log normally distributed with mean
<code>0.2</code> and standard deviation <code>1</code>). Available
distributional assumptions and settings are described <a href="https://canmod.github.io/macpan2/articles/likelihood_prior_specs">here</a>,
but inspecting the examples linked to in the previous FAQ will be more
useful for figuring out how to use this functionality.</p>
</div>
<div class="section level3">
<h3 id="can-i-get-a-new-model-specification-with-fitted-parameters-as-defaults-from-a-calibrated-calibrator-object">Can I get a new model specification with fitted parameters as
defaults, from a calibrated calibrator object?<a class="anchor" aria-label="anchor" href="#can-i-get-a-new-model-specification-with-fitted-parameters-as-defaults-from-a-calibrated-calibrator-object"></a>
</h3>
<p>Coming soon!</p>
</div>
</div>
<div class="section level2">
<h2 id="plotting-simulated-trajectories">Plotting Simulated Trajectories<a class="anchor" aria-label="anchor" href="#plotting-simulated-trajectories"></a>
</h2>
<div class="section level3">
<h3 id="how-can-i-plot-simulated-trajectories">How can I plot simulated trajectories?<a class="anchor" aria-label="anchor" href="#how-can-i-plot-simulated-trajectories"></a>
</h3>
<p>This question is answered in the <a href="https://canmod.github.io/macpan2/articles/quickstart">quickstart
guide</a>.</p>
</div>
<div class="section level3">
<h3 id="how-can-i-plot-a-calibrated-model-with-the-observed-data-used-in-the-calibration">How can I plot a calibrated model with the observed data used in the
calibration?<a class="anchor" aria-label="anchor" href="#how-can-i-plot-a-calibrated-model-with-the-observed-data-used-in-the-calibration"></a>
</h3>
<p>This is my favourite way to do it.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="va">model_calibrator</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">observed_data</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">fitted_data</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="calibration-troubleshooting">Calibration Troubleshooting<a class="anchor" aria-label="anchor" href="#calibration-troubleshooting"></a>
</h2>
<div class="section level3">
<h3 id="should-i-worry-about-nanan-function-evaluation-warnings">Should I worry about <code>NA/NaN function evaluation</code>
warnings?<a class="anchor" aria-label="anchor" href="#should-i-worry-about-nanan-function-evaluation-warnings"></a>
</h3>
<p>The optimizer will sometimes give warnings like this.</p>
<pre><code>Warning messages:
1: In (function (start, objective, gradient = NULL, hessian = NULL,  :
  NA/NaN function evaluation</code></pre>
<p>This is usually nothing to worry about, though you should take note
of it. Typically this warning indicates that the optimizer tried
parameter values that led the objective function (i.e., the negative log
posterior density) to be non-numeric. Usually, the optimizer is smart
enough (if it is possible) to get back on track. The key thing to watch
out for is whether the optimizer converged, which can be explored using
the <code><a href="../reference/mp_optimizer_output.html">mp_optimizer_output()</a></code> function that is illustrated in
<a href="https://canmod.github.io/macpan2/articles/calibration">this
article</a>.</p>
</div>
<div class="section level3">
<h3 id="what-should-i-do-if-i-do-not-converge">What should I do if I do not converge?<a class="anchor" aria-label="anchor" href="#what-should-i-do-if-i-do-not-converge"></a>
</h3>
<p>It depends on the reason for non-convergence. The optimizer tries to
give you information about this, and you can get this information using
the <code><a href="../reference/mp_optimizer_output.html">mp_optimizer_output()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="how-do-i-increase-the-number-of-iterations-that-the-optimizer-takes">How do I increase the number of iterations that the optimizer
takes?<a class="anchor" aria-label="anchor" href="#how-do-i-increase-the-number-of-iterations-that-the-optimizer-takes"></a>
</h3>
<p>When non-convergence results because the optimizer reaches its
specified maximum number of iterations that it was allowed to take, you
can increase that value by specifying arguments in
<code><a href="../reference/mp_optimize.html">mp_optimize()</a></code> that get passed through to the optimizer. The
default optimizer in <code>macpan2</code> is <a href="https://stat.ethz.ch/R-manual/R-devel/library/stats/html/nlminb.html" class="external-link">nlminb</a>:
for example, specifying
<code>control = list(eval.max = 1000, iter.max = 1000)</code> (the
defaults for these settings are 200 and 150, respectively) within
<code><a href="../reference/mp_optimize.html">mp_optimize()</a></code> will allow the optimizer to run longer.
However, running out of iterations could also be an indication that
there is something wrong with your model, e.g. that there is not enough
information present in the data to estimate all of the parameters.</p>
</div>
</div>
<div class="section level2">
<h2 id="parameter-estimation-and-uncertainty">Parameter Estimation and Uncertainty<a class="anchor" aria-label="anchor" href="#parameter-estimation-and-uncertainty"></a>
</h2>
<div class="section level3">
<h3 id="what-can-i-do-when-my-confidence-intervals-include-zero-for-a-parameter-that-should-be-positive">What can I do when my confidence intervals include zero for a
parameter that should be positive?<a class="anchor" aria-label="anchor" href="#what-can-i-do-when-my-confidence-intervals-include-zero-for-a-parameter-that-should-be-positive"></a>
</h3>
<p>You should use <code><a href="../reference/mp_tmb_insert.html">mp_tmb_insert()</a></code> to transform your
parameters so that they cannot go negative. TODO: link to an
example.</p>
</div>
<div class="section level3">
<h3 id="can-i-weight-the-importance-of-trajectories-when-fitting-to-more-than-one-of-them">Can I weight the importance of trajectories when fitting to more
than one of them?<a class="anchor" aria-label="anchor" href="#can-i-weight-the-importance-of-trajectories-when-fitting-to-more-than-one-of-them"></a>
</h3>
<p>Yes, but it is not recommended until you are deep into it. TODO: give
explanation and link to example.</p>
</div>
</div>
<div class="section level2">
<h2 id="dynamical-instabilities">Dynamical Instabilities<a class="anchor" aria-label="anchor" href="#dynamical-instabilities"></a>
</h2>
<div class="section level3">
<h3 id="what-is-the-best-way-for-me-to-keep-my-state-variables-from-going-negative">What is the best way for me to keep my state variables from going
negative?<a class="anchor" aria-label="anchor" href="#what-is-the-best-way-for-me-to-keep-my-state-variables-from-going-negative"></a>
</h3>
<p>The hazard correction (<code><a href="../reference/state_updates.html">mp_hazard()</a></code>) works best in my
experience. TODO: link to example.</p>
</div>
</div>
<div class="section level2">
<h2 id="initial-conditions">Initial Conditions<a class="anchor" aria-label="anchor" href="#initial-conditions"></a>
</h2>
<div class="section level3">
<h3 id="my-data-start-mid-epidemic-how-do-i-know-what-the-initial-number-of-infectious-individuals-is">My data start mid-epidemic: how do I know what the initial number of
infectious individuals is?<a class="anchor" aria-label="anchor" href="#my-data-start-mid-epidemic-how-do-i-know-what-the-initial-number-of-infectious-individuals-is"></a>
</h3>
<p>This is a common situation as data collection often gets better after
it is clear that there is a problem. But simulating epidemic models
requires specifying the initial conditions of all of the state
variables, and we do not have data on that. The basic idea for solving
this problem is to fit the initial numbers of some of the state
variables. But there are issues.</p>
<p>Let’s get an example. We manipulate the example infection data above
by removing the first 25 time steps. The first issue is what to set the
time steps as. We could just keep them as they were (i.e.,
<code>26:50</code>) but this would be cheating because it would be
preserving the time of the start of the epidemic as 25 time steps again,
and in real life we do not know this information. So we pretend that the
epidemic started 10 time steps before the data start.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start_date_offset</span> <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="va">in_progress_epidemic</span> <span class="op">=</span> <span class="op">(</span><span class="va">example_data</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;</span> <span class="fl">25</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        value <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rpois</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, <span class="fl">100</span> <span class="op">*</span> <span class="va">value</span><span class="op">)</span></span>
<span>      , time <span class="op">=</span> <span class="va">start_date_offset</span> <span class="op">+</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">max_time</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">in_progress_epidemic</span><span class="op">$</span><span class="va">time</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">in_progress_epidemic</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">max_time</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="FAQs_files/figure-html/unnamed-chunk-1-1.png" width="576"></p>
<p>The blank space on the graph from time <code>1</code> to
<code>10</code> represents the period of the outbreak without data. The
exact size of this period is not crucial, only that it is long enough to
let the dynamics of model settle down and become independent of the
initial values of the state variables. Actually, for this simple SI
model example we could even ignore this start-time issue, and just fit
the initial values of the number of infectious individuals. But in
models with many state variables it becomes very easy to specify initial
conditions that the model wouldn’t go to naturally, resulting in
dynamical instability. This instability can cause optimization problems
because the optimizer might choose starting conditions that lead to
instabilities and therefore bad fits.</p>
<p>But we will continue with the SI model to illustrate the general idea
with relative simplicity. There are a few key ideas in the code
below.</p>
<ol style="list-style-type: decimal">
<li>We express the initial number of infectious individuals as
<code>N</code> times a logistic function of a new parameter,
<code>logit_prop_I</code>, giving the proportion of the population that
is infectious on the logit scale. This transformation allows us to fit
<code>logit_prop_I</code> while ensuring that the initial value of
<code>I</code> stays between <code>0</code> and <code>N</code>.</li>
<li>We use the <code>mp_sim_bounds</code> function to assert that the
first time step is <code>1</code> and the last time step is
<code>max_time</code>, which in this case is 35.</li>
<li>We give a prior distribution for <code>logit_prop_I</code>
</li>
</ol>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calibrator</span> <span class="op">=</span> <span class="op">(</span><span class="st">"starter_models"</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_tmb_library.html">mp_tmb_library</a></span><span class="op">(</span><span class="st">"si"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_tmb_insert.html">mp_tmb_insert</a></span><span class="op">(</span>phase <span class="op">=</span> <span class="st">"before"</span></span>
<span>    , expressions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">I</span> <span class="op">~</span> <span class="va">N</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">logit_prop_I</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>logit_prop_I <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_tmb_calibrator.html">mp_tmb_calibrator</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="va">in_progress_epidemic</span></span>
<span>    , traj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>infection <span class="op">=</span> <span class="fu"><a href="../reference/distribution.html">mp_nbinom</a></span><span class="op">(</span>disp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>    , par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        beta <span class="op">=</span> <span class="fu"><a href="../reference/distribution.html">mp_norm</a></span><span class="op">(</span>location <span class="op">=</span> <span class="fl">0.4</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>      , logit_prop_I <span class="op">=</span> <span class="fu"><a href="../reference/distribution.html">mp_norm</a></span><span class="op">(</span>location <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    , time <span class="op">=</span> <span class="fu"><a href="../reference/mp_sim_bounds.html">mp_sim_bounds</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">max_time</span>, <span class="st">"steps"</span><span class="op">)</span></span>
<span> <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/mp_optimize.html">mp_optimize</a></span><span class="op">(</span><span class="va">calibrator</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;     params     params </span></span>
<span><span class="co">#&gt; 0.09910844 0.55847313 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 38.00748</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 9</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       13       10 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "relative convergence (4)"</span></span>
<span><span class="va">cc</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_coef.html">mp_tmb_coef</a></span><span class="op">(</span><span class="va">calibrator</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">cc</span><span class="op">)</span></span>
<span><span class="co">#&gt;       term    mat row col default  type   estimate  std.error   conf.low</span></span>
<span><span class="co">#&gt; 1   params   beta   0   0     0.2 fixed 0.09910844 0.04234644 0.01611094</span></span>
<span><span class="co">#&gt; 2 params.1 prop_I   0   0     0.5 fixed 0.63609918 0.42942418 0.04404282</span></span>
<span><span class="co">#&gt;   conf.high</span></span>
<span><span class="co">#&gt; 1 0.1821059</span></span>
<span><span class="co">#&gt; 2 0.9851457</span></span></code></pre></div>
<p>We see that we are able to fit both the transmission rate,
<code>beta</code>, and the initial proportion of infectious individuals,
and get reasonable confidence intervals. Note that
<code>logit_prop_I</code> has been automatically back-transformed to
<code>prop_I</code>, but this functionality can be turned off by setting
<code>back_transform = FALSE</code> in <code>mp_tmb_coef</code>. The
plot below shows how the model is able to fit to the data without
knowing the initial number of infectious individuals 10</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted_data</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="va">calibrator</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">in_progress_epidemic</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">fitted_data</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="FAQs_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
<p>Real data will not be as simple, but these principles will help.</p>
</div>
</div>
<div class="section level2">
<h2 id="coding-style">Coding Style<a class="anchor" aria-label="anchor" href="#coding-style"></a>
</h2>
<div class="section level3">
<h3 id="what-does-mean">What does <code>|&gt;</code> mean?<a class="anchor" aria-label="anchor" href="#what-does-mean"></a>
</h3>
<p>We use the <a href="https://www.tidyverse.org/blog/2023/04/base-vs-magrittr-pipe/#pipes" class="external-link">base
R pipe</a> operator throughout our examples. Please read this link for
details.</p>
</div>
<div class="section level3">
<h3 id="why-do-you-put-weird-symbols-at-the-start-of-lines">Why do you put weird symbols at the start of lines?<a class="anchor" aria-label="anchor" href="#why-do-you-put-weird-symbols-at-the-start-of-lines"></a>
</h3>
<p>In many of our examples we start lines with characters that many
people put at the end of lines, such as the commas, plus signs and the
<a href="https://www.tidyverse.org/blog/2023/04/base-vs-magrittr-pipe/#pipes" class="external-link">base
R pipe</a>. These characters tell R how the code on the rest of the line
is to combined with previous lines. We prefer to put these characters at
the start of lines because it makes it slightly easier to comment lines
out. Note that for this approach to work you need to wrap these
continued expressions in parentheses. See the <a href="https://canmod.github.io/macpan2/articles/quickstart.html">quickstart</a>
guide for examples of this style.</p>
</div>
</div>
<div class="section level2">
<h2 id="time-variation-of-parameters">Time Variation of Parameters<a class="anchor" aria-label="anchor" href="#time-variation-of-parameters"></a>
</h2>
<div class="section level3">
<h3 id="how-can-i-use-a-known-time-series-of-values">How can I use a known time series of values?<a class="anchor" aria-label="anchor" href="#how-can-i-use-a-known-time-series-of-values"></a>
</h3>
</div>
<div class="section level3">
<h3 id="what-if-my-time-series-has-missing-values">What if my time-series has missing values?<a class="anchor" aria-label="anchor" href="#what-if-my-time-series-has-missing-values"></a>
</h3>
</div>
<div class="section level3">
<h3 id="what-can-i-do-if-i-do-not-know-the-functional-form-of-time-variation">What can I do if I do not know the functional form of
time-variation?<a class="anchor" aria-label="anchor" href="#what-can-i-do-if-i-do-not-know-the-functional-form-of-time-variation"></a>
</h3>
</div>
</div>
<div class="section level2">
<h2 id="under-reporting-delayed-reporting-and-total-reporting">Under Reporting, Delayed Reporting, and Total Reporting<a class="anchor" aria-label="anchor" href="#under-reporting-delayed-reporting-and-total-reporting"></a>
</h2>
<div class="section level3">
<h3 id="how-should-i-account-for-under-reporting-in-macpan2">How should I account for under-reporting in
<code>macpan2</code>?<a class="anchor" aria-label="anchor" href="#how-should-i-account-for-under-reporting-in-macpan2"></a>
</h3>
</div>
<div class="section level3">
<h3 id="how-should-i-account-for-delayed-reporting-as-well-as-under-reporting-in-macpan2">How should I account for delayed reporting as well as
under-reporting in <code>macpan2</code>?<a class="anchor" aria-label="anchor" href="#how-should-i-account-for-delayed-reporting-as-well-as-under-reporting-in-macpan2"></a>
</h3>
<p>The challenge introduced by reporting delays is that we cannot
compare the simulated incidence values from our model with observed case
reports, because there is a reporting delay. The following toy example
shows how the apparent peak in the data follows the simulations.</p>
<p><img src="FAQs_files/figure-html/unnamed-chunk-5-1.png" width="576"></p>
<p>So before comparing the simulations with observed data, we use
convolution to transform the simulated incidence values into a time
series of reported cases that is expected by the model. Keep reading to
find out specifically how this is done.</p>
<p><img src="FAQs_files/figure-html/unnamed-chunk-6-1.png" width="576"></p>
<p>Now we can now compare the observed and expected reported cases in a
manner that accounts for reporting delays.</p>
<p><img src="FAQs_files/figure-html/unnamed-chunk-7-1.png" width="576"></p>
<p>Now to explain how the expected reported case curve is computed. In
this method we assume that each new case waits a Gamma-distributed
random amount of time before it is observed. The mean and coefficient of
variation of this distribution can be fitted parameters. During the
COVID-19 pandemic the McMaster group found that a Gamma distribution
with mean delay of 11 days and coefficient of variation of 0.25 was a
reasonable model.</p>
<p>The following figure illustrates how a single expected case report is
computed, in this case at time 26. The Gamma distribution of delay times
is represented as bars giving the probability that a new case at a
particular time is reported at time 26, which is given as the dashed
horizontal line. Note how the reported number of cases is roughly near
(but not identical) to the simulated number of cases at the peak of the
delay distribution. This makes sense because we would expect most of our
reports now to come from the highest probability time in the past.</p>
<p><img src="FAQs_files/figure-html/plot-expected-case-report-1.png" width="576"></p>
<p>To account for delays between incidence and case reports (or other
delays in reporting), you can update an existing model with
<code><a href="../reference/mp_tmb_insert_reports.html">mp_tmb_insert_reports()</a></code> before fitting the model:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">si_with_delays</span> <span class="op">=</span> <span class="op">(</span><span class="va">si</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_tmb_insert_reports.html">mp_tmb_insert_reports</a></span><span class="op">(</span></span>
<span>      incidence_name <span class="op">=</span> <span class="st">"infection"</span></span>
<span>    , mean_delay <span class="op">=</span> <span class="fl">11</span></span>
<span>    , cv_delay <span class="op">=</span> <span class="fl">0.25</span></span>
<span>    , report_prob <span class="op">=</span> <span class="fl">0.1</span></span>
<span>    , reports_name <span class="op">=</span> <span class="st">"reports"</span></span>
<span> <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">si_with_delays</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span></span>
<span>      time_steps <span class="op">=</span> <span class="fl">50L</span></span>
<span>    , outputs <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"infection"</span>, <span class="st">"reports"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span>, colour <span class="op">=</span> <span class="va">matrix</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="FAQs_files/figure-html/mp-tmb-insert-reports-1.png" width="576"></p>
<p>This function can account for under-reporting as well, by specifying
a <code>report_prob</code> that is less than 1.</p>
<pre><code><span><span class="fl">16</span><span class="op">:</span> <span class="va">dist</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">pgamma</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">17</span>, <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">incidence_cv_delay</span><span class="op">)</span>, <span class="va">incidence_mean_delay</span> <span class="op">*</span> <span class="op">(</span><span class="va">incidence_cv_delay</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fl">17</span><span class="op">:</span> <span class="va">delta</span> <span class="op">~</span> <span class="va">dist</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">16</span><span class="op">]</span> <span class="op">-</span> <span class="va">dist</span><span class="op">[</span><span class="fl">0</span><span class="op">:</span><span class="fl">15</span><span class="op">]</span></span>
<span><span class="fl">18</span><span class="op">:</span> <span class="va">kernel</span> <span class="op">~</span> <span class="va">incidence_report_prob</span> <span class="op">*</span> <span class="va">delta</span><span class="op">/</span><span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="va">delta</span><span class="op">)</span></span>
<span><span class="fl">19</span><span class="op">:</span> <span class="va">reported_incidence</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">convolution</a></span><span class="op">(</span><span class="va">incidence</span>, <span class="va">kernel</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="can-macpan2-use-hidden-markov-models-to-account-for-reporting-bias">Can <code>macpan2</code> use hidden Markov models to account for
reporting bias?<a class="anchor" aria-label="anchor" href="#can-macpan2-use-hidden-markov-models-to-account-for-reporting-bias"></a>
</h3>
</div>
</div>
<div class="section level2">
<h2 id="stochastic-simulation">Stochastic Simulation<a class="anchor" aria-label="anchor" href="#stochastic-simulation"></a>
</h2>
<div class="section level3">
<h3 id="how-can-i-set-the-seed-for-the-random-number-generator">How can I set the seed for the random number generator?<a class="anchor" aria-label="anchor" href="#how-can-i-set-the-seed-for-the-random-number-generator"></a>
</h3>
</div>
<div class="section level3">
<h3 id="why-do-i-keep-getting-the-same-result-even-though-my-model-has-randomness">Why do I keep getting the same result even though my model has
randomness?<a class="anchor" aria-label="anchor" href="#why-do-i-keep-getting-the-same-result-even-though-my-model-has-randomness"></a>
</h3>
</div>
<div class="section level3">
<h3 id="what-are-the-mathematical-details-of-the-euler-multinomial-process-error-model">What are the mathematical details of the Euler multinomial process
error model?<a class="anchor" aria-label="anchor" href="#what-are-the-mathematical-details-of-the-euler-multinomial-process-error-model"></a>
</h3>
<p>The <a href="https://kingaa.github.io/manuals/pomp/html/eulermultinom.html" class="external-link">Euler-multinomial</a>
state update method assumes that the number of individuals that move
from one box to another in a single time-step is a random non-negative
integer, coming from a particular multinomial distribution that we now
describe.</p>
<p>The probability of staying in the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>th
box through an entire time-step is assumed to be the following (TODO:
relate this to Poisson processes).</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><mo>=</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mo>−</mo><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>r</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
p_{ii} = \exp\left(-\sum_j r_{ij}\right)
</annotation></semantics></math></p>
<p>This probability assumes that the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>r</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">r_{ij}</annotation></semantics></math>
are held constant throughout the entire time-step, although they can
change when each time-step begins.</p>
<p>The probability of moving from box
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
to box
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
in one time-step is given by the following.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mfrac><msub><mi>r</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mrow><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>r</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">
p_{ij} = (1 - p_{ii}) \frac{r_{ij}}{\sum_j r_{ij}}
</annotation></semantics></math></p>
<p>This probability is just the probability of not staying in box
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>,
which is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>−</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">1 - p_{ii}</annotation></semantics></math>,
and specifically going to box
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>,
which is assumed to be given by this expression
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mfrac><msub><mi>r</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mrow><msub><mo>∑</mo><mi>j</mi></msub><msub><mi>r</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow></mfrac><annotation encoding="application/x-tex">\frac{r_{ij}}{\sum_j r_{ij}}</annotation></semantics></math>.</p>
<p>Let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ρ</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">\rho_{ij}</annotation></semantics></math>
be the random number of individuals that move from box
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
to box
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>j</mi><annotation encoding="application/x-tex">j</annotation></semantics></math>
in one time-step. The expected value of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ρ</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">\rho_{ij}</annotation></semantics></math>
is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">p_{ij} x_i</annotation></semantics></math>.
However, these random variables are not independent events, because the
total number of individuals,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mo>∑</mo><mi>i</mi></msub><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\sum_i x_i</annotation></semantics></math>,
has to remain constant through a single time-step (at least in the
models that we are currently considering).</p>
<p>To account for this non-independence, we collect the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ρ</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">\rho_{ij}</annotation></semantics></math>
associated with a from compartment
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
into a vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ρ</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\rho_i</annotation></semantics></math>.
We collect similar vector of probabilities,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>i</mi></msub><annotation encoding="application/x-tex">p_i</annotation></semantics></math>.
Each
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ρ</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\rho_i</annotation></semantics></math>
is a random draw from a multinomial distribution with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mi>i</mi></msub><annotation encoding="application/x-tex">x_i</annotation></semantics></math>
trials and probability vector,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>p</mi><mi>i</mi></msub><annotation encoding="application/x-tex">p_i</annotation></semantics></math>.</p>
<p>Once these random draws have been made, the state variables can be
updated at each time-step as follows.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>=</mo><msub><mi>x</mi><mi>i</mi></msub><mo>−</mo><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>ρ</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>+</mo><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>ρ</mi><mrow><mi>j</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">
x_i = x_i - \sum_j \rho_{ij} + \sum_j \rho_{ji}
</annotation></semantics></math></p>
<p>Note that we do not actually need to generate values for the diagonal
elements,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ρ</mi><mrow><mi>i</mi><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">\rho_{ii}</annotation></semantics></math>,
because they cancel out in this update equation. We also can ignore any
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>ρ</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><annotation encoding="application/x-tex">\rho_{ij}</annotation></semantics></math>
such that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">r_{ij} = 0</annotation></semantics></math>.</p>
<p>Under the SIR example we have a particularly simple Euler-binomial
distribution because there are no branching flows – when individuals
leave S they can only go to I and when they leave I they can only go to
R. These two flows are given by the following distributions.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ρ</mi><mrow><mi>S</mi><mi>I</mi></mrow></msub><mo>∼</mo><mtext mathvariant="normal">Binomial</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>S</mi><mo>,</mo><msub><mi>p</mi><mrow><mi>S</mi><mi>I</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\rho_{SI} \sim \text{Binomial}(S, p_{SI})
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ρ</mi><mrow><mi>I</mi><mi>R</mi></mrow></msub><mo>∼</mo><mtext mathvariant="normal">Binomial</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>I</mi><mo>,</mo><msub><mi>p</mi><mrow><mi>I</mi><mi>R</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\rho_{IR} \sim \text{Binomial}(I, p_{IR})
</annotation></semantics></math></p>
<p>In models with branching flows we would have multinomial
distributions. But in this model the state update is given by the
following equations.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo>=</mo><mi>S</mi><mo>−</mo><msub><mi>ρ</mi><mrow><mi>S</mi><mi>I</mi></mrow></msub></mrow><annotation encoding="application/x-tex">
S = S - \rho_{SI}
</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>I</mi><mo>=</mo><mi>I</mi><mo>−</mo><msub><mi>ρ</mi><mrow><mi>I</mi><mi>R</mi></mrow></msub><mo>+</mo><msub><mi>ρ</mi><mrow><mi>S</mi><mi>I</mi></mrow></msub></mrow><annotation encoding="application/x-tex">
I = I - \rho_{IR} + \rho_{SI}
</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>=</mo><mi>R</mi><mo>+</mo><msub><mi>ρ</mi><mrow><mi>I</mi><mi>R</mi></mrow></msub></mrow><annotation encoding="application/x-tex">
R = R + \rho_{IR}
</annotation></semantics></math></p>
</div>
<div class="section level3">
<h3 id="does-macpan2-implement-the-gillespie-algorithm">Does <code>macpan2</code> implement the <a href="https://en.wikipedia.org/wiki/Gillespie_algorithm" class="external-link">Gillespie
algorithm</a>?<a class="anchor" aria-label="anchor" href="#does-macpan2-implement-the-gillespie-algorithm"></a>
</h3>
<p>No. Using <code>state_update = "discrete_stoch"</code> in your <a href="https://canmod.github.io/macpan2/reference/mp_tmb_model_spec.html">model
specification</a>, and using a small time step, will (inefficiently)
approximate a continuous-time, discrete-state stochastic model.</p>
</div>
<div class="section level3">
<h3 id="more-process-error-incomplete">More Process Error (incomplete)<a class="anchor" aria-label="anchor" href="#more-process-error-incomplete"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">spec</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_model_spec.html">mp_tmb_model_spec</a></span><span class="op">(</span></span>
<span>    before <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="va">R</span> <span class="op">~</span> <span class="va">vaxprop</span> <span class="op">*</span> <span class="va">N</span></span>
<span>      , <span class="va">S</span> <span class="op">~</span> <span class="va">N</span> <span class="op">-</span> <span class="va">I</span> <span class="op">-</span> <span class="va">R</span></span>
<span>    <span class="op">)</span></span>
<span>  , during <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="va">infection</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">reulermultinom</a></span><span class="op">(</span><span class="va">S</span>, <span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span><span class="op">)</span></span>
<span>      , <span class="va">recovery</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">reulermultinom</a></span><span class="op">(</span><span class="va">I</span>, <span class="va">gamma</span><span class="op">)</span></span>
<span>      , <span class="va">S</span> <span class="op">~</span> <span class="va">S</span> <span class="op">-</span> <span class="va">infection</span></span>
<span>      , <span class="va">I</span> <span class="op">~</span> <span class="va">I</span> <span class="op">+</span> <span class="va">infection</span> <span class="op">-</span> <span class="va">recovery</span></span>
<span>      , <span class="va">R</span> <span class="op">~</span> <span class="va">R</span> <span class="op">+</span> <span class="va">recovery</span></span>
<span>    <span class="op">)</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        vaxprop <span class="op">=</span> <span class="fl">0.71111111</span></span>
<span>      , N <span class="op">=</span> <span class="fl">1000</span></span>
<span>      , I <span class="op">=</span> <span class="fl">10</span></span>
<span>      , beta <span class="op">=</span> <span class="fl">1.25</span></span>
<span>      , gamma <span class="op">=</span> <span class="fl">1.1</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">spec</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span></span>
<span>      time_steps <span class="op">=</span> <span class="fl">10</span></span>
<span>    , outputs <span class="op">=</span> <span class="st">"infection"</span></span>
<span>  <span class="op">)</span> </span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory_replicate</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;       matrix time row col value</span></span>
<span><span class="co">#&gt; 1  infection    1   0   0     2</span></span>
<span><span class="co">#&gt; 2  infection    2   0   0     2</span></span>
<span><span class="co">#&gt; 3  infection    3   0   0     1</span></span>
<span><span class="co">#&gt; 4  infection    4   0   0     3</span></span>
<span><span class="co">#&gt; 5  infection    5   0   0     2</span></span>
<span><span class="co">#&gt; 6  infection    6   0   0     0</span></span>
<span><span class="co">#&gt; 7  infection    7   0   0     0</span></span>
<span><span class="co">#&gt; 8  infection    8   0   0     0</span></span>
<span><span class="co">#&gt; 9  infection    9   0   0     0</span></span>
<span><span class="co">#&gt; 10 infection   10   0   0     0</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vaxprop</span> <span class="op">=</span> <span class="fl">0.7</span></span>
<span><span class="va">N</span> <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">spec</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_model_spec.html">mp_tmb_model_spec</a></span><span class="op">(</span></span>
<span>    before <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">S</span> <span class="op">~</span> <span class="va">N</span> <span class="op">-</span> <span class="va">I</span> <span class="op">-</span> <span class="va">R</span><span class="op">)</span></span>
<span>  , during <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="va">infection</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">reulermultinom</a></span><span class="op">(</span><span class="va">S</span>, <span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span><span class="op">)</span></span>
<span>      , <span class="va">recovery</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">reulermultinom</a></span><span class="op">(</span><span class="va">I</span>, <span class="va">gamma</span><span class="op">)</span></span>
<span>      , <span class="va">S</span> <span class="op">~</span> <span class="va">S</span> <span class="op">-</span> <span class="va">infection</span></span>
<span>      , <span class="va">I</span> <span class="op">~</span> <span class="va">I</span> <span class="op">+</span> <span class="va">infection</span> <span class="op">-</span> <span class="va">recovery</span></span>
<span>      , <span class="va">R</span> <span class="op">~</span> <span class="va">R</span> <span class="op">+</span> <span class="va">recovery</span></span>
<span>    <span class="op">)</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        N <span class="op">=</span> <span class="va">N</span></span>
<span>      , R <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">round</a></span><span class="op">(</span><span class="va">vaxprop</span> <span class="op">*</span> <span class="va">N</span><span class="op">)</span></span>
<span>      , I <span class="op">=</span> <span class="fl">10</span></span>
<span>      , beta <span class="op">=</span> <span class="fl">1.25</span></span>
<span>      , gamma <span class="op">=</span> <span class="fl">1.1</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op">=</span> <span class="op">(</span><span class="va">spec</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span></span>
<span>      time_steps <span class="op">=</span> <span class="fl">10</span></span>
<span>    , outputs <span class="op">=</span> <span class="st">"infection"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory_replicate</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;       matrix time row col value</span></span>
<span><span class="co">#&gt; 1  infection    1   0   0     3</span></span>
<span><span class="co">#&gt; 2  infection    2   0   0     2</span></span>
<span><span class="co">#&gt; 3  infection    3   0   0     0</span></span>
<span><span class="co">#&gt; 4  infection    4   0   0     0</span></span>
<span><span class="co">#&gt; 5  infection    5   0   0     0</span></span>
<span><span class="co">#&gt; 6  infection    6   0   0     0</span></span>
<span><span class="co">#&gt; 7  infection    7   0   0     0</span></span>
<span><span class="co">#&gt; 8  infection    8   0   0     0</span></span>
<span><span class="co">#&gt; 9  infection    9   0   0     0</span></span>
<span><span class="co">#&gt; 10 infection   10   0   0     0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;       matrix time row col value</span></span>
<span><span class="co">#&gt; 1  infection    1   0   0     4</span></span>
<span><span class="co">#&gt; 2  infection    2   0   0     3</span></span>
<span><span class="co">#&gt; 3  infection    3   0   0     0</span></span>
<span><span class="co">#&gt; 4  infection    4   0   0     0</span></span>
<span><span class="co">#&gt; 5  infection    5   0   0     0</span></span>
<span><span class="co">#&gt; 6  infection    6   0   0     0</span></span>
<span><span class="co">#&gt; 7  infection    7   0   0     0</span></span>
<span><span class="co">#&gt; 8  infection    8   0   0     0</span></span>
<span><span class="co">#&gt; 9  infection    9   0   0     0</span></span>
<span><span class="co">#&gt; 10 infection   10   0   0     0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt;       matrix time row col value</span></span>
<span><span class="co">#&gt; 1  infection    1   0   0     1</span></span>
<span><span class="co">#&gt; 2  infection    2   0   0     1</span></span>
<span><span class="co">#&gt; 3  infection    3   0   0     2</span></span>
<span><span class="co">#&gt; 4  infection    4   0   0     2</span></span>
<span><span class="co">#&gt; 5  infection    5   0   0     1</span></span>
<span><span class="co">#&gt; 6  infection    6   0   0     1</span></span>
<span><span class="co">#&gt; 7  infection    7   0   0     1</span></span>
<span><span class="co">#&gt; 8  infection    8   0   0     0</span></span>
<span><span class="co">#&gt; 9  infection    9   0   0     0</span></span>
<span><span class="co">#&gt; 10 infection   10   0   0     0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt;       matrix time row col value</span></span>
<span><span class="co">#&gt; 1  infection    1   0   0     2</span></span>
<span><span class="co">#&gt; 2  infection    2   0   0     2</span></span>
<span><span class="co">#&gt; 3  infection    3   0   0     3</span></span>
<span><span class="co">#&gt; 4  infection    4   0   0     3</span></span>
<span><span class="co">#&gt; 5  infection    5   0   0     1</span></span>
<span><span class="co">#&gt; 6  infection    6   0   0     0</span></span>
<span><span class="co">#&gt; 7  infection    7   0   0     0</span></span>
<span><span class="co">#&gt; 8  infection    8   0   0     0</span></span>
<span><span class="co">#&gt; 9  infection    9   0   0     0</span></span>
<span><span class="co">#&gt; 10 infection   10   0   0     0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[5]]</span></span>
<span><span class="co">#&gt;       matrix time row col value</span></span>
<span><span class="co">#&gt; 1  infection    1   0   0     0</span></span>
<span><span class="co">#&gt; 2  infection    2   0   0     0</span></span>
<span><span class="co">#&gt; 3  infection    3   0   0     0</span></span>
<span><span class="co">#&gt; 4  infection    4   0   0     0</span></span>
<span><span class="co">#&gt; 5  infection    5   0   0     0</span></span>
<span><span class="co">#&gt; 6  infection    6   0   0     0</span></span>
<span><span class="co">#&gt; 7  infection    7   0   0     0</span></span>
<span><span class="co">#&gt; 8  infection    8   0   0     0</span></span>
<span><span class="co">#&gt; 9  infection    9   0   0     0</span></span>
<span><span class="co">#&gt; 10 infection   10   0   0     0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[6]]</span></span>
<span><span class="co">#&gt;       matrix time row col value</span></span>
<span><span class="co">#&gt; 1  infection    1   0   0     3</span></span>
<span><span class="co">#&gt; 2  infection    2   0   0     2</span></span>
<span><span class="co">#&gt; 3  infection    3   0   0     0</span></span>
<span><span class="co">#&gt; 4  infection    4   0   0     0</span></span>
<span><span class="co">#&gt; 5  infection    5   0   0     0</span></span>
<span><span class="co">#&gt; 6  infection    6   0   0     0</span></span>
<span><span class="co">#&gt; 7  infection    7   0   0     0</span></span>
<span><span class="co">#&gt; 8  infection    8   0   0     0</span></span>
<span><span class="co">#&gt; 9  infection    9   0   0     0</span></span>
<span><span class="co">#&gt; 10 infection   10   0   0     0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[7]]</span></span>
<span><span class="co">#&gt;       matrix time row col value</span></span>
<span><span class="co">#&gt; 1  infection    1   0   0     3</span></span>
<span><span class="co">#&gt; 2  infection    2   0   0     4</span></span>
<span><span class="co">#&gt; 3  infection    3   0   0     3</span></span>
<span><span class="co">#&gt; 4  infection    4   0   0     0</span></span>
<span><span class="co">#&gt; 5  infection    5   0   0     0</span></span>
<span><span class="co">#&gt; 6  infection    6   0   0     0</span></span>
<span><span class="co">#&gt; 7  infection    7   0   0     0</span></span>
<span><span class="co">#&gt; 8  infection    8   0   0     0</span></span>
<span><span class="co">#&gt; 9  infection    9   0   0     0</span></span>
<span><span class="co">#&gt; 10 infection   10   0   0     0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[8]]</span></span>
<span><span class="co">#&gt;       matrix time row col value</span></span>
<span><span class="co">#&gt; 1  infection    1   0   0     4</span></span>
<span><span class="co">#&gt; 2  infection    2   0   0     0</span></span>
<span><span class="co">#&gt; 3  infection    3   0   0     0</span></span>
<span><span class="co">#&gt; 4  infection    4   0   0     0</span></span>
<span><span class="co">#&gt; 5  infection    5   0   0     0</span></span>
<span><span class="co">#&gt; 6  infection    6   0   0     0</span></span>
<span><span class="co">#&gt; 7  infection    7   0   0     0</span></span>
<span><span class="co">#&gt; 8  infection    8   0   0     0</span></span>
<span><span class="co">#&gt; 9  infection    9   0   0     0</span></span>
<span><span class="co">#&gt; 10 infection   10   0   0     0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[9]]</span></span>
<span><span class="co">#&gt;       matrix time row col value</span></span>
<span><span class="co">#&gt; 1  infection    1   0   0     6</span></span>
<span><span class="co">#&gt; 2  infection    2   0   0     2</span></span>
<span><span class="co">#&gt; 3  infection    3   0   0     1</span></span>
<span><span class="co">#&gt; 4  infection    4   0   0     1</span></span>
<span><span class="co">#&gt; 5  infection    5   0   0     0</span></span>
<span><span class="co">#&gt; 6  infection    6   0   0     0</span></span>
<span><span class="co">#&gt; 7  infection    7   0   0     0</span></span>
<span><span class="co">#&gt; 8  infection    8   0   0     0</span></span>
<span><span class="co">#&gt; 9  infection    9   0   0     0</span></span>
<span><span class="co">#&gt; 10 infection   10   0   0     0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[10]]</span></span>
<span><span class="co">#&gt;       matrix time row col value</span></span>
<span><span class="co">#&gt; 1  infection    1   0   0     3</span></span>
<span><span class="co">#&gt; 2  infection    2   0   0     3</span></span>
<span><span class="co">#&gt; 3  infection    3   0   0     1</span></span>
<span><span class="co">#&gt; 4  infection    4   0   0     1</span></span>
<span><span class="co">#&gt; 5  infection    5   0   0     1</span></span>
<span><span class="co">#&gt; 6  infection    6   0   0     0</span></span>
<span><span class="co">#&gt; 7  infection    7   0   0     0</span></span>
<span><span class="co">#&gt; 8  infection    8   0   0     0</span></span>
<span><span class="co">#&gt; 9  infection    9   0   0     0</span></span>
<span><span class="co">#&gt; 10 infection   10   0   0     0</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">proc_err</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">spec</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_model_spec.html">mp_tmb_model_spec</a></span><span class="op">(</span></span>
<span>    before <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">S</span> <span class="op">~</span> <span class="va">N</span> <span class="op">-</span> <span class="va">I</span> <span class="op">-</span> <span class="va">R</span><span class="op">)</span></span>
<span>  , during <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        <span class="va">mean_foi</span> <span class="op">~</span> <span class="va">beta</span> <span class="op">*</span> <span class="va">I</span> <span class="op">/</span> <span class="va">N</span></span>
<span>      , <span class="va">mean_infection</span> <span class="op">~</span> <span class="va">mean_foi</span> <span class="op">*</span> <span class="va">S</span></span>
<span>      , <span class="va">dev_foi</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="va">proc_err</span><span class="op">[</span><span class="fu"><a href="../reference/engine_functions.html">time_step</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>      , <span class="fu"><a href="../reference/mp_per_capita_flow.html">mp_per_capita_flow</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"dev_foi * mean_foi"</span>, <span class="st">"infection"</span><span class="op">)</span></span>
<span>      , <span class="fu"><a href="../reference/mp_per_capita_flow.html">mp_per_capita_flow</a></span><span class="op">(</span><span class="st">"I"</span>, <span class="st">"R"</span>, <span class="st">"gamma"</span>, <span class="st">"recovery"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        N <span class="op">=</span> <span class="va">N</span></span>
<span>      , R <span class="op">=</span> <span class="fl">0</span></span>
<span>      , I <span class="op">=</span> <span class="fl">1</span></span>
<span>      , beta <span class="op">=</span> <span class="fl">0.4</span></span>
<span>      , gamma <span class="op">=</span> <span class="fl">0.2</span></span>
<span>      , proc_err <span class="op">=</span> <span class="va">proc_err</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sim</span> <span class="op">=</span> <span class="op">(</span><span class="va">spec</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/state_updates.html">mp_hazard</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span></span>
<span>      time_steps <span class="op">=</span> <span class="fl">50</span></span>
<span>    , outputs <span class="op">=</span> <span class="st">"infection"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sim_infection</span> <span class="op">=</span> <span class="op">(</span><span class="va">sim</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>value <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rpois</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fixef</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    beta <span class="op">=</span> <span class="fu"><a href="../reference/distribution.html">mp_lnorm</a></span><span class="op">(</span>location <span class="op">=</span> <span class="fl">0.2</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  , gamma <span class="op">=</span> <span class="fu"><a href="../reference/distribution.html">mp_lnorm</a></span><span class="op">(</span>location <span class="op">=</span> <span class="fl">0.2</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">ranef</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="co">#proc_err = mp_norm(location = 0, sd = 0.1)</span></span>
<span><span class="co">#)</span></span>
<span><span class="va">cal</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_calibrator.html">mp_tmb_calibrator</a></span><span class="op">(</span></span>
<span>    spec <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_insert.html">mp_tmb_update</a></span><span class="op">(</span><span class="va">spec</span>, default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.2</span>, proc_err <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  , data <span class="op">=</span> <span class="va">sim_infection</span></span>
<span>  , traj <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>infection <span class="op">=</span> <span class="fu"><a href="../reference/distribution.html">mp_nbinom</a></span><span class="op">(</span>disp <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  , par <span class="op">=</span> <span class="va">fixef</span> <span class="co"># mp_par(param = fixef, random = ranef)</span></span>
<span>  , outputs <span class="op">=</span> <span class="st">"mean_infection"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/mp_optimize.html">mp_optimize</a></span><span class="op">(</span><span class="va">cal</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in (function (start, objective, gradient = NULL, hessian = NULL, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;    params    params </span></span>
<span><span class="co">#&gt; 0.5811725 0.2381576 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 215.4921</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       13       11 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "relative convergence (4)"</span></span>
<span><span class="fu"><a href="../reference/mp_tmb_coef.html">mp_tmb_coef</a></span><span class="op">(</span><span class="va">cal</span><span class="op">)</span></span>
<span><span class="co">#&gt;       term   mat row col default  type  estimate  std.error</span></span>
<span><span class="co">#&gt; 1   params  beta   0   0     0.2 fixed 0.5811725 0.03470795</span></span>
<span><span class="co">#&gt; 2 params.1 gamma   0   0     0.2 fixed 0.2381576 0.04467113</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_infection</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="va">cal</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">sim_infection</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span>, colour <span class="op">=</span> <span class="va">matrix</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">fit_infection</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="FAQs_files/figure-html/unnamed-chunk-12-1.png" width="576"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Walker, Weiguang Guan, Jen Freeman, Ben Bolker, Darren Flynn-Primrose.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
