<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="macpan2">
<title>Standard Expressions • macpan2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Standard Expressions">
<meta property="og:description" content="macpan2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/quickstart.html">Quickstart</a>
    <a class="dropdown-item" href="../articles/example_models.html">Example Models</a>
    <a class="dropdown-item" href="../articles/time_varying_parameters.html">Specifying Time-Varying Parameters</a>
    <a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a>
    <a class="dropdown-item" href="../articles/engine_agnostic_grammar.html">Engine-Agnostic Model Specification Grammar</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Standard Expressions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/HEAD/vignettes/standard_expressions.rmd" class="external-link"><code>vignettes/standard_expressions.rmd</code></a></small>
      <div class="d-none name"><code>standard_expressions.rmd</code></div>
    </div>

    
    
<p><a href="https://canmod.github.io/macpan2/articles/vignette-status#working-draft"><img src="https://img.shields.io/badge/status-working%20draft-red" alt="status"></a></p>
<p>Macpan2 separates model expressions into two types; user expressions
which vary from model to model and standard expressions which are common
across all models that employ the same numerical method (e.g. Euler
steps). User expressions are typically evaluated in the
<code>during_pre_update</code> simulation phase although some may be
evaluated in the <code>before</code> simulation phase (if the output
does not vary with time). Standard expressions are evaluated in the
<code>during_update</code> simulation phase and are used to update the
state vector for the next time step.</p>
<p>state: A vector with the population of each compartment. The purpose
of the <code>during_update</code> simulation phase is to update this
vector in accordance with the user supplied expressions detailing the
flows between compartments.</p>
<p>total_inflow: A vector with the total inflow to each compartment.
This is computed by summing the effects of <code>per_capita</code>,
<code>absolute</code>, <code>per_capita_inflow</code> and
<code>absolute_inflow</code> type flows.</p>
<p>total_outflow: A vector with the total outflow from each compartment.
This is computed by summing the effects of <code>per_capita</code>,
<code>absolute</code>, <code>per_capita_outflow</code> and
<code>absolute_outflow</code> type flows.</p>
<p>So the final step of the <code>during_update</code> simulation phase
is simply</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state</span> <span class="op">=</span> <span class="va">state</span> <span class="op">+</span> <span class="va">total_inflow</span> <span class="op">-</span> <span class="va">total_outflow</span></span></code></pre></div>
<p>Computing <code>total_inflow</code> and <code>total_outflow</code> is
more complicated. We use as an example <code>total_inflow</code> the
procedure for <code>total_outflow</code> is fundamentally the same.
There are two primary challenges to overcome:</p>
<ol style="list-style-type: decimal">
<li><p>Each of the flow types may or may not be present in a given
model</p></li>
<li><p>There may be multiple flows of the same type to any given
compartment.</p></li>
</ol>
<p>Another key point to keep in mind is that per_capita flows are
specified as a rate that needs to be multiplied by the population of
their from compartment whereas absolute flows do not.</p>
<p>After the <code>during_pre_update</code> simulation phase we are
guaranteed to have two vectors <code>state</code> and <code>flow</code>.
<code>flow</code> in particular will have been generated during the
previous simulation phases using whatever expressions where supplied by
the user. We also have, for each flow type, vectors specifying which
elements of <code>flow</code> are of that flow type and, where
applicable, which elements of <code>state</code> correspond to the
<code>from</code> and <code>to</code> compartments of the flows in
<code>flow</code>. These vectors are denoted with the suffix
<code>_flow</code>, <code>_from</code> and <code>_to</code>
respectively. So for example <code>per_capita_flow</code> specifiec
which elements of <code>flow</code> are per_capita,
<code>per_capita_from</code> specifies which elements of
<code>state</code> are from compartments for per capita flows, and
<code>per_capita_to</code> specifies which elements of
<code>state</code> are to compartments for per_capita flows. thus we can
write</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">per_capita</span> <span class="op">=</span> <span class="va">state</span><span class="op">[</span><span class="va">per_capita_from</span><span class="op">]</span><span class="op">*</span><span class="va">flow</span><span class="op">[</span><span class="va">per_capita_flow</span><span class="op">]</span></span>
<span><span class="va">per_capita_inflow</span> <span class="op">=</span> <span class="va">state</span><span class="op">[</span><span class="va">per_capita_inflow_from</span><span class="op">]</span><span class="op">*</span><span class="va">flow</span><span class="op">[</span><span class="va">per_capita_inflow_flow</span><span class="op">]</span></span>
<span><span class="va">absolute</span> <span class="op">=</span> <span class="va">flow</span><span class="op">[</span><span class="va">absolute_flow</span><span class="op">]</span></span>
<span><span class="va">absolute_inflow</span> <span class="op">=</span> <span class="va">flow</span><span class="op">[</span><span class="va">absolute_inflow_flow</span><span class="op">]</span></span></code></pre></div>
<p>We then create a vector which sums all inflows of a single type that
have the same <code>to</code> compartment.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>    <span class="va">total_inflow_expression_vct</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"groupSums(per_capita, per_capita_to, state_length)"</span>,</span>
<span>      <span class="st">"groupSums(absolute, absolute_to, state_length)"</span>,</span>
<span>      <span class="st">"groupSums(per_capita_inflow, per_capita_inflow_to, state_length)"</span>,</span>
<span>      <span class="st">"groupSums(absolute_inflow, absolute_inflow_to, state_length)"</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<p>The total inflow can than be calculated with the expression</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">total_inflow</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">total_inflow_expression_vct</span><span class="op">[</span><span class="va">present_inflows</span><span class="op">]</span>, collapse <span class="op">=</span> <span class="st">"+"</span><span class="op">)</span></span></code></pre></div>
<p>Where <code>present_inflows</code> is a vector which communicates
which of the four inflow types are actually being used in the specific
model at hand.</p>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Steve Walker, Weiguang Guan, Ben Bolker, Jen Freeman, Darren Flynn-Primrose.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
