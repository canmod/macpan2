<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Advanced Specification of Time-Varying Parameters • macpan2</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced Specification of Time-Varying Parameters">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-7zkQWkzuo3B5mTepMUcHkMB5jZaolc2xDwL6VFqjFALcbeS9Ggm/Yr2r3Dy4lfFg" crossorigin="anonymous"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">macpan2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/quickstart.html">Quickstart</a></li>
    <li><a class="dropdown-item" href="../articles/example_models.html">Example Models</a></li>
    <li><a class="dropdown-item" href="../articles/calibration.html">Calibrating Compartmental Models to Data</a></li>
    <li><a class="dropdown-item" href="../articles/real_data.html">Fitting to Real Data</a></li>
    <li><a class="dropdown-item" href="../articles/state_updaters.html">ODE Solvers, Process Error, and Difference Equations</a></li>
    <li><a class="dropdown-item" href="../articles/options.html">Options</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/canmod/macpan2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Advanced Specification of Time-Varying Parameters</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/canmod/macpan2/blob/main/vignettes/time_varying_parameters_advanced.Rmd" class="external-link"><code>vignettes/time_varying_parameters_advanced.Rmd</code></a></small>
      <div class="d-none name"><code>time_varying_parameters_advanced.Rmd</code></div>
    </div>

    
    
<p><a href="https://canmod.github.io/macpan2/articles/vignette-status#working-draft"><img src="https://img.shields.io/badge/status-working%20draft-red" alt="status"></a></p>
<div class="section level2">
<h2 id="baseline-sir-model">Baseline SIR Model<a class="anchor" aria-label="anchor" href="#baseline-sir-model"></a>
</h2>
<p>Here we modify an <a href="https://github.com/canmod/macpan2/tree/main/inst/starter_models/sir" class="external-link">SIR</a>
model so that transmission rate is time-varying.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">state_labels</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span><span class="op">)</span></span>
<span><span class="va">simulator</span> <span class="op">=</span> <span class="op">(</span><span class="st">"starter_models"</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_tmb_library.html">mp_tmb_library</a></span><span class="op">(</span><span class="st">"sir"</span>, package <span class="op">=</span> <span class="st">"macpan2"</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span>time_steps <span class="op">=</span> <span class="fl">50</span></span>
<span>    , outputs <span class="op">=</span> <span class="va">state_labels</span></span>
<span>    , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fl">0.8</span>, gamma <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">simulator</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">matrix</span>, <span class="va">state_labels</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> </span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span>, colour <span class="op">=</span> <span class="va">state</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_advanced_files/figure-html/baseline_sir-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="piecewise-time-variation">Piecewise Time Variation<a class="anchor" aria-label="anchor" href="#piecewise-time-variation"></a>
</h2>
<p>We now change the value of the transmission rate, <code>beta</code>,
at the beginning of time-step 10 and 15. In the first step we add to the
simulator a vector containing these change-points.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span>beta_changepoints <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">15</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next we add the values to which <code>beta</code> changes at these
time-steps.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span>beta_values <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.01</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We also need a variable to track the current value of
<code>beta</code>. This <code>beta_pointer</code> starts at time-step
equal to 0, and it will be incremented throughout the simulation.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span>beta_pointer <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>We increment <code>beta_pointer</code> using the <a href="https://canmod.github.io/macpan2/reference/engine_functions.html#time-indexing"><code>time_group</code>
function</a> that returns either <code>beta_pointer</code> or
<code>beta_pointer + 1</code> depending on whether or not the current
time-step is at a change-point in <code>beta_changepoints</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">beta_pointer</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">time_group</a></span><span class="op">(</span><span class="va">beta_pointer</span>, <span class="va">beta_changepoints</span><span class="op">)</span>, </span>
<span>    .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We update <code>beta</code> at every iteration of the simulation loop
using this <code>beta_pointer</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>  <span class="va">beta</span> <span class="op">~</span> <span class="va">beta_values</span><span class="op">[</span><span class="va">beta_pointer</span><span class="op">]</span>,</span>
<span>  .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we plot the updated simulations using these change-points, which
we highlight with vertical lines.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">)</span></span>
<span><span class="va">cp</span> <span class="op">=</span> <span class="va">simulator</span><span class="op">$</span><span class="va">get</span><span class="op">$</span><span class="fu">initial</span><span class="op">(</span><span class="st">"beta_changepoints"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">s</span></span>
<span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">matrix</span>, <span class="va">state_labels</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span>, colour <span class="op">=</span> <span class="va">state</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">x</span><span class="op">)</span>, </span>
<span>    linetype <span class="op">=</span> <span class="st">"dashed"</span>, </span>
<span>    alpha <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cp</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_advanced_files/figure-html/time_varying_graph-1.png" width="576"></p>
<p>The clear kinks at times 10 and 15 are due the drop and then lift of
the transmission rate at these times.</p>
</div>
<div class="section level2">
<h2 id="calibrating-time-variation-parameters">Calibrating Time Variation Parameters<a class="anchor" aria-label="anchor" href="#calibrating-time-variation-parameters"></a>
</h2>
<p>First we simulate data to fit our model to, to see if we can recover
the time-varying parameters.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">I_observed</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rpois</a></span><span class="op">(</span><span class="fl">50</span></span>
<span>  , <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">s</span>, <span class="va">matrix</span> <span class="op">==</span> <span class="st">"I"</span><span class="op">)</span><span class="op">$</span><span class="va">value</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">I_observed</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_advanced_files/figure-html/noisy_data-1.png" width="576"></p>
<p>Then we add a few matrices to the model for keeping tracking of
information used in model fitting.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">update</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span></span>
<span>  </span>
<span>  <span class="co">## observed data</span></span>
<span>  I_obs <span class="op">=</span> <span class="va">I_observed</span>,</span>
<span>  </span>
<span>  <span class="co">## simulated trajectory to compare with data</span></span>
<span>  I_sim <span class="op">=</span> <span class="va">empty_matrix</span>, </span>
<span>  </span>
<span>  <span class="co">## location of I in the state vector</span></span>
<span>  <span class="co">## (the `-1L` bit is to get 0-based indices instead of 1-based)</span></span>
<span>  I_index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="st">"I"</span>, <span class="va">state_labels</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1L</span>, </span>
<span>  </span>
<span>  <span class="co">## matrix to contain the log likelihood values at </span></span>
<span>  <span class="co">## each time step</span></span>
<span>  log_lik <span class="op">=</span> <span class="va">empty_matrix</span>, </span>
<span>  </span>
<span>  <span class="co">## need to save the simulation history of each of these matrices</span></span>
<span>  .mats_to_save <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"I_sim"</span>, <span class="st">"log_lik"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we need some new expressions. The first expression pulls out the
I state from the state vector.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>  <span class="va">I_sim</span> <span class="op">~</span> <span class="va">I</span>,</span>
<span>  .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The second expression computes a vector of Poisson log-likelihood
values – one for each time step.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>  <span class="va">log_lik</span> <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">dpois</a></span><span class="op">(</span><span class="va">I_obs</span>, <span class="fu"><a href="../reference/engine_functions.html">clamp</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">rbind_time</a></span><span class="op">(</span><span class="va">I_sim</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  .phase <span class="op">=</span> <span class="st">"after"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">obj_fn</span><span class="op">(</span><span class="op">~</span> <span class="op">-</span><span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="va">log_lik</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next we declare the beta values as parameters to be optimized on the
log scale. The clearest way to do this is to form a data frame with one
row for each parameter to be fitted.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">default_beta</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">mean</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="va">get</span><span class="op">$</span><span class="fu">initial</span><span class="op">(</span><span class="st">"beta_values"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">params_to_fit</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    mat <span class="op">=</span> <span class="st">"log_beta_values"</span></span>
<span>  , row <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">2</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">log</a></span><span class="op">(</span><span class="va">default_beta</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">params_to_fit</span><span class="op">)</span></span>
<span><span class="co">#&gt;               mat row    default</span></span>
<span><span class="co">#&gt; 1 log_beta_values   0 -0.9079919</span></span>
<span><span class="co">#&gt; 2 log_beta_values   1 -0.9079919</span></span>
<span><span class="co">#&gt; 3 log_beta_values   2 -0.9079919</span></span></code></pre></div>
<p>There are a couple potentially confusing aspects to this data frame.
First, we want to fit the <code>beta</code> values on the log scale, and
we indicate this by prepending <code>log_</code> in front of the name of
the <code>beta_values</code> matrix that is in the model. We will more
explicitly add the <code>log_beta_values</code> matrix to the model in
the next code chunk. Second, the word <code>row</code> corresponds to an
index for the change points. In particular, <code>row = 0</code>
corresponds to the initial <code>beta</code>, <code>row = 1</code> to
the first change point and <code>row = 2</code> to the second. This is
because all quantities passed to <code>macpan2</code> engines are
matrices, and so in this case different rows of this
<code>log_beta_values</code> matrix (actually column vector) correspond
to different change points. If we were dealing with matrices with more
than one column we would need to include a <code>col</code> column in
this data frame to indicate the matrix columns of the matrix entries
that correspond to parameters to be fitted.</p>
<p>Now we log transform the <code>beta_values</code> matrix entries and
declare them as parameters.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">transformations</span><span class="op">(</span><span class="fu"><a href="../reference/Transform.html">Log</a></span><span class="op">(</span><span class="st">"beta_values"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">params_frame</span><span class="op">(</span><span class="va">params_to_fit</span><span class="op">)</span></span></code></pre></div>
<p>Finally we fit the model back to the simulation data.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">optimize</span><span class="op">$</span><span class="fu">nlminb</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; outer mgc:  736.1414 </span></span>
<span><span class="co">#&gt; outer mgc:  112.6655 </span></span>
<span><span class="co">#&gt; outer mgc:  71.38648 </span></span>
<span><span class="co">#&gt; outer mgc:  13.6616 </span></span>
<span><span class="co">#&gt; outer mgc:  12.58091 </span></span>
<span><span class="co">#&gt; outer mgc:  3.638083 </span></span>
<span><span class="co">#&gt; outer mgc:  1.399513 </span></span>
<span><span class="co">#&gt; outer mgc:  1.609453 </span></span>
<span><span class="co">#&gt; outer mgc:  1.140347 </span></span>
<span><span class="co">#&gt; outer mgc:  0.5870909 </span></span>
<span><span class="co">#&gt; outer mgc:  0.2527136 </span></span>
<span><span class="co">#&gt; outer mgc:  0.09938628 </span></span>
<span><span class="co">#&gt; outer mgc:  0.03753935 </span></span>
<span><span class="co">#&gt; outer mgc:  0.01394885 </span></span>
<span><span class="co">#&gt; outer mgc:  0.005150654 </span></span>
<span><span class="co">#&gt; outer mgc:  0.001897432 </span></span>
<span><span class="co">#&gt; outer mgc:  0.0006983805 </span></span>
<span><span class="co">#&gt; outer mgc:  0.0002569678 </span></span>
<span><span class="co">#&gt; outer mgc:  9.453969e-05 </span></span>
<span><span class="co">#&gt; outer mgc:  3.478009e-05 </span></span>
<span><span class="co">#&gt; outer mgc:  1.2795e-05 </span></span>
<span><span class="co">#&gt; outer mgc:  4.707033e-06 </span></span>
<span><span class="co">#&gt; outer mgc:  1.731622e-06 </span></span>
<span><span class="co">#&gt; outer mgc:  6.370289e-07 </span></span>
<span><span class="co">#&gt; outer mgc:  2.343497e-07 </span></span>
<span><span class="co">#&gt; outer mgc:  8.62125e-08 </span></span>
<span><span class="co">#&gt; outer mgc:  3.171603e-08</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt;      params      params      params </span></span>
<span><span class="co">#&gt;  -0.1710158 -22.8268369  -0.8291142 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $objective</span></span>
<span><span class="co">#&gt; [1] 99.74231</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $iterations</span></span>
<span><span class="co">#&gt; [1] 26</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $evaluations</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       28       27 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "relative convergence (4)"</span></span></code></pre></div>
<p>We can see that the optimizer converges
(i.e. <code>$convergence = 0</code>) in 26 iterations.</p>
<p>On the log scale we see that the optimizer finds different values
(<code>current</code>) than it started at (<code>default</code>).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">current</span><span class="op">$</span><span class="fu">params_frame</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;   par_id             mat row col    default     current</span></span>
<span><span class="co">#&gt; 1      0 log_beta_values   0   0 -0.9079919  -0.1710158</span></span>
<span><span class="co">#&gt; 2      1 log_beta_values   1   0 -0.9079919 -22.8268369</span></span>
<span><span class="co">#&gt; 3      2 log_beta_values   2   0 -0.9079919  -0.8291142</span></span></code></pre></div>
<p>More importantly the beta values on the untransformed scale recover
reasonable values that are qualitatively consistent with the values used
in the simulations.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  fitted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/formatc.html" class="external-link">formatC</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="va">current</span><span class="op">$</span><span class="fu">params_frame</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">current</span><span class="op">)</span>,</span>
<span>    format <span class="op">=</span> <span class="st">"e"</span>, digits <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span>,</span>
<span>  true <span class="op">=</span> <span class="va">simulator</span><span class="op">$</span><span class="va">get</span><span class="op">$</span><span class="fu">initial</span><span class="op">(</span><span class="st">"beta_values"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     fitted true</span></span>
<span><span class="co">#&gt; 1 8.43e-01 0.80</span></span>
<span><span class="co">#&gt; 2 1.22e-10 0.01</span></span>
<span><span class="co">#&gt; 3 4.36e-01 0.40</span></span></code></pre></div>
<p>Note however that the second fitted beta value is much smaller than
the true value, which is potentially interesting.</p>
</div>
<div class="section level2">
<h2 id="radial-basis-functions-for-flexible-time-variation-in-progress">Radial Basis Functions for Flexible Time Variation
(In-Progress)<a class="anchor" aria-label="anchor" href="#radial-basis-functions-for-flexible-time-variation-in-progress"></a>
</h2>
<p>This section uses radial basis functions (RBFs) to generate models
with a flexible functional form for smooth changes in the transmission
rate.</p>
<p>Before we can add the fancy radial basis for the transmission rate,
we need a base model. We use an SIR model that has been modified to
include waning.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sir</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_tmb_library.html">mp_tmb_library</a></span><span class="op">(</span><span class="st">"starter_models"</span></span>
<span>  , <span class="st">"sir_waning"</span></span>
<span>  , package <span class="op">=</span> <span class="st">"macpan2"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/rbf.html">macpan2::rbf</a></code> function can be used to produce a
matrix giving the values of each basis function (each column) at each
time step (each row). Using this matrix,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>,
and a weights vector,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>,
we can get a flexible output vector,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>y</mi><annotation encoding="application/x-tex">y</annotation></semantics></math>,
with a shape that can be modified by changing the weights vector.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><mi>X</mi><mi>b</mi></mrow><annotation encoding="application/x-tex">
y = Xb
</annotation></semantics></math></p>
<p>The following code illustrates this approach.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">d</span> <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="va">n</span> <span class="op">=</span> <span class="fl">2500</span></span>
<span><span class="va">X</span> <span class="op">=</span> <span class="fu"><a href="../reference/rbf.html">rbf</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="va">d</span>, sd <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  , mar <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span><span class="va">X</span></span>
<span>  , type <span class="op">=</span> <span class="st">"l"</span>, lty <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="fl">1</span></span>
<span>  , ylab <span class="op">=</span> <span class="st">"basis functions"</span></span>
<span>  , axes <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/axis.html" class="external-link">axis</a></span><span class="op">(</span>side <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/box.html" class="external-link">box</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">b</span></span>
<span>  , xlab <span class="op">=</span> <span class="st">""</span></span>
<span>  , ylab <span class="op">=</span> <span class="st">"weights"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b</span></span>
<span>  , type <span class="op">=</span> <span class="st">"l"</span></span>
<span>  , xlab <span class="op">=</span> <span class="st">"time"</span></span>
<span>  , ylab <span class="op">=</span> <span class="st">"output"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_advanced_files/figure-html/unnamed-chunk-2-1.png" width="576"></p>
<p>Here <code>d</code> is the dimension of the basis, or number of
functions, and <code>n</code> is the number of time steps. By
multiplying the uniform basis matrix (top panel) by a set of weights
(middle panel), we obtain a non-uniform curve (bottom panel). Note how
the peaks (troughs) in the output are associated with large positive
(negative) weights.</p>
<p>Now we want to transform the output of the (matrix) product of the
RBF matrix and the weights vector into a time-series for the
transmission rate,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>.
Although we could just use the output vector as the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
time series, it is more convenient to transform it so that the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
values yield more interesting dynamics in an SIR model. In particular,
our model for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>β</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\beta_t</annotation></semantics></math>
as a function of time,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>,
is</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>β</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>γ</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>N</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mo>log</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>S</mi><mi>t</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>x</mi><mi>t</mi></msub><mi>b</mi></mrow><annotation encoding="application/x-tex">
\log(\beta_t) = \log(\gamma_t) + \log(N) - \log(S_t) + x_tb
</annotation></semantics></math></p>
<p>Here we have the recovery rate,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>γ</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\gamma_t</annotation></semantics></math>,
and number of susceptibles,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>S</mi><mi>t</mi></msub><annotation encoding="application/x-tex">S_t</annotation></semantics></math>,
at time,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>,
the total population,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>,
and the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>th
row of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mi>t</mi></msub><annotation encoding="application/x-tex">x_t</annotation></semantics></math>.
To better understand the rationale for this equation note that if every
element of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>
is set to zero, we have the following condition.</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><msub><mi>β</mi><mi>t</mi></msub><msub><mi>S</mi><mi>t</mi></msub></mrow><mi>N</mi></mfrac><mo>=</mo><msub><mi>γ</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">
\frac{\beta_t S_t}{N} = \gamma_t
</annotation></semantics></math></p>
<p>This condition assures that the number of infected individuals
remains constant at time,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>.
This means that positive values of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>
will tend to generate outbreaks and negative values will tend to reduce
transmission.</p>
<p><strong>fixme</strong>: I (BMB) understand why you’re setting the
model up this way, but it’s an odd/non-standard setup - may confuse
people who are already familiar with epidemic models (it confused me
initially).</p>
<p>Here is a simulation model with a radial basis for exogenous
transmission rate dynamics.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span></span>
<span><span class="va">simulator</span> <span class="op">=</span> <span class="fu"><a href="../reference/mp_simulator.html">mp_simulator</a></span><span class="op">(</span><span class="va">sir</span></span>
<span>  , time_steps <span class="op">=</span> <span class="va">n</span></span>
<span>  , outputs <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"S"</span>, <span class="st">"I"</span>, <span class="st">"R"</span>, <span class="st">"infection"</span>, <span class="st">"beta"</span><span class="op">)</span></span>
<span>  , default <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      N <span class="op">=</span> <span class="fl">100000</span>, I <span class="op">=</span> <span class="fl">500</span>, R <span class="op">=</span> <span class="fl">0</span></span>
<span>    , beta <span class="op">=</span> <span class="fl">1</span>, gamma <span class="op">=</span> <span class="fl">0.2</span>, phi <span class="op">=</span> <span class="fl">0.01</span></span>
<span>    , X <span class="op">=</span> <span class="fu"><a href="../reference/rbf.html">rbf</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">d</span><span class="op">)</span></span>
<span>    , b <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="va">d</span>, sd <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">eta</span> <span class="op">~</span> <span class="va">gamma</span> <span class="op">*</span> <span class="fu"><a href="../reference/engine_functions.html">exp</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">b</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"before"</span></span>
<span>  , .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>    <span class="va">beta</span> <span class="op">~</span> <span class="va">eta</span><span class="op">[</span><span class="fu"><a href="../reference/engine_functions.html">time_step</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">]</span> <span class="op">/</span> <span class="fu"><a href="../reference/engine_functions.html">clamp</a></span><span class="op">(</span><span class="va">S</span><span class="op">/</span><span class="va">N</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">100</span><span class="op">)</span></span>
<span>  , .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span>  , .at <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span></span>
<span>    eta <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">params</span><span class="op">(</span></span>
<span>    default <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="va">d</span>, sd <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span>  , mat <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">rep</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="va">d</span><span class="op">)</span></span>
<span>  , row <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1L</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/engine_functions.html">print</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">)</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; Before the simulation loop (t = 0):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: S ~ N - I - R</span></span>
<span><span class="co">#&gt; 2: eta ~ gamma * exp(X %*% b)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; At every iteration of the simulation loop (t = 1 to 2500):</span></span>
<span><span class="co">#&gt; ---------------------</span></span>
<span><span class="co">#&gt; 1: beta ~ eta[time_step(1)]/clamp(S/N, 1/100)</span></span>
<span><span class="co">#&gt; 2: infection ~ S * (I * beta/N)</span></span>
<span><span class="co">#&gt; 3: recovery ~ I * (gamma)</span></span>
<span><span class="co">#&gt; 4: waning_immunity ~ R * (phi)</span></span>
<span><span class="co">#&gt; 5: S ~ S - infection + waning_immunity</span></span>
<span><span class="co">#&gt; 6: I ~ I + infection - recovery</span></span>
<span><span class="co">#&gt; 7: R ~ R + recovery - waning_immunity</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">simulator</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span>
<span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span></span>
<span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">matrix</span>, ncol <span class="op">=</span> <span class="fl">1</span>, scales <span class="op">=</span> <span class="st">'free'</span><span class="op">)</span></span>
<span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_advanced_files/figure-html/plot_rbf-1.png" width="576"></p>
<div class="section level3">
<h3 id="calibration">Calibration<a class="anchor" aria-label="anchor" href="#calibration"></a>
</h3>
<p>Now we’re going to calibrate this model to data. The main innovation
here is that we will use a built-in feature of <a href="https://cran.r-project.org/package=TMB" class="external-link">TMB</a> (on which
<code>macpan2</code> is constructed), estimation of latent variables by
<a href="https://en.wikipedia.org/wiki/Laplace%27s_approximation" class="external-link">Laplace
approximation</a> to fit the time series efficiently without overfitting
(see section 5.10 of <span class="citation">Madsen and Thyregod
(2011)</span>, <span class="citation">Kristensen et al. (2016)</span>,
or the <a href="https://kaskr.github.io/adcomp/_book/Tutorial.html#statistical-modelling" class="external-link">TMB
documentation</a> for more detail).</p>
<p>The next few steps will roughly follow the first example in the <a href="./calibration.html">Calibration</a> vignette: TODO: make sure to
line this state up with the specific code in the calibration
vignette.</p>
<p>1. Simulate from the model and add some noise:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">obs_I</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">simulator</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span> <span class="op">==</span> <span class="st">"I"</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="va">value</span>, <span class="op">~</span> <span class="fu"><a href="../reference/engine_functions.html">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">.</span>, sd <span class="op">=</span> <span class="fl">50</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">obs_I</span>, xlab <span class="op">=</span> <span class="st">"time"</span>, ylab <span class="op">=</span> <span class="st">"prevalence"</span><span class="op">)</span></span></code></pre></div>
<p><img src="time_varying_parameters_advanced_files/figure-html/noisy_sim-1.png" width="576"></p>
<p>2. Add calibration information.</p>
<p>We start by adding standard boilerplate stuff to include the observed
data and store/return the results.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## copied from 'calibration/"hello world"' example</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span></span>
<span>    I_obs <span class="op">=</span> <span class="va">obs_I</span></span>
<span>  , I_sim <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>  , log_lik <span class="op">=</span> <span class="va">empty_matrix</span></span>
<span>  , .mats_to_save <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"I_sim"</span><span class="op">)</span></span>
<span>  , .mats_to_return <span class="op">=</span> <span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="st">"I_sim"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>     <span class="va">I_sim</span> <span class="op">~</span> <span class="va">I</span></span>
<span>   , .phase <span class="op">=</span> <span class="st">"during"</span></span>
<span>   , .at <span class="op">=</span> <span class="cn">Inf</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now we start to deviate from the previous example: in addition to a
parameter (<code>I_sd</code>) for the standard deviation of the noise in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>,
we also add a parameter (<code>rbf_sd</code>) for the variance of the
RBF coefficients, and penalize the likelihood using</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>I</mi><mtext mathvariant="normal">obs</mtext></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mtext mathvariant="normal">Normal</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>I</mi><mtext mathvariant="normal">sim</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>ϕ</mi><mo>,</mo><mi>𝐛</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><msubsup><mi>σ</mi><mi>I</mi><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>b</mi><mi>i</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>∼</mo><mtext mathvariant="normal">Normal</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><msubsup><mi>σ</mi><mtext mathvariant="normal">rbf</mtext><mn>2</mn></msubsup><mo stretchy="true" form="postfix">)</mo></mrow></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{split}
I_{\textrm{obs}} &amp; \sim \textrm{Normal}(I_\textrm{sim}(\phi, {\mathbf b}), \sigma^2_I) \\
b_i &amp; \sim \textrm{Normal}(0, \sigma^2_{\textrm{rbf}})
\end{split}
</annotation></semantics></math> and the likelihood is defined as: <span class="math display">$$
\int {\cal L}(I_{\textrm{obs}}|\phi, {\mathbf b}', \sigma^2_I) \cdot
{\cal L}({\mathbf b}'|\sigma^2_{\textrm{rbf}}) \, d{\mathbf b}.
$$</span></p>
<p>The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ϕ</mi><annotation encoding="application/x-tex">\phi</annotation></semantics></math>
vector is a set of <em>fixed-effect</em> (unpenalized) parameters; in
this case it is empty, but it could include (for example) time-constant
recovery or immune-waning rates, or a baseline transmission rate (see
note below). (The fixed-effect parameter is usually denoted as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>β</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
in statistical models, but we’ve already used that symbol for the
transmission coefficient …)</p>
<p>Although this looks awful, (1) the high-dimensional integral over
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>𝐛</mi><annotation encoding="application/x-tex">\mathbf b</annotation></semantics></math>
can be separated into a product of one-dimensional integrals and (2) the
Laplace approximation gives us a quick, reasonable approximation to the
one-dimensional integrals.</p>
<p>The <code>rbf_sd</code> parameter can be interpreted as a standard
deviation on a Gaussian random effect or as approximately
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi>/</mi><msqrt><mi>λ</mi></msqrt></mrow><annotation encoding="application/x-tex">1/\sqrt{\lambda}</annotation></semantics></math>
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>λ</mi><annotation encoding="application/x-tex">\lambda</annotation></semantics></math>
is a ridge penalty.</p>
<p>Continuing with the coding, we add the parameters and negative
log-likelihood to the model, making the negative log-likelihood a
<em>sum</em> of the two terms in the integral above: the NLL of the data
(<code>-sum(dnorm(I_obs, ...))</code>) and the likelihood of the RBF
parameters (<code>-sum(dnorm(b, ...))</code>): we fit both of the SD
parameters on the log scale.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">matrices</span><span class="op">(</span></span>
<span>    I_sd <span class="op">=</span> <span class="fl">1</span></span>
<span>  , rbf_sd <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">insert</span><span class="op">$</span><span class="fu">expressions</span><span class="op">(</span></span>
<span>     <span class="va">log_lik</span> <span class="op">~</span> </span>
<span>       <span class="op">-</span><span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">dnorm</a></span><span class="op">(</span><span class="va">I_obs</span>, <span class="fu"><a href="../reference/engine_functions.html">rbind_time</a></span><span class="op">(</span><span class="va">I_sim</span><span class="op">)</span>, <span class="va">I_sd</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>       <span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="fu"><a href="../reference/engine_functions.html">sum</a></span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">dnorm</a></span><span class="op">(</span><span class="va">b</span>, <span class="fl">0.0</span>, <span class="va">rbf_sd</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     .phase <span class="op">=</span> <span class="st">"after"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">## initially forgot this: maybe we could warn when someone is missing this????</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">obj_fn</span><span class="op">(</span><span class="op">~</span> <span class="va">log_lik</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">transformations</span><span class="op">(</span><span class="fu"><a href="../reference/Transform.html">Log</a></span><span class="op">(</span><span class="st">"I_sd"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">add</span><span class="op">$</span><span class="fu">transformations</span><span class="op">(</span><span class="fu"><a href="../reference/Transform.html">Log</a></span><span class="op">(</span><span class="st">"rbf_sd"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## not sure if this is required?</span></span>
<span><span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.delim</a></span><span class="op">(</span>sep <span class="op">=</span> <span class="st">"|"</span>, header <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                     strip.white <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co">## important!</span></span>
<span>                      text <span class="op">=</span> <span class="st">"</span></span>
<span><span class="st">mat         | default</span></span>
<span><span class="st">log_I_sd    | 0</span></span>
<span><span class="st">log_rbf_sd  | 1</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">params_frame</span><span class="op">(</span><span class="va">params</span><span class="op">)</span></span></code></pre></div>
<p>Finally, we add the <code>b</code> vector as a set of <em>random</em>
parameters: this tells <code>macpan2</code> to apply the Laplace
approximation to these parameters …</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">matrix_version</span> <span class="op">=</span> <span class="st">"1.6-5"</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"Matrix"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">matrix_version</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">rparams</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      mat  <span class="op">=</span> <span class="st">"b"</span>,</span>
<span>      row <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">19</span>,</span>
<span>      col <span class="op">=</span> <span class="fl">0</span>,</span>
<span>      default <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="va">simulator</span><span class="op">$</span><span class="va">replace</span><span class="op">$</span><span class="fu">random_frame</span><span class="op">(</span><span class="va">rparams</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Test the objective function:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"Matrix"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">matrix_version</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">simulator</span><span class="op">$</span><span class="fu">ad_fun</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="fu">fn</span><span class="op">(</span><span class="fu"><a href="../reference/engine_functions.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; iter: 1  value: 5990932 mgc: 2060840114 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 2  value: 1326996 mgc: 1334151123 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 3  value: 539110 mgc: 359118190 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 4  value: 461680.8 mgc: 72801334 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 5  value: 458020.5 mgc: 9237470 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 6  value: 457980.9 mgc: 606791.4 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 7  value: 457980.9 mgc: 7710.865 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 8  value: 457980.9 mgc: 2.557382 ustep: 1 </span></span>
<span><span class="co">#&gt; iter: 9  value: 457980.9 mgc: 3.542136e-06 ustep: 1 </span></span>
<span><span class="co">#&gt; mgc: 7.456678e-06</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt; [1] 458152.8</span></span>
<span><span class="co">#&gt; attr(,"logarithm")</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre>
<p><strong>fixme</strong>: can’t get objective function to shut up.
Should have specified <code>silent = TRUE</code> when calling
<code>MakeADFun()</code> initially, now have tried assigning the value
in several different environments, without success …</p>
<p>This step normally produces lots of output (more output than a model
with random effects) because the Laplace approximation involves an
additional “inner” step where the <code>b</code> parameters are
optimized, even though we are only evaluating the objective for a single
set of fixed parameters (<code>log_I_sd</code>,
<code>log_rbf_sd</code>)</p>
<p><strong>fixme</strong>: note to developers, if we cache results we
may need to call the <code>$retape()</code> function to restore internal
structure when retrieving …</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"Matrix"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">matrix_version</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## testing: simulator$ad_fun()$fn()</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">simulator</span><span class="op">$</span><span class="va">optimize</span><span class="op">$</span><span class="fu">nlminb</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"Matrix"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">matrix_version</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co">## simulator$print$matrix_dims()</span></span>
<span>  <span class="co">## fixed effects only:</span></span>
<span>  <span class="co">## look at parameters, but skip the random-effects parameters</span></span>
<span>  <span class="co">## 'random' holds the indices of the parameters that are treated</span></span>
<span>  <span class="co">## as random effects</span></span>
<span>  <span class="op">(</span><span class="va">fixed_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="fu">ad_fun</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">env</span>,</span>
<span>                        <span class="va">last.par.best</span><span class="op">[</span><span class="op">-</span><span class="va">random</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">## ???</span></span>
<span>  <span class="co">## RE only</span></span>
<span>  <span class="op">(</span><span class="va">ran_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">simulator</span><span class="op">$</span><span class="fu">ad_fun</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">env</span>,</span>
<span>                      <span class="va">last.par.best</span><span class="op">[</span><span class="va">random</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt;        random        random        random        random        random </span></span>
<span><span class="co">#&gt;  0.0067465927  0.0116662707 -0.0036351043 -0.0151991877  0.0011407843 </span></span>
<span><span class="co">#&gt;        random        random        random        random        random </span></span>
<span><span class="co">#&gt;  0.0032611854 -0.0028961623 -0.0146685397 -0.0058109519  0.0073564031 </span></span>
<span><span class="co">#&gt;        random        random        random        random        random </span></span>
<span><span class="co">#&gt;  0.0097226258  0.0023723875  0.0007575157  0.0014767307 -0.0134880516 </span></span>
<span><span class="co">#&gt;        random        random        random        random        random </span></span>
<span><span class="co">#&gt; -0.0068763891 -0.0025158075  0.0027360906  0.0086700513  0.0033031980</span></span></code></pre></div>
<p><strong>fixme</strong>: we need an incantation to extract the full
parameters (including RE parameters) in order to make sure
<code>$report</code> works properly? (In general, should caution about
mutability/make sure we use <code>last.par.best</code> internally …)</p>
<p>Extract parameters, run the simulator for the best-fit parameters,
compare with data …</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"Matrix"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">matrix_version</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pp</span> <span class="op">&lt;-</span> <span class="va">simulator</span><span class="op">$</span><span class="fu">ad_fun</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">env</span><span class="op">$</span><span class="va">last.par.best</span>  <span class="co">## FIXME: use this</span></span>
<span>  <span class="va">est_I</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">simulator</span></span>
<span>      <span class="op">|&gt;</span> <span class="fu"><a href="../reference/mp_trajectory.html">mp_trajectory</a></span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">matrix</span> <span class="op">==</span> <span class="st">"I"</span><span class="op">)</span></span>
<span>      <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>las <span class="op">=</span> <span class="fl">1</span>, bty <span class="op">=</span> <span class="st">"l"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">obs_I</span>, xlab <span class="op">=</span> <span class="st">"time"</span>, ylab <span class="op">=</span> <span class="st">"prevalence"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="va">est_I</span>, col <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><img src="time_varying_parameters_advanced_files/figure-html/plot_sim-1.png" width="576"></p>
<p><strong>fixme</strong>: there are a few artificialities about this
example that could/should be relaxed</p>
<ul>
<li>the only fixed parameters are the standard deviations. Normally we
would also be estimating <code>gamma</code> (possibly with a prior? do
we have any examples, say in the calibration vignette, of adding
priors?)</li>
<li>the RBF function is penalized to zero. In general, we should augment
the penalized RBF component (which determines the variation around the
mean) with an unpenalized intercept/baseline transmission parameter. So,
for example, the transmission rate should be computed as
<code>b0 + exp(X %*% b)</code>, where <code>b0</code> represents an
unpenalized parameter that’s allowed to vary freely …</li>
</ul>
<p><strong>fixme</strong>: compare (1) unpenalized fit; (2) penalized
fit without Laplace approximation …</p>
<p><strong>fixme</strong>: discuss (somewhere) alternate bases for
latent variables (random-walk, Gaussian process, …)</p>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-kristensenTMB2016" class="csl-entry">
Kristensen, Kasper, Anders Nielsen, Casper W. Berg, Hans Skaug, and
Bradley M. Bell. 2016. <span>“<span>TMB</span>: Automatic
Differentiation and <span>Laplace</span> Approximation.”</span>
<em>Journal of Statistical Software</em> 70 (5). <a href="https://doi.org/10.18637/jss.v070.i05" class="external-link">https://doi.org/10.18637/jss.v070.i05</a>.
</div>
<div id="ref-madsenIntroduction2011" class="csl-entry">
Madsen, Henrik, and Poul Thyregod. 2011. <em>Introduction to General and
Generalized Linear Models</em>. CRC Press.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Steve Walker, Weiguang Guan, Jen Freeman, Ben Bolker, Darren Flynn-Primrose.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
